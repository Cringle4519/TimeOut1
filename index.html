<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TimeOut</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96'%3E%3Ccircle cx='48' cy='48' r='46' fill='%23fefce8' stroke='%23365b2c' stroke-width='4'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-size='46' font-family='Arial' fill='%23365b2c'%3ET%3C/text%3E%3C/svg%3E" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --brand:#2563eb;
    --brand-ink:#ffffff;
    --ink:#1f2937;
    --muted:#6b7280;
    --paper:#fafaf9;
    --card:#ffffff;
    --edge:#e5e7eb;
  }
  html,body{background:var(--paper); color:var(--ink);}
  .btn{ padding:.55rem .8rem; border:1px solid var(--edge); border-radius:.8rem; background:var(--card); font-size:.95rem; transition:transform .05s ease; }
  .btn:active{ transform:scale(.97); }
  .btn-primary{ background:var(--brand); color:var(--brand-ink); border-color:var(--brand); }
  .btn-ghost{ background:transparent; border-color:transparent; color:var(--muted); }
  .btn-badge{ font-size:.8rem; padding:.25rem .5rem; border-radius:.5rem; border-color:#d1d5db; }
  .card{ background:var(--card); border:1px solid var(--edge); border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .hidden-soft{ display:none !important; }
  .panel-scroll{ max-height:calc(100vh - 160px); overflow:auto; -webkit-overflow-scrolling:touch; }
  .yn-btn.selected{ background:var(--brand)!important; color:var(--brand-ink)!important; border-color:var(--brand)!important; }
  header .btn { min-width:44px; min-height:44px; }
  #hdrClock,#hdrWeather{ display:inline-flex; align-items:center; max-width:44vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .demo-qs button{ display:block; width:100%; text-align:left; margin:.3rem 0; padding:.45rem .6rem; border-radius:.5rem; background:#f3f4f6; }
  .kbd{ font:600 .78rem/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas; background:#f3f4f6; border:1px solid #e5e7eb; padding:.1rem .35rem; border-radius:.4rem; }
  footer.small{ font-size:.72rem; color:#9ca3af; }
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-gray-200">
    <div class="max-w-md mx-auto flex items-center justify-between px-3 py-2">
      <div class="flex items-center gap-2">
        <button id="langToggle" class="btn btn-ghost">EN/ES</button>
        <div id="hdrClock" class="text-sm font-medium">--:--</div>
      </div>
      <h1 id="appTitle" class="text-lg font-semibold select-none">TimeOut</h1>
      <div class="flex items-center gap-2">
        <div id="hdrWeather" class="text-sm">‚õÖ</div>
        <button id="btnBack" class="btn btn-ghost hidden-soft">Back</button>
        <button id="btnQuickExit" class="btn btn-ghost hidden-soft">Exit</button>
        <button id="btnPanic" class="btn btn-ghost hidden-soft">Clear&Lock</button>
      </div>
    </div>
  </header>

  <!-- DECOY VIEW -->
  <main id="decoyView" class="max-w-md mx-auto px-3 pt-4 pb-24">
    <section class="card p-4 mb-3">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Timer</h2>
        <span class="text-xs text-gray-500">Long-press title or timer to unlock</span>
      </div>
      <div id="decoyTimerDisplay" class="text-5xl font-mono text-center my-3 select-none">25:00</div>
      <div class="flex gap-2 justify-center">
        <button id="decoyStart" class="btn">Start</button>
        <button id="decoyPause" class="btn">Pause</button>
        <button id="decoyReset" class="btn">Reset</button>
      </div>
    </section>
    <section class="card p-4 mb-3">
      <h2 class="text-base font-semibold mb-2">Calculator</h2>
      <input id="calcInput" class="w-full border rounded-lg px-3 py-2 mb-2" placeholder="e.g., 12+3*4" inputmode="numeric">
      <button id="calcEval" class="btn">=</button>
      <span id="calcOut" class="ml-3 font-mono"></span>
    </section>
    <section class="card p-4 mb-3">
      <h2 class="text-base font-semibold mb-2">Notes</h2>
      <textarea id="decoyNotes" class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="Quick notes‚Ä¶"></textarea>
    </section>
    <footer class="max-w-md mx-auto text-center mt-4">
      <div class="small">v1.3.5</div>
    </footer>
  </main>

  <!-- REAL APP -->
  <main id="appView" class="max-w-md mx-auto px-3 pt-4 pb-28 hidden-soft">
    <!-- Home -->
    <section id="tab-home" class="panel-scroll">
      <div class="card p-4 mb-3">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold" id="homeTitle">Welcome</h2>
          <span class="btn-badge" id="verBadge">v1.3.5</span>
        </div>
        <p class="text-sm text-gray-600 mb-3" id="homeHello">Hi, Anonymous.</p>
        <div class="grid grid-cols-2 gap-2">
          <div class="card p-3">
            <div class="text-sm text-gray-500">Risk</div>
            <div id="riskPct" class="text-2xl font-mono">0%</div>
          </div>
          <div class="card p-3">
            <div class="text-sm text-gray-500">Trust</div>
            <div id="trustPct" class="text-2xl font-mono">100%</div>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-primary" onclick="setTab('checkin')">Go to Check-In</button>
          <button class="btn" onclick="setTab('plan')">Open Plan</button>
        </div>
      </div>
      <div id="safetyCard" class="card p-4">
        <h3 class="font-semibold mb-1" id="safetyTitle">Important Safety Notice</h3>
        <p class="text-sm text-gray-600" id="safetyText">
          This tool helps with planning and private check-ins. It is not emergency help or a guarantee of safety.
          If in danger, call local emergency services.
        </p>
        <button id="btnAckSafety" class="btn btn-primary mt-3">I Understand</button>
      </div>
    </section>

    <!-- Check-In -->
    <section id="tab-checkin" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <div class="flex items-center">
          <h2 id="checkTitle" class="text-lg font-semibold">Check-In</h2>
          <button class="btn btn-ghost" id="askChipCheck" title="Ask support">üéôÔ∏è Ask</button>
        </div>
        <p class="text-sm text-gray-600 mb-2">
          Answer the questions. Buttons highlight. Risk% updates live. Guidance appears as you answer.
        </p>

        <!-- Questions -->
        <div id="questions" class="space-y-2"></div>

        <!-- Per-question guidance appears above; overall synopsis here -->
        <div id="checkFeedback" class="mt-3 space-y-2"></div>

        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnLoadDemo" class="btn">Load Demo Answers</button>
          <button id="btnSaveCheckin" class="btn btn-primary">Save Check-In</button>
        </div>
      </div>
    </section>

    <!-- Plan -->
    <section id="tab-plan" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <div class="flex items-center">
          <h2 id="planTitle" class="text-lg font-semibold">Safety Plan</h2>
          <button class="btn btn-ghost" id="askChipPlan" title="Ask support">üéôÔ∏è Ask</button>
        </div>
        <div class="mt-2 flex gap-2 flex-wrap">
          <button id="btnNewPlan" class="btn">New Plan</button>
          <button id="btnTemplates" class="btn">Templates</button>
          <button id="btnQuickGenerate" class="btn btn-primary">Quick Generate</button>
        </div>
        <div id="plansList" class="mt-3 space-y-2"></div>
      </div>

      <div id="demoQs" class="card p-4">
        <div class="font-semibold mb-2">Example Questions</div>
        <div class="demo-qs">
          <button>Am I safe if I leave now?</button>
          <button>Where can I get help tonight?</button>
          <button>What should I put in my go-bag?</button>
        </div>
      </div>
    </section>

    <!-- Resources -->
    <section id="tab-resources" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <h2 id="resTitle" class="text-lg font-semibold">Resources</h2>
        <p class="text-sm text-gray-600 mb-2">Tap a resource to copy. Use ‚ÄúCall Hotline‚Äù.</p>
        <div class="flex gap-2 mb-2 flex-wrap">
          <button id="callHotlineBtn" class="btn">Call Hotline</button>
          <button id="btnAddResource" class="btn">Add</button>
          <button id="btnSeedLocal" class="btn">Add Local 211</button>
        </div>
        <div id="resList" class="space-y-2"></div>
      </div>
    </section>

    <!-- Profile -->
    <section id="tab-profile" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <h2 class="text-lg font-semibold">Profile</h2>
        <label class="block text-sm mb-1">Display name</label>
        <input id="profName" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="Anonymous">
        <label class="block text-sm mb-1">Change PIN</label>
        <div class="grid grid-cols-3 gap-2">
          <input id="oldPin" class="border rounded-lg px-3 py-2" placeholder="Old" inputmode="numeric" maxlength="8">
          <input id="newPin" class="border rounded-lg px-3 py-2" placeholder="New" inputmode="numeric" maxlength="8">
          <input id="newPin2" class="border rounded-lg px-3 py-2" placeholder="Confirm" inputmode="numeric" maxlength="8">
        </div>
        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnSaveProfile" class="btn btn-primary">Save Profile</button>
          <button id="btnExport" class="btn">Export JSON</button>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">Theme:</span>
            <select id="themePick" class="border rounded-lg px-2 py-2 text-sm">
              <option value="blue">Blue</option>
              <option value="teal">Teal</option>
              <option value="rose">Rose</option>
              <option value="amber">Amber</option>
              <option value="violet">Violet</option>
            </select>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Tabs -->
  <nav id="bottomNav" class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 hidden-soft">
    <div class="max-w-md mx-auto grid grid-cols-5 text-sm">
      <button onclick="setTab('home')" class="py-2 flex flex-col items-center"><span>üè†</span><span id="navHome">Home</span></button>
      <button onclick="setTab('checkin')" class="py-2 flex flex-col items-center"><span>‚úÖ</span><span id="navCheck">Check-In</span></button>
      <button onclick="setTab('plan')" class="py-2 flex flex-col items-center"><span>üß≠</span><span id="navPlan">Plan</span></button>
      <button onclick="setTab('resources')" class="py-2 flex flex-col items-center"><span>üìö</span><span id="navRes">Resources</span></button>
      <button onclick="setTab('profile')" class="py-2 flex flex-col items-center"><span>üë§</span><span id="navProf">Profile</span></button>
    </div>
  </nav>

  <!-- PIN Modal -->
  <div id="pinModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden-soft items-center justify-center">
    <div class="card p-4 w-[92vw] max-w-sm">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Enter PIN</h3>
        <button id="pinClose" class="btn btn-ghost" type="button">‚úï</button>
      </div>
      <input id="pinInput" class="w-full border rounded-lg px-3 py-2" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <div class="mt-3 flex gap-2">
        <button id="pinOk" class="btn btn-primary" type="button">Unlock</button>
        <button id="pinCancel" class="btn" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Ask Modal host -->
  <div id="askModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden-soft items-center justify-center"></div>
  <!-- Floating Ask -->
  <button id="askFab" class="btn btn-primary hidden-soft" style="position:fixed;right:16px;bottom:84px;z-index:55">üéôÔ∏è Ask</button>

<script>
/* ===================== CORE STATE ===================== */
const core = {
  lang: localStorage.getItem('timeout_lang') || 'en',
  pin: localStorage.getItem('timeout_pin') || '2580',
  name: localStorage.getItem('timeout_profile_name') || 'Anonymous',
  answers: JSON.parse(localStorage.getItem('timeout_answers')||'{}'),
  resources: JSON.parse(localStorage.getItem('timeout_resources')||'[]'),
  plans: JSON.parse(localStorage.getItem('timeout_plans')||'[]'),
  theme: localStorage.getItem('timeout_theme') || 'blue',
  risk: 0, trust: 100
};
const $ = id => document.getElementById(id);
function saveLocal(){
  localStorage.setItem('timeout_lang', core.lang);
  localStorage.setItem('timeout_pin', core.pin);
  localStorage.setItem('timeout_profile_name', core.name);
  localStorage.setItem('timeout_answers', JSON.stringify(core.answers));
  localStorage.setItem('timeout_resources', JSON.stringify(core.resources));
  localStorage.setItem('timeout_plans', JSON.stringify(core.plans));
  localStorage.setItem('timeout_theme', core.theme);
}
function toast(msg){ alert(msg); }

/* ===================== THEME ===================== */
function applyTheme(){
  const map={
    blue:{brand:'#2563eb',ink:'#ffffff'},
    teal:{brand:'#0ea5a4',ink:'#002b2a'},
    rose:{brand:'#e11d48',ink:'#ffffff'},
    amber:{brand:'#f59e0b',ink:'#1f2937'},
    violet:{brand:'#7c3aed',ink:'#ffffff'}
  }[core.theme] || {brand:'#2563eb',ink:'#ffffff'};
  document.documentElement.style.setProperty('--brand', map.brand);
  document.documentElement.style.setProperty('--brand-ink', map.ink);
  $('themePick').value = core.theme;
}
$('themePick').addEventListener('change', e=>{ core.theme=e.target.value; saveLocal(); applyTheme(); });

/* ===================== LANGUAGE ===================== */
$('langToggle').onclick = ()=>{
  core.lang = core.lang === 'en' ? 'es' : 'en';
  saveLocal();
  applyAll();
  const askOpen = !$('askModal').classList.contains('hidden-soft');
  if (askOpen) { $('askModal').dataset.ready=''; ensureAskModal(); }
};
function T(en, es){ return core.lang==='es'? es: en; }
function applyLang(){
  $('langToggle').textContent = core.lang==='es'?'ES/EN':'EN/ES';
  $('btnQuickExit').textContent = T('Exit','Salir');
  $('btnPanic').textContent = T('Clear&Lock','Borrar y Bloquear');
  $('btnBack').textContent = T('Back','Atr√°s');
  $('homeTitle').textContent = T('Welcome','Bienvenido/a');
  $('homeHello').textContent = T(`Hi, ${core.name}.`, `Hola, ${core.name}.`);
  $('resTitle').textContent = T('Resources','Recursos');
  $('checkTitle').textContent = T('Check-In','Autoevaluaci√≥n');
  $('planTitle').textContent = T('Safety Plan','Plan de Seguridad');
  $('navHome').textContent = T('Home','Inicio');
  $('navCheck').textContent = T('Check-In','Autoeval.');
  $('navPlan').textContent = T('Plan','Plan');
  $('navRes').textContent = T('Resources','Recursos');
  $('navProf').textContent = T('Profile','Perfil');
  const dqs = document.querySelectorAll('#demoQs .demo-qs button');
  if(dqs[0]) dqs[0].textContent = T('Am I safe if I leave now?','¬øEstoy seguro/a si me voy ahora?');
  if(dqs[1]) dqs[1].textContent = T('Where can I get help tonight?','¬øD√≥nde puedo obtener ayuda esta noche?');
  if(dqs[2]) dqs[2].textContent = T('What should I put in my go-bag?','¬øQu√© debo poner en mi bolsa de emergencia?');
  // Safety i18n
  const sTitle = document.getElementById('safetyTitle');
  const sText  = document.getElementById('safetyText');
  const sBtn   = document.getElementById('btnAckSafety');
  if (sTitle) sTitle.textContent = T('Important Safety Notice','Aviso importante de seguridad');
  if (sText)  sText.textContent  = T(
    'This tool helps with planning and private check-ins. It is not emergency help or a guarantee of safety. If in danger, call local emergency services.',
    'Esta herramienta ayuda con la planificaci√≥n y chequeos privados. No es ayuda de emergencia ni garant√≠a de seguridad. En peligro, llama a emergencias locales.'
  );
  if (sBtn)   sBtn.textContent   = T('I Understand','Entiendo');
}

/* ===================== CLOCK & WEATHER ===================== */
function tickClock(){
  const d = new Date();
  const h = d.getHours().toString().padStart(2,'0');
  const m = d.getMinutes().toString().padStart(2,'0');
  $('hdrClock').textContent = `${h}:${m}`;
}
setInterval(tickClock, 1000); tickClock();
(function setWeather(){ $('hdrWeather').textContent = '‚õÖ'; })();

/* ===================== DECOY: STOPWATCH/CALC/NOTES ===================== */
let swInterval=null, swSeconds=25*60;
function renderStopwatch(){ const mm=Math.floor(swSeconds/60).toString().padStart(2,'0'); const ss=(swSeconds%60).toString().padStart(2,'0'); $('decoyTimerDisplay').textContent=`${mm}:${ss}`;}
$('decoyStart').onclick=()=>{ if(swInterval) return; swInterval=setInterval(()=>{ if(swSeconds>0){ swSeconds--; renderStopwatch(); }},1000); };
$('decoyPause').onclick=()=>{ clearInterval(swInterval); swInterval=null; };
$('decoyReset').onclick=()=>{ swSeconds=25*60; renderStopwatch(); };
renderStopwatch();
$('calcEval').onclick=()=>{ try{ const v=eval(($('calcInput').value||'').replace(/[^0-9+\-*/(). ]/g,'')); $('calcOut').textContent = isFinite(v)? v: '‚Äî'; }catch{ $('calcOut').textContent='‚Äî'; } };
$('decoyNotes').value = localStorage.getItem('timeout_decoy_notes') || '';
$('decoyNotes').addEventListener('input', e=> localStorage.setItem('timeout_decoy_notes', e.target.value));

/* ===================== UNLOCK (LONG PRESS + PIN) ===================== */
let lpTimer=null;
function bindLongPress(el){
  const start=()=>{ lpTimer=setTimeout(()=> openPinModal(), 800); };
  const clear=()=>{ clearTimeout(lpTimer); };
  el.addEventListener('mousedown',start); el.addEventListener('touchstart',start,{passive:true});
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> el.addEventListener(ev, clear));
}
bindLongPress($('appTitle'));
bindLongPress($('decoyTimerDisplay'));
function openPinModal(){ $('pinModal').classList.remove('hidden-soft'); $('pinInput').value=''; $('pinInput').focus(); }
function closePinModal(){
  clearTimeout(lpTimer);
  const modal=$('pinModal'); if(!modal) return;
  modal.classList.add('hidden-soft');
}
$('pinClose').onclick=closePinModal; $('pinCancel').onclick=closePinModal;
$('pinOk').onclick=tryUnlock;
$('pinInput').addEventListener('keydown', e=>{ if(e.key==='Enter') tryUnlock(); });
$('pinModal').addEventListener('click', (e)=>{ if(e.target===$('pinModal')) closePinModal(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && !$('pinModal').classList.contains('hidden-soft')) closePinModal(); });
function tryUnlock(){
  const v = $('pinInput').value.trim();
  if(v===core.pin){ showRealApp(); closePinModal(); }
  else { toast(T('Wrong PIN','PIN incorrecto')); }
}

/* ===================== LOCK/UNLOCK + SAFETY ===================== */
function showRealApp(){
  $('decoyView').classList.add('hidden-soft');
  $('appView').classList.remove('hidden-soft');
  $('bottomNav').classList.remove('hidden-soft');
  $('btnQuickExit').classList.remove('hidden-soft');
  $('btnPanic').classList.remove('hidden-soft');
  $('btnBack').classList.remove('hidden-soft');
  $('askFab').classList.remove('hidden-soft');
  applyLang();
}
function lockToDecoy(){
  $('appView').classList.add('hidden-soft');
  $('bottomNav').classList.add('hidden-soft');
  $('btnQuickExit').classList.add('hidden-soft');
  $('btnPanic').classList.add('hidden-soft');
  $('btnBack').classList.add('hidden-soft');
  $('askFab').classList.add('hidden-soft');
  $('decoyView').classList.remove('hidden-soft');
  closeAsk();
}
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) lockToDecoy(); });
$('btnQuickExit').onclick=()=>{ location.href='https://www.google.com/'; };
$('btnPanic').onclick=()=>{
  localStorage.removeItem('timeout_profile_name');
  localStorage.removeItem('timeout_answers');
  localStorage.removeItem('timeout_resources');
  localStorage.removeItem('timeout_plans');
  localStorage.removeItem('timeout_theme');
  core.name='Anonymous'; core.answers={}; core.resources=[]; core.plans=[]; core.theme='blue';
  saveLocal(); applyTheme(); lockToDecoy();
};

/* ===================== TABS ===================== */
function setTab(name){
  ['home','checkin','plan','resources','profile'].forEach(t=>{
    $('tab-'+t).classList.toggle('hidden-soft', t!==name);
  });
  if(name==='checkin'){ buildQuestions(); updateScoresAndFeedback(); }
  if(name==='plan'){ renderPlans(); }
  if(name==='resources'){ renderResources(); }
}
window.setTab = setTab;

/* ===================== SAFETY ACK (ONCE) ===================== */
function applySafetyAckVisibility(){
  const seen = localStorage.getItem('timeout_safety_ack') === '1';
  const card = document.getElementById('safetyCard');
  if (card) card.style.display = seen ? 'none' : '';
}
document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'btnAckSafety') {
    localStorage.setItem('timeout_safety_ack','1');
    applySafetyAckVisibility();
  }
});

/* ===================== CHECK-IN: 13 near-clinical questions ===================== */
const Q13_EN = [
  {k:'q1',  t:'Are you safe in your current location right now?', w:2, pos:'If you can move to a place with other people (or a locked room), do so. Keep keys, phone, and shoes nearby.' , neg:'Good‚Äîstill keep exits visible and a charged phone accessible.'},
  {k:'q2',  t:'Has a partner or family member threatened you in the past 30 days?', w:2, pos:'Record dates/times privately and tell a trusted person. Consider storing notes off this device.', neg:'If threats arise, note details and update your plan.'},
  {k:'q3',  t:'In the past 30 days, have you experienced any physical harm (pushing, hitting, restraining)?', w:3, pos:'Seek medical care if needed and document injuries safely. Consider urgent support resources.', neg:'If this changes, increase safety steps and seek help.'},
  {k:'q4',  t:'Has the person ever used or threatened to use a weapon?', w:3, pos:'High concern. Avoid confrontation, prioritize exits, and contact emergency services if unsafe.', neg:'If weapons become involved, treat as urgent risk.'},
  {k:'q5',  t:'Is the person increasingly controlling (movement, money, phone, or contacts)?', w:2, pos:'Control often escalates. Hide critical info, set a trusted code word, and prepare a go-bag.', neg:'Maintain independence where possible and review finances.'},
  {k:'q6',  t:'Do you believe the person monitors your phone or accounts?', w:2, pos:'Change passwords from a safe device. Turn off location sharing and review account logins.', neg:'Keep devices locked and review privacy settings.'},
  {k:'q7',  t:'Has the person forced or coerced sexual activity?', w:3, pos:'This is sexual assault. Consider confidential medical care and advocacy support.', neg:'If this occurs, specialized support is available.'},
  {k:'q8',  t:'Has the person threatened children, family, pets, or immigration status?', w:3, pos:'Consider safe caregiving backups and legal advice. Tell a trusted adult and document threats.', neg:'If new threats arise, seek help immediately.'},
  {k:'q9',  t:'Has stalking behavior occurred (following, tracking, constant messages)?', w:2, pos:'Save evidence safely (screenshots, dates). Consider changing routes and devices.', neg:'If it starts, document and seek guidance.'},
  {k:'q10', t:'Has the frequency or severity of incidents increased recently?', w:2, pos:'Escalation raises risk. Shorten your timeline for leaving and alert trusted contacts.', neg:'Reassess weekly; escalation can be sudden.'},
  {k:'q11', t:'Do you have a safe place to go for 24‚Äì72 hours if needed?', w:1, pos:'List two backup locations and travel options. Keep copies of IDs and essentials.', neg:'Identify at least one safe place‚Äîeven a public location helps.'},
  {k:'q12', t:'Do you have someone you can contact quickly who knows a code word?', w:1, pos:'Share a simple code and what it means (call police, pick up kids, etc.).', neg:'Choose one person and agree on a short code word today.'},
  {k:'q13', t:'Would you like immediate local resources or legal information?', w:1, pos:'Check Resources for hotlines/advocates. They can help build a personalized plan.', neg:'Resources are there anytime‚Äîsave the numbers now.'}
];
const Q13_ES = [
  {k:'q1',  t:'¬øEst√°s seguro/a en tu ubicaci√≥n actual ahora mismo?', w:2, pos:'Si puedes moverte a un lugar con m√°s gente (o una habitaci√≥n con llave), hazlo. Mant√©n llaves, tel√©fono y zapatos cerca.', neg:'Bien‚Äîmant√©n salidas visibles y el tel√©fono cargado a mano.'},
  {k:'q2',  t:'¬øUna pareja o familiar te ha amenazado en los √∫ltimos 30 d√≠as?', w:2, pos:'Anota fechas/horas en privado y cu√©ntaselo a alguien de confianza. Guarda notas fuera de este dispositivo.', neg:'Si aparecen amenazas, anota detalles y actualiza tu plan.'},
  {k:'q3',  t:'En los √∫ltimos 30 d√≠as, ¬øhas sufrido da√±o f√≠sico (empujar, golpear, sujetar)?', w:3, pos:'Busca atenci√≥n m√©dica si es necesario y documenta lesiones de forma segura. Considera apoyo urgente.', neg:'Si cambia, aumenta medidas de seguridad y busca ayuda.'},
  {k:'q4',  t:'¬øLa persona ha usado o amenazado con usar un arma?', w:3, pos:'Alta preocupaci√≥n. Evita la confrontaci√≥n, prioriza salidas y llama a emergencias si no est√°s seguro/a.', neg:'Si aparecen armas, tr√°talo como riesgo urgente.'},
  {k:'q5',  t:'¬øLa persona controla m√°s (movimientos, dinero, tel√©fono o contactos)?', w:2, pos:'El control suele escalar. Oculta informaci√≥n cr√≠tica, define una palabra clave y prepara una bolsa de emergencia.', neg:'Mant√©n independencia donde sea posible y revisa finanzas.'},
  {k:'q6',  t:'¬øCrees que la persona monitorea tu tel√©fono o cuentas?', w:2, pos:'Cambia contrase√±as desde un dispositivo seguro. Desactiva compartir ubicaci√≥n y revisa inicios de sesi√≥n.', neg:'Mant√©n bloqueo y revisa privacidad.'},
  {k:'q7',  t:'¬øLa persona te ha forzado o coaccionado sexualmente?', w:3, pos:'Es agresi√≥n sexual. Considera atenci√≥n m√©dica confidencial y apoyo de defensor√≠a.', neg:'Si ocurre, hay apoyo especializado.'},
  {k:'q8',  t:'¬øLa persona ha amenazado a ni√±os, familia, mascotas o estatus migratorio?', w:3, pos:'Considera cuidadores seguros y asesor√≠a legal. Av√≠sale a un adulto de confianza y documenta amenazas.', neg:'Si aparecen nuevas amenazas, busca ayuda de inmediato.'},
  {k:'q9',  t:'¬øHa habido acecho (seguir, rastrear, mensajes constantes)?', w:2, pos:'Guarda evidencia de forma segura (capturas, fechas). Considera cambiar rutas y dispositivos.', neg:'Si empieza, documenta y busca orientaci√≥n.'},
  {k:'q10', t:'¬øHan aumentado la frecuencia o la gravedad de los incidentes recientemente?', w:2, pos:'La escalada aumenta el riesgo. Acorta tu plazo para salir y avisa a contactos.', neg:'Reeval√∫a cada semana; la escalada puede ser repentina.'},
  {k:'q11', t:'¬øTienes un lugar seguro para 24‚Äì72 horas si fuera necesario?', w:1, pos:'Anota dos lugares alternos y opciones de traslado. Guarda copias de identificaciones y esenciales.', neg:'Identifica al menos un lugar seguro‚Äîun lugar p√∫blico tambi√©n ayuda.'},
  {k:'q12', t:'¬øTienes a alguien a quien contactar r√°pido que sepa una palabra clave?', w:1, pos:'Comparte un c√≥digo breve y lo que significa (llamar a polic√≠a, recoger ni√±os, etc.).', neg:'Elige a una persona y acuerden hoy una palabra clave.'},
  {k:'q13', t:'¬øQuieres recursos locales inmediatos o informaci√≥n legal?', w:1, pos:'Revisa Recursos para l√≠neas de ayuda/abogadas/os. Pueden crear un plan personalizado.', neg:'Los recursos est√°n disponibles siempre‚Äîguarda los n√∫meros ahora.'}
];
function getQ(){ return core.lang==='es'? Q13_ES : Q13_EN; }

function qRow(q, i){
  const qid = q.k;
  const yesSel = core.answers[qid]==='yes' ? 'selected' : '';
  const noSel  = core.answers[qid]==='no'  ? 'selected' : '';
  const yesLab = T('Yes','S√≠');
  const noLab  = T('No','No');
  const helpId = `help_${qid}`;
  return `
    <div class="card p-3">
      <div class="mb-2 text-sm">${i+1}. ${q.t}</div>
      <div class="flex gap-2">
        <button class="btn yn-btn ${yesSel}" data-q="${qid}" data-v="yes">${yesLab}</button>
        <button class="btn yn-btn ${noSel}"  data-q="${qid}" data-v="no">${noLab}</button>
      </div>
      <div id="${helpId}" class="text-xs text-gray-600 mt-2"></div>
    </div>`;
}
function buildQuestions(){
  const box = $('questions'); if(!box) return;
  box.innerHTML = '';
  getQ().forEach((q,i)=> box.insertAdjacentHTML('beforeend', qRow(q,i)));
  // repopulate guidance if answers already exist
  getQ().forEach(q=>{
    const a = core.answers[q.k];
    if(a) writeGuidance(q.k, a==='yes'? q.pos: q.neg);
  });
}
function writeGuidance(qid, text){
  const el = $('help_'+qid);
  if(el){ el.textContent = text; }
}
function computeRisk(){
  let total=0, max=0;
  const arr = getQ();
  arr.forEach(q=>{
    max += q.w;
    // risk points: most "yes" indicate risk except q1,q11,q12,q13
    // Treat risky when (q1=='no') OR (yes for q2..q10) ; (q11/q12/q13 yes reduce risk)
    const a = core.answers[q.k];
    if(q.k==='q1'){
      if(a==='no') total += q.w; // not safe now
    } else if(['q11','q12','q13'].includes(q.k)){
      if(a==='no') total += Math.max(1, q.w-0); // lacking buffers
    } else {
      if(a==='yes') total += q.w;
    }
  });
  const pct = Math.round((total/ (max+3)) * 100); // +3 softens to avoid pegging at 100 on sparse answers
  core.risk = Math.max(0, Math.min(100, pct));
  core.trust = 100 - core.risk;
}
function overallSynopsis(){
  // Build 2‚Äì3 short paragraphs tailored to risk band
  const r = core.risk;
  const a = core.answers;
  const Q = getQ().reduce((m,q)=>{ m[q.k]=q; return m; },{});
  const P = (en, es)=> T(en, es);

  const bits = [];

  if(r >= 60){
    bits.push(P(
      "Your answers suggest a high and potentially escalating risk. Focus first on immediate safety: keep keys, phone, and shoes ready; identify the fastest exit; and move toward people when you can.",
      "Tus respuestas sugieren un riesgo alto y potencialmente en aumento. Prioriza la seguridad inmediata: ten listas llaves, tel√©fono y zapatos; identifica la salida m√°s r√°pida; y mu√©vete hacia lugares con gente cuando sea posible."
    ));
    if(a.q4==='yes') bits.push(P(
      "Because a weapon has been used or threatened, avoid confrontation and consider contacting emergency services. If you must leave, leave quickly without collecting items.",
      "Como se ha usado o amenazado con un arma, evita la confrontaci√≥n y considera contactar a emergencias. Si debes salir, hazlo r√°pido sin recoger objetos."
    ));
    bits.push(P(
      "Document incidents privately and off-device when possible, and tell a trusted person using a simple code word. A confidential advocate can help you plan each step.",
      "Documenta incidentes en privado y fuera del dispositivo cuando sea posible, y avisa a alguien de confianza usando una palabra clave. Una persona defensora puede ayudarte a planear cada paso."
    ));
  } else if (r >= 30){
    bits.push(P(
      "Your answers indicate a moderate level of concern. Strengthen buffers now: set a code word with one trusted person, prepare a small go-bag, and map two quick exits.",
      "Tus respuestas indican un nivel de preocupaci√≥n moderado. Refuerza protecciones: define una palabra clave con alguien de confianza, prepara una bolsa de emergencia y traza dos salidas r√°pidas."
    ));
    if(a.q6==='yes') bits.push(P(
      "Because phone or account monitoring is a concern, change passwords from a safe device and review location sharing settings.",
      "Dado que te preocupa la vigilancia del tel√©fono o cuentas, cambia contrase√±as desde un dispositivo seguro y revisa los ajustes de ubicaci√≥n."
    ));
    bits.push(P(
      "Check Resources for hotlines or local advocates who can tailor a plan to you. Small steps taken early can prevent escalation.",
      "Revisa Recursos para l√≠neas de ayuda o servicios locales que puedan personalizar un plan para ti. Pasos peque√±os a tiempo ayudan a evitar la escalada."
    ));
  } else {
    bits.push(P(
      "Your answers reflect low reported risk right now. Keep basic safety habits: charged phone, exits in view, and one person who knows a code word.",
      "Tus respuestas reflejan un riesgo bajo en este momento. Mant√©n h√°bitos b√°sicos: tel√©fono cargado, salidas a la vista y una persona que conozca una palabra clave."
    ));
    bits.push(P(
      "Review your plan weekly and store key numbers in a safe place. If things change, you can update this check-in anytime.",
      "Revisa tu plan semanalmente y guarda n√∫meros clave en un lugar seguro. Si algo cambia, puedes actualizar esta autoevaluaci√≥n en cualquier momento."
    ));
    bits.push(P(
      "Use this time-out to think about resources nearby and what you would take if you needed to leave quickly.",
      "Usa este ‚Äòtime-out‚Äô para pensar en recursos cercanos y qu√© llevar√≠as si necesitaras salir r√°pidamente."
    ));
  }

  // Add short legal/clinical disclaimer
  bits.push(P(
    "Guidance here is general and not a guarantee of safety or a substitute for professional care. If you‚Äôre in immediate danger, call local emergency services.",
    "Esta orientaci√≥n es general y no garantiza seguridad ni reemplaza la atenci√≥n profesional. Si est√°s en peligro inmediato, llama a emergencias locales."
  ));
  return bits.map(t=>`<div class="card p-3 text-sm">${t}</div>`).join('');
}
function updateScoresAndFeedback(){
  computeRisk();
  $('riskPct').textContent = core.risk + '%';
  $('trustPct').textContent = core.trust + '%';

  const fb = $('checkFeedback'); if(!fb) return;
  fb.innerHTML = overallSynopsis();
}

// Answer handling (write guidance + recompute)
document.addEventListener('click', (e)=>{
  const b = e.target.closest('.yn-btn'); if(!b) return;
  const qid = b.dataset.q; const val=b.dataset.v; if(!qid||!val) return;
  core.answers[qid] = val; saveLocal();

  // button highlight swap
  document.querySelectorAll(`.yn-btn[data-q="${qid}"]`).forEach(x=>x.classList.remove('selected'));
  b.classList.add('selected');

  // per-question guidance
  const qObj = getQ().find(q=>q.k===qid);
  if(qObj){ writeGuidance(qid, val==='yes'? qObj.pos: qObj.neg); }

  updateScoresAndFeedback();
});

// Demo fill
$('btnLoadDemo').onclick=()=>{
  core.answers = {
    q1:'no', q2:'yes', q3:'yes', q4:'no', q5:'yes',
    q6:'yes', q7:'no', q8:'no', q9:'yes', q10:'yes',
    q11:'no', q12:'no', q13:'yes'
  };
  saveLocal(); buildQuestions(); updateScoresAndFeedback();
};
$('btnSaveCheckin').onclick=()=>{ saveLocal(); toast(T('Check-In saved.','Autoevaluaci√≥n guardada.')); };

/* ===================== SAFETY PLAN (unchanged) ===================== */
function renderPlans(){
  const list = $('plansList'); if(!list) return;
  list.innerHTML='';
  if(core.plans.length===0){
    list.insertAdjacentHTML('beforeend', `<div class="text-sm text-gray-600">${T('No plans yet. Use New, Templates, or Quick Generate.','A√∫n no hay planes. Usa Nuevo, Plantillas o Generar R√°pido.')}</div>`);
    return;
  }
  core.plans.forEach((p,idx)=>{
    const steps = (p.steps||[]).map(s=>`<li class="list-disc ml-5">${s}</li>`).join('');
    const card = `
      <div class="card p-3">
        <div class="flex items-center justify-between">
          <div class="font-semibold">${p.title||T('Untitled','Sin t√≠tulo')}</div>
          <button data-i="${idx}" class="btn btn-ghost text-rose-600 delPlan">${T('Delete','Eliminar')}</button>
        </div>
        ${steps? `<ul class="mt-2 text-sm">${steps}</ul>`:''}
      </div>`;
    list.insertAdjacentHTML('beforeend', card);
  });
  list.querySelectorAll('.delPlan').forEach(btn=>{
    btn.onclick=()=>{ const i=+btn.dataset.i; core.plans.splice(i,1); saveLocal(); renderPlans(); };
  });
}
$('btnNewPlan').onclick=()=>{
  const t = prompt(T('Plan title?','¬øT√≠tulo del plan?')) || T('Personal Plan','Plan personal');
  const s = prompt(T('Steps (comma-separated):','Pasos (separados por comas):')) || '';
  const steps = s.split(',').map(x=>x.trim()).filter(Boolean);
  core.plans.push({title:t, steps}); saveLocal(); renderPlans();
};
$('btnTemplates').onclick=()=>{
  const template = { title:T('Grab & Go Bag','Bolsa de emergencia'), steps:[T('ID & documents','Identificaci√≥n y documentos'),T('Keys & cash','Llaves y efectivo'),T('Medications','Medicamentos'),T('Change of clothes','Cambio de ropa'),T('Backup phone numbers','N√∫meros de tel√©fono de respaldo')] };
  core.plans.push(template); saveLocal(); renderPlans();
};
let qpGuard=false;
$('btnQuickGenerate').onclick=()=>{
  if(qpGuard) return; qpGuard=true; setTimeout(()=>qpGuard=false,600);
  const a=core.answers; const steps=[];
  if(a.q6==='yes') steps.push(T('Change passwords from a safe device; review location sharing.','Cambia contrase√±as desde un dispositivo seguro; revisa compartir ubicaci√≥n.'));
  if(a.q2==='yes' || a.q3==='yes' || a.q9==='yes') steps.push(T('Document incidents safely and tell a trusted person.','Documenta incidentes de forma segura y avisa a alguien de confianza.'));
  if(a.q1==='no') steps.push(T('Move to a public place; call a hotline or trusted contact.','Mu√©vete a un lugar p√∫blico; llama a una l√≠nea de ayuda o contacto de confianza.'));
  if(a.q11==='no') steps.push(T('Identify one safe place for 24‚Äì72 hours.','Identifica un lugar seguro para 24‚Äì72 horas.'));
  if(a.q12==='no') steps.push(T('Choose one person and agree on a code word.','Elige a una persona y acuerden una palabra clave.'));
  if(steps.length===0) steps.push(T('Share location with a trusted person; review exits and transport.','Comparte ubicaci√≥n con alguien de confianza; revisa salidas y transporte.'));
  core.plans.push({title:T('Quick Plan','Plan r√°pido'), steps}); saveLocal(); renderPlans(); toast(T('Quick plan created.','Plan r√°pido creado.'));
};
document.getElementById('demoQs').addEventListener('click', e=>{
  const b=e.target.closest('button'); if(!b) return;
  openAsk(); setTimeout(()=>{ const i=$('askInput'); if(i){ i.value=b.textContent; i.focus(); }},250);
});

/* ===================== RESOURCES (unchanged) ===================== */
function seedResourcesIfEmpty(){
  if(!Array.isArray(core.resources) || core.resources.length===0){
    core.resources = [
      {title:"National Domestic Violence Hotline (US)", desc:"24/7 confidential help ‚Äî call or chat", url:"tel:+18007997233"},
      {title:"RAINN Sexual Assault Hotline (US)", desc:"24/7 ‚Äî phone + online chat", url:"tel:+18006564673"},
      {title:"Childhelp National Child Abuse Hotline (US)", desc:"24/7 ‚Äî children & adults", url:"tel:+18004224453"},
      {title:"StrongHearts Native Helpline (US)", desc:"Support for Native communities", url:"tel:+18447628483"},
      {title:"love is respect (US)", desc:"Dating abuse support ‚Äî call/text/chat", url:"https://www.loveisrespect.org/"},
      {title:"National Deaf DV Hotline (US)", desc:"Deaf/Hard of Hearing support (ASL)", url:"https://thedeafhotline.org/"},
      {title:"211 ‚Äî Local Services (US/Canada)", desc:"Housing, legal, financial, counseling", url:"https://www.211.org/"},
      {title:"SAMHSA Helpline (US)", desc:"Mental health & substance use", url:"tel:+18006624357"},
      {title:"Emergency", desc:"Call your local emergency number", url:"tel:911"}
    ];
    saveLocal();
  }
}
function renderResources(){
  const box=$('resList'); box.innerHTML='';
  core.resources.forEach((r,i)=>{
    const isTel = /^tel:/i.test(r.url||'');
    const item = `
      <div class="card p-3 flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="font-semibold truncate">${r.title}</div>
          <div class="text-sm text-gray-600">${r.desc||''}</div>
          <div class="text-xs mt-1 break-all">${r.url}</div>
        </div>
        <div class="flex flex-col gap-2 shrink-0">
          ${isTel? `<a class="btn" href="${r.url}">${T('Call','Llamar')}</a>` : `<button class="btn openRes" data-i="${i}">${T('Open','Abrir')}</button>`}
          <button class="btn copyRes" data-i="${i}">${T('Copy','Copiar')}</button>
          <button class="btn delRes text-rose-600" data-i="${i}">${T('Delete','Eliminar')}</button>
        </div>
      </div>`;
    box.insertAdjacentHTML('beforeend', item);
  });
  box.querySelectorAll('.copyRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; navigator.clipboard.writeText(core.resources[i].url||''); toast(T('Copied.','Copiado.')); });
  box.querySelectorAll('.delRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; core.resources.splice(i,1); saveLocal(); renderResources(); });
  box.querySelectorAll('.openRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; const u=core.resources[i].url; if(u) location.href=u; });
}
$('callHotlineBtn').onclick=()=>{ location.href='tel:+18007997233'; };
$('btnAddResource').onclick=()=>{
  const title = prompt(T('Title','T√≠tulo'))||''; if(!title) return;
  const desc  = prompt(T('Description (optional)','Descripci√≥n (opcional)'))||'';
  const url   = prompt(T('Link or phone (prefix phone with tel:)','Enlace o tel√©fono (prefijo tel:)'))||'';
  core.resources.push({title,desc,url}); saveLocal(); renderResources();
};
$('btnSeedLocal').onclick=()=>{
  core.resources.push({title:T("Local 211 ‚Äî Services","211 Local ‚Äî Servicios"), desc:T("Tap to open 211","Pulsa para abrir 211"), url:"https://www.211.org/"}); saveLocal(); renderResources();
};

/* ===================== PROFILE (unchanged) ===================== */
$('profName').value = core.name;
$('themePick').value = core.theme;
$('btnSaveProfile').onclick=()=>{
  core.name = $('profName').value.trim() || 'Anonymous';
  const old = $('oldPin').value.trim();
  const np  = $('newPin').value.trim();
  const np2 = $('newPin2').value.trim();
  if(np || np2 || old){
    if(old!==core.pin) return toast(T('Old PIN is wrong.','PIN anterior incorrecto.'));
    if(np.length<4 || np!==np2) return toast(T('New PIN mismatch or too short.','Nuevo PIN no coincide o es muy corto.'));
    core.pin = np;
  }
  saveLocal();
  applyLang();
  toast(T('Profile saved.','Perfil guardado.'));
};
$('btnExport').onclick=()=>{
  const data = {
    profile:{name:core.name},
    answers:core.answers,
    risk:core.risk, trust:core.trust,
    resources:core.resources,
    plans:core.plans,
    theme:core.theme,
    app:"TimeOut", version:"v1.3.5"
  };
  const blob = new Blob/* ===================== PIN FIX ===================== */
function tryUnlock(){
  const v = $('pinInput').value.trim();
  if(v === core.pin){
    showRealApp();
    closePinModal();
  } else {
    toast(T('Wrong PIN','PIN incorrecto'));
    $('pinInput').value = '';   // clear input
    $('pinInput').focus();      // refocus for retry
  }
}

/* ===================== PLACEHOLDER: SUPPORT PANEL ===================== */
function renderSupportPlaceholder(){
  const ask = $('askModal');
  if(!ask) return;
  ask.innerHTML = `
    <div class="card p-4 w-[92vw] max-w-md mx-auto">
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold">${T('Professional Support','Apoyo profesional')}</div>
        <button id="askClose" class="btn btn-ghost">‚úï</button>
      </div>
      <p class="text-sm text-gray-600 mb-2">
        ${T(
          'This feature is reserved for professional partners. When activated, a live clinic or support organization will appear here. Contact us if your clinic or service would like to provide help through TimeOut.',
          'Esta funci√≥n est√° reservada para socios profesionales. Cuando est√© activada, aqu√≠ aparecer√° una cl√≠nica u organizaci√≥n de apoyo en vivo. Cont√°ctanos si tu cl√≠nica o servicio desea brindar ayuda a trav√©s de TimeOut.'
        )}
      </p>
      <button id="askClose2" class="btn btn-primary">${T('OK','Entiendo')}</button>
    </div>
  `;
  $('askClose').onclick = closeAsk;
  $('askClose2').onclick = closeAsk;
}

// Override openAsk to always show placeholder
function openAsk(){
  renderSupportPlaceholder();
  $('askModal').classList.remove('hidden-soft');
  document.body.style.overflow='hidden';
}
function closeAsk(){
  $('askModal').classList.add('hidden-soft');
  document.body.style.overflow='auto';
}
$('askFab').onclick = openAsk;
$('askChipCheck').onclick = openAsk;
$('askChipPlan').onclick = openAsk;</script>
</body>
</html>
