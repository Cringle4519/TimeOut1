<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>TimeOut</title>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220;--card:#121a2b;--ink:#e7eaf6;--muted:#9ca3af;
    --pri:#6366f1;--pri-2:#4f46e5;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;
    --line:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:480px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}
  header{
    position:sticky;top:0;z-index:5;background:linear-gradient(0deg,rgba(11,18,32,0),rgba(11,18,32,.9) 30%,rgba(11,18,32,1));
    backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line);padding:10px 12px 8px;
  }
  .topbar{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:8px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#1f40ff,#7c3aed)}
  h1{font-size:16px;margin:0}
  .toolbar{display:flex;gap:6px}
  button.tap{
    background:#1f2937;color:var(--ink);border:1px solid #273244;border-radius:10px;padding:.55rem .8rem;font-weight:600;
  }
  button.pri{background:var(--pri);border-color:var(--pri-2)}
  button.danger{background:var(--bad);border-color:#b91c1c}
  main{flex:1;padding:10px 12px 20px;display:flex;flex-direction:column;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .muted{color:var(--muted);font-size:.9rem}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--line);border-radius:12px;background:#0f1729}
  .qtxt{font-size:.98rem;line-height:1.3}
  .btns{display:flex;gap:8px;flex-shrink:0}
  .seg{display:flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .seg button{background:#111827;border:0;padding:.45rem .75rem;color:var(--muted);font-weight:700}
  .seg button.active-yes{background:#0b3a2b;color:#34d399}
  .seg button.active-no{background:#3a1111;color:#f87171}
  .scorebar{height:10px;background:#0f172a;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .scorebar>div{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .list a{
    display:block;text-decoration:none;color:var(--ink);background:#0f1729;border:1px solid var(--line);
    padding:12px;border-radius:12px;margin-bottom:8px
  }
  .hint{font-size:.85rem;color:var(--muted)}
  .footer-note{font-size:.8rem;color:#94a3b8;text-align:center;margin-top:10px}
  .hidden{display:none !important}
  /* mobile safe area spacing */
  @supports(padding:max(0px)){ header{padding-top:max(10px, env(safe-area-inset-top))} .wrap{padding-bottom:env(safe-area-inset-bottom)} }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="topbar">
      <div class="brand" id="panic-dbltap">
        <div class="logo"></div>
        <h1>TimeOut</h1>
      </div>
      <div class="toolbar">
        <button id="btn-home" class="tap pri">Home</button>
        <button id="btn-resources" class="tap">Resources</button>
        <button id="btn-settings" class="tap">Settings</button>
        <button id="btn-exit" class="tap danger">Quick&nbsp;Exit</button>
      </div>
    </div>
  </header>

  <main>
    <!-- HOME: questions + trust score -->
    <section id="screen-home" class="card">
      <div class="title">
        <div>
          <div style="font-weight:700">Check-in</div>
          <div class="muted">Answer 8 quick questions. Your answers stay on this device.</div>
        </div>
        <button id="btn-reset" class="tap" title="Reset answers">Reset</button>
      </div>

      <div id="q-list" class="space">
        <!-- questions rendered here -->
      </div>

      <div style="margin-top:12px">
        <div class="title">
          <div style="font-weight:700">Trust Score</div>
          <div id="score-label" class="muted">0 / 8</div>
        </div>
        <div class="scorebar"><div id="score-fill"></div></div>
        <div id="score-note" class="hint" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- RESOURCES -->
    <section id="screen-resources" class="card hidden">
      <div class="title">
        <div>
          <div style="font-weight:700">Resources</div>
          <div class="muted">Tap to call, text, or open a site.</div>
        </div>
      </div>
      <div class="list">
        <a href="tel:18007997233">üìû National DV Hotline ‚Äî 1-800-799-SAFE (7233)</a>
        <a href="sms:88788">üí¨ Text ‚ÄúSTART‚Äù to 88788 (Hotline)</a>
        <a href="https://www.thehotline.org/" target="_blank" rel="noopener">üåê thehotline.org (chat, safety planning)</a>
        <a href="https://www.loveisrespect.org/" target="_blank" rel="noopener">üíú loveisrespect.org (youth & teens)</a>
        <a href="https://www.womenslaw.org/" target="_blank" rel="noopener">‚öñÔ∏è WomensLaw.org (legal info)</a>
      </div>
      <div class="hint">If you‚Äôre in immediate danger, call 911.</div>
    </section>

    <!-- SETTINGS -->
    <section id="screen-settings" class="card hidden">
      <div class="title">
        <div>
          <div style="font-weight:700">Settings</div>
          <div class="muted">Your data is saved locally on this device.</div>
        </div>
      </div>

      <div class="grid2">
        <button id="btn-export" class="tap">Export Backup</button>
        <label class="tap" style="text-align:center;cursor:pointer">Restore Backup
          <input id="file-restore" type="file" accept="application/json" style="display:none">
        </label>
        <button id="btn-clear" class="tap danger">Erase Local Data</button>
        <button id="btn-demo-fill" class="tap">Demo Fill (toggle)</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Press <b>Esc</b> or tap <b>Quick Exit</b> any time to jump to a safe decoy page.
      </div>
    </section>

    <div class="footer-note">¬© TimeOut ‚Äî private on-device check-ins</div>
  </main>
</div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const STORAGE_KEY = 'timeout.v1';

  const QUESTIONS = [
    "Do you feel safe at home right now?",
    "Has anyone threatened you or controlled where you go?",
    "Has pushing, hitting, or choking occurred recently?",
    "Do you fear things might escalate soon?",
    "Is someone monitoring your phone, texts, or location?",
    "Has money, IDs, or transportation been taken from you?",
    "Do you have injuries that worry you?",
    "Would you like help building a safety plan?"
  ];

  let state = load() || { answers: Array(QUESTIONS.length).fill(null) };

  // UI refs
  const scrHome = $('#screen-home');
  const scrRes  = $('#screen-resources');
  const scrSet  = $('#screen-settings');

  const scoreFill = $('#score-fill');
  const scoreLabel = $('#score-label');
  const scoreNote = $('#score-note');
  const qList = $('#q-list');

  function nav(to){
    [scrHome,scrRes,scrSet].forEach(el=>el.classList.add('hidden'));
    (to==='home'?scrHome:to==='resources'?scrRes:scrSet).classList.remove('hidden');
  }

  // Build question rows
  function renderQuestions(){
    qList.innerHTML = '';
    QUESTIONS.forEach((q, idx) => {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div class="qtxt">${q}</div>
        <div class="btns">
          <div class="seg" role="group" aria-label="Yes or No">
            <button data-i="${idx}" data-v="yes">Yes</button>
            <button data-i="${idx}" data-v="no">No</button>
          </div>
        </div>
      `;
      qList.appendChild(row);
    });

    // restore state
    $$('.seg button').forEach(btn=>{
      const i = +btn.dataset.i, v = btn.dataset.v;
      const cur = state.answers[i];
      btn.classList.toggle('active-yes', cur==='yes' && v==='yes');
      btn.classList.toggle('active-no',  cur==='no'  && v==='no');
    });

    // handlers
    $$('.seg button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = +btn.dataset.i, v = btn.dataset.v;
        state.answers[i] = v;
        persist();
        // update classes for this group
        const group = btn.parentElement.querySelectorAll('button');
        group.forEach(b=>{ b.classList.remove('active-yes','active-no'); });
        btn.classList.add(v==='yes' ? 'active-yes' : 'active-no');
        calcScore();
      });
    });
  }

  function calcScore(){
    // Trust Score idea: count ‚Äúconcern‚Äù answers.
    // For this screening, we‚Äôll treat ‚Äúyes‚Äù as risk on all except Q1.
    let risk = 0;
    state.answers.forEach((v, i)=>{
      if(i===0){ if(v==='no') risk++; } else { if(v==='yes') risk++; }
    });
    const total = QUESTIONS.length;
    scoreLabel.textContent = `${risk} / ${total}`;
    const pct = Math.round((risk/total)*100);
    scoreFill.style.width = pct + '%';

    let msg = '';
    if(risk === 0) msg = 'No immediate red flags reported.';
    else if(risk <= 2) msg = 'Some concerns. Consider reviewing resources.';
    else if(risk <= 5) msg = 'Elevated risk. Building a safety plan may help.';
    else msg = 'High risk. Please consider contacting support now.';
    scoreNote.textContent = msg;
  }

  function resetAll(){
    state.answers = Array(QUESTIONS.length).fill(null);
    persist(); renderQuestions(); calcScore(); toast('Answers cleared');
  }

  function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || ''); }catch(e){ return null; } }

  // Backup/Restore
  $('#btn-export').addEventListener('click', ()=>{
    try{
      const raw = JSON.stringify(state);
      const blob = new Blob([raw], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'timeout-backup.json'; a.click();
      URL.revokeObjectURL(url);
      toast('Backup exported');
    }catch(e){ toast('Export failed'); }
  });
  $('#file-restore').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    try{
      const txt = await f.text();
      const parsed = JSON.parse(txt);
      if(!Array.isArray(parsed.answers) || parsed.answers.length !== QUESTIONS.length) throw new Error();
      state = parsed; persist(); renderQuestions(); calcScore(); toast('Backup restored');
    }catch(e){ toast('Invalid backup'); }
    e.target.value='';
  });
  $('#btn-clear').addEventListener('click', ()=>{
    if(confirm('Erase ALL local data on this device?')){
      localStorage.removeItem(STORAGE_KEY);
      state = { answers: Array(QUESTIONS.length).fill(null) };
      renderQuestions(); calcScore(); toast('Local data erased');
    }
  });

  // Demo fill (toggle)
  let demoOn = false;
  $('#btn-demo-fill').addEventListener('click', ()=>{
    demoOn = !demoOn;
    state.answers = demoOn
      ? ['no','yes','yes','no','yes','no','yes','yes'] // an example pattern
      : Array(QUESTIONS.length).fill(null);
    persist(); renderQuestions(); calcScore();
    toast(demoOn ? 'Demo answers filled' : 'Demo cleared');
  });

  // Navigation
  $('#btn-home').addEventListener('click', ()=> nav('home'));
  $('#btn-resources').addEventListener('click', ()=> nav('resources'));
  $('#btn-settings').addEventListener('click', ()=> nav('settings'));

  // Reset
  $('#btn-reset').addEventListener('click', resetAll);

  // Quick Exit
  function quickExit(){
    try{ history.replaceState(null,'','/'); }catch(e){}
    location.replace('decoy.html');
  }
  $('#btn-exit').addEventListener('click', quickExit);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') quickExit(); });

  // Double-tap brand area to exit
  let lastTap=0;
  $('#panic-dbltap').addEventListener('touchend', ()=>{
    const now = Date.now();
    if(now - lastTap < 300) quickExit();
    lastTap = now;
  });

  // UI helpers
  function toast(msg){
    const d=document.createElement('div');
    d.textContent=msg;
    d.style.cssText='position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#0f172a;color:#fff;padding:.55rem .8rem;border:1px solid #1f2937;border-radius:10px;z-index:9999';
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),1500);
  }

  // First paint
  renderQuestions();
  calcScore();
})();
</script>
</body>
</html>
