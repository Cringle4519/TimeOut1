<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TimeOut — Safety & Support</title>
  <meta name="theme-color" content="#0a0f18" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--maxw:480px}
    html,body{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:#0a0f18;color:#eaf1fb;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .container{max-width:var(--maxw);margin:0 auto;padding:16px}
    .card{background:rgba(18,25,38,.78);border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-weight:800;font-size:20px;margin:0;letter-spacing:.2px}
    .pill{background:#0d1626;padding:.15rem .6rem;border-radius:999px;border:1px solid rgba(255,255,255,.06);font-size:12px;color:#9fb0d9}
    .btn{border-radius:10px;padding:.5rem .8rem;font-weight:700;cursor:pointer}
    .btn-primary{background:#2563eb;color:#fff;border:0}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:inherit}
    .small{font-size:13px;color:#9fb0d9}
    .hidden-soft{display:none!important}
    .digit{width:54px;height:76px;border-radius:12px;background:linear-gradient(180deg,#0e1a2a,#0c1726);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:42px;letter-spacing:.02em;text-shadow:0 0 8px rgba(59,130,246,.28);border:1px solid rgba(255,255,255,.05)}
    .sep{width:14px;display:flex;align-items:center;justify-content:center;font-weight:900;color:#9fb5ff;font-size:38px;text-shadow:0 0 8px rgba(99,102,241,.25)}
    .flipwrap{display:inline-grid;grid-auto-flow:column;gap:.18rem;user-select:none}
    .tab-btn{padding:.45rem .75rem;border-radius:999px;border:1px solid rgba(255,255,255,.06)}
    .tab-btn.active{background:#2563eb;color:white;border:0}
    input.card, textarea.card, select.card{background:rgba(0,0,0,.15);border:1px solid rgba(255,255,255,.08);padding:.6rem;border-radius:8px;color:inherit}
    footer.small-note{text-align:center;color:#93a7c7;margin-top:12px;font-size:12px}
    .danger{color:#ff6b6b}
    .bottom-bar{
      position:fixed;left:0;right:0;bottom:0;height:64px;display:flex;align-items:center;justify-content:space-around;
      background:rgba(11,17,26,.94);backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,.06);z-index:50
    }
    .bottom-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 10px;border-radius:10px;border:1px solid transparent;font-size:12px;color:#9fb0d9}
    .bottom-btn.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .bottom-ico{font-size:18px;line-height:18px}
    .theme-dim body, body.theme-dim{background:#0c1220;color:#edf3ff}
    .theme-dim .card{background:rgba(16,23,36,.8);border-color:rgba(255,255,255,.07)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;z-index:60}
    .overlay .panel{max-width:520px;width:92vw}
    @media(max-width:480px){ .digit{width:48px;height:70px;font-size:36px} }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <header>
      <div>
        <h1 id="decoyTitle" class="select-none">TimeOut</h1>
        <div class="small"><span id="hdrSub">Clock</span> • <span class="pill" id="versionPill">v1.4.0</span></div>
      </div>
      <div class="flex items-center gap-3">
        <div id="langToggle" class="btn btn-ghost">EN | ES</div>
        <button id="quickExitBtn" class="btn btn-ghost">Home</button>
      </div>
    </header>

    <!-- DECOY VIEW -->
    <section id="decoyView" class="card">
      <div class="flex items-center justify-center gap-2 mb-3">
        <button id="decoyTabClock" class="tab-btn active">Clock</button>
        <button id="decoyTabStopwatch" class="tab-btn">Stopwatch</button>
        <button id="decoySkinCalc" class="tab-btn">Calculator</button>
        <button id="decoySkinNotes" class="tab-btn">Notes</button>
        <button id="decoySkinWeather" class="tab-btn">Weather</button>
      </div>

      <!-- CLOCK SKIN -->
      <div id="skinClock" class="text-center">
        <div id="flipClock" class="inline-flex items-center justify-center select-none" style="gap:.18rem;">
          <div class="flipwrap" id="hh"><div class="digit">0</div><div class="digit">0</div></div>
          <div class="sep">:</div>
          <div class="flipwrap" id="mm"><div class="digit">0</div><div class="digit">0</div></div>
          <div class="sep">:</div>
          <div class="flipwrap" id="ss"><div class="digit">0</div><div class="digit">0</div></div>
        </div>
        <div id="liveDate" class="small mt-2">—</div>
        <p class="small mt-3">Long-press title or digits to unlock the app.</p>
      </div>

      <!-- STOPWATCH SKIN -->
      <div id="skinStopwatch" class="text-center hidden-soft">
        <div id="swDisplay" class="font-extrabold text-4xl my-3">00:00.00</div>
        <div class="flex items-center justify-center gap-2">
          <button id="swStart" class="btn btn-primary">Start</button>
          <button id="swLap" class="btn btn-ghost">Lap</button>
          <button id="swReset" class="btn btn-ghost">Reset</button>
        </div>
        <ul id="swLaps" class="mt-3 text-sm text-gray-300 max-h-36 overflow-auto"></ul>
      </div>

      <!-- CALC SKIN -->
      <div id="skinCalc" class="hidden-soft mt-3">
        <div class="card mb-3 text-right" id="calcDisplay" style="font-size:1.4rem;padding:.7rem">0</div>
        <div class="grid grid-cols-4 gap-2">
          <button class="btn btn-ghost">7</button><button class="btn btn-ghost">8</button><button class="btn btn-ghost">9</button><button class="btn btn-ghost">÷</button>
          <button class="btn btn-ghost">4</button><button class="btn btn-ghost">5</button><button class="btn btn-ghost">6</button><button class="btn btn-ghost">×</button>
          <button class="btn btn-ghost">1</button><button class="btn btn-ghost">2</button><button class="btn btn-ghost">3</button><button class="btn btn-ghost">-</button>
          <button class="btn btn-ghost">0</button><button class="btn btn-ghost">.</button><button class="btn btn-ghost">=</button><button class="btn btn-ghost">+</button>
        </div>
        <p class="small mt-3">Long-press the display to unlock (hidden).</p>
      </div>

      <!-- NOTES SKIN -->
      <div id="skinNotes" class="hidden-soft mt-3">
        <div class="card p-3" id="fakeNoteContent">Grocery: milk, eggs, bread. Call Mom later.</div>
        <p class="small mt-3">Long-press note area to unlock (hidden).</p>
      </div>

      <!-- WEATHER SKIN -->
      <div id="skinWeather" class="hidden-soft mt-3 text-center">
        <div class="card p-4">
          <div class="text-4xl font-bold" id="weatherTemp">72°</div>
          <div class="small mt-1" id="weatherCity">Sunny • Your City</div>
        </div>
        <p class="small mt-3">Long-press weather card to unlock (hidden).</p>
      </div>
    </section>

    <!-- OVERLAY: PIN / CHANGE PIN -->
    <div id="pinModal" class="overlay hidden-soft">
      <div class="panel card p-4">
        <h3 id="pinModalTitle" class="text-lg font-semibold mb-2">Enter PIN</h3>
        <form id="pinForm" class="space-y-3">
          <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" autocomplete="off"
                 class="w-full card text-center font-bold text-xl" placeholder="••••" />
          <div id="pinChangeFields" class="hidden-soft space-y-2">
            <input id="oldPin" maxlength="32" inputmode="numeric" class="w-full card text-center" placeholder="Current PIN" />
            <input id="newPin" maxlength="64" class="w-full card text-center" placeholder="New PIN or passphrase (min 4)" />
            <input id="newPin2" maxlength="64" class="w-full card text-center" placeholder="Confirm new" />
          </div>
          <div class="flex gap-2">
            <button id="pinConfirmBtn" class="btn btn-primary flex-1" type="submit">Confirm</button>
            <button id="pinCancelBtn" class="btn btn-ghost flex-1" type="button">Cancel</button>
          </div>
          <div id="pinError" class="small danger min-h-[1rem]"></div>
          <div class="small text-gray-400">Default PIN: <strong>2580</strong>. Duress: <strong>1111</strong>. Change in Profile.</div>
        </form>
      </div>
    </div>

    <!-- OVERLAY: DISCLAIMER (first unlock only) -->
    <div id="firstRunDisc" class="overlay hidden-soft">
      <div class="panel card p-4">
        <h3 class="text-lg font-semibold mb-2" id="discTitle">Important Safety Notice</h3>
        <div class="small mb-3" id="discBody">
          This tool helps with planning and private check-ins. It is <strong>not</strong> a guarantee of safety or emergency response.
          If you are in immediate danger, call local emergency services. Use duress PIN and auto-wipe with caution. No system is 100% secure.
        </div>
        <div class="flex gap-2 justify-end">
          <button id="acceptDisclaimer" class="btn btn-primary">I Understand</button>
        </div>
      </div>
    </div>

    <!-- REAL APP -->
    <section id="realApp" class="hidden-soft mt-3">
      <div class="card mb-3">
        <div class="flex items-center justify-between">
          <div>
            <div class="small" id="signedAsLbl">Signed in as</div>
            <div id="profileName" class="font-semibold text-lg">Anonymous</div>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <div class="small" id="trustLbl">Trust</div>
              <div id="trustBadge" class="font-bold text-2xl">100%</div>
            </div>
            <button id="lockBtn" class="btn btn-ghost">Lock</button>
          </div>
        </div>
      </div>

      <!-- Spacer so content doesn't hide behind bottom bar -->
      <div style="height:64px"></div>

      <!-- HOME -->
      <div id="tab-home" class="card">
        <h3 class="text-lg font-semibold" id="homeTitle">Welcome</h3>
        <p class="small mt-2"><span id="homeHi">Hi</span> <span id="homeName">Anonymous</span>. <span id="homeTrustCopy">Your trust score is</span> <span id="homeTrust">100</span>%.</p>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button id="goToCheckIn" class="btn btn-primary">Go to Check-In</button>
          <button id="saveAll" class="btn btn-ghost">Save</button>
        </div>
      </div>

      <!-- CHECK-IN -->
      <div id="tab-checkin" class="card hidden-soft mt-3">
        <h3 class="text-lg font-semibold mb-2" id="checkTitle">Safety Check-In</h3>
        <div id="questions" class="space-y-3"></div>
        <div class="flex gap-2 mt-3">
          <button id="saveCheckIn" class="btn btn-primary flex-1">Save Check-In</button>
          <button id="clearCheckIn" class="btn btn-ghost flex-1">Clear</button>
        </div>
        <div class="mt-3 flex justify-between">
          <div>
            <div class="small" id="riskLbl">Risk</div>
            <div id="riskPct" class="font-bold text-2xl text-rose-400">0%</div>
          </div>
          <div class="text-right">
            <div class="small" id="trustPctLbl">Trust</div>
            <div id="trustPct" class="font-bold text-2xl text-green-400">100%</div>
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <button id="demoLoadBtn" class="btn btn-ghost">Load Demo Answers</button>
          <button id="talkBtn" class="btn btn-ghost">Talk to the App</button>
        </div>
        <div id="checkFeedback" class="mt-4"></div>
      </div>

      <!-- SAFETY PLAN -->
      <div id="tab-plan" class="card hidden-soft mt-3">
        <h3 class="text-lg font-semibold" id="planTitle">Safety Plans</h3>
        <div id="planList" class="mt-2 space-y-2"></div>
        <div class="mt-2 flex gap-2">
          <button id="btnNewPlan" class="btn btn-primary">New Plan</button>
          <button id="btnTemplates" class="btn btn-ghost">Templates</button>
          <button id="btnQuickGenerate" class="btn btn-ghost">Quick Generate</button>
        </div>
      </div>

      <!-- RESOURCES -->
      <div id="tab-resources" class="card hidden-soft mt-3">
        <h3 class="text-lg font-semibold" id="resTitle">My Resources</h3>
        <form id="resourceForm" class="grid grid-cols-1 gap-2 mt-3 mb-3">
          <input id="resTitleInput" class="card" placeholder="Title (e.g., Shelter)" />
          <input id="resDesc" class="card" placeholder="Description" />
          <input id="resUrl" class="card" placeholder="Link or phone (https:// or 1-800...)" />
          <div class="flex gap-2">
            <button id="btnAddResource" class="btn btn-primary flex-1">Add Resource</button>
            <button id="btnCopyHotline" class="btn btn-ghost flex-1">Copy Hotline</button>
          </div>
        </form>
        <ul id="resourceList" class="space-y-2"></ul>
      </div>

      <!-- PROFILE -->
      <div id="tab-profile" class="card hidden-soft mt-3">
        <h3 class="text-lg font-semibold" id="profileTitle">Profile & Security</h3>
        <div class="mt-3 grid gap-2">
          <label class="small" id="displayNameLbl">Display Name</label>
          <input id="displayNameInput" class="card" placeholder="Your name (optional)" />
          <button id="saveProfile" class="btn btn-primary">Save Profile</button>
        </div>

        <hr class="my-4 border-gray-700" />

        <h4 class="font-semibold" id="securityTitle">Security</h4>
        <div class="mt-2 grid gap-2">
          <div class="flex items-center gap-2">
            <label class="small" id="changePinLbl">Change PIN</label>
            <input id="profileChangePin" class="card" placeholder="New PIN (min 4)" />
            <button id="profileChangePinBtn" class="btn btn-ghost">Change</button>
          </div>
          <div class="flex items-center gap-2">
            <label class="small" id="duressPinLbl">Set Duress PIN</label>
            <input id="profileDuressPin" class="card" placeholder="Duress PIN" />
            <button id="profileSetDuress" class="btn btn-ghost">Set</button>
          </div>
          <div class="flex items-center gap-2">
            <label class="small" id="autoWipeLbl">Auto-wipe after failed attempts</label>
            <select id="autoWipeSelect" class="card w-28"><option value="0">Off</option><option value="3">3</option><option value="5">5</option></select>
          </div>
          <div class="flex items-center gap-2">
            <label class="small" id="shakeLbl">Shake-to-lock</label>
            <input id="toggleShake" type="checkbox" />
          </div>
        </div>

        <hr class="my-4 border-gray-700" />

        <div class="grid gap-2">
          <button id="exportJson" class="btn btn-ghost">Export Encrypted JSON</button>
          <input id="importJsonFile" type="file" class="mt-1" />
          <button id="importJsonBtn" class="btn btn-ghost">Import Encrypted JSON</button>
          <button id="clearData" class="btn btn-ghost danger">Clear Data (Wipe)</button>
        </div>
      </div>

      <footer class="small-note">TimeOut • Privacy-first support • <span id="verFoot">v1.4.0</span></footer>
    </section>
  </div>

  <!-- Firebase v11.6.1 (hooks are safe if not configured) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC3Ga-GhV8xQztnbef7ybPFu4BRtLANtuk",
      authDomain: "unbrokenpath-630b0.firebaseapp.com",
      projectId: "unbrokenpath-630b0",
      storageBucket: "unbrokenpath-630b0.firebasestorage.app",
      messagingSenderId: "147188865145",
      appId: "1:147188865145:web:ff1f35a732bf89b31e1ca8",
      measurementId: "G-0Y8G7SS1BV"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    signInAnonymously(auth).catch(()=>{});
    let currentUid = null;
    onAuthStateChanged(auth, u => { if(u){ currentUid = u.uid; } });

    // Safe no-op if not signed in yet
    window.saveProfileMirror = async function(profile){
      if(!currentUid) return;
      try{
        const ref = doc(db, "artifacts/timeout-app/public/data/profiles/" + currentUid);
        await setDoc(ref, {
          publicName: profile.name || "Anonymous",
          trustScore: profile.trust || 100,
          appVersion: "v1.4.0",
          updatedAt: serverTimestamp()
        }, { merge:true });
      }catch(e){}
    };
    window.saveCheckinToFirestore = async function(payload){
      if(!currentUid) return;
      try{
        const col = collection(db, "artifacts/timeout-app/private/data/checkins");
        await addDoc(col, {
          userId: currentUid,
          answers: payload.answers,
          profile: payload.profile,
          createdAt: serverTimestamp(),
          appVersion: "v1.4.0"
        });
      }catch(e){}
    };
  </script>

  <!-- App Core -->
  <script>
  const $ = id => document.getElementById(id);
  const APP_VER = "v1.4.0";
  const LS = {
    meta:"timeout_meta", enc:"timeout_enc", pinCheck:"timeout_pin_check", duressCheck:"timeout_duress_check",
    profile:"timeout_profile", answers:"timeout_answers", resources:"timeout_resources", plans:"timeout_plans",
    disclaimer:"timeout_disclaimer_accepted", autoWipe:"timeout_autowipe", failed:"timeout_failed", lang:"timeout_lang", theme:"timeout_theme_dim"
  };

  let unlocked=false, unlockedPassword=null, failedAttempts=0;

  // Default core
  let core = { profile:{name:"Anonymous", trust:100}, answers:{}, resources:[], plans:[], settings:{ shakeLock:false, autoWipe:0 } };

  /* ===== Crypto helpers (AES-GCM + PBKDF2) ===== */
  function randBytes(n){ const b=new Uint8Array(n); crypto.getRandomValues(b); return b; }
  function toB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
  function fromB64(s){ const bin=atob(s); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr; }
  async function deriveKey(password, salt, iterations=150000){
    const enc=new TextEncoder();
    const pw = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
    return crypto.subtle.deriveKey({name:"PBKDF2", salt, iterations, hash:"SHA-256"}, pw, {name:"AES-GCM", length:256}, false, ["encrypt","decrypt"]);
  }
  async function encryptWithPassword(obj, password){
    const salt=randBytes(16), iv=randBytes(12);
    const key=await deriveKey(password, salt);
    const data=new TextEncoder().encode(JSON.stringify(obj));
    const ct=await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, data);
    return { header:{salt:toB64(salt), iv:toB64(iv), version:1}, ciphertext:toB64(ct) };
  }
  async function decryptWithPassword(blob, password){
    const salt=fromB64(blob.header.salt), iv=fromB64(blob.header.iv);
    const key=await deriveKey(password, salt);
    const plain=await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, fromB64(blob.ciphertext));
    return JSON.parse(new TextDecoder().decode(plain));
  }
  async function createPinCheck(pin){
    const salt=randBytes(12), iv=randBytes(12);
    const key=await deriveKey(pin, salt, 100000);
    const ct=await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, new TextEncoder().encode("timeout-check"));
    return { salt:toB64(salt), iv:toB64(iv), ct:toB64(ct) };
  }
  async function verifyPinCheck(pin, stored){
    try{
      const salt=fromB64(stored.salt), iv=fromB64(stored.iv);
      const key=await deriveKey(pin, salt, 100000);
      const plain=await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, fromB64(stored.ct));
      return new TextDecoder().decode(plain) === "timeout-check";
    }catch(e){ return false; }
  }
  async function saveEncryptedCore(password){
    const pkg = await encryptWithPassword(core, password);
    localStorage.setItem(LS.enc, JSON.stringify(pkg));
  }
  async function loadEncryptedCore(password){
    const blob = JSON.parse(localStorage.getItem(LS.enc)||"null");
    if(!blob) return null;
    return decryptWithPassword(blob, password);
  }

  /* ===== Defaults (first run) ===== */
  (async function initDefaults(){
    if(!localStorage.getItem(LS.pinCheck)){
      const pk = await createPinCheck("2580");
      localStorage.setItem(LS.pinCheck, JSON.stringify(pk));
      await saveEncryptedCore("2580").catch(()=>{});
    }
    if(!localStorage.getItem(LS.duressCheck)){
      const dk = await createPinCheck("1111");
      localStorage.setItem(LS.duressCheck, JSON.stringify(dk));
    }
    if(!localStorage.getItem(LS.resources)){
      // preload broad resources (EN/ES titles switch later in UI)
      const R = [
        {title:"National Domestic Violence Hotline (US)", desc:"24/7 confidential support", url:"https://www.thehotline.org/ 1-800-799-7233"},
        {title:"RAINN Sexual Assault Hotline (US)", desc:"24/7 — chat & phone", url:"https://www.rainn.org/ 1-800-656-4673"},
        {title:"Childhelp National Child Abuse Hotline (US)", desc:"24/7 — children & adults", url:"https://www.childhelp.org/ 1-800-422-4453"},
        {title:"Elder Abuse Resource (NCEA)", desc:"Info & reporting paths", url:"https://ncea.acl.gov/"},
        {title:"Local Social Services Finder", desc:"Locate nearby assistance", url:"https://www.211.org/"},
        {title:"Emergency (If in immediate danger)", desc:"Call your local emergency number", url:"911"}
      ];
      localStorage.setItem(LS.resources, JSON.stringify(R));
    }
  })();

  /* ===== Decoy clock & skins ===== */
  const flipHH=$("hh"), flipMM=$("mm"), flipSS=$("ss"), liveDate=$("liveDate");
  const pad2 = n=> String(n).padStart(2,"0");
  let lastClock="000000";
  function updateFlip(group, prev, next){
    const a=group.children[0], b=group.children[1];
    if(prev[0]!==next[0]) a.textContent=next[0];
    if(prev[1]!==next[1]) b.textContent=next[1];
  }
  function renderClock(){
    const d=new Date(); const h=pad2(d.getHours()), m=pad2(d.getMinutes()), s=pad2(d.getSeconds());
    const now=h+m+s, prev=lastClock; lastClock=now;
    updateFlip(flipHH, prev.slice(0,2), h);
    updateFlip(flipMM, prev.slice(2,4), m);
    updateFlip(flipSS, prev.slice(4,6), s);
    const opts={weekday:'short', month:'short', day:'numeric'}; liveDate.textContent=d.toLocaleDateString(undefined,opts);
  }
  setInterval(renderClock,1000); renderClock();

  // Stopwatch
  let swRunning=false, swStartT=0, swElapsed=0, swRAF=null;
  const fmtMillis = ms => { const cs=Math.floor(ms/10)%100, sec=Math.floor(ms/1000)%60, min=Math.floor(ms/60000)%60, hr=Math.floor(ms/3600000); const hh=hr>0?String(hr).padStart(2,'0')+':':''; return `${hh}${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}.${String(cs).padStart(2,"0")}`; }
  function swTick(){ const ms=swElapsed + (swRunning?(performance.now()-swStartT):0); $("swDisplay").textContent=fmtMillis(ms); if(swRunning) swRAF=requestAnimationFrame(swTick); }
  $("swStart").addEventListener("click", ()=>{ if(!swRunning){ swRunning=true; swStartT=performance.now(); $("swStart").textContent="Pause"; swTick(); } else { swRunning=false; swElapsed += (performance.now()-swStartT); cancelAnimationFrame(swRAF); $("swStart").textContent="Start"; }});
  $("swLap").addEventListener("click", ()=>{ const li=document.createElement("li"); li.textContent=$("swDisplay").textContent; $("swLaps").prepend(li); });
  $("swReset").addEventListener("click", ()=>{ swRunning=false; cancelAnimationFrame(swRAF); swElapsed=0; $("swDisplay").textContent="00:00.00"; $("swStart").textContent="Start"; $("swLaps").innerHTML=""; });

  function setSkin(s){
    ["skinClock","skinStopwatch","skinCalc","skinNotes","skinWeather"].forEach(id=>$(id).classList.add("hidden-soft"));
    if(s==="clock") $("skinClock").classList.remove("hidden-soft");
    if(s==="stopwatch") $("skinStopwatch").classList.remove("hidden-soft");
    if(s==="calc") $("skinCalc").classList.remove("hidden-soft");
    if(s==="notes") $("skinNotes").classList.remove("hidden-soft");
    if(s==="weather") $("skinWeather").classList.remove("hidden-soft");
    const m = JSON.parse(localStorage.getItem(LS.meta)||"{}"); m.skin=s; localStorage.setItem(LS.meta, JSON.stringify(m));
  }
  $("decoyTabClock").onclick = ()=> setSkin("clock");
  $("decoyTabStopwatch").onclick = ()=> setSkin("stopwatch");
  $("decoySkinCalc").onclick = ()=> setSkin("calc");
  $("decoySkinNotes").onclick = ()=> setSkin("notes");
  $("decoySkinWeather").onclick = ()=> setSkin("weather");
  setSkin((JSON.parse(localStorage.getItem(LS.meta)||"{}").skin) || "clock");

  // Simple calculator (decoy)
  (function(){
    const out=$("calcDisplay"); let expr="";
    function show(v){ out.textContent=v; }
    function push(x){ if(x==="="){ try{ const r=Function(`return (${expr.replace(/×/g,'*').replace(/÷/g,'/')})`)(); show(String(r)); expr=String(r); }catch{ show("0"); expr=""; } } else { if(expr==="0") expr=""; expr += x; show(expr); } }
    document.querySelectorAll("#skinCalc .btn").forEach(b=> b.addEventListener("click", ()=> push(b.textContent.trim())));
  })();

  /* ===== Long-press unlock (robust) ===== */
  function addLongPress(el, action){
    if(!el) return; let t=null;
    const start=()=>{ t=setTimeout(action,900); };
    const stop =()=>{ if(t){ clearTimeout(t); t=null; } };
    el.addEventListener("mousedown",start); el.addEventListener("mouseup",stop); el.addEventListener("mouseleave",stop);
    el.addEventListener("touchstart",start,{passive:true}); el.addEventListener("touchend",stop); el.addEventListener("touchcancel",stop);
  }
  const openPINModal=(mode="enter")=>{
    $("pinError").textContent=""; $("pinInput").value="";
    $("oldPin").value=$("newPin").value=$("newPin2").value="";
    $("pinChangeFields").classList.toggle("hidden-soft", mode!=="change");
    $("pinModalTitle").textContent = (lang==="en" ? (mode==="change"?"Change PIN":"Enter PIN") : (mode==="change"?"Cambiar PIN":"Introduce el PIN"));
    $("pinForm").dataset.mode=mode;
    $("pinModal").classList.remove("hidden-soft");
    document.body.style.overflow="hidden";
    setTimeout(()=>$("pinInput").focus(),50);
  };
  const closePINModal=()=>{ $("pinModal").classList.add("hidden-soft"); document.body.style.overflow="auto"; };
  addLongPress($("decoyView"), ()=> openPINModal());
  addLongPress($("decoyTitle"), ()=> openPINModal());
  addLongPress($("flipClock"), ()=> openPINModal());
  addLongPress($("fakeNoteContent"), ()=> openPINModal());

  $("pinCancelBtn").onclick = closePINModal;

  $("pinForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const mode=$("pinForm").dataset.mode||"enter";
    const val=$("pinInput").value.trim();
    if(mode==="enter"){
      const stored=localStorage.getItem(LS.pinCheck), duress=localStorage.getItem(LS.duressCheck);
      const ok = stored && await verifyPinCheck(val, JSON.parse(stored));
      if(ok){
        try{ const data=await loadEncryptedCore(val); if(data) core=data; unlocked=true; unlockedPassword=val; failedAttempts=0; localStorage.removeItem(LS.failed); closePINModal(); showRealApp(); refreshUI(); }
        catch{ $("pinError").textContent=(lang==="en"?"Incorrect PIN.":"PIN incorrecto."); recordFailedAttempt(); }
      } else if(duress && await verifyPinCheck(val, JSON.parse(duress))){
        // Duress: stay on decoy, quietly close modal
        closePINModal();
      } else {
        $("pinError").textContent=(lang==="en"?"Incorrect PIN.":"PIN incorrecto."); recordFailedAttempt();
      }
    } else {
      const old=$("oldPin").value.trim(), np=$("newPin").value.trim(), np2=$("newPin2").value.trim();
      if(!old || !np || np.length<4 || np!==np2){ $("pinError").textContent=(lang==="en"?"Check entries (min 4; must match).":"Verifica (mín 4; deben coincidir)."); return; }
      const ok = await verifyPinCheck(old, JSON.parse(localStorage.getItem(LS.pinCheck)||"null"));
      if(!ok){ $("pinError").textContent=(lang==="en"?"Incorrect current PIN.":"PIN actual incorrecto."); return; }
      const newCheck=await createPinCheck(np); localStorage.setItem(LS.pinCheck, JSON.stringify(newCheck));
      if(unlockedPassword){ await saveEncryptedCore(np); unlockedPassword=np; }
      closePINModal(); alert(lang==="en"?"PIN changed.":"PIN cambiado.");
    }
  });

  async function recordFailedAttempt(){
    failedAttempts = Number(localStorage.getItem(LS.failed)||0)+1;
    localStorage.setItem(LS.failed, String(failedAttempts));
    const limit = Number(localStorage.getItem(LS.autoWipe)||0);
    if(limit>0 && failedAttempts>=limit){
      clearAllLocal(); alert(lang==="en"?"Local data wiped (auto-wipe).":"Datos locales borrados (auto-borrado)."); lockToDecoy();
    }
  }

  // Hash unlock
  function hashUnlock(){ if(location.hash==="#unlock") openPINModal("enter"); }
  window.addEventListener("hashchange", hashUnlock); hashUnlock();

  /* ===== Disclaimer overlay ===== */
  function showDisclaimerIfNeeded(){
    if(localStorage.getItem(LS.disclaimer)==="1") return;
    $("firstRunDisc").classList.remove("hidden-soft"); document.body.style.overflow="hidden";
  }
  function acceptDisclaimer(){ localStorage.setItem(LS.disclaimer,"1"); hideDisclaimer(); }
  function hideDisclaimer(){ $("firstRunDisc").classList.add("hidden-soft"); document.body.style.overflow="auto"; }
  $("acceptDisclaimer").onclick = acceptDisclaimer;

  /* ===== Tabs & app state ===== */
  function showRealApp(){ $("decoyView").classList.add("hidden-soft"); $("realApp").classList.remove("hidden-soft"); setTab('home'); showDisclaimerIfNeeded(); }
  function lockToDecoy(){ unlocked=false; unlockedPassword=null; $("realApp").classList.add("hidden-soft"); $("decoyView").classList.remove("hidden-soft"); setTab('home'); }
  $("lockBtn").onclick = lockToDecoy;
  $("quickExitBtn").onclick = ()=> location.href="https://www.google.com/";

  function setTab(name){
    const ids={home:"tab-home",checkin:"tab-checkin",plan:"tab-plan",resources:"tab-resources",profile:"tab-profile"};
    Object.values(ids).forEach(id=> $(id).classList.add("hidden-soft"));
    $(ids[name]).classList.remove("hidden-soft");
    // bottom bar active
    ["bHome","bCheck","bPlan","bRes","bProf"].forEach(k=>{ const el=$(k); if(el) el.classList.toggle("active", (
      (k==="bHome" && name==="home")||(k==="bCheck"&&name==="checkin")||(k==="bPlan"&&name==="plan")||(k==="bRes"&&name==="resources")||(k==="bProf"&&name==="profile")
    )); });
  }

  // Bottom bar bindings
  $("bHome")?.addEventListener("click", ()=> setTab('home'));
  $("bCheck")?.addEventListener("click", ()=> setTab('checkin'));
  $("bPlan")?.addEventListener("click", ()=> setTab('plan'));
  $("bRes")?.addEventListener("click", ()=> setTab('resources'));
  $("bProf")?.addEventListener("click", ()=> setTab('profile'));
  $("goToCheckIn").addEventListener("click", ()=> setTab('checkin'));

  // Language
  let lang = localStorage.getItem(LS.lang)||"en";
  function setLangText(){
    $("langToggle").textContent = (lang==="en"?"EN | ES":"ES | EN");
    $("hdrSub").textContent = (lang==="en"?"Clock":"Reloj");
    $("quickExitBtn").textContent = (lang==="en"?"Home":"Inicio");
    $("signedAsLbl").textContent = (lang==="en"?"Signed in as":"Has iniciado como");
    $("trustLbl").textContent = (lang==="en"?"Trust":"Confianza");
    $("homeTitle").textContent = (lang==="en"?"Welcome":"Bienvenida/o");
    $("homeHi").textContent = (lang==="en"?"Hi":"Hola");
    $("homeTrustCopy").textContent = (lang==="en"?"Your trust score is":"Tu nivel de confianza es");
    $("checkTitle").textContent = (lang==="en"?"Safety Check-In":"Revisión de seguridad");
    $("riskLbl").textContent = (lang==="en"?"Risk":"Riesgo");
    $("trustPctLbl").textContent = (lang==="en"?"Trust":"Confianza");
    $("demoLoadBtn").textContent = (lang==="en"?"Load Demo Answers":"Cargar respuestas de demo");
    $("talkBtn").textContent = (lang==="en"?"Talk to the App":"Hablar con la app");
    $("planTitle").textContent = (lang==="en"?"Safety Plans":"Planes de seguridad");
    $("btnNewPlan").textContent = (lang==="en"?"New Plan":"Nuevo plan");
    $("btnTemplates").textContent = (lang==="en"?"Templates":"Plantillas");
    $("btnQuickGenerate").textContent = (lang==="en"?"Quick Generate":"Generar rápido");
    $("resTitle").textContent = (lang==="en"?"My Resources":"Mis recursos");
    $("profileTitle").textContent = (lang==="en"?"Profile & Security":"Perfil y seguridad");
    $("displayNameLbl").textContent = (lang==="en"?"Display Name":"Nombre a mostrar");
    $("securityTitle").textContent = (lang==="en"?"Security":"Seguridad");
    $("changePinLbl").textContent = (lang==="en"?"Change PIN":"Cambiar PIN");
    $("duressPinLbl").textContent = (lang==="en"?"Set Duress PIN":"Establecer PIN de coacción");
    $("autoWipeLbl").textContent = (lang==="en"?"Auto-wipe after failed attempts":"Borrado automático tras intentos fallidos");
    $("shakeLbl").textContent = (lang==="en"?"Shake-to-lock":"Agitar para bloquear");
    $("discTitle").textContent = (lang==="en"?"Important Safety Notice":"Aviso de seguridad importante");
    $("discBody").innerHTML = (lang==="en"
      ?"This tool helps with planning and private check-ins. It is <strong>not</strong> a guarantee of safety or emergency response. If you are in immediate danger, call local emergency services. Use duress PIN and auto-wipe with caution. No system is 100% secure."
      :"Esta herramienta ayuda con planes y revisiones privadas. <strong>No</strong> garantiza seguridad ni respuesta de emergencia. Si hay peligro inmediato, llama a emergencias. Usa el PIN de coacción y el borrado automático con cuidado. Ningún sistema es 100% seguro.");
    $("acceptDisclaimer").textContent = (lang==="en"?"I Understand":"Entiendo");
    $("verFoot").textContent = APP_VER;
  }
  $("langToggle").onclick = ()=>{ lang=(lang==="en"?"es":"en"); localStorage.setItem(LS.lang,lang); setLangText(); buildQuestions(); renderResources(); renderPlans(); renderFeedback(true); };

  // Questions + feedback
  const QUESTIONS_EN=[
    "Are you currently safe where you are?",
    "Has someone threatened you recently?",
    "Have you experienced physical harm in past month?",
    "Are you worried about your partner’s access to your phone?",
    "Is anyone preventing you from leaving?",
    "Do you have children at risk?",
    "Do you feel isolated from help?",
    "Would you like immediate local resources?"
  ];
  const QUESTIONS_ES=[
    "¿Estás segura/o donde estás ahora?",
    "¿Alguien te ha amenazado recientemente?",
    "¿Has sufrido daño físico en el último mes?",
    "¿Te preocupa que tu pareja tenga acceso a tu teléfono?",
    "¿Alguien te impide salir?",
    "¿Tienes hijas/os en riesgo?",
    "¿Te sientes aislada/o de la ayuda?",
    "¿Quieres recursos locales de inmediato?"
  ];
  const QUESTIONS = [
    {id:"q1", invert:true},
    {id:"q2"},
    {id:"q3"},
    {id:"q4"},
    {id:"q5"},
    {id:"q6"},
    {id:"q7"},
    {id:"q8"}
  ];

  const FEEDBACK = {
    en:{ green:{title:"Small concerns — you’re doing okay", body:"Low immediate risk. Stay connected and keep your plan ready."},
         yellow:{title:"Some concerns — consider extra steps", body:"Warning signs present. Update your plan and tell a trusted person."},
         red:{title:"High risk — prioritize safety now", body:"If in immediate danger, call emergency services. Consider sharing a summary with someone you trust."} },
    es:{ green:{title:"Pocas preocupaciones — vas bien", body:"Riesgo bajo. Mantén conexiones y tu plan listo."},
         yellow:{title:"Algunas preocupaciones — toma pasos extra", body:"Hay señales de alerta. Actualiza tu plan y habla con alguien de confianza."},
         red:{title:"Alto riesgo — prioriza tu seguridad", body:"Si hay peligro inmediato, llama a emergencias. Considera compartir un resumen con alguien de confianza."} }
  };

  const Q_PROMPTS = {
    en:{
      q1_yes:"Good — keep exits clear and identify a safe place.",
      q1_no:"You may be at immediate risk. Move to a public place or contact a trusted person.",
      q2_yes:"Threats increase risk. Record details safely.",
      q2_no:"Positive — continue to monitor.",
      q3_yes:"Seek medical care and document injuries if safe.",
      q3_no:"Keep prevention steps in your plan.",
      q4_yes:"If your phone can be checked, avoid sensitive content and use quick-wipe.",
      q4_no:"Maintain locks and privacy settings.",
      q5_yes:"Plan discreet exits and ask trusted helpers.",
      q5_no:"Keep plans ready if things change.",
      q6_yes:"Include children: meeting points and caregivers.",
      q6_no:"Focus on your own plan; keep essentials ready.",
      q7_yes:"Reach out to one trusted person or local group today.",
      q7_no:"Maintain those connections.",
      q8_yes:"Use Resources; copy numbers if call logs worry you.",
      q8_no:"Resources remain available when you want them."
    },
    es:{
      q1_yes:"Bien — mantén salidas libres e identifica un lugar seguro.",
      q1_no:"Podrías estar en riesgo inmediato. Ve a un lugar público o contacta a alguien de confianza.",
      q2_yes:"Las amenazas aumentan el riesgo. Registra detalles de forma segura.",
      q2_no:"Señal positiva — sigue observando.",
      q3_yes:"Busca atención médica y documenta lesiones si es seguro.",
      q3_no:"Mantén medidas de prevención.",
      q4_yes:"Si pueden revisar tu teléfono, evita contenido sensible y usa borrado rápido.",
      q4_no:"Mantén bloqueos y privacidad.",
      q5_yes:"Planifica salidas discretas y pide ayuda.",
      q5_no:"Ten planes listos por si cambia algo.",
      q6_yes:"Incluye a niñas/os: puntos de encuentro y cuidadores.",
      q6_no:"Enfócate en tu plan; ten lo esencial listo.",
      q7_yes:"Contacta hoy a una persona o grupo local.",
      q7_no:"Mantén esas conexiones.",
      q8_yes:"Usa Recursos; copia números si te preocupan historiales.",
      q8_no:"Los recursos estarán disponibles cuando los necesites."
    }
  };

  function buildQuestions(){
    const box=$("questions"); box.innerHTML="";
    QUESTIONS.forEach((q,i)=>{
      const row=document.createElement("div"); row.className="card";
      const label=document.createElement("div"); label.className="font-semibold small mb-2";
      label.textContent=`${i+1}. ${(lang==="en"?QUESTIONS_EN:QUESTIONS_ES)[i]}`;
      const wrap=document.createElement("div"); wrap.className="flex gap-2";
      const yes=document.createElement("button"); yes.className="btn btn-ghost flex-1"; yes.textContent=(lang==="en"?"Yes":"Sí");
      const no=document.createElement("button");  no.className="btn btn-ghost flex-1";  no.textContent=(lang==="en"?"No":"No");
      yes.onclick=()=>{ core.answers[q.id]="yes"; mark(); updateScoresAndFeedback(); saveCoreEncryptedIfUnlocked(); };
      no.onclick =()=>{ core.answers[q.id]="no";  mark(); updateScoresAndFeedback(); saveCoreEncryptedIfUnlocked(); };
      function mark(){
        yes.classList.toggle("bg-green-600", core.answers[q.id]==="yes"); yes.classList.toggle("text-white", core.answers[q.id]==="yes");
        no.classList.toggle("bg-rose-600", core.answers[q.id]==="no");    no.classList.toggle("text-white", core.answers[q.id]==="no");
      }
      if(core.answers[q.id]) mark();
      row.append(label); wrap.append(yes,no); row.append(wrap); box.append(row);
    });
  }

  function computeRiskTrust(){
    let risky=0;
    QUESTIONS.forEach((q,idx)=>{
      const a=(core.answers[q.id]||"").toLowerCase(); if(!a) return;
      if(q.invert){ if(a==="no") risky++; } else { if(a==="yes") risky++; }
    });
    const risk=Math.round((risky/QUESTIONS.length)*100); const trust=100-risk;
    return {risk, trust};
  }

  function updateScoresAndFeedback(){
    const {risk, trust}=computeRiskTrust();
    $("riskPct").textContent=`${risk}%`;
    $("trustPct").textContent=`${trust}%`;
    $("trustBadge").textContent=`${trust}%`;
    core.profile.trust=trust;
    saveCoreLocals();
    renderFeedback();
  }

  function renderFeedback(force){
    const fb=$("checkFeedback");
    if(force) fb.innerHTML="";
    const { risk } = computeRiskTrust();
    let tier="green"; if(risk>=66) tier="red"; else if(risk>=26) tier="yellow";
    const f=FEEDBACK[lang][tier];
    const wrap=document.createElement("div"); wrap.className="card";
    const title=document.createElement("div"); title.className="font-semibold"; title.textContent=f.title;
    const body=document.createElement("div"); body.className="small mt-2"; body.textContent=f.body;
    wrap.append(title,body);

    const actions=document.createElement("div"); actions.className="mt-3 flex gap-2";
    const copyHotline=document.createElement("button"); copyHotline.className="btn btn-ghost"; copyHotline.textContent=(lang==="en"?"Copy local hotline":"Copiar línea local");
    copyHotline.onclick=()=>{ navigator.clipboard?.writeText("1-800-799-7233"); alert((lang==="en"?"Number copied: ":"Número copiado: ")+"1-800-799-7233"); };
    const quickPlanBtn=document.createElement("button"); quickPlanBtn.className="btn btn-primary"; quickPlanBtn.textContent=(lang==="en"?"Create quick plan":"Crear plan rápido");
    quickPlanBtn.onclick=createQuickPlanFromAnswers;
    if(tier==="green"){ actions.append(copyHotline); } else { actions.append(quickPlanBtn, copyHotline); }
    wrap.append(actions); fb.prepend(wrap);

    // Micro-prompts by answer
    QUESTIONS.forEach((q,idx)=>{
      const a=core.answers[q.id]; if(!a) return;
      const row=document.createElement("div"); row.className="p-2 card mt-2";
      const qEl=document.createElement("div"); qEl.className="font-semibold small"; qEl.textContent=(lang==="en"?QUESTIONS_EN:QUESTIONS_ES)[idx];
      const pEl=document.createElement("div"); pEl.className="small mt-1";
      const key=`${q.id}_${a==="yes"?"yes":"no"}`; pEl.textContent=Q_PROMPTS[lang][key]||"";
      row.append(qEl,pEl); fb.append(row);
    });
  }

  $("demoLoadBtn").onclick = ()=>{ core.answers={ q1:"no", q2:"yes", q3:"no", q4:"yes", q5:"no", q6:"no", q7:"yes", q8:"yes" }; buildQuestions(); updateScoresAndFeedback(); setTab('checkin'); };
  $("saveCheckIn").onclick = async ()=>{
    await saveCoreEncryptedIfUnlocked();
    try{ if(window.saveCheckinToFirestore) await window.saveCheckinToFirestore({answers:core.answers, profile:core.profile}); }catch(e){}
    alert(lang==="en"?"Check-in saved.":"Revisión guardada.");
  };
  $("clearCheckIn").onclick = ()=>{ core.answers={}; buildQuestions(); updateScoresAndFeedback(); };

  // Talk to the app (rule-based supportive tips)
  $("talkBtn").onclick = ()=>{
    const box=$("checkFeedback"); const card=document.createElement("div"); card.className="card mt-2";
    const h=document.createElement("div"); h.className="font-semibold"; h.textContent=(lang==="en"?"Quick suggestions":"Sugerencias rápidas");
    const a=core.answers||{}; const lines=[];
    if(a.q1==="no") lines.push(lang==="en"?"You might not be safe now. Move to a public place or contact someone you trust.":"Podrías no estar segura/o ahora. Ve a un lugar público o contacta a alguien de confianza.");
    if(a.q2==="yes") lines.push(lang==="en"?"Threats raise risk. Note dates/times privately.":"Las amenazas elevan el riesgo. Anota fechas/horas en privado.");
    if(a.q4==="yes") lines.push(lang==="en"?"Phone privacy: avoid sensitive content; use quick wipe if needed.":"Privacidad del teléfono: evita contenido sensible; usa borrado rápido si es necesario.");
    if(a.q7==="yes") lines.push(lang==="en"?"Message one trusted person today.":"Escribe hoy a una persona de confianza.");
    if(a.q8==="yes") lines.push(lang==="en"?"Open Resources; copy numbers if call logs worry you.":"Abre Recursos; copia números si te preocupan los historiales.");
    if(lines.length===0) lines.push(lang==="en"?"Low immediate risk suggested. Keep your plan updated.":"Riesgo inmediato bajo. Mantén tu plan actualizado.");
    const p=document.createElement("div"); p.className="small mt-2"; p.innerHTML=lines.map(l=>"• "+l).join("<br>");
    card.append(h,p); box.prepend(card);
  };

  // Plans
  function renderPlans(){
    const list=$("planList"); list.innerHTML="";
    (core.plans||[]).forEach((p,i)=>{
      const el=document.createElement("div"); el.className="p-3 card flex items-center justify-between gap-2";
      const txt=document.createElement("div"); txt.innerHTML=`<div class="font-semibold">${p.title||"Plan"}</div><div class="small">${p.summary||""}</div>`;
      const actions=document.createElement("div");
      const open=document.createElement("button"); open.className="btn btn-ghost"; open.textContent=(lang==="en"?"Open":"Abrir");
      open.onclick=()=>{ const t=prompt(lang==="en"?"Title:":"Título:", p.title||""); if(t===null) return; const s=prompt(lang==="en"?"Summary:":"Resumen:", p.summary||""); core.plans[i]={...p,title:t,summary:s}; saveCoreEncryptedIfUnlocked(); renderPlans(); };
      const del=document.createElement("button"); del.className="btn btn-ghost"; del.textContent=(lang==="en"?"Delete":"Eliminar");
      del.onclick=()=>{ core.plans.splice(i,1); saveCoreEncryptedIfUnlocked(); renderPlans(); };
      actions.append(open,del); el.append(txt,actions); list.appendChild(el);
    });
  }
  function addPlan(title, summary){ core.plans=core.plans||[]; core.plans.push({ id:"plan_"+Date.now(), title, summary, items:{} }); saveCoreEncryptedIfUnlocked(); renderPlans(); }
  $("btnNewPlan").onclick = ()=>{ const t=prompt(lang==="en"?"Plan title:":"Título del plan:"); if(!t) return; const s=prompt(lang==="en"?"Short summary:":"Resumen corto:")||""; addPlan(t,s); alert(lang==="en"?"Plan created.":"Plan creado."); };
  $("btnTemplates").onclick = ()=>{
    const templates=[
      {title:(lang==="en"?"Grab-and-Go Bag":"Bolsa de emergencia"), summary:(lang==="en"?"List items & hidden spot":"Lista de artículos y lugar oculto")},
      {title:(lang==="en"?"Trusted Contacts":"Contactos de confianza"), summary:(lang==="en"?"Names & numbers":"Nombres y teléfonos")},
      {title:(lang==="en"?"Safe Exit Plan":"Salida segura"), summary:(lang==="en"?"Safe place & transport":"Lugar seguro y transporte")}
    ];
    const pick=prompt((lang==="en"?"Templates:\n":"Plantillas:\n")+templates.map((t,i)=>`${i+1}. ${t.title}`).join("\n")+"\n"+(lang==="en"?"Number:":"Número:"));
    const n=Number(pick); if(n>=1 && n<=templates.length){ const tpl=templates[n-1]; addPlan(tpl.title, tpl.summary); alert(lang==="en"?"Template added.":"Plantilla añadida."); }
  };
  function createQuickPlanFromAnswers(){
    const a=core.answers||{}; const parts=[];
    if(a.q1==="no") parts.push(lang==="en"?"Safe site: public place or trusted home.":"Sitio seguro: lugar público o casa de confianza.");
    if(a.q2==="yes") parts.push(lang==="en"?"Record threats privately (date/time).":"Registra amenazas en privado (fecha/hora).");
    if(a.q4==="yes") parts.push(lang==="en"?"Avoid sensitive content; consider quick-wipe.":"Evita contenido sensible; considera borrado rápido.");
    if(parts.length===0) parts.push(lang==="en"?"Keep exits clear and contacts ready.":"Mantén salidas despejadas y contactos listos.");
    addPlan(lang==="en"?"Quick Plan":"Plan Rápido", parts.join(" "));
  }
  $("btnQuickGenerate").onclick = ()=>{ createQuickPlanFromAnswers(); alert(lang==="en"?"Quick plan created.":"Plan rápido creado."); };

  // Resources
  function renderResources(){
    const list=$("resourceList"); list.innerHTML="";
    (core.resources||[]).forEach((r,i)=>{
      const li=document.createElement("li"); li.className="p-3 card flex items-start justify-between gap-3";
      const txt=document.createElement("div");
      const t=document.createElement("div"); t.className="font-semibold"; t.textContent=r.title||"Untitled";
      const d=document.createElement("div"); d.className="small text-gray-300"; d.textContent=r.desc||"";
      const u=document.createElement("a"); u.className="text-blue-400 underline small"; u.href=(r.url && r.url.startsWith("http"))?r.url:"#"; u.target="_blank"; u.rel="noreferrer"; u.textContent=r.url||"";
      txt.append(t); if(r.desc) txt.append(d); if(r.url) txt.append(u);
      const del=document.createElement("button"); del.className="btn btn-ghost"; del.textContent=(lang==="en"?"Delete":"Eliminar");
      del.onclick=()=>{ core.resources.splice(i,1); saveCoreEncryptedIfUnlocked(); renderResources(); };
      li.append(txt,del); list.appendChild(li);
    });
  }
  $("btnAddResource").onclick = (e)=>{ e.preventDefault(); const it={ title:$("resTitleInput").value.trim(), desc:$("resDesc").value.trim(), url:$("resUrl").value.trim() }; if(!it.title){ alert(lang==="en"?"Title required":"Título requerido"); return; } core.resources=core.resources||[]; core.resources.push(it); saveCoreEncryptedIfUnlocked(); renderResources(); $("resTitleInput").value=$("resDesc").value=$("resUrl").value=""; };
  $("btnCopyHotline").onclick = ()=>{ navigator.clipboard?.writeText("1-800-799-7233"); alert((lang==="en"?"Copied: ":"Copiado: ")+"1-800-799-7233"); };

  // Save/Export/Import
  async function saveCoreEncryptedIfUnlocked(){ if(!unlocked || !unlockedPassword){ saveCoreLocals(); return; } await saveEncryptedCore(unlockedPassword); saveCoreLocals(); try{ if(window.saveProfileMirror) saveProfileMirror(core.profile); }catch(e){} }
  function saveCoreLocals(){ localStorage.setItem(LS.profile, JSON.stringify(core.profile||{})); localStorage.setItem(LS.answers, JSON.stringify(core.answers||{})); localStorage.setItem(LS.resources, JSON.stringify(core.resources||[])); localStorage.setItem(LS.plans, JSON.stringify(core.plans||[])); }
  $("saveAll").onclick = ()=> saveCoreEncryptedIfUnlocked().then(()=> alert(lang==="en"?"Saved.":"Guardado."));

  $("saveProfile").onclick = ()=>{ core.profile.name=$("displayNameInput").value.trim()||"Anonymous"; saveCoreEncryptedIfUnlocked(); refreshUI(); alert(lang==="en"?"Profile saved.":"Perfil guardado."); };
  $("profileChangePinBtn").onclick = async ()=>{ const np=$("profileChangePin").value.trim(); if(!np || np.length<4){ alert(lang==="en"?"PIN must be at least 4 digits.":"El PIN debe tener al menos 4 dígitos."); return; } const chk=await createPinCheck(np); localStorage.setItem(LS.pinCheck, JSON.stringify(chk)); if(unlockedPassword){ await saveEncryptedCore(np); unlockedPassword=np; } $("profileChangePin").value=""; alert(lang==="en"?"PIN changed.":"PIN cambiado."); };
  $("profileSetDuress").onclick = async ()=>{ const dp=$("profileDuressPin").value.trim(); if(!dp){ alert(lang==="en"?"Enter duress PIN.":"Introduce PIN de coacción."); return; } const chk=await createPinCheck(dp); localStorage.setItem(LS.duressCheck, JSON.stringify(chk)); $("profileDuressPin").value=""; alert(lang==="en"?"Duress PIN set.":"PIN de coacción establecido."); };
  $("autoWipeSelect").onchange = ()=> localStorage.setItem(LS.autoWipe, $("autoWipeSelect").value);

  $("exportJson").onclick = async ()=>{
    if(!unlockedPassword){ alert(lang==="en"?"Unlock to export securely.":"Desbloquea para exportar."); return; }
    const pass=prompt(lang==="en"?"Enter export passphrase:":"Introduce contraseña para exportar:"); if(!pass) return;
    const snapshot={ profile:core.profile, answers:core.answers, resources:core.resources, plans:core.plans, version:APP_VER };
    const blob=await encryptWithPassword(snapshot, pass);
    const file=new Blob([JSON.stringify(blob)],{type:"application/json"}); const url=URL.createObjectURL(file);
    const a=document.createElement("a"); a.href=url; a.download="timeout-export.json"; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},800);
  };
  $("importJsonBtn").onclick = async ()=>{
    const f=$("importJsonFile").files[0]; if(!f){ alert(lang==="en"?"Select a file first.":"Selecciona un archivo primero."); return; }
    const txt=await f.text(); try{
      const blob=JSON.parse(txt); const pass=prompt(lang==="en"?"Enter import passphrase:":"Introduce la contraseña para importar:"); if(!pass) return;
      const data=await decryptWithPassword(blob, pass); const replace=confirm(lang==="en"?"Replace local data? Cancel = merge.":"¿Reemplazar datos locales? Cancelar = fusionar.");
      if(replace) core=data; else { core=Object.assign(core,data); core.resources=[...(core.resources||[]),...(data.resources||[])]; core.plans=[...(core.plans||[]),...(data.plans||[])]; }
      saveCoreEncryptedIfUnlocked(); buildQuestions(); renderResources(); renderPlans(); updateScoresAndFeedback(); alert(lang==="en"?"Import successful.":"Importación exitosa.");
    }catch(e){ alert(lang==="en"?"Import failed or wrong passphrase.":"Falló la importación o contraseña incorrecta."); }
  };

  function clearAllLocal(){
    [LS.enc,LS.pinCheck,LS.duressCheck,LS.profile,LS.answers,LS.resources,LS.plans,LS.disclaimer,LS.autoWipe,LS.failed].forEach(k=> localStorage.removeItem(k));
    core={ profile:{name:"Anonymous",trust:100}, answers:{}, resources:[], plans:[], settings:{} };
    unlocked=false; unlockedPassword=null;
  }
  $("clearData").onclick = ()=>{ if(confirm(lang==="en"?"Clear ALL local data?":"¿Borrar TODOS los datos locales?")){ clearAllLocal(); lockToDecoy(); alert(lang==="en"?"Local data cleared.":"Datos locales borrados."); } };

  // Visibility auto-lock
  document.addEventListener("visibilitychange", ()=>{ if(document.hidden && unlocked) lockToDecoy(); });

  // Shake to lock
  if(window.DeviceMotionEvent){
    window.addEventListener("devicemotion", (e)=>{
      if(!($("toggleShake")?.checked)) return;
      const a=e.accelerationIncludingGravity; if(!a) return;
      const s=Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z);
      if(s>30){ const now=Date.now(); if(!window.__lastShake || now-window.__lastShake>1500){ window.__lastShake=now; lockToDecoy(); } }
    });
  }

  function refreshUI(){
    $("profileName").textContent=core.profile.name||"Anonymous";
    $("homeName").textContent=core.profile.name||"Anonymous";
    $("homeTrust").textContent=core.profile.trust||100;
    $("displayNameInput").value=core.profile.name||"";
    buildQuestions(); renderResources(); renderPlans(); updateScoresAndFeedback();
  }

  // Bottom bar HTML (kept here to ensure exists)
  (function ensureBottomBar(){
    if(document.getElementById("bottomNav")) return;
    const wrap=document.createElement("div");
    wrap.id="bottomNav"; wrap.className="bottom-bar";
    wrap.innerHTML=`
      <button id="bHome" class="bottom-btn active" aria-label="Home"><div class="bottom-ico">🏠</div><div>Home</div></button>
      <button id="bCheck" class="bottom-btn" aria-label="Check-In"><div class="bottom-ico">✅</div><div>Check-In</div></button>
      <button id="bPlan"  class="bottom-btn" aria-label="Plan"><div class="bottom-ico">📝</div><div>Plan</div></button>
      <button id="bRes"   class="bottom-btn" aria-label="Resources"><div class="bottom-ico">📚</div><div>Resources</div></button>
      <button id="bProf"  class="bottom-btn" aria-label="Profile"><div class="bottom-ico">👤</div><div>Profile</div></button>`;
    document.body.appendChild(wrap);
    $("bHome").onclick=()=>setTab('home'); $("bCheck").onclick=()=>setTab('checkin'); $("bPlan").onclick=()=>setTab('plan'); $("bRes").onclick=()=>setTab('resources'); $("bProf").onclick=()=>setTab('profile');
  })();

  // Theme toggle via long-press version pill
  (function themeInit(){
    const pill=$("versionPill"); const on=localStorage.getItem(LS.theme)==="1"; if(on) document.body.classList.add("theme-dim");
    let t; function togg(){ const now=document.body.classList.toggle("theme-dim"); localStorage.setItem(LS.theme, now?"1":"0"); }
    if(pill){
      pill.addEventListener("mousedown", ()=>{ t=setTimeout(togg,900); });
      ["mouseup","mouseleave"].forEach(ev=> pill.addEventListener(ev, ()=> clearTimeout(t)));
      pill.addEventListener("touchstart", ()=>{ t=setTimeout(togg,900); }, {passive:true});
      pill.addEventListener("touchend", ()=> clearTimeout(t));
      pill.addEventListener("touchcancel", ()=> clearTimeout(t));
    }
  })();

  // Boot
  (function boot(){
    try{ core.profile = JSON.parse(localStorage.getItem(LS.profile)) || core.profile; }catch{}
    try{ core.answers = JSON.parse(localStorage.getItem(LS.answers)) || core.answers; }catch{}
    try{ core.resources = JSON.parse(localStorage.getItem(LS.resources)) || core.resources; }catch{}
    try{ core.plans = JSON.parse(localStorage.getItem(LS.plans)) || core.plans; }catch{}
    lang = localStorage.getItem(LS.lang)||lang; setLangText();
    const meta = JSON.parse(localStorage.getItem(LS.meta)||"{}"); if(meta.skin) setSkin(meta.skin);
  })();
  </script><!-- LIGHT PALETTE PATCH: sand + sage, force light theme -->
<style>
  :root{
    --bg: #f7f3ea;      /* sand */
    --card: #ffffff;    /* white cards */
    --ink: #0f172a;     /* dark text */
    --sub: #48556b;     /* subtext */
    --line: #e6e4de;    /* light borders */
    --sage: #16a34a;    /* primary sage green */
    --sage-ink: #ffffff;
    --sage-soft: #e8f7ee;
    --btn-ghost-ink:#0f172a;
  }
  body{ background:var(--bg)!important; color:var(--ink)!important; }
  .container{ padding-bottom:88px; } /* keep bottom bar clear in real app */

  /* Cards, inputs */
  .card{ background:var(--card)!important; border:1px solid var(--line)!important; color:var(--ink)!important; }
  input.card, textarea.card, select.card{ background:#fff!important; border:1px solid var(--line)!important; color:var(--ink)!important; }

  /* Buttons */
  .btn-primary{ background:var(--sage)!important; color:var(--sage-ink)!important; border:0!important; }
  .btn-ghost{ background:#fff!important; color:var(--btn-ghost-ink)!important; border:1px solid var(--line)!important; }

  /* Pills, small text */
  .pill{ background:#fff!important; color:var(--sub)!important; border:1px solid var(--line)!important; }
  .small{ color:var(--sub)!important; }

  /* Tabs */
  .tab-btn{ background:#fff!important; border:1px solid var(--line)!important; color:var(--ink)!important; }
  .tab-btn.active{ background:var(--sage)!important; color:#fff!important; border-color:var(--sage)!important; }

  /* Bottom bar (only visible in real app) */
  #bottomNav{
    background:#ffffff!important; border-top:1px solid var(--line)!important;
  }
  #bottomNav .bottom-btn{ color:#334155!important; border-color:transparent!important; }
  #bottomNav .bottom-btn.active{ background:var(--sage)!important; color:#fff!important; border-color:var(--sage)!important; }

  /* Decoy digits & separators (clock) */
  .digit{
    background:#fff!important; color:#0f172a!important;
    border:1px solid var(--line)!important; text-shadow:none!important;
  }
  .sep{ color:#2f855a!important; text-shadow:none!important; }

  /* Overlays */
  .overlay{ background:rgba(0,0,0,.35)!important; }
  .overlay .panel.card{ box-shadow:0 10px 30px rgba(0,0,0,.08); }

  /* Weather tile demo */
  #skinWeather .card{ background:linear-gradient(180deg,#fff,#f1fbf5)!important; }

  /* Misc accents on feedback */
  #riskPct{ color:#dc2626!important; }
  #trustPct, #trustBadge{ color:#15803d!important; }
</style>

<script>
/* Force LIGHT mode (disable stored dim/dark), tidy decoy/bottom bar */
(function(){
  try{
    // Kill any saved dim/dark choice and ensure light
    localStorage.setItem('timeout_theme_dim','0');
    document.body.classList.remove('theme-dim');
  }catch(e){}

  // Ensure bottom bar hidden on decoy (keep real app clean)
  function updateBottomBarVisibility(){
    const decoy = document.getElementById('decoyView');
    const bar   = document.getElementById('bottomNav');
    if(!bar || !decoy) return;
    const onDecoy = !decoy.classList.contains('hidden-soft');
    bar.style.display = onDecoy ? 'none' : 'flex';
  }
  // Wrap existing functions if present
  const _showRealApp = window.showRealApp;
  const _lockToDecoy = window.lockToDecoy;
  const _setTab      = window.setTab;

  if(_showRealApp) window.showRealApp = function(){ _showRealApp(); updateBottomBarVisibility(); };
  if(_lockToDecoy) window.lockToDecoy = function(){ _lockToDecoy(); updateBottomBarVisibility(); };
  if(_setTab) window.setTab = function(name){ _setTab(name); updateBottomBarVisibility(); };

  // Initial call
  updateBottomBarVisibility();

  // Optional: rename header sublabel from "Clock" to something neutral/light
  const sub = document.getElementById('hdrSub');
  if(sub) sub.textContent = (localStorage.getItem('timeout_lang')==='es'?'Reloj':'Clock');

  // Slightly soften the decoy hint text
  const hint = document.querySelector('#skinClock + p, #skinClock .small, #decoyView .small');
  if(hint) hint.style.color = '#64748b';
})();
</script><!-- PATCH: #ask quick-open + scrollable tab panels (no clutter) -->
<style>
  /* Give each app tab its own tall, scrollable panel */
  .panel-scroll{
    /* Header (~68) + margins + bottom bar (64) + buffer */
    max-height: calc(100vh - 160px);
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
  }
  /* Ensure decoy never gets covered */
  #decoyView{ padding-bottom: 20px !important; }
</style>
<script>
(function(){
  if(window.__timeout_layout_hashask) return;
  window.__timeout_layout_hashask = true;

  /* 1) Mark tabs as scrollable panels (roomier on phones) */
  function applyScrollablePanels(){
    ["tab-home","tab-checkin","tab-plan","tab-resources","tab-profile"].forEach(id=>{
      const el = document.getElementById(id);
      if(el && !el.classList.contains('panel-scroll')) el.classList.add('panel-scroll');
    });
  }
  applyScrollablePanels();

  /* Also re-apply after any rebuilds */
  const _setTab = window.setTab;
  window.setTab = function(name){
    if(_setTab) _setTab(name);
    applyScrollablePanels();
    // When you open Check-In, clear old feedback so it never “grows”
    if(name==='checkin'){
      const fb=document.getElementById('checkFeedback');
      if(fb) fb.innerHTML='';
    }
  };

  /* 2) Quick-open Ask modal via URL hash (#ask) */
  function openAskIfHash(){
    if(location.hash === '#ask'){
      if(typeof window.openAiChat === 'function'){
        window.openAiChat();
      } else {
        // fallback: if modal exists, show it
        const m = document.getElementById('askModal');
        if(m){ m.classList.remove('hidden-soft'); document.body.style.overflow='hidden'; }
      }
    }
  }
  window.addEventListener('hashchange', openAskIfHash);
  openAskIfHash();

  /* 3) Make sure Ask FAB only shows inside the real app (not on decoy) */
  const _showRealApp = window.showRealApp;
  const _lockToDecoy = window.lockToDecoy;
  window.showRealApp = function(){ if(_showRealApp) _showRealApp(); const f=document.getElementById('askFab'); if(f) f.classList.remove('hidden-soft'); };
  window.lockToDecoy = function(){ if(_lockToDecoy) _lockToDecoy(); const f=document.getElementById('askFab'); if(f) f.classList.add('hidden-soft'); };

  /* 4) One more guard: prevent duplicate Quick Plan */
  const btnQ = document.getElementById('btnQuickGenerate');
  if(btnQ && !btnQ.__onceGuard){
    btnQ.addEventListener('click', ()=>{ btnQ.disabled=true; setTimeout(()=>btnQ.disabled=false,500); }, {capture:true});
    btnQ.__onceGuard = true;
  }
})();
</script>
</body>
</html>
