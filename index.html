<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1,viewport-fit=cover">
<title>TimeOut</title>
<style>
  :root{
    --brand:#6b8e23;      /* olive */
    --rose:#e11d48;       /* rose for accents */
    --ink:#1f2937;
    --muted:#6b7280;
    --paper:#fdfcf7;      /* light, calm */
    --card:#ffffff;
    --edge:#e5e7eb;
    --ok:#16a34a;
    --warn:#f59e0b;
    --bad:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--paper);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
  .app{max-width:480px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--edge);z-index:20}
  .bar{display:flex;align-items:center;gap:.5rem;padding:.75rem}
  .title{margin:0;font-size:1rem;font-weight:800;letter-spacing:.2px}
  .spacer{flex:1}
  .btn{appearance:none;border:1px solid var(--edge);background:#fff;color:var(--ink);padding:.5rem .75rem;border-radius:.6rem;font-weight:600;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn-ghost{border-color:transparent;background:transparent}
  .btn-danger{background:var(--bad);border-color:var(--bad);color:#fff}
  .chip{font-size:.8rem;padding:.25rem .5rem;border-radius:999px;border:1px solid var(--edge);background:#fff}
  .lang{font-size:.85rem}
  main{flex:1;overflow:auto;padding:1rem}
  .panel{display:none}
  .panel.active{display:block}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:1rem;padding:1rem}
  .stack{display:flex;flex-direction:column;gap:.75rem}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
  .row{display:flex;gap:.5rem;align-items:center;justify-content:space-between}
  .nav{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--edge);display:flex}
  .nav button{flex:1;padding:.75rem 0;font-weight:700;border:0;background:transparent;color:var(--ink)}
  .nav .on{color:var(--brand)}
  .muted{color:var(--muted)}
  .meter{display:flex;gap:.5rem;align-items:center;font-size:.9rem}
  .barline{flex:1;height:.5rem;background:#f3f4f6;border-radius:999px;overflow:hidden}
  .barfill{height:100%;background:var(--brand);width:0%}
  .hidden{display:none}

  /* decoy timer */
  .timer{font-variant-numeric:tabular-nums;letter-spacing:.5px;font-size:3rem;font-weight:900;text-align:center}
  .pill{padding:.35rem .6rem;border:1px solid var(--edge);border-radius:999px;background:#fff}

  /* yes/no */
  .yn{display:flex;gap:.5rem}
  .yn .ynbtn{flex:1}
  .selected{outline:2px solid var(--brand)}

  /* synopsis styles */
  .syn{padding:1rem;border-radius:1rem;border:1px solid #fde2e2;background:#fff7f7}
  .syn.good{border-color:#dcfce7;background:#f0fdf4}
  .syn.mid{border-color:#fef3c7;background:#fffbeb}
  .syn.bad{border-color:#ffe4e6;background:#fff1f2}

  /* small helpers */
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.85rem;border:1px solid var(--edge);padding:.1rem .35rem;border-radius:.4rem;background:#fff}
</style>
</head>
<body>
<div class="app" id="app">

  <!-- Top bar -->
  <header>
    <div class="bar">
      <button id="btnBack" class="btn btn-ghost" title="Back">←</button>
      <h1 id="appTitle" class="title">TimeOut</h1>
      <div class="spacer"></div>
      <select id="langSel" class="lang"><option value="en">EN</option><option value="es">ES</option></select>
      <button id="btnExit" class="btn btn-danger">EXIT</button>
    </div>
  </header>

  <main id="main">

    <!-- HOME (Decoy) -->
    <section id="home" class="panel active">
      <div class="stack">
        <div class="card stack">
          <div class="timer" id="clock">25:00</div>
          <div class="row">
            <span id="rounds" class="pill">Pomodoro • 1</span>
            <span class="pill" id="statusPill">Focus</span>
          </div>
          <div class="row" style="justify-content:center">
            <button class="btn" id="btnStart">Start</button>
            <button class="btn" id="btnPause">Pause</button>
            <button class="btn" id="btnReset">Reset</button>
          </div>
          <div class="muted" id="hint" style="text-align:center">
            Long-press the title to unlock. / Mantén presionado el título para desbloquear.
          </div>
        </div>

        <!-- Unlocked summary -->
        <div id="homeUnlocked" class="card stack hidden">
          <div class="row">
            <strong id="greet">Welcome, Anonymous</strong>
            <span class="chip">v1.3.5</span>
          </div>
          <div class="meter">
            <span id="riskLab">Risk</span>
            <div class="barline"><div id="riskBar" class="barfill" style="background:var(--bad)"></div></div>
            <strong id="riskNum">0%</strong>
          </div>
          <div class="meter">
            <span id="trustLab">Trust</span>
            <div class="barline"><div id="trustBar" class="barfill"></div></div>
            <strong id="trustNum">100%</strong>
          </div>
          <div class="row" style="justify-content:center">
            <button class="btn btn-primary" onclick="nav('checkin')" id="goCheck">Go to Check-In</button>
            <button class="btn" onclick="nav('plan')" id="goPlan">Safety Plan</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CHECK-IN -->
    <section id="checkin" class="panel">
      <div class="stack">
        <div class="card stack">
          <div class="row">
            <strong id="checkTitle">Check-In</strong>
            <span class="chip" id="scoreChip">Risk 0% • Trust 100%</span>
          </div>
          <p class="muted" id="checkHint">Answer each question. Buttons will highlight and guidance appears below each one.</p>
          <div id="qList" class="stack"></div>

          <div id="synWrap" class="syn hidden">
            <div id="synBody"></div>
            <div id="disc" class="muted" style="margin-top:.5rem;font-size:.85rem"></div>
          </div>

          <div class="row">
            <button class="btn" id="btnDemo">Load Demo Answers</button>
            <button class="btn btn-primary" id="btnSave">Save Check-In</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PLAN -->
    <section id="plan" class="panel">
      <div class="stack">
        <div class="card stack">
          <strong id="planTitle">Safety Plan</strong>
          <div class="grid2">
            <button class="btn" id="btnQuick">Quick Plan</button>
            <button class="btn" id="btnTemplate">Template</button>
          </div>
          <textarea id="planNote" rows="8" class="card" placeholder="Plan notes…" style="width:100%;"></textarea>
          <div class="row">
            <button class="btn btn-primary" id="btnPlanSave">Save Plan</button>
            <button class="btn" id="btnPlanClear">Clear</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RESOURCES -->
    <section id="resources" class="panel">
      <div class="stack">
        <div class="card stack">
          <strong id="resTitle">Resources</strong>
          <div id="resList" class="stack"></div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="panel">
      <div class="stack">
        <div class="card stack">
          <strong id="profTitle">Profile</strong>
          <label>
            <div class="muted" id="nameLab">Display name</div>
            <input id="nameInput" class="card" style="width:100%;padding:.6rem" placeholder="Anonymous">
          </label>
          <label>
            <div class="muted" id="pinLab">PIN (default 2580)</div>
            <input id="pinInput" class="card" style="width:100%;padding:.6rem" placeholder="2580" inputmode="numeric" maxlength="8">
          </label>
          <div class="row">
            <button class="btn btn-primary" id="btnProfSave">Save Profile</button>
            <button class="btn" id="btnWipe">Panic: Clear Data</button>
          </div>
          <div class="muted" style="font-size:.85rem">Language / Idioma: <span class="chip">EN/ES</span> — set via top-right selector.</div>
        </div>
      </div>
    </section>

  </main>

  <!-- Bottom nav -->
  <nav class="nav">
    <button id="tabHome" class="on" onclick="nav('home')">Home</button>
    <button id="tabCheck" onclick="nav('checkin')">Check-In</button>
    <button id="tabPlan" onclick="nav('plan')">Plan</button>
    <button id="tabRes" onclick="nav('resources')">Resources</button>
    <button id="tabProf" onclick="nav('profile')">Profile</button>
  </nav>

</div>

<script>
/* ================ STATE ================ */
const S = {
  pin: localStorage.getItem('timeout_pin') || '2580',
  name: localStorage.getItem('timeout_name') || 'Anonymous',
  lang: localStorage.getItem('timeout_lang') || 'en',
  unlocked: JSON.parse(localStorage.getItem('timeout_unlocked')||'false'),
  answers: JSON.parse(localStorage.getItem('timeout_answers')||'{}'),
  plan: localStorage.getItem('timeout_plan') || '',
  risk: 0, trust: 100,
  stack: ['home']
};
const $ = id => document.getElementById(id);
const tr = (en,es)=> S.lang==='es'?es:en;

/* ================ TOP BAR ================ */
$('langSel').value = S.lang;
$('langSel').addEventListener('change', e=>{
  S.lang = e.target.value; save(); applyLang();
});
$('btnExit').onclick = ()=> location.href='https://www.google.com';
$('btnBack').onclick = ()=> { if(S.stack.length>1){ S.stack.pop(); showPanel(S.stack.at(-1)); } };

/* ================ NAV ================ */
function nav(id){
  showPanel(id);
  if(S.stack.at(-1)!==id) S.stack.push(id);
}
function showPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $(id).classList.add('active');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('on'));
  ({home:'tabHome',checkin:'tabCheck',plan:'tabPlan',resources:'tabRes',profile:'tabProf'}[id]) && $( {home:'tabHome',checkin:'tabCheck',plan:'tabPlan',resources:'tabRes',profile:'tabProf'}[id] ).classList.add('on');
}

/* ================ DECOY TIMER ================ */
let t=25*60, tid=null, running=false, rounds=1;
function drawTimer(){ const m=Math.floor(t/60), s=t%60; $('clock').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
function tick(){ if(t>0){ t--; drawTimer(); } else { clearInterval(tid); running=false; rounds++; $('rounds').textContent=tr(`Pomodoro • ${rounds}`,`Pomodoro • ${rounds}`); $('statusPill').textContent=tr('Break','Descanso'); t=5*60; drawTimer(); } }
$('btnStart').onclick=()=>{ if(!running){ running=true; $('statusPill').textContent=tr('Focus','Enfoque'); tid=setInterval(tick,1000);} };
$('btnPause').onclick=()=>{ running=false; clearInterval(tid); };
$('btnReset').onclick=()=>{ running=false; clearInterval(tid); t=25*60; drawTimer(); $('statusPill').textContent=tr('Focus','Enfoque'); };
drawTimer();

/* ================ UNLOCK: long-press title ================ */
let lpTimer=null; const LP_MS=800;
$('appTitle').addEventListener('touchstart',startLP,{passive:true});
$('appTitle').addEventListener('mousedown',startLP);
;['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>{
  $('appTitle').addEventListener(ev,()=>clearTimeout(lpTimer));
});
function startLP(){ clearTimeout(lpTimer); lpTimer=setTimeout(pinPrompt,LP_MS); }
function pinPrompt(){
  const p = prompt(tr('Enter PIN to unlock','Ingresa el PIN para desbloquear'));
  if(p===null) return;
  if(p===S.pin){ S.unlocked=true; save(); afterUnlock(); }
  else { alert(tr('Incorrect PIN','PIN incorrecto')); }
}
function afterUnlock(){
  $('homeUnlocked').classList.remove('hidden');
  $('greet').textContent = tr('Welcome','Bienvenido/a')+', '+S.name;
  updateMeters();
}

/* Auto-hide sensitive when backgrounded */
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){ S.unlocked=false; save(); $('homeUnlocked').classList.add('hidden'); showPanel('home'); }
});

/* ================ CHECK-IN: 13 refined Qs, per-item feedback, single synopsis ================ */
const Q_EN = [
"Do you feel safe in your home right now?",
"Has your partner, or anyone close to you, threatened to harm you recently?",
"Have you experienced physical harm in the past month?",
"Is your phone, computer, or movement being monitored?",
"Do you have children who could be at risk in your situation?",
"Has anyone prevented you from leaving or restricted your freedom?",
"Do you feel isolated from friends, family, or community support?",
"Are finances being controlled in ways that limit your independence?",
"Do you feel pressured to have sex or do things against your will?",
"Has your partner ever harmed pets or threatened to harm them?",
"Do you believe your partner has access to weapons?",
"Have you been forced or pressured to keep abuse a secret?",
"Do you worry that leaving could make things more dangerous for you?"
];
const Q_ES = [
"¿Te sientes seguro/a en tu hogar en este momento?",
"¿Tu pareja u otra persona cercana te ha amenazado con hacerte daño recientemente?",
"¿Has sufrido daño físico en el último mes?",
"¿Se monitorea tu teléfono, computadora o tus movimientos?",
"¿Tienes hijos que podrían estar en riesgo en tu situación?",
"¿Alguien te ha impedido salir o restringido tu libertad?",
"¿Te sientes aislado/a de amigos, familia o apoyo comunitario?",
"¿Controlan tus finanzas de forma que limite tu independencia?",
"¿Sientes presión para tener relaciones sexuales o hacer cosas contra tu voluntad?",
"¿Tu pareja ha lastimado o amenazado con lastimar mascotas?",
"¿Crees que tu pareja tiene acceso a armas?",
"¿Te han obligado o presionado a mantener en secreto el abuso?",
"¿Te preocupa que irte pueda hacer la situación más peligrosa para ti?"
];
const FB_EN = {
q1:{yes:"Good to hear you feel safe right now. Safety can change quickly; stay aware of shifts. Keep simple exit options in mind.",
    no:"Feeling unsafe at home is a major warning sign. Prioritize immediate safety and identify exits/safe rooms. Consider contacting trusted people or a hotline."},
q2:{yes:"Threats are serious and can precede physical harm. Take them at face value, even if framed as jokes. Plan quick exits and safe contacts.",
    no:"Positive there were no recent threats. Watch for intimidation or control that can replace direct threats. Staying alert helps you respond quickly."},
q3:{yes:"Recent physical harm is a critical red flag. Your risk is elevated; urgent protection may be needed. If you feel unsafe, call emergency services.",
    no:"Good that no recent physical harm occurred. Abuse can be emotional, financial, or psychological. Stay mindful of non-physical warning signs."},
q4:{yes:"Monitoring your devices or movements is a strong control tactic. Use safer devices and review shared accounts. Limit sensitive content on your phone.",
    no:"No monitoring noticed is positive. Stay alert for unusual device behavior or unexpected logins and location knowledge."},
q5:{yes:"Children exposed to violence face emotional and physical risks. Include them in your plan (school, caregiver, emergency contacts). Protecting yourself helps protect them.",
    no:"Not having children at risk reduces immediate concern, but your safety remains vital. Extend planning to children if that changes."},
q6:{yes:"Being prevented from leaving is coercive control and may escalate. Identify safe exits and a code word with trusted contacts. Consider places you can go on short notice.",
    no:"Freedom of movement is protective. Stay mindful if new restrictions appear or pressures increase."},
q7:{yes:"Isolation is common in abusive situations and increases dependence. Try small steps to reconnect with supportive people. One trusted contact can improve safety.",
    no:"Staying connected is protective. Keep relationships strong; they can be critical if things change."},
q8:{yes:"Financial control can trap you in unsafe situations. Discreetly set aside resources or contact financial advocacy programs. Document restrictions if safe.",
    no:"Financial independence is protective. Safeguard accounts and stay alert for attempts to limit access."},
q9:{yes:"Sexual coercion is a serious form of abuse and violates consent. You have the right to bodily autonomy. Seek medical or advocacy support if needed.",
    no:"Not experiencing this is positive. Consent must always be freely given; recognize any future pressure as abuse."},
q10:{yes:"Harming or threatening pets is intimidation and may signal escalation. Include pets in the safety plan if possible. Consider safe shelter options for animals.",
     no:"Good to hear. Stay aware; threats to animals can emerge later as control tactics."},
q11:{yes:"Access to weapons greatly increases lethal risk. Prioritize urgent safety planning and consider contacting authorities or advocates. Trust your instincts.",
     no:"No weapons access lowers immediate risk. Stay aware of changes in access or escalation in other forms."},
q12:{yes:"Pressure to keep abuse secret is designed to isolate you. Silence increases risk and blocks support. Reaching out to trusted people is a safety step.",
     no:"Not being pressured into secrecy is positive. Be cautious of guilt, shame, or intimidation that may appear later."},
q13:{yes:"Leaving can be the most dangerous time. Plan carefully and seek advocate support to lower risk. Choose timing and routes that maximize safety.",
     no:"Not fearing increased danger when leaving is encouraging. Still, have a plan to act quickly if circumstances shift."}
};
const FB_ES = {
q1:{yes:"Es bueno que te sientas seguro/a ahora. La seguridad puede cambiar rápido; mantente atento/a. Ten salidas simples en mente.",
    no:"Sentirte inseguro/a en casa es una señal importante. Prioriza tu seguridad inmediata e identifica salidas/cuartos seguros. Considera contactar a personas de confianza o una línea de ayuda."},
q2:{yes:"Las amenazas son serias y pueden preceder el daño físico. Tómalas literalmente, aunque parezcan bromas. Planea salidas rápidas y contactos seguros.",
    no:"Es positivo que no haya amenazas recientes. Observa intimidación o control que puedan reemplazar amenazas directas. Mantenerte alerta ayuda a reaccionar a tiempo."},
q3:{yes:"El daño físico reciente es una alerta crítica. Tu riesgo es alto; podrías necesitar protección urgente. Si te sientes en peligro, llama a emergencias.",
    no:"Es bueno no haber sufrido daño físico reciente. El abuso también puede ser emocional, financiero o psicológico. Mantente atento/a a señales no físicas."},
q4:{yes:"Monitorear dispositivos o movimientos es un control fuerte. Usa dispositivos más seguros y revisa cuentas compartidas. Limita contenido sensible en el teléfono.",
    no:"No notar monitoreo es positivo. Vigila el móvil por comportamientos extraños o inicios de sesión inesperados y conocimiento de tu ubicación."},
q5:{yes:"Los niños expuestos a violencia tienen riesgos emocionales y físicos. Inclúyelos en el plan (escuela, cuidador, contactos de emergencia). Protegerte también los protege.",
    no:"No tener hijos en riesgo reduce la preocupación inmediata, pero tu seguridad sigue siendo vital. Extiende el plan si eso cambia."},
q6:{yes:"Impedirte salir es control coercitivo y puede escalar. Define salidas seguras y una palabra clave con contactos de confianza. Considera lugares a donde ir rápidamente.",
    no:"La libertad de movimiento es protectora. Mantente atento/a si aparecen nuevas restricciones o aumentan las presiones."},
q7:{yes:"La aislación es común y aumenta la dependencia. Da pequeños pasos para reconectar con apoyos. Un contacto de confianza ya mejora la seguridad.",
    no:"Seguir conectado/a es protector. Fortalece esas relaciones; pueden ser cruciales si la situación cambia."},
q8:{yes:"El control financiero puede atraparte. Considera reservar recursos discretamente o buscar asesoría financiera. Documenta restricciones si es seguro.",
    no:"La independencia financiera protege. Resguarda cuentas y mantente alerta ante intentos de limitar acceso."},
q9:{yes:"La coerción sexual es un abuso serio y viola el consentimiento. Tienes derecho a tu autonomía corporal. Busca apoyo médico o de defensa si lo necesitas.",
    no:"No vivir esto es positivo. El consentimiento debe ser libre; reconoce cualquier presión futura como abuso."},
q10:{yes:"Dañar o amenazar mascotas intimida y puede indicar escalamiento. Incluye mascotas en tu plan si es posible. Considera refugios seguros para animales.",
     no:"Es buena noticia. Mantente atento/a; las amenazas a animales pueden aparecer después como control."},
q11:{yes:"El acceso a armas aumenta el riesgo letal. Prioriza una planificación urgente de seguridad y considera contactar autoridades o defensores. Confía en tus instintos.",
     no:"No tener acceso a armas reduce el riesgo inmediato. Mantente atento/a a cambios o a otras formas de escalada."},
q12:{yes:"La presión para guardar el abuso en secreto busca aislarte. El silencio aumenta el riesgo y bloquea el apoyo. Contactar a alguien de confianza es un paso de seguridad.",
     no:"No estar obligado/a al silencio es positivo. Cuídate de tácticas de culpa, vergüenza o intimidación que puedan aparecer."},
q13:{yes:"Irte puede ser el momento más peligroso. Planea con cuidado y busca apoyo de defensores para reducir el riesgo. Elige tiempos y rutas que maximicen la seguridad.",
     no:"No temer mayor peligro al irte es alentador. Aun así, ten un plan para actuar rápido si la situación cambia."}
};
const SYN_EN = {
  high:"Your answers suggest you may be facing serious and immediate risks. Your safety is a real concern. Please consider reaching out right away for support — if you ever feel in danger, call 911 or the National DV Hotline (1-800-799-7233). You are not alone; many have found help through hotlines, shelters, and trusted friends. Use this TimeOut to think about resources and next steps. Remember, you are not alone.",
  mid:"Your answers suggest some challenges and warning signs. While the risk may not feel urgent, it’s important to stay prepared and watch for changes. Strengthen your support system and review your safety plan. Support is available whenever you need it. Use this TimeOut to reflect on your options and resources. Remember, you are not alone.",
  low:"Your answers suggest fewer immediate risks, which is encouraging. Even so, circumstances can shift quickly, so staying aware and prepared is wise. This is a good time to review resources and line up support you can rely on if things change. Use this TimeOut to focus on your strengths and plan ahead. Remember, you are not alone.",
  disc:"Disclaimer: This guidance is for general safety awareness and is not a substitute for professional advice. If you are in immediate danger, call 911 or the National Domestic Violence Hotline at 1-800-799-7233."
};
const SYN_ES = {
  high:"Tus respuestas sugieren riesgos serios e inmediatos. Tu seguridad es una preocupación real. Considera buscar apoyo de inmediato; si estás en peligro, llama al 911 o a la Línea Nacional contra la Violencia Doméstica (1-800-799-7233). No estás solo/a; muchas personas han encontrado ayuda en líneas, refugios y amistades de confianza. Usa este TimeOut para pensar en recursos y próximos pasos. Recuerda: no estás solo/a.",
  mid:"Tus respuestas indican señales de alerta y algunos desafíos. Aunque el riesgo no parezca urgente, es importante estar preparado/a y observar cambios. Fortalece tu red de apoyo y revisa tu plan de seguridad. El apoyo está disponible cuando lo necesites. Usa este TimeOut para reflexionar sobre tus opciones y recursos. Recuerda: no estás solo/a.",
  low:"Tus respuestas sugieren pocos riesgos inmediatos, lo cual es alentador. Aun así, la situación puede cambiar; mantenerse alerta y preparado/a es prudente. Es buen momento para revisar recursos y asegurar apoyos por si algo cambia. Usa este TimeOut para enfocarte en tus fortalezas y planear. Recuerda: no estás solo/a.",
  disc:"Aviso: Esta orientación es para concienciación general y no reemplaza el consejo profesional. Si estás en peligro inmediato, llama al 911 o a la Línea Nacional contra la Violencia Doméstica: 1-800-799-7233."
};
function questions(){ return S.lang==='es'?Q_ES:Q_EN; }
function fb(){ return S.lang==='es'?FB_ES:FB_EN; }
function syn(){ return S.lang==='es'?SYN_ES:SYN_EN; }

function buildQs(){
  const box=$('qList'); box.innerHTML='';
  questions().forEach((text,i)=>{
    const qk='q'+(i+1);
    const val=S.answers[qk]||'';
    const ySel=val==='yes'?' selected':'';
    const nSel=val==='no'?' selected':'';
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <div style="margin-bottom:.5rem">${i+1}. ${text}</div>
      <div class="yn">
        <button class="btn ynbtn${ySel}" data-k="${qk}" data-v="yes">${tr('Yes','Sí')}</button>
        <button class="btn ynbtn${nSel}" data-k="${qk}" data-v="no">${tr('No','No')}</button>
      </div>
      <div id="fb-${qk}" class="muted" style="margin-top:.5rem"></div>
    `;
    box.appendChild(card);
    if(val) renderFB(qk,val);
  });
  updateScores();
}
function renderFB(k,val){
  const dict=fb(); const el=$('fb-'+k);
  if(!el) return;
  const item=dict[k]; if(!item) return;
  el.textContent=item[val]||'';
}
function computeRisk(){
  let risky=0,total=13;
  for(let i=1;i<=13;i++){
    const k='q'+i, v=S.answers[k];
    if(!v) continue;
    if(i===1){ if(v==='no') risky++; } else { if(v==='yes') risky++; }
  }
  const r=Math.round((risky/total)*100);
  S.risk=r; S.trust=100-r;
}
function updateScores(){
  computeRisk();
  $('riskNum').textContent=S.risk+'%';
  $('trustNum').textContent=S.trust+'%';
  $('riskBar').style.width=S.risk+'%';
  $('trustBar').style.width=S.trust+'%';
  $('scoreChip').textContent = tr('Risk','Riesgo')+' '+S.risk+'% • '+tr('Trust','Confianza')+' '+S.trust+'%';

  const wrap=$('synWrap'), body=$('synBody'), d=$('disc');
  const s=syn();
  let txt, cls='good';
  if(S.risk>=60){ txt=s.high; cls='bad'; }
  else if(S.risk>=30){ txt=s.mid; cls='mid'; }
  else { txt=s.low; cls='good'; }
  if(Object.keys(S.answers).length>0){
    wrap.classList.remove('hidden','good','mid','bad');
    wrap.classList.add(cls);
    body.textContent=txt;
    d.textContent=s.disc;
  }else{
    wrap.classList.add('hidden');
  }
}
/* yn button toggles */
document.addEventListener('click',(e)=>{
  const b=e.target.closest('.ynbtn'); if(!b) return;
  const k=b.dataset.k, v=b.dataset.v;
  S.answers[k]=v; save();
  document.querySelectorAll(`.ynbtn[data-k="${k}"]`).forEach(x=>x.classList.remove('selected'));
  b.classList.add('selected');
  renderFB(k,v);
  updateScores();
});
/* demo answers */
$('btnDemo').onclick=()=>{
  S.answers={
    q1:'no', q2:'yes', q3:'no', q4:'yes', q5:'no',
    q6:'yes', q7:'yes', q8:'no', q9:'no', q10:'no',
    q11:'no', q12:'yes', q13:'yes'
  };
  save(); buildQs();
};
/* save check-in (local) */
$('btnSave').onclick=()=>{ save(); alert(tr('Check-In saved.','Autoevaluación guardada.')); };

/* ================ PLAN ================ */
$('planNote').value=S.plan;
$('btnQuick').onclick=()=>{
  $('planNote').value = tr(
`Quick Plan
• Keep phone charged; location off when safe.
• Code word with trusted contact.
• Copies of IDs and cash in a safe place.
• Identify 2 safe places to go.`,
`Plan Rápido
• Mantén el teléfono cargado; ubicación desactivada cuando sea seguro.
• Palabra clave con un contacto de confianza.
• Copias de identificaciones y efectivo en un lugar seguro.
• Identifica 2 lugares seguros a donde ir.`);
};
$('btnTemplate').onclick=()=>{
  $('planNote').value = tr(
`Template
1) Warning signs I notice:
2) People I can contact:
3) Safe places I can go:
4) Items to take (docs, meds, cash):
5) Steps if danger increases:`,
`Plantilla
1) Señales de alerta que noto:
2) Personas a quienes contactar:
3) Lugares seguros a donde ir:
4) Artículos para llevar (docs, medicinas, efectivo):
5) Pasos si el peligro aumenta:`);
};
$('btnPlanSave').onclick=()=>{ S.plan=$('planNote').value; save(); alert(tr('Plan saved.','Plan guardado.')); };
$('btnPlanClear').onclick=()=>{ $('planNote').value=''; S.plan=''; save(); };

/* ================ RESOURCES ================ */
const RES = [
  {en:{t:"National DV Hotline",d:"24/7 confidential support",u:"tel:18007997233"},
   es:{t:"Línea Nacional contra la Violencia Doméstica",d:"Apoyo confidencial 24/7",u:"tel:18007997233"}},
  {en:{t:"RAINN (Sexual Assault)",d:"24/7 hotline",u:"tel:8006564673"},
   es:{t:"RAINN (Asalto sexual)",d:"Línea 24/7",u:"tel:8006564673"}},
  {en:{t:"Childhelp",d:"Child abuse hotline",u:"tel:8004224453"},
   es:{t:"Childhelp",d:"Línea contra abuso infantil",u:"tel:8004224453"}},
  {en:{t:"StrongHearts Native Helpline",d:"Support for Native communities",u:"tel:8447628483"},
   es:{t:"StrongHearts Native Helpline",d:"Apoyo para comunidades nativas",u:"tel:8447628483"}}
];
function drawRes(){
  const box=$('resList'); box.innerHTML='';
  RES.forEach(r=>{
    const v=S.lang==='es'?r.es:r.en;
    const item=document.createElement('div');
    item.className='card';
    item.innerHTML=`<strong>${v.t}</strong><div class="muted">${v.d}</div>
      <div class="row" style="justify-content:flex-start;gap:.5rem">
        <a class="btn btn-primary" href="${v.u}">${tr('Call','Llamar')}</a>
      </div>`;
    box.appendChild(item);
  });
}

/* ================ PROFILE ================ */
$('nameInput').value=S.name;
$('pinInput').value=S.pin;
$('btnProfSave').onclick=()=>{
  S.name=$('nameInput').value.trim()||'Anonymous';
  const np=$('pinInput').value.trim()||'2580';
  S.pin=np; save(); alert(tr('Profile saved.','Perfil guardado.'));
};
$('btnWipe').onclick=()=>{
  if(confirm(tr('Clear all local data?','¿Borrar todos los datos locales?'))){
    localStorage.removeItem('timeout_pin');
    localStorage.removeItem('timeout_name');
    localStorage.removeItem('timeout_lang');
    localStorage.removeItem('timeout_unlocked');
    localStorage.removeItem('timeout_answers');
    localStorage.removeItem('timeout_plan');
    Object.assign(S,{pin:'2580',name:'Anonymous',lang:'en',unlocked:false,answers:{},plan:'',risk:0,trust:100,stack:['home']});
    location.reload();
  }
};

/* ================ LANG ================ */
function applyLang(){
  $('appTitle').textContent='TimeOut';
  $('btnExit').textContent='EXIT';
  $('btnBack').title=tr('Back','Atrás');
  $('statusPill').textContent=tr('Focus','Enfoque');
  $('hint').textContent=tr('Long-press the title to unlock.','Mantén presionado el título para desbloquear.');
  $('greet').textContent=tr('Welcome','Bienvenido/a')+', '+S.name;
  $('riskLab').textContent=tr('Risk','Riesgo');
  $('trustLab').textContent=tr('Trust','Confianza');
  $('goCheck').textContent=tr('Go to Check-In','Ir a Autoevaluación');
  $('goPlan').textContent=tr('Safety Plan','Plan de Seguridad');
  $('checkTitle').textContent=tr('Check-In','Autoevaluación');
  $('checkHint').textContent=tr('Answer each question. Buttons will highlight and guidance appears below each one.','Responde cada pregunta. Los botones se iluminan y aparece orientación debajo de cada una.');
  $('btnDemo').textContent=tr('Load Demo Answers','Cargar respuestas de demostración');
  $('btnSave').textContent=tr('Save Check-In','Guardar autoevaluación');
  $('planTitle').textContent=tr('Safety Plan','Plan de Seguridad');
  $('resTitle').textContent=tr('Resources','Recursos');
  $('profTitle').textContent=tr('Profile','Perfil');
  $('nameLab').textContent=tr('Display name','Nombre para mostrar');
  $('pinLab').textContent=tr('PIN (default 2580)','PIN (predeterminado 2580)');
  $('btnPlanSave').textContent=tr('Save Plan','Guardar plan');
  $('btnPlanClear').textContent=tr('Clear','Borrar');
  $('tabHome').textContent=tr('Home','Inicio');
  $('tabCheck').textContent=tr('Check-In','Autoeval.');
  $('tabPlan').textContent=tr('Plan','Plan');
  $('tabRes').textContent=tr('Resources','Recursos');
  $('tabProf').textContent=tr('Profile','Perfil');
  $('scoreChip').textContent=tr('Risk','Riesgo')+' '+S.risk+'% • '+tr('Trust','Confianza')+' '+S.trust+'%';
  buildQs();
  drawRes();
}

/* ================ SAVE ================ */
function save(){
  localStorage.setItem('timeout_pin',S.pin);
  localStorage.setItem('timeout_name',S.name);
  localStorage.setItem('timeout_lang',S.lang);
  localStorage.setItem('timeout_unlocked',JSON.stringify(S.unlocked));
  localStorage.setItem('timeout_answers',JSON.stringify(S.answers));
  localStorage.setItem('timeout_plan',S.plan||$('planNote').value||'');
}

/* INIT */
applyLang();
drawRes();
if(S.unlocked) afterUnlock();
</script>
</body>
</html>
