<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TimeOut — Privacy-first Safety App</title>
  <meta name="theme-color" content="#07090d" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--maxw:480px}
    html,body{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:#06070a;color:#e6eef8;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .container{max-width:var(--maxw);margin:0 auto;padding:16px}
    .card{background:rgba(10,14,24,.68);border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,.03);backdrop-filter:blur(6px)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-weight:700;font-size:20px;margin:0}
    .pill{background:#081226;padding:.15rem .6rem;border-radius:999px;border:1px solid rgba(255,255,255,.04);font-size:12px;color:#9fb0d9}
    .theme-dot{width:16px;height:16px;border-radius:999px;border:1px solid rgba(255,255,255,.06);cursor:pointer}
    .btn{border-radius:10px;padding:.5rem .8rem;font-weight:700;cursor:pointer}
    .btn-primary{background:#2563eb;color:white;border:0}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:inherit}
    .small{font-size:13px;color:#9fb0d9}
    .flipwrap{display:inline-grid;grid-auto-flow:column;gap:.18rem;user-select:none}
    .digit{width:56px;height:80px;border-radius:12px;background:linear-gradient(180deg,#071428,#071025);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:44px;letter-spacing:.02em;text-shadow:0 0 8px rgba(59,130,246,.28);border:1px solid rgba(255,255,255,.02);overflow:hidden}
    .sep{width:14px;display:flex;align-items:center;justify-content:center;font-weight:900;color:#9fb5ff;font-size:40px;text-shadow:0 0 8px rgba(99,102,241,.25)}
    .tick{animation:tick .62s ease}
    @keyframes tick{0%{transform:rotateX(0)}49%{transform:rotateX(-86deg)}50%{transform:rotateX(86deg)}100%{transform:rotateX(0)}}
    .hidden-soft{display:none!important}
    .tab-btn{padding:.45rem .75rem;border-radius:999px;border:1px solid rgba(255,255,255,.03)}
    .tab-btn.active{background:#2563eb;color:white;border:0}
    input.card{background:transparent;border:1px solid rgba(255,255,255,.04);padding:.6rem;border-radius:8px;color:inherit}
    .chip{padding:.2rem .5rem;border-radius:999px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.02)}
    footer.small-note{text-align:center;color:#93a7c7;margin-top:12px;font-size:12px}
    .danger{color:#ff6b6b}
    @media (max-width:480px){ .digit{width:48px;height:72px;font-size:38px} }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <header>
      <div>
        <h1 id="decoyTitle" class="select-none">TimeOut</h1>
        <div class="small"><span id="hdrSub">Clock</span> • <span class="pill">v1.3.5</span></div>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2" title="Theme">
          <div class="theme-dot" data-t="aurora" aria-label="Aurora" style="background:linear-gradient(135deg,#22c55e,#2563eb)"></div>
          <div class="theme-dot" data-t="neon" aria-label="Neon" style="background:linear-gradient(135deg,#06b6d4,#8b5cf6)"></div>
          <div class="theme-dot" data-t="amoled" aria-label="AMOLED" style="background:#000"></div>
        </div>
        <div id="langToggle" class="btn btn-ghost mr-2">EN | ES</div>
        <button id="quickExitBtn" class="btn btn-ghost">Home</button>
      </div>
    </header>

    <!-- DECOY VIEW -->
    <section id="decoyView" class="card">
      <div class="flex items-center justify-center gap-2 mb-3">
        <button id="decoyTabClock" class="tab-btn active">Clock</button>
        <button id="decoyTabStopwatch" class="tab-btn">Stopwatch</button>
        <button id="decoySkinCalc" class="tab-btn">Calculator</button>
        <button id="decoySkinNotes" class="tab-btn">Notes</button>
        <button id="decoySkinWeather" class="tab-btn">Weather</button>
      </div>

      <!-- CLOCK SKIN -->
      <div id="skinClock" class="text-center">
        <div id="flipClock" class="inline-flex items-center justify-center select-none" style="gap:.18rem;">
          <div class="flipwrap" id="hh"><div class="digit">0</div><div class="digit">0</div></div>
          <div class="sep">:</div>
          <div class="flipwrap" id="mm"><div class="digit">0</div><div class="digit">0</div></div>
          <div class="sep">:</div>
          <div class="flipwrap" id="ss"><div class="digit">0</div><div class="digit">0</div></div>
        </div>
        <div id="liveDate" class="small mt-2">—</div>
        <p class="small mt-3">Long-press title or digits to unlock the app.</p>
      </div>

      <!-- STOPWATCH SKIN -->
      <div id="skinStopwatch" class="text-center hidden-soft">
        <div id="swDisplay" class="font-extrabold text-4xl my-3">00:00.00</div>
        <div class="flex items-center justify-center gap-2">
          <button id="swStart" class="btn btn-primary">Start</button>
          <button id="swLap" class="btn btn-ghost">Lap</button>
          <button id="swReset" class="btn btn-ghost">Reset</button>
        </div>
        <ul id="swLaps" class="mt-3 text-sm text-gray-300 max-h-36 overflow-auto"></ul>
      </div>

      <!-- CALC SKIN -->
      <div id="skinCalc" class="hidden-soft mt-3">
        <div class="card mb-3 text-right" id="calcDisplay" style="font-size:1.4rem;padding:.7rem">123 + 456</div>
        <div class="grid grid-cols-4 gap-2">
          <button class="btn btn-ghost">7</button><button class="btn btn-ghost">8</button><button class="btn btn-ghost">9</button><button class="btn btn-ghost">÷</button>
          <button class="btn btn-ghost">4</button><button class="btn btn-ghost">5</button><button class="btn btn-ghost">6</button><button class="btn btn-ghost">×</button>
          <button class="btn btn-ghost">1</button><button class="btn btn-ghost">2</button><button class="btn btn-ghost">3</button><button class="btn btn-ghost">-</button>
          <button class="btn btn-ghost">0</button><button class="btn btn-ghost">.</button><button class="btn btn-ghost">=</button><button class="btn btn-ghost">+</button>
        </div>
        <p class="small mt-3">Long-press the display to unlock (hidden).</p>
      </div>

      <!-- NOTES SKIN -->
      <div id="skinNotes" class="hidden-soft mt-3">
        <div class="card p-3" id="fakeNoteContent">Grocery: milk, eggs, bread. Call Mom later.</div>
        <p class="small mt-3">Long-press note area to unlock (hidden).</p>
      </div>

      <!-- WEATHER SKIN -->
      <div id="skinWeather" class="hidden-soft mt-3 text-center">
        <div class="card p-4">
          <div class="text-4xl font-bold" id="weatherTemp">72°</div>
          <div class="small mt-1" id="weatherCity">Sunny • Your City</div>
        </div>
        <p class="small mt-3">Long-press weather card to unlock (hidden).</p>
      </div>
    </section>

    <!-- PIN / CHANGE PIN MODAL -->
    <div id="pinModal" class="fixed inset-0 bg-black/80 hidden-soft flex items-center justify-center p-4">
      <div class="card w-full max-w-md p-4">
        <h3 id="pinModalTitle" class="text-lg font-semibold mb-2">Enter PIN</h3>
        <form id="pinForm" class="space-y-3">
          <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" autocomplete="off"
                 class="w-full card text-center font-bold text-xl" placeholder="••••" />
          <div id="pinChangeFields" class="hidden-soft space-y-2">
            <input id="oldPin" maxlength="32" inputmode="numeric" class="w-full card text-center" placeholder="Current PIN" />
            <input id="newPin" maxlength="64" inputmode="text" class="w-full card text-center" placeholder="New PIN or passphrase (min 4)" />
            <input id="newPin2" maxlength="64" inputmode="text" class="w-full card text-center" placeholder="Confirm new" />
          </div>
          <div class="flex gap-2">
            <button id="pinConfirmBtn" class="btn btn-primary flex-1" type="submit">Confirm</button>
            <button id="pinCancelBtn" class="btn btn-ghost flex-1" type="button">Cancel</button>
          </div>
          <div id="pinError" class="small danger min-h-[1rem]"></div>
          <div class="small text-gray-400">Default PIN: <strong>2580</strong>. Duress PIN: <strong>1111</strong>. Change in Profile.</div>
        </form>
      </div>
    </div>

    <!-- DISCLAIMER (first-run after unlock) -->
    <div id="firstRunDisc" class="fixed inset-0 bg-black/80 hidden-soft flex items-center justify-center p-4">
      <div class="card max-w-lg">
        <h3 class="text-lg font-semibold mb-2">Important Safety Notice</h3>
        <div class="small mb-3">
          <p>This tool helps with planning and private check-ins. It is <strong>not</strong> a guarantee of safety or emergency response.</p>
          <p>If you are in immediate danger call local emergency services. Use duress PIN and auto-wipe with caution. No system is 100% secure.</p>
        </div>
        <div class="flex gap-2">
          <button id="acceptDisclaimer" class="btn btn-primary">I Understand</button>
          <button id="declineDisclaimer" class="btn btn-ghost">Not Now</button>
        </div>
      </div>
    </div>

    <!-- REAL APP -->
    <section id="realApp" class="hidden-soft mt-3">
      <div class="card mb-3">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Signed in as</div>
            <div id="profileName" class="font-semibold text-lg">Anonymous</div>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="text-align:right">
              <div class="small">Trust</div>
              <div id="trustBadge" class="font-bold text-2xl">100%</div>
            </div>
            <button id="lockBtn" class="btn btn-ghost">Lock</button>
          </div>
        </div>
      </div>

      <nav class="mb-3">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="tabHomeBtn" class="tab-btn active">Home</button>
          <button id="tabCheckBtn" class="tab-btn">Check-In</button>
          <button id="tabPlanBtn" class="tab-btn">Safety Plan</button>
          <button id="tabResBtn" class="tab-btn">Resources</button>
          <button id="tabProfileBtn" class="tab-btn">Profile</button>
        </div>
      </nav>

      <!-- HOME -->
      <div id="tab-home" class="card">
        <h3 class="text-lg font-semibold">Welcome</h3>
        <p class="small mt-2">Hi <span id="homeName">Anonymous</span>. Your trust score is <span id="homeTrust">100</span>%.</p>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button id="goToCheckIn" class="btn btn-primary">Go to Check-In</button>
          <button id="saveAll" class="btn btn-ghost">Save</button>
        </div>
      </div>

      <!-- CHECK-IN -->
      <div id="tab-checkin" class="card hidden-soft mt-3">
        <h3 class="text-lg font-semibold mb-2" id="checkTitle">Safety Check-In</h3>
        <div id="questions" class="space-y-3"></div>
        <div class="flex gap-2 mt-3">
          <button id="saveCheckIn" class="btn btn-primary flex-1">Save Check-In</button>
          <button id="clearCheckIn" class="btn btn-ghost flex-1">Clear</button>
        </div>
        <div class="mt-3 flex justify-between">
          <div>
            <div class="small">Risk</div>
            <div id="riskPct" class="font-bold text-2xl text-rose-400">0%</div>
          </div>
          <div style="text-align:right">
            <div class="small">Trust</div>
            <div id="trustPct" class="font-bold text-2xl text-green-400">100%</div>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="demoLoadBtn" class="btn btn-ghost">Load Demo Answers</button>
          <button id="talkBtn" class="btn btn-ghost">Talk to the App</button>
        </div>

        <div id="checkFeedback" class="mt-4"></div>
      </div>

      <!-- PLAN -->
      <div id="tab-plan" class="card hidden-soft mt-3">
        <h3 class="text-lg font-semibold">Safety Plans</h3>
        <div id="planList" class="mt-2 space-y-2"></div>
        <div class="mt-2 flex gap-2">
          <button id="btnNewPlan" class="btn btn-primary">New Plan</button>
          <button id="btnTemplates" class="btn btn-ghost">Templates</button>
          <button id="btnQuickGenerate" class="btn btn-ghost">Quick Generate</button>
        </div>
      </div>

      <!-- RESOURCES -->
      <div id="tab-resources" class="card hidden-soft mt-3">
        <h3 class="text-lg font-semibold">My Resources</h3>
        <form id="resourceForm" class="grid grid-cols-1 gap-2 mt-3 mb-3">
          <input id="resTitleInput" class="card" placeholder="Title (e.g., Shelter)" />
          <input id="resDesc" class="card" placeholder="Description" />
          <input id="resUrl" class="card" placeholder="Link or phone (https:// or 1-800...)" />
          <div class="flex gap-2">
            <button id="btnAddResource" class="btn btn-primary flex-1">Add Resource</button>
            <button id="btnCopyHotline" class="btn btn-ghost flex-1">Copy Hotline</button>
          </div>
        </form>
        <ul id="resourceList" class="space-y-2"></ul>
      </div>

      <!-- PROFILE -->
      <div id="tab-profile" class="card hidden-soft mt-3">
        <h3 class="text-lg font-semibold">Profile & Security</h3>
        <div class="mt-3 grid gap-2">
          <label class="small">Display Name</label>
          <input id="displayNameInput" class="card" placeholder="Your name (optional)" />
          <button id="saveProfile" class="btn btn-primary">Save Profile</button>
        </div>

        <hr class="my-4 border-gray-700" />

        <h4 class="font-semibold">Security</h4>
        <div class="mt-2 grid gap-2">
          <div class="flex items-center gap-2">
            <label class="small">Change PIN</label>
            <input id="profileChangePin" class="card" placeholder="New PIN (min 4)" />
            <button id="profileChangePinBtn" class="btn btn-ghost">Change</button>
          </div>
          <div class="flex items-center gap-2">
            <label class="small">Set Duress PIN</label>
            <input id="profileDuressPin" class="card" placeholder="Duress PIN" />
            <button id="profileSetDuress" class="btn btn-ghost">Set</button>
          </div>
          <div class="flex items-center gap-2">
            <label class="small">Auto-wipe after failed attempts</label>
            <select id="autoWipeSelect" class="card w-28"><option value="0">Off</option><option value="3">3</option><option value="5">5</option></select>
          </div>
          <div class="flex items-center gap-2">
            <label class="small">Shake-to-lock</label>
            <input id="toggleShake" type="checkbox" />
          </div>
        </div>

        <hr class="my-4 border-gray-700" />

        <div class="grid gap-2">
          <button id="exportJson" class="btn btn-ghost">Export Encrypted JSON</button>
          <input id="importJsonFile" type="file" class="mt-1" />
          <button id="importJsonBtn" class="btn btn-ghost">Import Encrypted JSON</button>
          <button id="clearData" class="btn btn-ghost danger">Clear Data (Wipe)</button>
        </div>

        <div id="devPanel" class="mt-3 hidden-soft">
          <h4 class="font-semibold">Developer</h4>
          <pre id="devState" class="small" style="white-space:pre-wrap;max-height:160px;overflow:auto;background:rgba(255,255,255,.02);padding:.6rem;border-radius:8px;"></pre>
        </div>
      </div>

      <footer class="small-note">TimeOut • Privacy-first support • v1.3.5</footer>
    </section>
  </div><!-- Firebase modular SDK (v11.6.1) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC3Ga-GhV8xQztnbef7ybPFu4BRtLANtuk",
      authDomain: "unbrokenpath-630b0.firebaseapp.com",
      projectId: "unbrokenpath-630b0",
      storageBucket: "unbrokenpath-630b0.firebasestorage.app",
      messagingSenderId: "147188865145",
      appId: "1:147188865145:web:ff1f35a732bf89b31e1ca8",
      measurementId: "G-0Y8G7SS1BV"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    signInAnonymously(auth).catch((err)=> console.warn("Firebase anon signin failed:", err));
    let currentUid = null;
    onAuthStateChanged(auth, user => { if(user){ currentUid = user.uid; } });

    window.saveProfileMirror = async function(profile){
      if(!currentUid) return;
      try{
        const ref = doc(db, "artifacts/timeout-app/public/data/profiles/" + currentUid);
        await setDoc(ref, { publicName: profile.name || "Anonymous", trustScore: profile.trust || 100, appVersion: "v1.3.5", updatedAt: serverTimestamp() }, { merge: true });
      }catch(e){ console.warn("profile mirror failed", e); }
    };

    window.saveCheckinToFirestore = async function(payload){
      if(!currentUid) return;
      try{
        const col = collection(db, "artifacts/timeout-app/private/data/checkins");
        await addDoc(col, { userId: currentUid, answers: payload.answers, profile: payload.profile, createdAt: serverTimestamp(), appVersion: "v1.3.5" });
      }catch(e){ console.warn("save checkin failed", e); }
    };
  </script>

  <!-- App core (non-module) -->
  <script>
  /* ====== App core ====== */
  const $ = id => document.getElementById(id);
  const APP_VER = "v1.3.5";
  const LS = {
    meta: "timeout_meta",
    enc: "timeout_enc",
    pinCheck: "timeout_pin_check",
    duressCheck: "timeout_duress_check",
    profile: "timeout_profile",
    answers: "timeout_answers",
    resources: "timeout_resources",
    plans: "timeout_plans",
    disclaimer: "timeout_disclaimer_accepted",
    autoWipe: "timeout_autowipe"
  };

  let unlocked = false;
  let unlockedPassword = null;
  let core = {
    profile: { name: "Anonymous", trust: 100 },
    answers: {},
    resources: [],
    plans: [],
    settings: { shakeLock: false, autoWipe: 0 }
  };
  let failedAttempts = 0;

  /* ---- Crypto helpers ---- */
  function randBytes(len){ const b = new Uint8Array(len); crypto.getRandomValues(b); return b; }
  function toB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
  function fromB64(s){ const bin = atob(s); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr; }
  async function deriveKey(password, salt, iterations=150000){
    const enc = new TextEncoder();
    const pwKey = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
    return crypto.subtle.deriveKey({ name:"PBKDF2", salt, iterations, hash:"SHA-256" }, pwKey, { name:"AES-GCM", length:256 }, false, ["encrypt","decrypt"]);
  }
  async function encryptWithPassword(obj, password){
    const salt = randBytes(16);
    const iv = randBytes(12);
    const key = await deriveKey(password, salt);
    const data = new TextEncoder().encode(JSON.stringify(obj));
    const ct = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, key, data);
    return { header:{ salt: toB64(salt.buffer), iv: toB64(iv.buffer), version:1 }, ciphertext: toB64(ct) };
  }
  async function decryptWithPassword(blob, password){
    const salt = fromB64(blob.header.salt);
    const iv = fromB64(blob.header.iv);
    const key = await deriveKey(password, salt);
    const ct = fromB64(blob.ciphertext);
    const plain = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, ct);
    return JSON.parse(new TextDecoder().decode(plain));
  }
  async function createPinCheck(pin){
    const salt = randBytes(12);
    const key = await deriveKey(pin, salt, 100000);
    const iv = randBytes(12);
    const ct = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, key, new TextEncoder().encode("timeout-check"));
    return { salt: toB64(salt.buffer), iv: toB64(iv.buffer), ct: toB64(ct) };
  }
  async function verifyPinCheck(pin, stored){
    try{
      const salt = fromB64(stored.salt), iv = fromB64(stored.iv);
      const key = await deriveKey(pin, salt, 100000);
      const plain = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, fromB64(stored.ct));
      return new TextDecoder().decode(plain) === "timeout-check";
    }catch(e){ return false; }
  }

  async function saveEncryptedCore(password){
    const pkg = await encryptWithPassword(core, password);
    localStorage.setItem(LS.enc, JSON.stringify(pkg));
  }
  function getEncryptedBlob(){ try{ return JSON.parse(localStorage.getItem(LS.enc)); }catch{return null;} }
  async function loadEncryptedCore(password){
    const blob = getEncryptedBlob();
    if(!blob) return null;
    return decryptWithPassword(blob, password);
  }

  (async function initDefaults(){
    if(!localStorage.getItem(LS.pinCheck)){
      const pk = await createPinCheck("2580");
      localStorage.setItem(LS.pinCheck, JSON.stringify(pk));
      await saveEncryptedCore("2580").catch(()=>{});
    }
    if(!localStorage.getItem(LS.duressCheck)){
      const dk = await createPinCheck("1111");
      localStorage.setItem(LS.duressCheck, JSON.stringify(dk));
    }
  })();

  /* ---- Decoy clock & skins ---- */
  const flipHH = $("hh"), flipMM = $("mm"), flipSS = $("ss"), liveDate = $("liveDate");
  const pad2 = (n)=> String(n).padStart(2,"0");
  let lastClock = "000000";
  function updateFlip(group, prev, next){
    const a = group.children[0], b = group.children[1];
    if(prev[0] !== next[0]) { a.textContent = next[0]; a.classList.add("tick"); setTimeout(()=>a.classList.remove("tick"),320); }
    if(prev[1] !== next[1]) { b.textContent = next[1]; b.classList.add("tick"); setTimeout(()=>b.classList.remove("tick"),320); }
  }
  function renderClock(){
    const d = new Date(); const h = pad2(d.getHours()), m = pad2(d.getMinutes()), s = pad2(d.getSeconds());
    const now = h+m+s, prev = lastClock; lastClock = now;
    updateFlip(flipHH, prev.slice(0,2), h);
    updateFlip(flipMM, prev.slice(2,4), m);
    updateFlip(flipSS, prev.slice(4,6), s);
    const opts = { weekday:'short', month:'short', day:'numeric' };
    liveDate.textContent = d.toLocaleDateString(undefined, opts);
  }
  setInterval(renderClock,1000); renderClock();

  let swRunning=false, swStart=0, swElapsed=0, swRAF=null;
  function fmtMillis(ms){ const cs=Math.floor(ms/10)%100, sec=Math.floor(ms/1000)%60, min=Math.floor(ms/60000)%60, hr=Math.floor(ms/3600000); const hh=hr>0?String(hr).padStart(2,'0')+':':''; return `${hh}${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}.${String(cs).padStart(2,"0")}`; }
  function swTick(){ const ms = swElapsed + (swRunning?(performance.now()-swStart):0); $("swDisplay").textContent = fmtMillis(ms); if(swRunning) swRAF = requestAnimationFrame(swTick); }
  $("swStart").addEventListener("click", ()=>{ if(!swRunning){ swRunning=true; swStart=performance.now(); $("swStart").textContent="Pause"; swTick(); } else { swRunning=false; swElapsed += (performance.now()-swStart); cancelAnimationFrame(swRAF); $("swStart").textContent="Start"; }});
  $("swLap").addEventListener("click", ()=>{ const li=document.createElement("li"); li.textContent=$("swDisplay").textContent; $("swLaps").prepend(li); });
  $("swReset").addEventListener("click", ()=>{ swRunning=false; cancelAnimationFrame(swRAF); swElapsed=0; $("swDisplay").textContent="00:00.00"; $("swStart").textContent="Start"; $("swLaps").innerHTML=""; });

  function setSkin(s){
    ["skinClock","skinStopwatch","skinCalc","skinNotes","skinWeather"].forEach(id=>$(id).classList.add("hidden-soft"));
    if(s==="clock") $("skinClock").classList.remove("hidden-soft");
    if(s==="stopwatch") $("skinStopwatch").classList.remove("hidden-soft");
    if(s==="calc") $("skinCalc").classList.remove("hidden-soft");
    if(s==="notes") $("skinNotes").classList.remove("hidden-soft");
    if(s==="weather") $("skinWeather").classList.remove("hidden-soft");
    const m = JSON.parse(localStorage.getItem(LS.meta) || "{}"); m.skin = s; localStorage.setItem(LS.meta, JSON.stringify(m));
  }
  $("decoyTabClock").addEventListener("click", ()=> setSkin("clock"));
  $("decoyTabStopwatch").addEventListener("click", ()=> setSkin("stopwatch"));
  $("decoySkinCalc").addEventListener("click", ()=> setSkin("calc"));
  $("decoySkinNotes").addEventListener("click", ()=> setSkin("notes"));
  $("decoySkinWeather").addEventListener("click", ()=> setSkin("weather"));
  setSkin((JSON.parse(localStorage.getItem(LS.meta) || "{}").skin) || "clock");

  /* ---- Long-press (mobile + desktop) ---- */
  function addLongPress(el, action) {
    let timer;
    const start = () => { timer = setTimeout(action, 800); };
    const cancel = () => { clearTimeout(timer); };
    el.addEventListener("mousedown", start);
    el.addEventListener("mouseup", cancel);
    el.addEventListener("mouseleave", cancel);
    el.addEventListener("touchstart", start);
    el.addEventListener("touchend", cancel);
    el.addEventListener("touchcancel", cancel);
  }
  const openPINModal = (mode="enter")=>{
    $("pinError").textContent=""; $("pinInput").value=""; $("oldPin").value=$("newPin").value=$("newPin2").value="";
    if(mode==="change"){ $("pinChangeFields").classList.remove("hidden-soft"); $("pinModalTitle").textContent = (lang==="en"?"Change PIN":"Cambiar PIN"); }
    else { $("pinChangeFields").classList.add("hidden-soft"); $("pinModalTitle").textContent = (lang==="en"?"Enter PIN":"Introduce el PIN"); }
    $("pinForm").dataset.mode = mode;
    $("pinModal").classList.remove("hidden-soft");
    setTimeout(()=> $("pinInput").focus(), 50);
  };
  const closePINModal = ()=> $("pinModal").classList.add("hidden-soft");

  addLongPress($("decoyTitle"), ()=> openPINModal());
  addLongPress($("flipClock"), ()=> openPINModal());
  addLongPress($("fakeNoteContent"), ()=> openPINModal());
  addLongPress(document.querySelector(".card"), ()=> openPINModal());

  $("pinCancelBtn").addEventListener("click", closePINModal);

  $("pinForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const mode = $("pinForm").dataset.mode || "enter";
    const val = $("pinInput").value.trim();
    if(mode==="enter"){
      if(!val){ $("pinError").textContent = (lang==="en"?"Incorrect PIN.":"PIN incorrecto."); return; }
      const stored = localStorage.getItem(LS.pinCheck);
      const duress = localStorage.getItem(LS.duressCheck);
      const ok = stored && await verifyPinCheck(val, JSON.parse(stored));
      if(ok){
        try {
          const data = await loadEncryptedCore(val);
          if(data) core = data;
          unlocked = true; unlockedPassword = val; failedAttempts = 0; localStorage.removeItem("timeout_failed");
          closePINModal(); showRealApp(); refreshUI();
        } catch(err){ $("pinError").textContent = (lang==="en"?"Incorrect PIN.":"PIN incorrecto."); recordFailedAttempt(); }
      } else if(duress && await verifyPinCheck(val, JSON.parse(duress))){
        closePINModal(); alert("Duress PIN entered — showing fake screen."); // keep decoy
      } else {
        $("pinError").textContent = (lang==="en"?"Incorrect PIN.":"PIN incorrecto."); recordFailedAttempt();
      }
    } else {
      const old = $("oldPin").value.trim();
      const newp = $("newPin").value.trim();
      const new2 = $("newPin2").value.trim();
      if(!old || !newp || newp.length<4){ $("pinError").textContent = (lang==="en"?"New PIN must be at least 4 characters.":"El PIN nuevo debe tener al menos 4 caracteres."); return; }
      if(newp !== new2){ $("pinError").textContent = (lang==="en"?"PINs do not match.":"Los PIN no coinciden."); return; }
      const stored = localStorage.getItem(LS.pinCheck);
      if(!stored){ $("pinError").textContent = "No PIN set"; return; }
      const ok = await verifyPinCheck(old, JSON.parse(stored));
      if(!ok){ $("pinError").textContent = (lang==="en"?"Incorrect PIN.":"PIN incorrecto."); return; }
      const newCheck = await createPinCheck(newp);
      localStorage.setItem(LS.pinCheck, JSON.stringify(newCheck));
      if(unlocked && unlockedPassword){ await saveEncryptedCore(newp); unlockedPassword = newp; }
      closePINModal(); alert((lang==="en"?"PIN changed.":"PIN cambiado."));
    }
  });

  async function recordFailedAttempt(){
    failedAttempts = Number(localStorage.getItem("timeout_failed") || 0) + 1;
    localStorage.setItem("timeout_failed", String(failedAttempts));
    const limit = Number(localStorage.getItem(LS.autoWipe) || 0);
    if(limit>0 && failedAttempts >= limit){
      clearAllLocal(); alert("Local data wiped (auto-wipe)."); lockToDecoy();
    }
  }

  function showRealApp(){
    $("decoyView").classList.add("hidden-soft");
    $("realApp").classList.remove("hidden-soft");
    setTab('home');
    if(!localStorage.getItem(LS.disclaimer)){
      $("firstRunDisc").classList.remove("hidden-soft");
    }
  }
  function lockToDecoy(){
    unlocked=false; unlockedPassword=null;
    $("realApp").classList.add("hidden-soft");
    $("decoyView").classList.remove("hidden-soft");
    setTab('home');
  }
  $("lockBtn").addEventListener("click", lockToDecoy);
  $("quickExitBtn").addEventListener("click", ()=> location.href="https://www.google.com/");

  $("acceptDisclaimer").addEventListener("click", ()=> { localStorage.setItem(LS.disclaimer,"1"); $("firstRunDisc").classList.add("hidden-soft"); });
  $("declineDisclaimer").addEventListener("click", ()=> { $("firstRunDisc").classList.add("hidden-soft"); lockToDecoy(); });

  function setTab(name){
    const m = {home:$("tabHomeBtn"),checkin:$("tabCheckBtn"),plan:$("tabPlanBtn"),resources:$("tabResBtn"),profile:$("tabProfileBtn")};
    Object.keys(m).forEach(k=> m[k].classList.toggle("active", k===name));
    $("tab-home").classList.toggle("hidden-soft", name!=='home');
    $("tab-checkin").classList.toggle("hidden-soft", name!=='checkin');
    $("tab-plan").classList.toggle("hidden-soft", name!=='plan');
    $("tab-resources").classList.toggle("hidden-soft", name!=='resources');
    $("tab-profile").classList.toggle("hidden-soft", name!=='profile');
  }
  $("tabHomeBtn").addEventListener("click", ()=> setTab('home'));
  $("tabCheckBtn").addEventListener("click", ()=> setTab('checkin'));
  $("tabPlanBtn").addEventListener("click", ()=> setTab('plan'));
  $("tabResBtn").addEventListener("click", ()=> setTab('resources'));
  $("tabProfileBtn").addEventListener("click", ()=> setTab('profile'));
  $("goToCheckIn").addEventListener("click", ()=> setTab('checkin'));

  const QUESTIONS = [
    {id:"q1",key:"Are you currently safe where you are?", invert:true},
    {id:"q2",key:"Has someone threatened you recently?"},
    {id:"q3",key:"Have you experienced physical harm in past month?"},
    {id:"q4",key:"Are you worried about your partner’s access to your phone?"},
    {id:"q5",key:"Is anyone preventing you from leaving?"},
    {id:"q6",key:"Do you have children at risk?"},
    {id:"q7",key:"Do you feel isolated from help?"},
    {id:"q8",key:"Would you like immediate local resources?"}
  ];

  const FEEDBACK = {
    en:{
      green:{title:"Small concerns — you’re doing okay", body:"Your answers show low immediate risk. Keep connected to trusted people and update your plan as needed."},
      yellow:{title:"Some concerns — consider extra steps", body:"There are warning signs. Update your plan, tell a trusted person, and consider support services."},
      red:{title:"High risk — prioritize safety now", body:"If you are in immediate danger, call local emergency services. Consider sending an encrypted summary to a trusted contact."}
    },
    es:{
      green:{title:"Pocas preocupaciones — estás bien por ahora", body:"Bajo riesgo inmediato. Mantente conectada/o y actualiza tu plan cuando sea necesario."},
      yellow:{title:"Algunas preocupaciones — pasos extra", body:"Hay señales de alerta. Actualiza tu plan, habla con alguien de confianza y considera servicios de apoyo."},
      red:{title:"Alto riesgo — prioriza tu seguridad", body:"Si hay peligro inmediato, llama a emergencias. Considera enviar un resumen cifrado a alguien de confianza."}
    }
  };

  const Q_PROMPTS = {
    en:{
      q1_yes:"Good — keep escape routes clear and know a safe place to go.",
      q1_no:"You may be at immediate risk. Move to a public place or contact a trusted person.",
      q2_yes:"Threats increase risk. Record dates/times safely.",
      q2_no:"Positive — continue to monitor for changes.",
      q3_yes:"Seek medical help and document injuries if safe.",
      q3_no:"Good — keep prevention steps in your plan.",
      q4_yes:"If your phone can be checked, avoid storing sensitive content and use quick-wipe.",
      q4_no:"Maintain screen locks and privacy settings.",
      q5_yes:"Plan discreet exits and ask trusted helpers.",
      q5_no:"Keep plans ready if things change.",
      q6_yes:"Include children in the plan: meeting places and caregivers.",
      q6_no:"Focus on your own plan but keep essentials ready.",
      q7_yes:"Try to contact one trusted person or a local group.",
      q7_no:"Maintain those connections.",
      q8_yes:"Visit Resources and copy hotline numbers instead of calling if logs are a concern.",
      q8_no:"Resources remain available when you want them."
    },
    es:{
      q1_yes:"Bien — mantén salidas libres y un lugar seguro en mente.",
      q1_no:"Podrías estar en riesgo inmediato. Ve a un lugar público o contacta a alguien de confianza.",
      q2_yes:"Las amenazas aumentan el riesgo. Anota fechas/horas de forma segura.",
      q2_no:"Señal positiva — sigue observando cambios.",
      q3_yes:"Busca atención médica y documenta lesiones si es seguro.",
      q3_no:"Bien — mantén medidas de prevención.",
      q4_yes:"Si pueden revisar tu teléfono, evita contenido sensible y usa borrado rápido.",
      q4_no:"Mantén bloqueo de pantalla y privacidad.",
      q5_yes:"Planifica salidas discretas y pide ayuda a personas de confianza.",
      q5_no:"Ten planes listos por si cambia la situación.",
      q6_yes:"Incluye a los niños: puntos de encuentro y cuidadores.",
      q6_no:"Enfócate en tu plan y ten lo esencial listo.",
      q7_yes:"Contacta a una persona de confianza o grupo local.",
      q7_no:"Mantén esas conexiones.",
      q8_yes:"Ve a Recursos y copia números en lugar de llamar si te preocupa el historial.",
      q8_no:"Los recursos estarán disponibles cuando los necesites."
    }
  };

  let lang = localStorage.getItem("timeout_lang") || "en";
  function applyLang(){
    $("langToggle").textContent = (lang==="en" ? "EN | ES" : "ES | EN");
    $("hdrSub").textContent = (lang==="en" ? "Clock" : "Reloj");
    buildQuestions(); renderResources(); renderPlans(); refreshUI();
  }
  $("langToggle").onclick = () => {
    lang = (lang === "en" ? "es" : "en");
    localStorage.setItem("timeout_lang", lang);
    applyLang();
  };

  function buildQuestions(){
    const box = $("questions"); box.innerHTML = "";
    QUESTIONS.forEach((q,i)=>{
      const row = document.createElement("div"); row.className = "card";
      const label = document.createElement("div"); label.className = "font-semibold small mb-2"; label.textContent = `${i+1}. ${q.key}`;
      const wrap = document.createElement("div"); wrap.style.display="flex"; wrap.style.gap="8px";
      const yes = document.createElement("button"); yes.className="btn btn-ghost flex-1"; yes.textContent = (lang==="en"?"Yes":"Sí");
      const no = document.createElement("button"); no.className="btn btn-ghost flex-1"; no.textContent = "No";
      yes.addEventListener("click", ()=>{ core.answers[q.id]="yes"; mark(); updateScoresAndFeedback(); saveCoreEncryptedIfUnlocked(); });
      no.addEventListener("click", ()=>{ core.answers[q.id]="no"; mark(); updateScoresAndFeedback(); saveCoreEncryptedIfUnlocked(); });
      function mark(){
        yes.classList.toggle("bg-green-600", core.answers[q.id]==="yes"); yes.classList.toggle("text-white", core.answers[q.id]==="yes");
        no.classList.toggle("bg-rose-600", core.answers[q.id]==="no");   no.classList.toggle("text-white", core.answers[q.id]==="no");
      }
      if(core.answers[q.id]) mark();
      row.appendChild(label); wrap.appendChild(yes); wrap.appendChild(no); row.appendChild(wrap); box.appendChild(row);
    });
  }

  function computeRiskTrust(){
    let risky = 0;
    QUESTIONS.forEach(q=>{
      const a = (core.answers[q.id]||"").toLowerCase();
      if(!a) return;
      if(q.invert){ if(a==="no") risky++; } else { if(a==="yes") risky++; }
    });
    const risk = Math.round((risky/QUESTIONS.length)*100);
    const trust = 100 - risk;
    return { risk, trust };
  }

  function updateScoresAndFeedback(){
    const { risk, trust } = computeRiskTrust();
    $("riskPct").textContent = `${risk}%`;
    $("trustPct").textContent = `${trust}%`;
    $("trustBadge").textContent = `${trust}%`;
    core.profile.trust = trust;
    saveCoreLocals();
    renderFeedback();
  }

  function renderFeedback(){
    const { risk } = computeRiskTrust();
    let tier = "green"; if(risk>=66) tier="red"; else if(risk>=26) tier="yellow";
    const f = FEEDBACK[lang][tier];
    const fb = $("checkFeedback"); fb.innerHTML = "";
    const wrap = document.createElement("div"); wrap.className = "card";
    const title = document.createElement("div"); title.className = "font-semibold"; title.textContent = f.title;
    const body = document.createElement("div"); body.className = "small mt-2"; body.textContent = f.body;
    wrap.appendChild(title); wrap.appendChild(body);

    const actions = document.createElement("div"); actions.style.marginTop="10px"; actions.style.display="flex"; actions.style.gap="8px";
    const copyHotline = document.createElement("button"); copyHotline.className="btn btn-ghost"; copyHotline.textContent=(lang==="en"?"Copy local hotline":"Copiar línea local");
    copyHotline.addEventListener("click", ()=> { navigator.clipboard?.writeText("1-800-555-1212"); alert((lang==="en"?"Number copied: ":"Número copiado: ")+"1-800-555-1212"); });
    const quickPlanBtn = document.createElement("button"); quickPlanBtn.className="btn btn-primary"; quickPlanBtn.textContent=(lang==="en"?"Create quick plan":"Crear plan rápido");
    quickPlanBtn.addEventListener("click", createQuickPlanFromAnswers);
    const exportBtn = document.createElement("button"); exportBtn.className="btn btn-ghost"; exportBtn.textContent=(lang==="en"?"Export summary":"Exportar resumen");
    exportBtn.addEventListener("click", ()=> exportEncryptedSnapshotPrompt());
    if(tier==="green"){ actions.append(copyHotline, exportBtn); }
    else if(tier==="yellow"){ actions.append(quickPlanBtn, copyHotline); }
    else { actions.append(copyHotline, exportBtn); }

    wrap.appendChild(actions);

    const promptsWrap = document.createElement("div"); promptsWrap.style.marginTop="12px";
    QUESTIONS.forEach((q)=>{
      const a = core.answers[q.id]; if(!a) return;
      const row = document.createElement("div"); row.className="p-2 card"; row.style.marginBottom="8px";
      const qEl = document.createElement("div"); qEl.className="font-semibold small"; qEl.textContent=q.key;
      const pEl = document.createElement("div"); pEl.className="small"; pEl.style.marginTop="6px";
      const key = `${q.id}_${a==="yes"?"yes":"no"}`;
      pEl.textContent = Q_PROMPTS[lang][key] || "";
      row.appendChild(qEl); row.appendChild(pEl); promptsWrap.appendChild(row);
    });
    if(Object.keys(core.answers||{}).length===0){ const empty=document.createElement("div"); empty.className="small"; empty.textContent=(lang==="en"?"No answers yet.":"Aún no hay respuestas."); promptsWrap.appendChild(empty); }

    fb.appendChild(wrap); fb.appendChild(promptsWrap);
  }

  $("demoLoadBtn").addEventListener("click", ()=>{
    core.answers = { q1:"no", q2:"yes", q3:"no", q4:"yes", q5:"no", q6:"no", q7:"yes", q8:"yes" };
    buildQuestions(); updateScoresAndFeedback(); setTab('checkin');
  });

  function createQuickPlanFromAnswers(){
    const plan = {
      id:"plan_"+Date.now(),
      title:(lang==="en"?"Quick Plan":"Plan Rápido")+" "+new Date().toLocaleString(),
      summary:"Auto-generated quick plan",
      items:{ safePlace:(core.answers.q1==="no")?(lang==="en"?"Public place / friend's home":"Lugar público / casa de confianza"):(lang==="en"?"Home — keep exits clear":"Casa — mantén salidas claras"), contact:(lang==="en"?"Trusted contact: [name/number]":"Contacto de confianza: [nombre/número]"), bag:(lang==="en"?"ID, cash, keys, phone charger":"ID, dinero, llaves, cargador") }
    };
    core.plans = core.plans || [];
    core.plans.push(plan);
    saveCoreEncryptedIfUnlocked(); renderPlans();
    alert(lang==="en"?"Quick plan created.":"Plan rápido creado.");
  }

  function renderPlans(){
    const list = $("planList"); list.innerHTML="";
    (core.plans||[]).forEach((p,i)=>{
      const el = document.createElement("div"); el.className="p-3 card flex items-center justify-between gap-2";
      const txt = document.createElement("div"); txt.innerHTML=`<div class="font-semibold">${p.title||"Plan"}</div><div class="small">${p.summary||""}</div>`;
      const actions = document.createElement("div");
      const open = document.createElement("button"); open.className="btn btn-ghost"; open.textContent=(lang==="en"?"Open":"Abrir"); open.addEventListener("click", ()=> openPlanEditor(i));
      const del = document.createElement("button"); del.className="btn btn-ghost"; del.textContent=(lang==="en"?"Delete":"Eliminar"); del.addEventListener("click", ()=>{ core.plans.splice(i,1); saveCoreEncryptedIfUnlocked(); renderPlans(); });
      actions.append(open,del); el.append(txt,actions); list.appendChild(el);
    });
  }
  function openPlanEditor(index){
    const p = core.plans[index];
    const title = prompt((lang==="en"?"Plan title:":"Título del plan:"), p.title||"");
    if(title===null) return;
    const summary = prompt((lang==="en"?"Short summary:":"Resumen corto:"), p.summary||"");
    core.plans[index] = { ...p, title, summary };
    saveCoreEncryptedIfUnlocked(); renderPlans();
  }

  function renderResources(){
    const list = $("resourceList"); list.innerHTML="";
    (core.resources||[]).forEach((r,i)=>{
      const li = document.createElement("li"); li.className="p-3 card flex items-start justify-between gap-3";
      const txt = document.createElement("div");
      const t = document.createElement("div"); t.className="font-semibold"; t.textContent=r.title||"Untitled";
      const d = document.createElement("div"); d.className="small text-gray-300"; d.textContent=r.desc||"";
      const u = document.createElement("a"); u.className="text-blue-400 underline small"; u.href=r.url||"#"; u.target="_blank"; u.rel="noreferrer"; u.textContent=r.url||"";
      txt.append(t); if(r.desc) txt.append(d); if(r.url) txt.append(u);
      const del = document.createElement("button"); del.className="btn btn-ghost"; del.textContent=(lang==="en"?"Delete":"Eliminar");
      del.addEventListener("click", ()=>{ core.resources.splice(i,1); saveCoreEncryptedIfUnlocked(); renderResources(); });
      li.append(txt,del); list.appendChild(li);
    });
  }

  $("btnAddResource").addEventListener("click",(e)=>{
    e.preventDefault();
    const it = { title:$("resTitleInput").value.trim(), desc:$("resDesc").value.trim(), url:$("resUrl").value.trim() };
    if(!it.title){ alert((lang==="en"?"Title required":"Título requerido")); return; }
    core.resources = core.resources || []; core.resources.push(it);
    saveCoreEncryptedIfUnlocked(); renderResources();
    $("resTitleInput").value=$("resDesc").value=$("resUrl").value="";
  });
  $("btnCopyHotline").addEventListener("click", ()=> { navigator.clipboard?.writeText("1-800-555-1212"); alert((lang==="en"?"Copied example hotline":"Línea de ejemplo copiada")+": 1-800-555-1212"); });

  async function exportEncryptedSnapshotPrompt(){
    if(!unlockedPassword){ alert((lang==="en"?"Unlock the app to export securely.":"Desbloquea la app para exportar de forma segura.")); return; }
    const pass = prompt((lang==="en"?"Enter export passphrase (required to import):":"Introduce una contraseña para exportar (se requerirá para importar):"));
    if(!pass) return;
    const snapshot = { profile: core.profile, answers: core.answers, resources: core.resources, plans: core.plans, version: APP_VER };
    const blob = await encryptWithPassword(snapshot, pass);
    const file = new Blob([JSON.stringify(blob)], { type: "application/json" });
    const url = URL.createObjectURL(file);
    const a = document.createElement("a"); a.href = url; a.download = "timeout-export.json"; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
  }
  $("exportJson").addEventListener("click", exportEncryptedSnapshotPrompt);

  $("importJsonBtn").addEventListener("click", async ()=>{
    const f = $("importJsonFile").files[0];
    if(!f){ alert((lang==="en"?"Select a file first.":"Selecciona un archivo primero.")); return; }
    const txt = await f.text();
    try{
      const blob = JSON.parse(txt);
      const pass = prompt((lang==="en"?"Enter import passphrase:":"Introduce la contraseña para importar:"));
      if(!pass) return;
      const data = await decryptWithPassword(blob, pass);
      const replace = confirm((lang==="en"?"Replace local data? Cancel to merge.":"¿Reemplazar datos locales? Cancelar para fusionar."));
      if(replace) core = data;
      else{
        core = Object.assign(core, data);
        core.resources = [...(core.resources||[]), ...(data.resources||[])];
        core.plans = [...(core.plans||[]), ...(data.plans||[])];
      }
      saveCoreEncryptedIfUnlocked(); buildQuestions(); renderResources(); renderPlans(); updateScoresAndFeedback();
      alert((lang==="en"?"Import successful.":"Importación exitosa."));
    }catch(e){ alert((lang==="en"?"Import failed or wrong passphrase.":"Importación fallida o contraseña incorrecta.")); }
  });

  function clearAllLocal(){
    localStorage.removeItem(LS.enc);
    localStorage.removeItem(LS.pinCheck);
    localStorage.removeItem(LS.duressCheck);
    localStorage.removeItem(LS.profile);
    localStorage.removeItem(LS.answers);
    localStorage.removeItem(LS.resources);
    localStorage.removeItem(LS.plans);
    localStorage.removeItem(LS.disclaimer);
    localStorage.removeItem(LS.autoWipe);
    localStorage.removeItem("timeout_failed");
    core = { profile:{name:"Anonymous", trust:100}, answers:{}, resources:[], plans:[], settings:{} };
    unlocked = false; unlockedPassword = null;
  }
  $("clearData").addEventListener("click", ()=> {
    if(confirm((lang==="en"?"Clear ALL local data? This is irreversible.":"¿Borrar TODOS los datos locales? Esto es irreversible."))){
      clearAllLocal(); lockToDecoy(); alert((lang==="en"?"Local data cleared.":"Datos locales borrados."));
    }
  });

  async function saveCoreEncryptedIfUnlocked(){
    if(!unlocked || !unlockedPassword){ saveCoreLocals(); return; }
    await saveEncryptedCore(unlockedPassword);
    saveCoreLocals();
    try{ if(window.saveProfileMirror) saveProfileMirror(core.profile); }catch(e){}
  }
  function saveCoreLocals(){
    localStorage.setItem(LS.profile, JSON.stringify(core.profile||{}));
    localStorage.setItem(LS.answers, JSON.stringify(core.answers||{}));
    localStorage.setItem(LS.resources, JSON.stringify(core.resources||[]));
    localStorage.setItem(LS.plans, JSON.stringify(core.plans||[]));
  }

  function refreshUI(){
    $("profileName").textContent = core.profile.name || "Anonymous";
    $("homeName").textContent = core.profile.name || "Anonymous";
    $("homeTrust").textContent = core.profile.trust || 100;
    $("displayNameInput") && ($("displayNameInput").value = core.profile.name || "");
    buildQuestions(); renderResources(); renderPlans(); updateScoresAndFeedback();
  }

  document.addEventListener("visibilitychange", ()=> { if(document.hidden && unlocked) lockToDecoy(); });

  if(window.DeviceMotionEvent){
    window.addEventListener('devicemotion', (e)=>{
      if(!($("toggleShake")?.checked)) return;
      const a = e.accelerationIncludingGravity; if(!a) return;
      const s = Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z);
      if(s>30){ const now=Date.now(); if(!window.__lastShake || now-window.__lastShake>1500){ window.__lastShake=now; lockToDecoy(); } }
    });
  }

  $("saveProfile").addEventListener("click", ()=> {
    core.profile.name = $("displayNameInput").value.trim() || "Anonymous";
    saveCoreEncryptedIfUnlocked(); refreshUI(); alert((lang==="en"?"Profile saved.":"Perfil guardado."));
  });
  $("profileChangePinBtn").addEventListener("click", async ()=>{
    const np = $("profileChangePin").value.trim();
    if(!np || np.length<4){ alert((lang==="en"?"PIN must be at least 4 digits.":"El PIN debe tener al menos 4 dígitos.")); return; }
    const chk = await createPinCheck(np);
    localStorage.setItem(LS.pinCheck, JSON.stringify(chk));
    if(unlockedPassword){ await saveEncryptedCore(np); unlockedPassword = np; }
    $("profileChangePin").value=""; alert((lang==="en"?"PIN changed.":"PIN cambiado."));
  });
  $("profileSetDuress").addEventListener("click", async ()=>{
    const dp = $("profileDuressPin").value.trim();
    if(!dp){ alert((lang==="en"?"Enter duress PIN.":"Introduce PIN de coacción.")); return; }
    const chk = await createPinCheck(dp);
    localStorage.setItem(LS.duressCheck, JSON.stringify(chk));
    $("profileDuressPin").value=""; alert((lang==="en"?"Duress PIN set.":"PIN de coacción establecido."));
  });

  $("autoWipeSelect").addEventListener("change", ()=> { localStorage.setItem(LS.autoWipe, $("autoWipeSelect").value); });

  $("saveCheckIn").addEventListener("click", async ()=>{
    await saveCoreEncryptedIfUnlocked();
    try{ if(window.saveCheckinToFirestore) await window.saveCheckinToFirestore({ answers: core.answers, profile: core.profile }); }catch(e){}
    alert((lang==="en"?"Check-in saved.":"Revisión guardada."));
  });

  $("goToCheckIn").addEventListener("click", ()=> setTab('checkin'));

  (function boot(){
    try{ const meta = JSON.parse(localStorage.getItem(LS.meta)||"{}"); if(meta.skin) setSkin(meta.skin); }catch{}
    try{ core.profile = JSON.parse(localStorage.getItem(LS.profile)) || core.profile; }catch{}
    try{ core.answers = JSON.parse(localStorage.getItem(LS.answers)) || core.answers; }catch{}
    try{ core.resources = JSON.parse(localStorage.getItem(LS.resources)) || core.resources; }catch{}
    try{ core.plans = JSON.parse(localStorage.getItem(LS.plans)) || core.plans; }catch{}
    applyLang();
  })();// Dev panel (optional)
  const printDev = ()=> {
    const el = $("devState"); if(!el) return;
    el.textContent = JSON.stringify({ profile:core.profile, answers:core.answers, plans:core.plans, resources:core.resources }, null, 2);
  };
  setInterval(()=> printDev(), 1500);

  // Close everything with ESC when unlocked
  document.addEventListener("keydown", (e)=> { if(e.key==="Escape" && unlocked) lockToDecoy(); });
  </script><!-- PATCH: force-close the Disclaimer overlay reliably -->
<script>
(function(){
  // Ensure the disclaimer overlay can never get "stuck" on top
  const closeDisclaimer = () => {
    try {
      localStorage.setItem('timeout_disclaimer_accepted','1');
      const overlay = document.getElementById('firstRunDisc');
      if (overlay) overlay.classList.add('hidden-soft');
      document.body.style.overflow = 'auto';
    } catch(e){}
  };

  // Rebind buttons safely (adds closures even if earlier code exists)
  const accept = document.getElementById('acceptDisclaimer');
  const decline = document.getElementById('declineDisclaimer');
  if (accept) accept.onclick = closeDisclaimer;
  if (decline) decline.onclick = () => {
    const overlay = document.getElementById('firstRunDisc');
    if (overlay) overlay.classList.add('hidden-soft');
    // send back to decoy just in case
    const real = document.getElementById('realApp');
    const decoy = document.getElementById('decoyView');
    if (real && decoy) { real.classList.add('hidden-soft'); decoy.classList.remove('hidden-soft'); }
    document.body.style.overflow = 'auto';
  };

  // Extra safety: any tab click also hides it (in case it lingered)
  ['tabHomeBtn','tabCheckBtn','tabPlanBtn','tabResBtn','tabProfileBtn'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.addEventListener('click', closeDisclaimer, { once:true });
  });
})();
</script><!-- HARD KILL for stuck Disclaimer -->
<script>
(function(){
  const KEY='timeout_disclaimer_accepted';
  function hideOverlay(){
    const el=document.getElementById('firstRunDisc');
    if(!el) return;
    el.classList.add('hidden-soft');
    el.style.display='none';
    el.style.pointerEvents='none';
    try{ el.remove(); }catch(e){}
    document.body.style.overflow='auto';
  }
  // If already accepted before, remove immediately
  try{ if(localStorage.getItem(KEY)==='1'){ hideOverlay(); } }catch(e){}

  // Rebind buttons to force-remove
  const acc=document.getElementById('acceptDisclaimer');
  const dec=document.getElementById('declineDisclaimer');
  if(acc) acc.onclick=()=>{ try{localStorage.setItem(KEY,'1');}catch(e){} hideOverlay(); };
  if(dec) dec.onclick=()=>{ hideOverlay();
    const real=document.getElementById('realApp'), decoy=document.getElementById('decoyView');
    if(real&&decoy){ real.classList.add('hidden-soft'); decoy.classList.remove('hidden-soft'); }
  };

  // Extra: any click inside main app hides it if it somehow lingers
  ['tabHomeBtn','tabCheckBtn','tabPlanBtn','tabResBtn','tabProfileBtn','saveCheckIn','goToCheckIn','btnQuickGenerate']
    .forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('click', hideOverlay, {once:true}); });
})();
</script><!-- CONSOLIDATED PATCH: bilingual Qs + plans working + resources preload + talk tips + overlay & unlock fixes -->
<script>
(function(){
  /* ---------- 0) UTIL ---------- */
  const getLang = ()=> (localStorage.getItem("timeout_lang")||"en");
  const isEN = ()=> getLang()==="en";

  /* ---------- 1) PRELOAD RESOURCES (once) ---------- */
  (function preloadResourcesOnce(){
    const KEY="timeout_resources";
    try{
      const existing = JSON.parse(localStorage.getItem(KEY)||"[]");
      if (Array.isArray(existing) && existing.length>0) return; // don't overwrite
      const R = [
        { title:isEN()?"National Domestic Violence Hotline (US)":"Línea Nacional de Violencia Doméstica (EE. UU.)", desc:isEN()?"24/7 confidential support":"Atención confidencial 24/7", url:"https://www.thehotline.org/ 1-800-799-7233" },
        { title:isEN()?"RAINN Sexual Assault Hotline (US)":"RAINN Línea de Agresión Sexual (EE. UU.)", desc:isEN()?"24/7 — chat & phone":"24/7 — chat y teléfono", url:"https://www.rainn.org/ 1-800-656-4673" },
        { title:isEN()?"Childhelp National Child Abuse Hotline (US)":"Childhelp Línea Nacional de Abuso Infantil (EE. UU.)", desc:isEN()?"24/7 — children & adults":"24/7 — para niños y adultos", url:"https://www.childhelp.org/ 1-800-422-4453" },
        { title:isEN()?"Elder Abuse Resource (NCEA)":"Recurso para Abuso a Personas Mayores (NCEA)", desc:isEN()?"Info & reporting paths":"Información y vías de reporte", url:"https://ncea.acl.gov/" },
        { title:isEN()?"Local Social Services Finder":"Buscador de Servicios Sociales Locales", desc:isEN()?"Locate nearby assistance":"Encuentra ayuda cercana", url:"https://www.211.org/" },
        { title:isEN()?"Emergency (If in immediate danger)":"Emergencias (Si hay peligro inmediato)", desc:isEN()?"Call your local emergency number":"Llama al número de emergencias local", url:"911" }
      ];
      localStorage.setItem(KEY, JSON.stringify(R));
      if (typeof window.renderResources === "function") window.renderResources();
      document.dispatchEvent(new Event("resources-updated"));
    }catch(e){}
  })();

  /* ---------- 2) TRUE BILINGUAL QUESTIONS (labels update) ---------- */
  const Q_EN = [
    "Are you currently safe where you are?",
    "Has someone threatened you recently?",
    "Have you experienced physical harm in past month?",
    "Are you worried about your partner’s access to your phone?",
    "Is anyone preventing you from leaving?",
    "Do you have children at risk?",
    "Do you feel isolated from help?",
    "Would you like immediate local resources?"
  ];
  const Q_ES = [
    "¿Estás segura/o donde estás ahora?",
    "¿Alguien te ha amenazado recientemente?",
    "¿Has sufrido daño físico en el último mes?",
    "¿Te preocupa que tu pareja tenga acceso a tu teléfono?",
    "¿Alguien te impide salir?",
    "¿Tienes hijas/os en riesgo?",
    "¿Te sientes aislada/o de la ayuda?",
    "¿Quieres recursos locales de inmediato?"
  ];

  function relabelQuestions(){
    const texts = isEN()? Q_EN : Q_ES;
    const container = document.getElementById("questions");
    if(!container) return;
    const rows = Array.from(container.querySelectorAll(".card"));
    rows.forEach((row, idx)=>{
      const label = row.querySelector(".font-semibold.small");
      if(label && texts[idx]) label.textContent = `${idx+1}. ${texts[idx]}`;
      const btns = row.querySelectorAll("button");
      if(btns.length>=2){
        btns[0].textContent = isEN()?"Yes":"Sí";
        btns[1].textContent = isEN()?"No":"No";
      }
    });
    const t = document.getElementById("checkTitle");
    if(t) t.textContent = isEN()? "Safety Check-In" : "Revisión de seguridad";
    const demo = document.getElementById("demoLoadBtn");
    if(demo) demo.textContent = isEN()? "Load Demo Answers" : "Cargar respuestas de demo";
    const quickExitBtn = document.getElementById("quickExitBtn");
    if(quickExitBtn) quickExitBtn.textContent = isEN()? "Home" : "Inicio";
  }

  // apply now and after language toggle
  relabelQuestions();
  const langToggle = document.getElementById("langToggle");
  if(langToggle){
    langToggle.addEventListener("click", ()=> setTimeout(relabelQuestions, 10));
    langToggle.textContent = isEN()? "EN | ES" : "ES | EN";
  }

  /* ---------- 3) SAFETY PLAN BUTTONS (make them work) ---------- */
  function plans(){ try{ return JSON.parse(localStorage.getItem("timeout_plans")||"[]"); }catch{ return []; } }
  function setPlans(arr){ localStorage.setItem("timeout_plans", JSON.stringify(arr)); }
  function renderPlansLite(){
    const list = document.getElementById("planList"); if(!list) return;
    const arr = plans();
    list.innerHTML = "";
    arr.forEach((p,i)=>{
      const el = document.createElement("div");
      el.className="p-3 card flex items-center justify-between gap-2";
      const txt = document.createElement("div");
      txt.innerHTML = `<div class="font-semibold">${p.title||"Plan"}</div><div class="small">${p.summary||""}</div>`;
      const actions = document.createElement("div");
      const open = document.createElement("button");
      open.className="btn btn-ghost";
      open.textContent = isEN()? "Open" : "Abrir";
      open.onclick = ()=>{
        const t = prompt(isEN()? "Title:" : "Título:", p.title||"");
        if(t===null) return;
        const s = prompt(isEN()? "Summary:" : "Resumen:", p.summary||"");
        const arr2 = plans(); arr2[i] = { ...arr2[i], title:t, summary:s };
        setPlans(arr2); renderPlansLite();
      };
      const del = document.createElement("button");
      del.className="btn btn-ghost";
      del.textContent = isEN()? "Delete" : "Eliminar";
      del.onclick = ()=>{ const arr2 = plans(); arr2.splice(i,1); setPlans(arr2); renderPlansLite(); };
      actions.append(open, del);
      el.append(txt, actions);
      list.appendChild(el);
    });
  }
  renderPlansLite();

  const btnNew = document.getElementById("btnNewPlan");
  if(btnNew) btnNew.onclick = ()=>{
    const t = prompt(isEN()? "Plan title:" : "Título del plan:");
    if(!t) return;
    const s = prompt(isEN()? "Short summary:" : "Resumen corto:") || "";
    const arr = plans(); arr.push({ id:"plan_"+Date.now(), title:t, summary:s, items:{} }); setPlans(arr);
    renderPlansLite(); alert(isEN()? "Plan created." : "Plan creado.");
  };

  const btnTemplates = document.getElementById("btnTemplates");
  if(btnTemplates) btnTemplates.onclick = ()=>{
    const templates = [
      {title:isEN()?"Grab-and-Go Bag":"Bolsa de emergencia", summary:isEN()?"List items + hidden spot":"Lista de artículos + lugar oculto"},
      {title:isEN()?"Trusted Contacts":"Contactos de confianza", summary:isEN()?"Names & numbers":"Nombres y teléfonos"},
      {title:isEN()?"Safe Exit Plan":"Salida segura", summary:isEN()?"Safe place & transport":"Lugar seguro y transporte"}
    ];
    const pick = prompt((isEN()?"Templates:\n":"Plantillas:\n")+templates.map((t,i)=>`${i+1}. ${t.title}`).join("\n")+"\n"+(isEN()?"Number:":"Número:"));
    const n = Number(pick);
    if(n>=1 && n<=templates.length){
      const arr = plans(); arr.push({ id:"plan_"+Date.now(), ...templates[n-1], items:{} }); setPlans(arr);
      renderPlansLite(); alert(isEN()? "Template added." : "Plantilla añadida.");
    }
  };

  const btnQuick = document.getElementById("btnQuickGenerate");
  if(btnQuick) btnQuick.onclick = ()=>{
    let a={}; try{ a = JSON.parse(localStorage.getItem("timeout_answers")||"{}"); }catch{}
    const parts=[];
    if(a.q1==="no") parts.push(isEN()? "Safe site: public place or trusted home." : "Sitio seguro: lugar público o casa de confianza.");
    if(a.q2==="yes") parts.push(isEN()? "Record threats privately (date/time)." : "Registra amenazas en privado (fecha/hora).");
    if(a.q4==="yes") parts.push(isEN()? "Avoid storing sensitive content; consider quick-wipe." : "Evita contenido sensible; considera borrado rápido.");
    if(parts.length===0) parts.push(isEN()? "Keep exits clear and contacts ready." : "Mantén salidas despejadas y contactos listos.");
    const arr = plans(); arr.push({ id:"plan_"+Date.now(), title:isEN()? "Quick Plan":"Plan Rápido", summary:parts.join(" "), items:{} }); setPlans(arr);
    renderPlansLite(); alert(isEN()? "Quick plan created." : "Plan rápido creado.");
  };

  /* ---------- 4) TALK TO THE APP (rule-based supportive tips) ---------- */
  const talkBtn = document.getElementById("talkBtn");
  if(talkBtn) talkBtn.onclick = ()=>{
    let a={}; try{ a = JSON.parse(localStorage.getItem("timeout_answers")||"{}"); }catch{}
    const lines = [];
    if(a.q1==="no") lines.push(isEN()? "You might not be safe now. Move to a public place or contact someone you trust." : "Podrías no estar segura/o ahora. Ve a un lugar público o contacta a alguien de confianza.");
    if(a.q2==="yes") lines.push(isEN()? "Threats raise risk. Note dates/times privately." : "Las amenazas elevan el riesgo. Anota fechas/horas en privado.");
    if(a.q4==="yes") lines.push(isEN()? "Phone privacy: avoid sensitive content; use quick wipe if needed." : "Privacidad del teléfono: evita contenido sensible; usa borrado rápido si es necesario.");
    if(a.q7==="yes") lines.push(isEN()? "Message one trusted person today." : "Escribe hoy a una persona de confianza.");
    if(a.q8==="yes") lines.push(isEN()? "Open Resources; copy numbers if call logs worry you." : "Abre Recursos; copia números si te preocupan los historiales.");
    if(lines.length===0) lines.push(isEN()? "Low immediate risk suggested. Keep your plan updated." : "Riesgo inmediato bajo. Mantén tu plan actualizado.");

    const box = document.getElementById("checkFeedback");
    if(box){
      const card = document.createElement("div"); card.className="card mt-2";
      const h = document.createElement("div"); h.className="font-semibold"; h.textContent = isEN()? "Quick suggestions" : "Sugerencias rápidas";
      const p = document.createElement("div"); p.className="small mt-2"; p.innerHTML = lines.map(l=>"• "+l).join("<br>");
      card.append(h,p); box.prepend(card);
    }
  };

  /* ---------- 5) OVERLAY FAILSAFE + HASH UNLOCK + WIDER LONG-PRESS ---------- */
  function killDisclaimer(){
    const el=document.getElementById('firstRunDisc');
    if(el){ try{ el.classList.add('hidden-soft'); el.style.display='none'; el.remove(); }catch{} }
    document.body.style.overflow='auto';
  }
  // bind close on accept/decline
  const acc=document.getElementById('acceptDisclaimer');
  const dec=document.getElementById('declineDisclaimer');
  if(acc) acc.onclick = ()=>{ try{ localStorage.setItem('timeout_disclaimer_accepted','1'); }catch{} killDisclaimer(); };
  if(dec) dec.onclick = ()=>{ killDisclaimer(); const real=$('realApp'), decoy=$('decoyView'); if(real&&decoy){ real.classList.add('hidden-soft'); decoy.classList.remove('hidden-soft'); } };

  // also close overlay on common actions
  ['saveCheckIn','btnQuickGenerate','btnTemplates','btnNewPlan','talkBtn'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.addEventListener('click', killDisclaimer, {capture:true});
  });

  // hash unlock: /#unlock opens PIN right away
  function hashUnlock(){
    if(location.hash === '#unlock'){
      const modal = document.getElementById('pinModal');
      if(modal) modal.classList.remove('hidden-soft');
      const inp = document.getElementById('pinInput'); if(inp) setTimeout(()=>inp.focus(),50);
    }
  }
  window.addEventListener('hashchange', hashUnlock); hashUnlock();

  // widen long-press to whole decoy card
  function addLongPress(el, action){
    if(!el) return; let t;
    const start=()=>{ t=setTimeout(action,800); }, stop=()=>clearTimeout(t);
    el.addEventListener('mousedown',start); el.addEventListener('mouseup',stop); el.addEventListener('mouseleave',stop);
    el.addEventListener('touchstart',start,{passive:true}); el.addEventListener('touchend',stop); el.addEventListener('touchcancel',stop);
  }
  const decoy = document.getElementById('decoyView');
  addLongPress(decoy, ()=>{
    const modal = document.getElementById('pinModal');
    if(modal) modal.classList.remove('hidden-soft');
    const inp = document.getElementById('pinInput'); if(inp) setTimeout(()=>inp.focus(),50);
  });

  // helper $
  function $(id){ return document.getElementById(id); }
})();
</script>
</body>
</html>
