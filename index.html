<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TimeOut</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96'%3E%3Ccircle cx='48' cy='48' r='46' fill='%23fefce8' stroke='%23365b2c' stroke-width='4'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-size='46' font-family='Arial' fill='%23365b2c'%3ET%3C/text%3E%3C/svg%3E" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --brand:#2563eb;
    --brand-ink:#ffffff;
    --ink:#1f2937;
    --muted:#6b7280;
    --paper:#fafaf9;
    --card:#ffffff;
    --edge:#e5e7eb;
  }
  html,body{background:var(--paper); color:var(--ink);}
  .btn{ padding:.55rem .8rem; border:1px solid var(--edge); border-radius:.8rem; background:var(--card); font-size:.95rem; transition:transform .05s ease; }
  .btn:active{ transform:scale(.97); }
  .btn-primary{ background:var(--brand); color:var(--brand-ink); border-color:var(--brand); }
  .btn-ghost{ background:transparent; border-color:transparent; color:var(--muted); }
  .btn-badge{ font-size:.8rem; padding:.25rem .5rem; border-radius:.5rem; border-color:#d1d5db; }
  .card{ background:var(--card); border:1px solid var(--edge); border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .hidden-soft{ display:none !important; }
  .panel-scroll{ max-height:calc(100vh - 160px); overflow:auto; -webkit-overflow-scrolling:touch; }
  .yn-btn.selected{ background:var(--brand)!important; color:var(--brand-ink)!important; border-color:var(--brand)!important; }
  header .btn { min-width:44px; min-height:44px; }
  #hdrClock,#hdrWeather{ display:inline-flex; align-items:center; max-width:44vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .demo-qs button{ display:block; width:100%; text-align:left; margin:.3rem 0; padding:.45rem .6rem; border-radius:.5rem; background:#f3f4f6; }
  .kbd{ font:600 .78rem/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas; background:#f3f4f6; border:1px solid #e5e7eb; padding:.1rem .35rem; border-radius:.4rem; }
  footer.small{ font-size:.72rem; color:#9ca3af; }
  .q-help{ font-size:.85rem; color:#374151; background:#f9fafb; border:1px dashed #e5e7eb; padding:.5rem .6rem; border-radius:.6rem; margin-top:.5rem; }
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-gray-200">
    <div class="max-w-md mx-auto flex items-center justify-between px-3 py-2">
      <div class="flex items-center gap-2">
        <button id="langToggle" class="btn btn-ghost">EN/ES</button>
        <div id="hdrClock" class="text-sm font-medium">--:--</div>
      </div>
      <h1 id="appTitle" class="text-lg font-semibold select-none">TimeOut</h1>
      <div class="flex items-center gap-2">
        <div id="hdrWeather" class="text-sm">⛅</div>
        <button id="btnBack" class="btn btn-ghost hidden-soft">Back</button>
        <button id="btnQuickExit" class="btn btn-ghost hidden-soft">Exit</button>
        <button id="btnPanic" class="btn btn-ghost hidden-soft">Clear&Lock</button>
      </div>
    </div>
  </header>

  <!-- DECOY VIEW -->
  <main id="decoyView" class="max-w-md mx-auto px-3 pt-4 pb-24">
    <section class="card p-4 mb-3">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Timer</h2>
        <span class="text-xs text-gray-500">Long-press title or timer to unlock</span>
      </div>
      <div id="decoyTimerDisplay" class="text-5xl font-mono text-center my-3 select-none">25:00</div>
      <div class="flex gap-2 justify-center">
        <button id="decoyStart" class="btn">Start</button>
        <button id="decoyPause" class="btn">Pause</button>
        <button id="decoyReset" class="btn">Reset</button>
      </div>
    </section>
    <section class="card p-4 mb-3">
      <h2 class="text-base font-semibold mb-2">Calculator</h2>
      <input id="calcInput" class="w-full border rounded-lg px-3 py-2 mb-2" placeholder="e.g., 12+3*4" inputmode="numeric">
      <button id="calcEval" class="btn">=</button>
      <span id="calcOut" class="ml-3 font-mono"></span>
    </section>
    <section class="card p-4 mb-3">
      <h2 class="text-base font-semibold mb-2">Notes</h2>
      <textarea id="decoyNotes" class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="Quick notes…"></textarea>
    </section>
    <footer class="max-w-md mx-auto text-center mt-4">
      <div class="small">v1.3.6</div>
    </footer>
  </main>

  <!-- REAL APP -->
  <main id="appView" class="max-w-md mx-auto px-3 pt-4 pb-28 hidden-soft">
    <!-- Home -->
    <section id="tab-home" class="panel-scroll">
      <div class="card p-4 mb-3">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold" id="homeTitle">Welcome</h2>
          <span class="btn-badge" id="verBadge">v1.3.6</span>
        </div>
        <p class="text-sm text-gray-600 mb-3" id="homeHello">Hi, Anonymous.</p>
        <div class="grid grid-cols-2 gap-2">
          <div class="card p-3">
            <div class="text-sm text-gray-500">Risk</div>
            <div id="riskPct" class="text-2xl font-mono">0%</div>
          </div>
          <div class="card p-3">
            <div class="text-sm text-gray-500">Trust</div>
            <div id="trustPct" class="text-2xl font-mono">100%</div>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-primary" onclick="setTab('checkin')">Go to Check-In</button>
          <button class="btn" onclick="setTab('plan')">Open Plan</button>
        </div>
      </div>
      <div id="safetyCard" class="card p-4">
        <h3 class="font-semibold mb-1" id="safetyTitle">Important Safety Notice</h3>
        <p class="text-sm text-gray-600" id="safetyText">
          This tool helps with planning and private check-ins. It is not emergency help or a guarantee of safety.
          If in danger, call local emergency services.
        </p>
        <button id="btnAckSafety" class="btn btn-primary mt-3">I Understand</button>
      </div>
    </section>

    <!-- Check-In -->
    <section id="tab-checkin" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <div class="flex items-center justify-between">
          <h2 id="checkTitle" class="text-lg font-semibold">Check-In</h2>
          <span class="text-xs text-gray-500" id="checkDisc">Guidance is informational; not therapy or emergency care.</span>
        </div>
        <p class="text-sm text-gray-600 mb-2" id="checkIntro">
          Answer 13 quick questions. Buttons highlight. Risk% updates live. Tap a question after answering to see guidance.
        </p>
        <div id="questions" class="space-y-2"></div>
        <div id="checkFeedback" class="mt-3 space-y-2"></div>
        <div id="synopsisBox" class="card p-3 mt-3 hidden-soft"></div>
        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnLoadDemo" class="btn">Load Demo Answers</button>
          <button id="btnSaveCheckin" class="btn btn-primary">Save Check-In</button>
        </div>
      </div>
    </section>

    <!-- Plan -->
    <section id="tab-plan" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <div class="flex items-center justify-between">
          <h2 id="planTitle" class="text-lg font-semibold">Safety Plan</h2>
          <span class="text-xs text-gray-500" id="planDisc">Plans are suggestions; use your judgment and local laws.</span>
        </div>
        <div class="mt-2 flex gap-2 flex-wrap">
          <button id="btnNewPlan" class="btn">New Plan</button>
          <button id="btnTemplates" class="btn">Templates</button>
          <button id="btnQuickGenerate" class="btn btn-primary">Quick Generate</button>
        </div>
        <div id="plansList" class="mt-3 space-y-2"></div>
      </div>

      <!-- Professional Partner Placeholder (replaces fake chat) -->
      <div class="card p-4">
        <h3 class="font-semibold mb-1" id="proHookTitle">Professional Support (Partner Slot)</h3>
        <p class="text-sm text-gray-600" id="proHookText">
          This area is reserved for live support from a clinic or advocacy organization. When activated, your trusted partner will appear here for confidential guidance.
        </p>
        <div class="mt-2 text-xs text-gray-600" id="proHookCTA">
          Organizations: contact us to integrate secure chat or appointment routing within TimeOut.
        </div>
        <button id="proLearnBtn" class="btn mt-3">Learn how partners integrate</button>
      </div>

      <div id="demoQs" class="card p-4">
        <div class="font-semibold mb-2">Example Prompts (info only)</div>
        <div class="demo-qs">
          <button>Am I safe if I leave now?</button>
          <button>Where can I get help tonight?</button>
          <button>What should I put in my go-bag?</button>
        </div>
      </div>
    </section>

    <!-- Resources -->
    <section id="tab-resources" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <h2 id="resTitle" class="text-lg font-semibold">Resources</h2>
        <p class="text-sm text-gray-600 mb-2">Tap a resource to copy. Use “Call Hotline”.</p>
        <div class="flex gap-2 mb-2 flex-wrap">
          <button id="callHotlineBtn" class="btn">Call Hotline</button>
          <button id="btnAddResource" class="btn">Add</button>
          <button id="btnSeedLocal" class="btn">Add Local 211</button>
        </div>
        <div id="resList" class="space-y-2"></div>
      </div>
    </section>

    <!-- Profile -->
    <section id="tab-profile" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <h2 class="text-lg font-semibold">Profile</h2>
        <label class="block text-sm mb-1">Display name</label>
        <input id="profName" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="Anonymous">
        <label class="block text-sm mb-1">Change PIN</label>
        <div class="grid grid-cols-3 gap-2">
          <input id="oldPin" class="border rounded-lg px-3 py-2" placeholder="Old" inputmode="numeric" maxlength="8">
          <input id="newPin" class="border rounded-lg px-3 py-2" placeholder="New" inputmode="numeric" maxlength="8">
          <input id="newPin2" class="border rounded-lg px-3 py-2" placeholder="Confirm" inputmode="numeric" maxlength="8">
        </div>
        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnSaveProfile" class="btn btn-primary">Save Profile</button>
          <button id="btnExport" class="btn">Export JSON</button>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">Theme:</span>
            <select id="themePick" class="border rounded-lg px-2 py-2 text-sm">
              <option value="blue">Blue</option>
              <option value="teal">Teal</option>
              <option value="rose">Rose</option>
              <option value="amber">Amber</option>
              <option value="violet">Violet</option>
            </select>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Tabs -->
  <nav id="bottomNav" class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 hidden-soft">
    <div class="max-w-md mx-auto grid grid-cols-5 text-sm">
      <button onclick="setTab('home')" class="py-2 flex flex-col items-center"><span>🏠</span><span id="navHome">Home</span></button>
      <button onclick="setTab('checkin')" class="py-2 flex flex-col items-center"><span>✅</span><span id="navCheck">Check-In</span></button>
      <button onclick="setTab('plan')" class="py-2 flex flex-col items-center"><span>🧭</span><span id="navPlan">Plan</span></button>
      <button onclick="setTab('resources')" class="py-2 flex flex-col items-center"><span>📚</span><span id="navRes">Resources</span></button>
      <button onclick="setTab('profile')" class="py-2 flex flex-col items-center"><span>👤</span><span id="navProf">Profile</span></button>
    </div>
  </nav>

  <!-- PIN Modal -->
  <div id="pinModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden-soft items-center justify-center">
    <div class="card p-4 w-[92vw] max-w-sm">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Enter PIN</h3>
        <button id="pinClose" class="btn btn-ghost">✕</button>
      </div>
      <input id="pinInput" class="w-full border rounded-lg px-3 py-2" inputmode="numeric" maxlength="8" placeholder="••••">
      <div class="mt-3 flex gap-2">
        <button id="pinOk" class="btn btn-primary">Unlock</button>
        <button id="pinCancel" class="btn">Cancel</button>
      </div>
    </div>
  </div><!-- Scripts -->
  <script>
/* ===================== CORE STATE ===================== */
const core = {
  lang: localStorage.getItem('timeout_lang') || 'en',
  pin: localStorage.getItem('timeout_pin') || '2580',
  name: localStorage.getItem('timeout_profile_name') || 'Anonymous',
  answers: JSON.parse(localStorage.getItem('timeout_answers')||'{}'),
  resources: JSON.parse(localStorage.getItem('timeout_resources')||'[]'),
  plans: JSON.parse(localStorage.getItem('timeout_plans')||'[]'),
  theme: localStorage.getItem('timeout_theme') || 'blue',
  risk: 0, trust: 100
};
const $ = id => document.getElementById(id);
function saveLocal(){
  localStorage.setItem('timeout_lang', core.lang);
  localStorage.setItem('timeout_pin', core.pin);
  localStorage.setItem('timeout_profile_name', core.name);
  localStorage.setItem('timeout_answers', JSON.stringify(core.answers));
  localStorage.setItem('timeout_resources', JSON.stringify(core.resources));
  localStorage.setItem('timeout_plans', JSON.stringify(core.plans));
  localStorage.setItem('timeout_theme', core.theme);
}
function toast(msg){ alert(msg); }

/* ===================== THEME ===================== */
function applyTheme(){
  const map={
    blue:{brand:'#2563eb',ink:'#ffffff'},
    teal:{brand:'#0ea5a4',ink:'#002b2a'},
    rose:{brand:'#e11d48',ink:'#ffffff'},
    amber:{brand:'#f59e0b',ink:'#1f2937'},
    violet:{brand:'#7c3aed',ink:'#ffffff'}
  }[core.theme] || {brand:'#2563eb',ink:'#ffffff'};
  document.documentElement.style.setProperty('--brand', map.brand);
  document.documentElement.style.setProperty('--brand-ink', map.ink);
  $('themePick').value = core.theme;
}
$('themePick').addEventListener('change', e=>{ core.theme=e.target.value; saveLocal(); applyTheme(); });

/* ===================== LANGUAGE ===================== */
$('langToggle').onclick = ()=>{
  core.lang = core.lang === 'en' ? 'es' : 'en';
  saveLocal();
  applyAll(); // rebuild labels/questions/resources
};
function T(en, es){ return core.lang==='es'? es: en; }
function applyLang(){
  $('langToggle').textContent = core.lang==='es'?'ES/EN':'EN/ES';
  $('btnQuickExit').textContent = T('Exit','Salir');
  $('btnPanic').textContent = T('Clear&Lock','Borrar y Bloquear');
  $('btnBack').textContent = T('Back','Atrás');
  $('homeTitle').textContent = T('Welcome','Bienvenido/a');
  $('homeHello').textContent = T(`Hi, ${core.name}.`, `Hola, ${core.name}.`);
  $('resTitle').textContent = T('Resources','Recursos');
  $('checkTitle').textContent = T('Check-In','Autoevaluación');
  $('planTitle').textContent = T('Safety Plan','Plan de Seguridad');
  $('checkDisc').textContent = T('Guidance is informational; not therapy or emergency care.','La orientación es informativa; no es terapia ni emergencia.');
  $('planDisc').textContent   = T('Plans are suggestions; use your judgment and local laws.','Los planes son sugerencias; usa tu juicio y las leyes locales.');
  $('proHookTitle').textContent = T('Professional Support (Partner Slot)','Apoyo profesional (espacio de socios)');
  $('proHookText').textContent  = T(
    'This area is reserved for live support from a clinic or advocacy organization. When activated, your trusted partner will appear here for confidential guidance.',
    'Este espacio está reservado para apoyo en vivo de una clínica u organización. Al activarse, tu aliado confiable aparecerá aquí para orientación confidencial.'
  );
  $('proHookCTA').textContent   = T(
    'Organizations: contact us to integrate secure chat or appointment routing within TimeOut.',
    'Organizaciones: contáctenos para integrar chat seguro o derivación de citas en TimeOut.'
  );
  $('navHome').textContent = T('Home','Inicio');
  $('navCheck').textContent = T('Check-In','Autoeval.');
  $('navPlan').textContent = T('Plan','Plan');
  $('navRes').textContent = T('Resources','Recursos');
  $('navProf').textContent = T('Profile','Perfil');
  $('safetyTitle').textContent = T('Important Safety Notice','Aviso importante de seguridad');
  $('safetyText').textContent  = T(
    'This tool helps with planning and private check-ins. It is not emergency help or a guarantee of safety. If in danger, call local emergency services.',
    'Esta herramienta ayuda con la planificación y chequeos privados. No es ayuda de emergencia ni garantía de seguridad. En peligro, llama a emergencias locales.'
  );
  $('btnAckSafety').textContent = T('I Understand','Entiendo');
}

/* ===================== CLOCK & WEATHER ===================== */
function tickClock(){
  const d = new Date();
  const h = d.getHours().toString().padStart(2,'0');
  const m = d.getMinutes().toString().padStart(2,'0');
  $('hdrClock').textContent = `${h}:${m}`;
}
setInterval(tickClock, 1000); tickClock();
(function setWeather(){ $('hdrWeather').textContent = '⛅'; })();

/* ===================== DECOY: STOPWATCH/CALC/NOTES ===================== */
let swInterval=null, swSeconds=25*60;
function renderStopwatch(){ const mm=Math.floor(swSeconds/60).toString().padStart(2,'0'); const ss=(swSeconds%60).toString().padStart(2,'0'); $('decoyTimerDisplay').textContent=`${mm}:${ss}`;}
$('decoyStart').onclick=()=>{ if(swInterval) return; swInterval=setInterval(()=>{ if(swSeconds>0){ swSeconds--; renderStopwatch(); }},1000); };
$('decoyPause').onclick=()=>{ clearInterval(swInterval); swInterval=null; };
$('decoyReset').onclick=()=>{ swSeconds=25*60; renderStopwatch(); };
renderStopwatch();
$('calcEval').onclick=()=>{ try{ const v=eval(($('calcInput').value||'').replace(/[^0-9+\-*/(). ]/g,'')); $('calcOut').textContent = isFinite(v)? v: '—'; }catch{ $('calcOut').textContent='—'; } };
$('decoyNotes').value = localStorage.getItem('timeout_decoy_notes') || '';
$('decoyNotes').addEventListener('input', e=> localStorage.setItem('timeout_decoy_notes', e.target.value));

/* ===================== UNLOCK (LONG PRESS + PIN) ===================== */
let lpTimer=null;
function bindLongPress(el){
  const start=()=>{ lpTimer=setTimeout(()=> openPinModal(), 800); };
  const clear=()=>{ clearTimeout(lpTimer); };
  el.addEventListener('mousedown',start); el.addEventListener('touchstart',start,{passive:true});
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> el.addEventListener(ev, clear));
}
bindLongPress($('appTitle'));
bindLongPress($('decoyTimerDisplay'));
function openPinModal(){ $('pinModal').classList.remove('hidden-soft'); $('pinInput').value=''; $('pinInput').focus(); }
function closePinModal(){ $('pinModal').classList.add('hidden-soft'); }
$('pinClose').onclick=closePinModal; $('pinCancel').onclick=closePinModal;
$('pinOk').onclick=tryUnlock;
$('pinInput').addEventListener('keydown', e=>{ if(e.key==='Enter') tryUnlock(); });
function tryUnlock(){
  const v = $('pinInput').value.trim();
  if(v===core.pin){ showRealApp(); closePinModal(); }
  else { toast(T('Wrong PIN','PIN incorrecto')); }
}

/* ===================== LOCK/UNLOCK ===================== */
function showRealApp(){
  $('decoyView').classList.add('hidden-soft');
  $('appView').classList.remove('hidden-soft');
  $('bottomNav').classList.remove('hidden-soft');
  $('btnQuickExit').classList.remove('hidden-soft');
  $('btnPanic').classList.remove('hidden-soft');
  $('btnBack').classList.remove('hidden-soft');
  applyLang();
}
function lockToDecoy(){
  $('appView').classList.add('hidden-soft');
  $('bottomNav').classList.add('hidden-soft');
  $('btnQuickExit').classList.add('hidden-soft');
  $('btnPanic').classList.add('hidden-soft');
  $('btnBack').classList.add('hidden-soft');
  $('decoyView').classList.remove('hidden-soft');
}
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) lockToDecoy(); });
$('btnQuickExit').onclick=()=>{ location.href='https://www.google.com/'; };
$('btnPanic').onclick=()=>{ 
  localStorage.removeItem('timeout_profile_name'); 
  localStorage.removeItem('timeout_answers'); 
  localStorage.removeItem('timeout_resources'); 
  localStorage.removeItem('timeout_plans'); 
  localStorage.removeItem('timeout_theme');
  core.name='Anonymous'; core.answers={}; core.resources=[]; core.plans=[]; core.theme='blue';
  saveLocal(); applyTheme(); lockToDecoy(); 
};

/* ===================== TABS ===================== */
function setTab(name){
  ['home','checkin','plan','resources','profile'].forEach(t=>{
    $('tab-'+t).classList.toggle('hidden-soft', t!==name);
  });
  if(name==='checkin'){ buildQuestions(); updateScoresAndFeedback(); }
  if(name==='plan'){ renderPlans(); }
  if(name==='resources'){ renderResources(); }
}
window.setTab = setTab;

/* ===================== SAFETY ACK (ONCE) ===================== */
function applySafetyAckVisibility(){
  const seen = localStorage.getItem('timeout_safety_ack') === '1';
  const card = document.getElementById('safetyCard');
  if (card) card.style.display = seen ? 'none' : '';
}
document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'btnAckSafety') {
    localStorage.setItem('timeout_safety_ack','1');
    applySafetyAckVisibility();
  }
});/* ===================== CHECK-IN (13 near-clinical Qs) ===================== */
/* Each question has a short guidance for Yes/No. */
const QS_EN = [
  { k:'q1',  t:'Are you currently in a place where you feel physically safe?', y:'If you do not feel safe, consider moving to a public or trusted location and keep essentials ready.', n:'If you feel unsafe, act quickly: move to a safer area and alert a trusted person.' },
  { k:'q2',  t:'Has anyone threatened you with harm, intimidation, or coercion in the past 30 days?', y:'Document dates/times privately and consider telling a trusted contact.', n:'Continue monitoring and update your plan if anything changes.' },
  { k:'q3',  t:'Have you been hit, pushed, choked, or otherwise physically harmed in the past 30 days?', y:'Seek medical care if needed and consider confidentially recording the incident details.', n:'Stay alert to early warning signs and keep an exit plan ready.' },
  { k:'q4',  t:'Does the person have access to weapons, dangerous objects, or prior violence history?', y:'Elevated risk. Increase distance from weapons and identify secure exits.', n:'Maintain awareness of environment and exits.' },
  { k:'q5',  t:'Is the person monitoring your phone, accounts, or location (tech surveillance)?', y:'Limit sensitive content, strengthen passcodes, and consider quick-wipe options.', n:'Use screen lock and review account security.' },
  { k:'q6',  t:'Have threats or incidents escalated recently in frequency or severity?', y:'Escalation is a red flag—prioritize contact with support resources.', n:'Keep checkpoints (weekly review) to detect changes early.' },
  { k:'q7',  t:'Are you being prevented from leaving, working, studying, or contacting others?', y:'This is controlling behavior—plan a safe exit and notify a trusted contact.', n:'Maintain access to transport and keep essential items ready.' },
  { k:'q8',  t:'Do you have children, elders, or dependents who may be at risk?', y:'Create a children/elder care safety plan and alternate caregiver.', n:'Note who can help with care if conditions change.' },
  { k:'q9',  t:'Has the person threatened self-harm to control you?', y:'This is manipulation and danger—seek support and document safely.', n:'If new threats appear, document and reassess promptly.' },
  { k:'q10', t:'Have you been isolated from friends, family, or services?', y:'Rebuild a safe contact chain (code word, check-in schedule).', n:'Keep your contact network warm and ready.' },
  { k:'q11', t:'Do you have a safe place to go for 24–72 hours if needed?', y:'Confirm transportation, cash, documents, and keys are accessible.', n:'Identify at least one safe location and route now.' },
  { k:'q12', t:'Do you have access to cash, documents, medications, and a go-bag?', y:'Great—verify contents and hide/store safely.', n:'Start a small go-bag: ID, keys, cash, meds, charger, clothes.' },
  { k:'q13', t:'Would you like immediate information for local hotlines or shelters?', y:'Check Resources and consider calling tonight if needed.', n:'Resources remain available anytime—review them now so they’re familiar.' }
];
const QS_ES = [
  { k:'q1',  t:'¿Estás en un lugar donde te sientas físicamente seguro/a?', y:'Si no te sientes seguro/a, muévete a un sitio público o de confianza y prepara lo esencial.', n:'Si te sientes inseguro/a, actúa rápido: busca un lugar más seguro y avisa a alguien de confianza.' },
  { k:'q2',  t:'¿Alguien te ha amenazado con daño, intimidación o coerción en los últimos 30 días?', y:'Registra fechas/horas en privado y considera contárselo a un contacto de confianza.', n:'Sigue monitoreando y actualiza tu plan si cambia algo.' },
  { k:'q3',  t:'¿Has sufrido daño físico (golpes, empujones, asfixia) en los últimos 30 días?', y:'Busca atención médica si es necesario y registra detalles de forma confidencial.', n:'Mantente alerta a señales tempranas y ten listo un plan de salida.' },
  { k:'q4',  t:'¿La persona tiene acceso a armas u objetos peligrosos o antecedentes de violencia?', y:'Riesgo elevado. Aumenta la distancia de las armas e identifica salidas seguras.', n:'Mantén conciencia del entorno y salidas.' },
  { k:'q5',  t:'¿La persona vigila tu teléfono, cuentas o ubicación (vigilancia tecnológica)?', y:'Limita contenido sensible, refuerza contraseñas y considera opciones de borrado rápido.', n:'Usa bloqueo de pantalla y revisa seguridad de cuentas.' },
  { k:'q6',  t:'¿Han aumentado recientemente la frecuencia o gravedad de amenazas o incidentes?', y:'La escalada es una señal—prioriza contacto con recursos de apoyo.', n:'Programa revisiones semanales para detectar cambios.' },
  { k:'q7',  t:'¿Te impiden salir, trabajar, estudiar o contactar a otras personas?', y:'Es control—planifica una salida segura y avisa a un contacto de confianza.', n:'Mantén acceso a transporte y lo esencial.' },
  { k:'q8',  t:'¿Hay niños, mayores o dependientes en riesgo?', y:'Crea un plan de seguridad para ellos y un cuidador alterno.', n:'Anota quién puede ayudar si cambian las condiciones.' },
  { k:'q9',  t:'¿La persona amenaza con autolesionarse para controlarte?', y:'Es manipulación y peligro—busca apoyo y documenta con seguridad.', n:'Si aparecen nuevas amenazas, documenta y reevalúa.' },
  { k:'q10', t:'¿Te han aislado de amigos, familia o servicios?', y:'Reconstruye una cadena de contactos segura (palabra clave, horario de chequeo).', n:'Mantén tu red de apoyo activa.' },
  { k:'q11', t:'¿Tienes un lugar seguro adonde ir por 24–72 horas si es necesario?', y:'Confirma transporte, dinero, documentos y llaves accesibles.', n:'Identifica ahora al menos un lugar seguro y la ruta.' },
  { k:'q12', t:'¿Tienes acceso a dinero, documentos, medicamentos y una bolsa de emergencia?', y:'Bien—verifica el contenido y escóndelo/guárdalo de forma segura.', n:'Inicia una bolsa: identificación, llaves, dinero, medicinas, cargador, ropa.' },
  { k:'q13', t:'¿Quieres información inmediata sobre líneas de ayuda o refugios locales?', y:'Revisa Recursos y considera llamar esta noche si es necesario.', n:'Los recursos están disponibles—revísalos ahora para familiarizarte.' }
];
function getQs(){ return core.lang==='es' ? QS_ES : QS_EN; }

function qRow(i, q){
  const qid = q.k;
  const yesSel = core.answers[qid]==='yes' ? 'selected' : '';
  const noSel  = core.answers[qid]==='no'  ? 'selected' : '';
  const yesLab = T('Yes','Sí');
  const noLab  = T('No','No');
  const help = core.answers[qid] ? `<div class="q-help" id="h_${qid}">${ core.answers[qid]==='yes' ? q.y : q.n }</div>` : '';
  return `
    <div class="card p-3" id="card_${qid}">
      <div class="mb-2 text-sm">${i+1}. ${q.t}</div>
      <div class="flex gap-2">
        <button class="btn yn-btn ${yesSel}" data-q="${qid}" data-v="yes">${yesLab}</button>
        <button class="btn yn-btn ${noSel}"  data-q="${qid}" data-v="no">${noLab}</button>
      </div>
      ${help}
    </div>`;
}
function buildQuestions(){
  const box = $('questions'); if(!box) return;
  box.innerHTML = '';
  getQs().forEach((q,i)=>{ box.insertAdjacentHTML('beforeend', qRow(i,q)); });
}
function computeRisk(){
  // Weighted simple model (higher weight for weapon access, recent harm, escalation)
  let score = 0; const a = core.answers;
  const yes = k => a[k]==='yes';
  const no  = k => a[k]==='no';
  if(no('q1')) score += 2;          // not currently safe
  if(yes('q2')) score += 1;         // threats
  if(yes('q3')) score += 2;         // physical harm recent
  if(yes('q4')) score += 2;         // weapons/history
  if(yes('q5')) score += 1;         // tech surveillance
  if(yes('q6')) score += 2;         // escalation
  if(yes('q7')) score += 2;         // control/entrapment
  if(yes('q8')) score += 1;         // children/elders
  if(yes('q9')) score += 1;         // self-harm threats to control
  if(yes('q10')) score += 1;        // isolation
  if(no('q11')) score += 1;         // no safe place ready
  if(no('q12')) score += 1;         // no go-bag/prep
  if(yes('q13')) score += 0;        // requesting resources doesn't change risk
  const max = 16; // max possible with weights above
  const pct = Math.round((score/max)*100);
  core.risk = Math.min(100, Math.max(0, pct));
  core.trust = 100 - core.risk;
}
function renderSynopsis(){
  const box = $('synopsisBox'); if(!box) return;
  computeRisk();
  box.classList.remove('hidden-soft');
  let html='';
  if(core.risk >= 60){
    html += `<div class="text-sm"><strong>${T('High concern:','Alta preocupación:')}</strong> ${T(
      'Your answers indicate significant safety risks (recent harm, control, or weapons/escalation).',
      'Tus respuestas indican riesgos significativos (daño reciente, control o armas/escalada).'
    )}</div>`;
    html += `<p class="text-sm mt-2">${T(
      'Consider moving to a safer place, alerting a trusted person, and contacting a hotline or local service tonight. Prepare essential items and review exits.',
      'Considera moverte a un lugar más seguro, avisar a una persona de confianza y contactar una línea de ayuda o servicio local esta noche. Prepara lo esencial y revisa salidas.'
    )}</p>`;
    html += `<p class="text-sm mt-2">${T(
      'A quick safety plan can help: list safe locations, transport options, and who can help children/elders. Document incidents privately when it is safe to do so.',
      'Un plan rápido puede ayudar: lugares seguros, opciones de transporte y quién puede ayudar a niños/mayores. Documenta incidentes en privado cuando sea seguro.'
    )}</p>`;
  } else if(core.risk >= 30){
    html += `<div class="text-sm"><strong>${T('Moderate concern:','Preocupación moderada:')}</strong> ${T(
      'Some warning signs are present. Keep a go-bag, set code words with trusted contacts, and schedule regular check-ins.',
      'Hay señales de alerta. Mantén una bolsa de emergencia, establece palabras clave con contactos de confianza y programa chequeos regulares.'
    )}</div>`;
    html += `<p class="text-sm mt-2">${T(
      'Update your safety plan and identify at least one safe place for 24–72 hours. Review phone security and limit sensitive content if needed.',
      'Actualiza tu plan e identifica al menos un lugar seguro por 24–72 horas. Revisa la seguridad del teléfono y limita contenido sensible si es necesario.'
    )}</p>`;
    html += `<p class="text-sm mt-2">${T(
      'If conditions escalate, use hotlines in Resources or contact emergency services.',
      'Si las condiciones escalan, usa las líneas de ayuda en Recursos o contacta a emergencias.'
    )}</p>`;
  } else {
    html += `<div class="text-sm"><strong>${T('Lower concern reported:','Preocupación menor informada:')}</strong> ${T(
      'Keep awareness high and review your plan weekly so you can act quickly if circumstances change.',
      'Mantén la alerta y revisa tu plan semanalmente para actuar rápido si cambian las circunstancias.'
    )}</div>`;
    html += `<p class="text-sm mt-2">${T(
      'Confirm a safe contact chain and store essentials in a discreet place.',
      'Confirma una cadena de contactos segura y guarda lo esencial en un lugar discreto.'
    )}</p>`;
    html += `<p class="text-sm mt-2">${T(
      'You are not alone—support is available if you ever need it.',
      'No estás solo/a—el apoyo está disponible si lo necesitas.'
    )}</p>`;
  }
  box.innerHTML = html;
}
function updateScoresAndFeedback(){
  computeRisk();
  $('riskPct').textContent = core.risk + '%';
  $('trustPct').textContent = core.trust + '%';
  const fb = $('checkFeedback'); if(!fb) return;
  fb.innerHTML = '';
  if(core.risk>=60){
    fb.insertAdjacentHTML('beforeend', `<div class="card p-3 text-sm">⚠️ ${T('High risk — open Plan and contact a hotline in Resources.','Riesgo alto — abre Plan y contacta una línea de ayuda en Recursos.')}</div>`);
  } else if(core.risk>=30){
    fb.insertAdjacentHTML('beforeend', `<div class="card p-3 text-sm">${T('Moderate risk — keep a go-bag and a trusted contact ready.','Riesgo moderado — prepara una bolsa y un contacto de confianza.')}</div>`);
  } else {
    fb.insertAdjacentHTML('beforeend', `<div class="card p-3 text-sm">${T('Lower risk reported — stay prepared and review your plan weekly.','Riesgo menor — mantente preparado/a y revisa tu plan semanalmente.')}</div>`);
  }
  renderSynopsis();
}
document.addEventListener('click', (e)=>{
  const b = e.target.closest('.yn-btn'); if(!b) return;
  const qid = b.dataset.q; const val=b.dataset.v; if(!qid||!val) return;
  core.answers[qid] = val; saveLocal();
  document.querySelectorAll(`.yn-btn[data-q="${qid}"]`).forEach(x=>x.classList.remove('selected'));
  b.classList.add('selected');
  // per-question guidance swap
  const qs = getQs().find(x=>x.k===qid);
  const helpId = `h_${qid}`;
  const host = document.getElementById(helpId);
  const text = (val==='yes')? (qs?qs.y:'') : (qs?qs.n:'');
  if(host){ host.textContent = text; } else {
    const parent = document.getElementById(`card_${qid}`);
    if(parent){ parent.insertAdjacentHTML('beforeend', `<div class="q-help" id="${helpId}">${text}</div>`); }
  }
  updateScoresAndFeedback();
});
$('btnLoadDemo').onclick=()=>{
  // a realistic demo pattern that yields moderate-high risk
  core.answers = { q1:'no', q2:'yes', q3:'yes', q4:'yes', q5:'yes', q6:'yes', q7:'yes', q8:'no', q9:'no', q10:'yes', q11:'no', q12:'no', q13:'yes' };
  saveLocal(); buildQuestions(); updateScoresAndFeedback();
};
$('btnSaveCheckin').onclick=()=>{ saveLocal(); toast(T('Check-In saved.','Autoevaluación guardada.')); };

/* ===================== SAFETY PLAN ===================== */
function renderPlans(){
  const list = $('plansList'); if(!list) return;
  list.innerHTML='';
  if(core.plans.length===0){
    list.insertAdjacentHTML('beforeend', `<div class="text-sm text-gray-600">${T('No plans yet. Use New, Templates, or Quick Generate.','Aún no hay planes. Usa Nuevo, Plantillas o Generar Rápido.')}</div>`);
    return;
  }
  core.plans.forEach((p,idx)=>{
    const steps = (p.steps||[]).map(s=>`<li class="list-disc ml-5">${s}</li>`).join('');
    const card = `
      <div class="card p-3">
        <div class="flex items-center justify-between">
          <div class="font-semibold">${p.title||T('Untitled','Sin título')}</div>
          <button data-i="${idx}" class="btn btn-ghost text-rose-600 delPlan">${T('Delete','Eliminar')}</button>
        </div>
        ${steps? `<ul class="mt-2 text-sm">${steps}</ul>`:''}
      </div>`;
    list.insertAdjacentHTML('beforeend', card);
  });
  list.querySelectorAll('.delPlan').forEach(btn=>{
    btn.onclick=()=>{ const i=+btn.dataset.i; core.plans.splice(i,1); saveLocal(); renderPlans(); };
  });
}
$('btnNewPlan').onclick=()=>{
  const t = prompt(T('Plan title?','¿Título del plan?')) || T('Personal Plan','Plan personal');
  const s = prompt(T('Steps (comma-separated):','Pasos (separados por comas):')) || '';
  const steps = s.split(',').map(x=>x.trim()).filter(Boolean);
  core.plans.push({title:t, steps}); saveLocal(); renderPlans();
};
$('btnTemplates').onclick=()=>{
  const template = { title:T('Grab & Go Bag','Bolsa de emergencia'), steps:[T('ID & documents','Identificación y documentos'),T('Keys & cash','Llaves y efectivo'),T('Medications','Medicamentos'),T('Change of clothes','Cambio de ropa'),T('Backup phone numbers','Números de teléfono de respaldo')] };
  core.plans.push(template); saveLocal(); renderPlans();
};
let qpGuard=false;
$('btnQuickGenerate').onclick=()=>{
  if(qpGuard) return; qpGuard=true; setTimeout(()=>qpGuard=false,600);
  const a=core.answers; const steps=[];
  if(a.q5==='yes') steps.push(T('Harden phone security: strong passcode, limit sensitive content.','Refuerza la seguridad del teléfono: código fuerte, limita contenido sensible.'));
  if(a.q2==='yes' || a.q3==='yes' || a.q6==='yes') steps.push(T('Privately document incidents; tell a trusted person.','Documenta incidentes en privado; avisa a alguien de confianza.'));
  if(a.q1==='no' || a.q7==='yes') steps.push(T('Identify a safe public place and transport route.','Identifica un lugar público seguro y ruta de transporte.'));
  if(a.q8==='yes') steps.push(T('Choose an alternate caregiver and meeting point for dependents.','Elige cuidador alterno y punto de encuentro para dependientes.'));
  if(a.q11==='no' || a.q12==='no') steps.push(T('Prepare a 24–72h option and start a go-bag.','Prepara una opción 24–72h e inicia una bolsa de emergencia.'));
  if(steps.length===0) steps.push(T('Share location with a trusted contact and review exits.','Comparte ubicación con un contacto de confianza y revisa salidas.'));
  core.plans.push({title:T('Quick Plan','Plan rápido'), steps}); saveLocal(); renderPlans(); toast(T('Quick plan created.','Plan rápido creado.'));
};

/* ===================== PROFESSIONAL PARTNER PLACEHOLDER ===================== */
document.getElementById('proLearnBtn').onclick=()=>{
  alert(T(
    'This slot is reserved for a professional partner. In a partnership, this panel becomes a live support portal with secure handoffs.',
    'Este espacio está reservado para un socio profesional. En alianza, este panel se convierte en un portal de apoyo en vivo con derivaciones seguras.'
  ));
};

/* ===================== RESOURCES ===================== */
function seedResourcesIfEmpty(){
  if(!Array.isArray(core.resources) || core.resources.length===0){
    core.resources = [
      {title:"National Domestic Violence Hotline (US)", desc:"24/7 confidential help — call or chat", url:"tel:+18007997233"},
      {title:"RAINN Sexual Assault Hotline (US)", desc:"24/7 — phone + online chat", url:"tel:+18006564673"},
      {title:"Childhelp National Child Abuse Hotline (US)", desc:"24/7 — children & adults", url:"tel:+18004224453"},
      {title:"StrongHearts Native Helpline (US)", desc:"Support for Native communities", url:"tel:+18447628483"},
      {title:"love is respect (US)", desc:"Dating abuse support — call/text/chat", url:"https://www.loveisrespect.org/"},
      {title:"National Deaf DV Hotline (US)", desc:"Deaf/Hard of Hearing support (ASL)", url:"https://thedeafhotline.org/"},
      {title:"211 — Local Services (US/Canada)", desc:"Housing, legal, financial, counseling", url:"https://www.211.org/"},
      {title:"SAMHSA Helpline (US)", desc:"Mental health & substance use", url:"tel:+18006624357"},
      {title:"Emergency", desc:"Call your local emergency number", url:"tel:911"}
    ];
    saveLocal();
  }
}
function renderResources(){
  const box=$('resList'); box.innerHTML='';
  core.resources.forEach((r,i)=>{
    const isTel = /^tel:/i.test(r.url||'');
    const item = `
      <div class="card p-3 flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="font-semibold truncate">${r.title}</div>
          <div class="text-sm text-gray-600">${r.desc||''}</div>
          <div class="text-xs mt-1 break-all">${r.url}</div>
        </div>
        <div class="flex flex-col gap-2 shrink-0">
          ${isTel? `<a class="btn" href="${r.url}">${T('Call','Llamar')}</a>` : `<button class="btn openRes" data-i="${i}">${T('Open','Abrir')}</button>`}
          <button class="btn copyRes" data-i="${i}">${T('Copy','Copiar')}</button>
          <button class="btn delRes text-rose-600" data-i="${i}">${T('Delete','Eliminar')}</button>
        </div>
      </div>`;
    box.insertAdjacentHTML('beforeend', item);
  });
  box.querySelectorAll('.copyRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; navigator.clipboard.writeText(core.resources[i].url||''); toast(T('Copied.','Copiado.')); });
  box.querySelectorAll('.delRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; core.resources.splice(i,1); saveLocal(); renderResources(); });
  box.querySelectorAll('.openRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; const u=core.resources[i].url; if(u) location.href=u; });
}
$('callHotlineBtn').onclick=()=>{ location.href='tel:+18007997233'; };
$('btnAddResource').onclick=()=>{
  const title = prompt(T('Title','Título'))||''; if(!title) return;
  const desc  = prompt(T('Description (optional)','Descripción (opcional)'))||'';
  const url   = prompt(T('Link or phone (prefix phone with tel:)','Enlace o teléfono (prefijo tel:)'))||'';
  core.resources.push({title,desc,url}); saveLocal(); renderResources();
};
$('btnSeedLocal').onclick=()=>{
  core.resources.push({title:T("Local 211 — Services","211 Local — Servicios"), desc:T("Tap to open 211","Pulsa para abrir 211"), url:"https://www.211.org/"}); saveLocal(); renderResources();
};

/* ===================== PROFILE ===================== */
$('profName').value = core.name;
$('themePick').value = core.theme;
$('btnSaveProfile').onclick=()=>{
  core.name = $('profName').value.trim() || 'Anonymous';
  const old = $('oldPin').value.trim();
  const np  = $('newPin').value.trim();
  const np2 = $('newPin2').value.trim();
  if(np || np2 || old){
    if(old!==core.pin) return toast(T('Old PIN is wrong.','PIN anterior incorrecto.'));
    if(np.length<4 || np!==np2) return toast(T('New PIN mismatch or too short.','Nuevo PIN no coincide o es muy corto.'));
    core.pin = np;
  }
  saveLocal();
  applyLang();
  toast(T('Profile saved.','Perfil guardado.'));
};
$('btnExport').onclick=()=>{
  const data = {
    profile:{name:core.name},
    answers:core.answers,
    risk:core.risk, trust:core.trust,
    resources:core.resources,
    plans:core.plans,
    theme:core.theme,
    app:"TimeOut", version:"v1.3.6"
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='timeout_export.json'; a.click(); URL.revokeObjectURL(a.href);
};/*********************** INIT & BACK ***********************/
function applyAll(){
  applyTheme();
  applyLang();
  buildQuestions();
  updateScoresAndFeedback();
  renderPlans();
  renderResources();
  applySafetyAckVisibility();
}
function init(){
  tickClock(); (function(){ $('hdrWeather').textContent = '⛅'; })();
  seedResourcesIfEmpty();
  if(!Array.isArray(core.plans) || core.plans.length===0){
    core.plans=[{title:T('Grab & Go Bag','Bolsa de emergencia'), steps:[T('ID & documents','Identificación y documentos'),T('Keys & cash','Llaves y efectivo'),T('Medications','Medicamentos'),T('Change of clothes','Cambio de ropa'),T('Backup phone numbers','Números de teléfono de respaldo')]}];
    saveLocal();
  }
  applyAll();
}
init();

/* Back button returns to Home (does NOT exit app) */
$('btnBack').onclick=()=>{
  setTab('home');
  window.scrollTo(0,0);
};

/* guard duplicates */
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) lockToDecoy(); });
let qeGuard=false, pcGuard=false;
document.getElementById('btnQuickExit').onclick=()=>{ if(qeGuard) return; qeGuard=true; setTimeout(()=>qeGuard=false,500); location.href='https://www.google.com/'; };
document.getElementById('btnPanic').onclick=()=>{ if(pcGuard) return; pcGuard=true; setTimeout(()=>pcGuard=false,700);
  localStorage.removeItem('timeout_profile_name'); 
  localStorage.removeItem('timeout_answers'); 
  localStorage.removeItem('timeout_resources'); 
  localStorage.removeItem('timeout_plans'); 
  localStorage.removeItem('timeout_theme');
  core.name='Anonymous'; core.answers={}; core.resources=[]; core.plans=[]; core.theme='blue';
  saveLocal(); applyTheme(); lockToDecoy(); 
};
  </script>
</body>
</html>
