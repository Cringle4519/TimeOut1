<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>TimeOut — Focus</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0a0a0a">
  <style>
    :root { --maxw: 480px; }
    body { background:#0a0a0a; color:#e5e7eb; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .container { max-width: var(--maxw); margin: 0 auto; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 16px; }
    .btn { border-radius: 12px; padding: .65rem .9rem; font-weight: 600; }
    .btn-primary { background:#2563eb; color:white; }
    .btn-ghost { background:#0b0b0b; border:1px solid #1f2937; color:#e5e7eb; }
    .btn-danger { background:#b91c1c; color:white; }
    .tab-btn { padding:.6rem .8rem; border-radius: 999px; }
    .toggle { border:1px solid #334155; border-radius:12px; }
    .toggle .opt { flex:1; padding:.6rem; text-align:center; border-right:1px solid #334155; }
    .toggle .opt:last-child { border-right:0; }
    .opt.active-yes { background:#16a34a; color:#fff; }
    .opt.active-no { background:#dc2626; color:#fff; }
    .hidden-soft { display:none !important; }
    .fade-enter { opacity:0; transform: translateY(4px); }
    .fade-enter-active { opacity:1; transform:none; transition: all .2s ease; }
    .pin-input { letter-spacing:.4em; text-align:center; font-weight:700; }
    .link { color:#60a5fa; text-decoration: underline; }
    .pill { border:1px solid #374151; background:#0b0b0b; border-radius:999px; padding:.2rem .6rem; font-size:.75rem; color:#9ca3af; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#111827; border:1px solid #374151; border-radius:6px; padding:.1rem .35rem; font-size:.75rem; color:#cbd5e1; }
  </style>
</head>
<body>
  <div id="app" class="container px-4 py-3">
    <!-- Header (always visible) -->
    <header class="flex items-center justify-between mb-3">
      <div>
        <h1 id="decoyTitle" class="text-xl font-bold select-none">TimeOut Focus</h1>
        <p class="text-xs text-gray-400">Stay on task • <span class="pill">v1.3.5</span></p>
      </div>
      <div class="flex items-center gap-2">
        <button id="quickExitBtn" class="btn btn-ghost" title="Quick Exit (opens Google)"><span class="hidden sm:inline">Quick Exit</span><span class="sm:hidden">Exit</span></button>
        <button id="panicBtn" class="btn btn-danger" title="Panic: Clear local data & return to decoy">Panic</button>
      </div>
    </header>

    <!-- Decoy Landing -->
    <section id="decoyView" class="card p-5 fade-enter-active">
      <div class="flex flex-col items-center">
        <div class="text-xs text-gray-400 mb-2">Focus Timer</div>
        <div id="timerDisplay" class="text-6xl font-bold tabular-nums tracking-tight">25:00</div>
        <div class="mt-4 flex gap-2">
          <button id="timerStart" class="btn btn-primary">Start</button>
          <button id="timerPause" class="btn btn-ghost">Pause</button>
          <button id="timerReset" class="btn btn-ghost">Reset</button>
        </div>
        <div class="mt-5 text-xs text-gray-500 text-center">
          Tip: Long-press the title for about <span class="font-semibold">0.8s</span> for more options.
        </div>
      </div>
    </section>

    <!-- PIN Modal -->
    <div id="pinModal" class="fixed inset-0 bg-black/70 hidden-soft items-end sm:items-center justify-center p-4">
      <div class="card w-full sm:max-w-sm p-4">
        <h3 id="pinModalTitle" class="text-lg font-semibold mb-2">Enter PIN</h3>
        <form id="pinForm" class="space-y-3">
          <input id="pinInput" inputmode="numeric" pattern="[0-9]*" maxlength="8" class="w-full px-3 py-3 card pin-input" placeholder="••••" autocomplete="off">
          <div id="pinChangeFields" class="space-y-2 hidden-soft">
            <input id="oldPin" inputmode="numeric" pattern="[0-9]*" maxlength="8" class="w-full px-3 py-2 card pin-input" placeholder="Current PIN">
            <input id="newPin" inputmode="numeric" pattern="[0-9]*" maxlength="8" class="w-full px-3 py-2 card pin-input" placeholder="New PIN (min 4)">
            <input id="newPin2" inputmode="numeric" pattern="[0-9]*" maxlength="8" class="w-full px-3 py-2 card pin-input" placeholder="Confirm New PIN">
          </div>
          <div class="flex gap-2">
            <button id="pinConfirmBtn" class="btn btn-primary flex-1" type="submit">Confirm</button>
            <button id="pinCancelBtn" class="btn btn-ghost flex-1" type="button">Cancel</button>
          </div>
          <div id="pinError" class="text-rose-400 text-sm min-h-[1.5rem]"></div>
        </form>
      </div>
    </div>

    <!-- Real App (hidden until unlocked) -->
    <section id="realApp" class="hidden-soft fade-enter">
      <!-- Real Header -->
      <div class="mt-4 card p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-gray-400">Signed in as</div>
            <div id="profileName" class="text-lg font-semibold">Anonymous</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-400">Trust</div>
            <div id="trustBadge" class="text-2xl font-bold">100%</div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <nav class="mt-3">
        <div class="flex gap-2">
          <button data-tab="home" class="tab-btn bg-blue-600 text-white">Home</button>
          <button data-tab="checkin" class="tab-btn card">Check-In</button>
          <button data-tab="resources" class="tab-btn card">Resources</button>
          <button data-tab="profile" class="tab-btn card">Profile</button>
        </div>
      </nav>

      <!-- Tab: Home -->
      <div id="tab-home" class="mt-3 card p-4">
        <h3 class="text-lg font-semibold mb-2">Welcome</h3>
        <p class="text-sm text-gray-300">Hi <span id="homeName">Anonymous</span>. Your current trust score is <span id="homeTrust">100</span>%.</p>
        <div class="mt-4 grid grid-cols-2 gap-2">
          <button id="goToCheckIn" class="btn btn-primary">Go to Check-In</button>
          <button id="saveAll" class="btn btn-ghost">Save (Local + Cloud)</button>
        </div>
        <div class="mt-4 text-xs text-gray-500">
          Losing focus (switching apps) will auto-hide sensitive screens.
        </div>
      </div>

      <!-- Tab: Check-In -->
      <div id="tab-checkin" class="mt-3 card p-4 hidden-soft">
        <h3 class="text-lg font-semibold mb-3">Safety Check-In</h3>
        <div class="space-y-3" id="questions"></div>
        <div class="mt-4 flex items-center justify-between">
          <div>
            <div class="text-xs text-gray-400">Risk</div>
            <div id="riskPct" class="text-2xl font-bold text-rose-400">0%</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-400">Trust</div>
            <div id="trustPct" class="text-2xl font-bold text-green-400">100%</div>
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <button id="saveCheckIn" class="btn btn-primary flex-1">Save Check-In</button>
          <button id="clearCheckIn" class="btn btn-ghost flex-1">Clear</button>
        </div>
      </div>

      <!-- Tab: Resources -->
      <div id="tab-resources" class="mt-3 card p-4 hidden-soft">
        <h3 class="text-lg font-semibold mb-3">My Resources</h3>
        <form id="resourceForm" class="grid grid-cols-1 gap-2 mb-3">
          <input id="resTitle" class="card px-3 py-2" placeholder="Title (e.g., Shelter)">
          <input id="resDesc" class="card px-3 py-2" placeholder="Description">
          <input id="resUrl" class="card px-3 py-2" placeholder="Link (https://...)">
          <button class="btn btn-primary">Add Resource</button>
        </form>
        <ul id="resourceList" class="space-y-2"></ul>
      </div>

      <!-- Tab: Profile -->
      <div id="tab-profile" class="mt-3 card p-4 hidden-soft">
        <h3 class="text-lg font-semibold mb-3">Profile</h3>
        <div class="grid grid-cols-1 gap-2">
          <label class="text-sm">Display Name</label>
          <input id="displayNameInput" class="card px-3 py-2" placeholder="Your name (optional)">
          <button id="saveProfile" class="btn btn-primary">Save Profile</button>
        </div>
        <hr class="my-4 border-gray-800">
        <div class="grid grid-cols-1 gap-2">
          <label class="text-sm">Change PIN</label>
          <button id="openChangePin" class="btn btn-ghost">Change PIN</button>
        </div>
        <hr class="my-4 border-gray-800">
        <div class="grid grid-cols-1 gap-2">
          <label class="text-sm">Export Data</label>
          <button id="exportJson" class="btn btn-ghost">Export JSON</button>
        </div>
      </div>

      <!-- Footer -->
      <footer class="py-6 text-center text-xs text-gray-500">
        TimeOut • Privacy-first support • <span class="pill">v1.3.5</span>
      </footer>
    </section>
  </div>

  <!-- Firebase v11.6.1 (modules via CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ---- Firebase Config (verbatim) ----
    const firebaseConfig = {
      apiKey: "AIzaSyC3Ga-GhV8xQztnbef7ybPFu4BRtLANtuk",
      authDomain: "unbrokenpath-630b0.firebaseapp.com",
      projectId: "unbrokenpath-630b0",
      storageBucket: "unbrokenpath-630b0.firebasestorage.app",
      messagingSenderId: "147188865145",
      appId: "1:147188865145:web:ff1f35a732bf89b31e1ca8",
      measurementId: "G-0Y8G7SS1BV"
    };

    // ---- App State / Constants ----
    const APP_VERSION = "v1.3.5";
    const DEFAULT_PIN = "2580";
    const LS_KEYS = {
      profile: "timeout_profile",
      answers: "timeout_answers",
      resources: "timeout_resources",
      pin: "timeout_pin"
    };
    const QUESTIONS = [
      { id:"q1", text:"Are you currently safe where you are?", invert:true },
      { id:"q2", text:"Has someone threatened you recently?" },
      { id:"q3", text:"Have you experienced physical harm in past month?" },
      { id:"q4", text:"Are you worried about your partner’s access to your phone?" },
      { id:"q5", text:"Is anyone preventing you from leaving?" },
      { id:"q6", text:"Do you have children at risk?" },
      { id:"q7", text:"Do you feel isolated from help?" },
      { id:"q8", text:"Would you like immediate local resources?" }
    ];

    // ---- UI Refs ----
    const decoyTitle = document.getElementById("decoyTitle");
    const decoyView = document.getElementById("decoyView");
    const realApp = document.getElementById("realApp");
    const quickExitBtn = document.getElementById("quickExitBtn");
    const panicBtn = document.getElementById("panicBtn");

    const pinModal = document.getElementById("pinModal");
    const pinModalTitle = document.getElementById("pinModalTitle");
    const pinForm = document.getElementById("pinForm");
    const pinInput = document.getElementById("pinInput");
    const pinError = document.getElementById("pinError");
    const pinCancelBtn = document.getElementById("pinCancelBtn");
    const pinChangeFields = document.getElementById("pinChangeFields");
    const oldPin = document.getElementById("oldPin");
    const newPin = document.getElementById("newPin");
    const newPin2 = document.getElementById("newPin2");

    const tabs = [...document.querySelectorAll("[data-tab]")];
    const tabHome = document.getElementById("tab-home");
    const tabCheck = document.getElementById("tab-checkin");
    const tabRes = document.getElementById("tab-resources");
    const tabProfile = document.getElementById("tab-profile");

    const profileName = document.getElementById("profileName");
    const trustBadge = document.getElementById("trustBadge");
    const homeName = document.getElementById("homeName");
    const homeTrust = document.getElementById("homeTrust");
    const goToCheckIn = document.getElementById("goToCheckIn");
    const saveAll = document.getElementById("saveAll");

    const questionsBox = document.getElementById("questions");
    const riskPct = document.getElementById("riskPct");
    const trustPct = document.getElementById("trustPct");
    const saveCheckIn = document.getElementById("saveCheckIn");
    const clearCheckIn = document.getElementById("clearCheckIn");

    const resForm = document.getElementById("resourceForm");
    const resTitle = document.getElementById("resTitle");
    const resDesc = document.getElementById("resDesc");
    const resUrl = document.getElementById("resUrl");
    const resList = document.getElementById("resourceList");

    const displayNameInput = document.getElementById("displayNameInput");
    const saveProfile = document.getElementById("saveProfile");
    const openChangePin = document.getElementById("openChangePin");
    const exportJson = document.getElementById("exportJson");

    // ---- Utility: Local Storage helpers ----
    const loadJSON = (k, f) => {
      try { const v = JSON.parse(localStorage.getItem(k)); return v ?? f; } catch { return f; }
    };
    const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    // ---- PIN helpers ----
    function getStoredPin() {
      const p = localStorage.getItem(LS_KEYS.pin);
      return (p && p.length >= 4) ? p : DEFAULT_PIN;
    }
    function setStoredPin(p) { localStorage.setItem(LS_KEYS.pin, p); }

    // ---- App Data In-Memory ----
    let unlocked = false;
    let user = null;
    let uid = null;
    let profile = loadJSON(LS_KEYS.profile, { name: "Anonymous", trust: 100 });
    let answers = loadJSON(LS_KEYS.answers, {}); // { q1: "yes"/"no", ... }
    let resources = loadJSON(LS_KEYS.resources, []); // [{title,desc,url}]
    let longPressTimer = null;

    // ---- Firebase Init ----
    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);

    // Anonymous Auth
    onAuthStateChanged(auth, async (u) => {
      if (u) {
        user = u; uid = u.uid;
      } else {
        await signInAnonymously(auth).catch(console.error);
      }
    });
    // Kick off anon sign-in immediately (in case state doesn't trigger on fast load)
    signInAnonymously(auth).catch(()=>{});

    // ---- Decoy Timer ----
    const timerDisplay = document.getElementById("timerDisplay");
    const timerStart = document.getElementById("timerStart");
    const timerPause = document.getElementById("timerPause");
    const timerReset = document.getElementById("timerReset");
    let timerSeconds = 25 * 60;
    let timerInterval = null;

    function fmtTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }
    function renderTimer() { timerDisplay.textContent = fmtTime(timerSeconds); }
    function startTimer() {
      if (timerInterval) return;
      timerInterval = setInterval(() => {
        if (timerSeconds > 0) { timerSeconds--; renderTimer(); } else { pauseTimer(); }
      }, 1000);
    }
    function pauseTimer() { clearInterval(timerInterval); timerInterval = null; }
    function resetTimer() { timerSeconds = 25*60; renderTimer(); }
    timerStart.addEventListener("click", startTimer);
    timerPause.addEventListener("click", pauseTimer);
    timerReset.addEventListener("click", resetTimer);
    renderTimer();

    // ---- Quick Exit / Panic ----
    quickExitBtn.addEventListener("click", () => {
      // Immediate redirect to Google
      location.href = "https://www.google.com/";
    });
    panicBtn.addEventListener("click", () => {
      try {
        localStorage.removeItem(LS_KEYS.profile);
        localStorage.removeItem(LS_KEYS.answers);
        localStorage.removeItem(LS_KEYS.resources);
        localStorage.removeItem(LS_KEYS.pin);
      } catch {}
      // Reset in-memory
      profile = { name: "Anonymous", trust: 100 };
      answers = {};
      resources = [];
      lockToDecoy();
    });

    // ---- Long-press on Title to Unlock ----
    const LP_MS = 800;
    function openPin(mode="enter") {
      pinError.textContent = "";
      pinInput.value = "";
      oldPin.value = newPin.value = newPin2.value = "";
      pinChangeFields.classList.add("hidden-soft");
      if (mode === "change") {
        pinModalTitle.textContent = "Change PIN";
        pinChangeFields.classList.remove("hidden-soft");
      } else {
        pinModalTitle.textContent = "Enter PIN";
      }
      pinModal.classList.remove("hidden-soft");
      setTimeout(()=>pinInput.focus(), 50);
      pinForm.dataset.mode = mode;
    }
    function closePin() { pinModal.classList.add("hidden-soft"); }

    function armLongPress(el) {
      const start = () => { longPressTimer = setTimeout(()=> openPin("enter"), LP_MS); };
      const cancel = () => { clearTimeout(longPressTimer); longPressTimer = null; };
      ["pointerdown","touchstart","mousedown"].forEach(ev=> el.addEventListener(ev, start));
      ["pointerup","pointerleave","touchend","touchcancel","mouseup","mouseleave"].forEach(ev=> el.addEventListener(ev, cancel));
    }
    armLongPress(decoyTitle);
    pinCancelBtn.addEventListener("click", closePin);

    pinForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const mode = pinForm.dataset.mode || "enter";
      if (mode === "enter") {
        const expected = getStoredPin();
        if (pinInput.value === expected) {
          closePin();
          unlockRealApp();
        } else {
          pinError.textContent = "Incorrect PIN.";
        }
      } else {
        // change mode
        const expected = getStoredPin();
        if (oldPin.value !== expected) { pinError.textContent = "Current PIN is incorrect."; return; }
        if ((newPin.value ?? "").length < 4) { pinError.textContent = "New PIN must be at least 4 digits."; return; }
        if (newPin.value !== newPin2.value) { pinError.textContent = "New PINs do not match."; return; }
        setStoredPin(newPin.value);
        closePin();
      }
    });

    openChangePin.addEventListener("click", () => openPin("change"));

    // ---- Lock/Unlock ----
    function unlockRealApp() {
      unlocked = true;
      decoyView.classList.add("hidden-soft");
      realApp.classList.remove("hidden-soft");
      realApp.classList.remove("fade-enter"); // ensure visible
      // set default tab
      setActiveTab("home");
      refreshAllUI();
    }
    function lockToDecoy() {
      unlocked = false;
      realApp.classList.add("hidden-soft");
      decoyView.classList.remove("hidden-soft");
    }

    document.addEventListener("visibilitychange", () => {
      if (document.hidden && unlocked) {
        lockToDecoy();
      }
    });

    // ---- Tabs ----
    const tabViews = {
      home: tabHome,
      checkin: tabCheck,
      resources: tabRes,
      profile: tabProfile
    };
    function setActiveTab(name) {
      tabs.forEach(b=>{
        if (b.dataset.tab === name) {
          b.classList.add("bg-blue-600","text-white");
          b.classList.remove("card");
        } else {
          b.classList.remove("bg-blue-600","text-white");
          b.classList.add("card");
        }
      });
      for (const k in tabViews) {
        if (k === name) tabViews[k].classList.remove("hidden-soft");
        else tabViews[k].classList.add("hidden-soft");
      }
    }
    tabs.forEach(b => b.addEventListener("click", ()=> setActiveTab(b.dataset.tab)));
    goToCheckIn.addEventListener("click", ()=> setActiveTab("checkin"));

    // ---- Questions UI ----
    function buildQuestions() {
      questionsBox.innerHTML = "";
      QUESTIONS.forEach((q, idx) => {
        const row = document.createElement("div");
        row.className = "p-3 card";
        const label = document.createElement("div");
        label.className = "text-sm mb-2";
        label.textContent = `${idx+1}. ${q.text}`;
        const toggle = document.createElement("div");
        toggle.className = "toggle flex overflow-hidden";
        const yes = document.createElement("button");
        yes.type="button"; yes.className="opt"; yes.textContent="Yes";
        const no = document.createElement("button");
        no.type="button"; no.className="opt"; no.textContent="No";
        toggle.appendChild(yes); toggle.appendChild(no);
        row.appendChild(label); row.appendChild(toggle);
        questionsBox.appendChild(row);

        const cur = (answers[q.id] || "").toLowerCase();
        if (cur === "yes") yes.classList.add("active-yes");
        if (cur === "no") no.classList.add("active-no");

        yes.addEventListener("click", ()=> { answers[q.id] = "yes"; mark(); updateScores(); persistAnswers(); });
        no.addEventListener("click",  ()=> { answers[q.id] = "no";  mark(); updateScores(); persistAnswers(); });

        function mark() {
          yes.classList.toggle("active-yes", answers[q.id]==="yes");
          no.classList.toggle("active-no", answers[q.id]==="no");
        }
      });
    }

    function computeRiskAndTrust() {
      let risky = 0;
      QUESTIONS.forEach(q => {
        const a = (answers[q.id]||"").toLowerCase();
        if (!a) return;
        if (q.invert) {
          // "Are you currently safe..." -> risky if NO
          if (a === "no") risky++;
        } else {
          // all others risky if YES
          if (a === "yes") risky++;
        }
      });
      const risk = Math.round((risky / QUESTIONS.length) * 100);
      const trust = 100 - risk;
      return { risk, trust };
    }

    function updateScores() {
      const { risk, trust } = computeRiskAndTrust();
      riskPct.textContent = `${risk}%`;
      trustPct.textContent = `${trust}%`;
      trustBadge.textContent = `${trust}%`;
      homeTrust.textContent = `${trust}`;
      profile.trust = trust;
    }

    function refreshAllUI() {
      profileName.textContent = profile.name || "Anonymous";
      homeName.textContent = profile.name || "Anonymous";
      displayNameInput.value = profile.name || "";
      buildQuestions();
      updateScores();
      renderResources();
    }

    function persistAnswers() { saveJSON(LS_KEYS.answers, answers); }

    // ---- Resources ----
    function renderResources() {
      resList.innerHTML = "";
      if (!Array.isArray(resources)) resources = [];
      resources.forEach((r, i) => {
        const li = document.createElement("li");
        li.className = "p-3 card flex items-start justify-between gap-3";
        const txt = document.createElement("div");
        const t = document.createElement("div"); t.className="font-semibold"; t.textContent = r.title || "Untitled";
        const d = document.createElement("div"); d.className="text-sm text-gray-300"; d.textContent = r.desc || "";
        const u = document.createElement("a"); u.className="link text-sm"; u.href = r.url || "#"; u.target="_blank"; u.rel="noreferrer"; u.textContent = r.url || "";
        txt.appendChild(t); if (r.desc) txt.appendChild(d); if (r.url) txt.appendChild(u);
        const del = document.createElement("button");
        del.className = "btn btn-ghost"; del.textContent = "Delete";
        del.addEventListener("click", ()=> {
          resources.splice(i,1);
          saveJSON(LS_KEYS.resources, resources);
          renderResources();
        });
        li.appendChild(txt); li.appendChild(del);
        resList.appendChild(li);
      });
    }

    resForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const item = { title: resTitle.value.trim(), desc: resDesc.value.trim(), url: resUrl.value.trim() };
      if (!item.title) return;
      resources.push(item);
      saveJSON(LS_KEYS.resources, resources);
      resTitle.value = resDesc.value = resUrl.value = "";
      renderResources();
    });

    // ---- Profile ----
    saveProfile.addEventListener("click", async () => {
      profile.name = displayNameInput.value.trim() || "Anonymous";
      saveJSON(LS_KEYS.profile, profile);
      profileName.textContent = profile.name;
      homeName.textContent = profile.name;
      await mirrorProfileToCloud().catch(console.error);
    });

    openChangePin.addEventListener("click", () => openPin("change"));

    // ---- Save (Local + Cloud) ----
    saveAll.addEventListener("click", async () => {
      saveJSON(LS_KEYS.profile, profile);
      saveJSON(LS_KEYS.answers, answers);
      saveJSON(LS_KEYS.resources, resources);
      await Promise.all([
        mirrorProfileToCloud(),
        saveCheckInToCloud()
      ]).catch(console.error);
    });

    saveCheckIn.addEventListener("click", async () => {
      persistAnswers();
      await saveCheckInToCloud().catch(console.error);
    });

    clearCheckIn.addEventListener("click", () => {
      answers = {};
      persistAnswers();
      buildQuestions();
      updateScores();
    });

    // ---- Cloud Ops ----
    async function mirrorProfileToCloud() {
      if (!uid) return;
      const ref = doc(db, "artifacts/timeout-app/public/data/profiles", uid);
      await setDoc(ref, {
        publicName: profile.name || "Anonymous",
        trustScore: profile.trust ?? 100,
        appVersion: APP_VERSION,
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp() // Firestore will set on first write; harmless if overwritten
      }, { merge: true });
    }

    async function saveCheckInToCloud() {
      if (!uid) return;
      const { risk, trust } = computeRiskAndTrust();
      const col = collection(db, "artifacts/timeout-app/private/data/checkins");
      await addDoc(col, {
        userId: uid,
        answers: { ...answers },
        profile: { name: profile.name || "Anonymous", trustScore: trust },
        riskPercent: risk,
        appVersion: APP_VERSION,
        createdAt: serverTimestamp()
      });
      profile.trust = trust;
      saveJSON(LS_KEYS.profile, profile);
      updateScores();
    }

    // ---- Export JSON ----
    exportJson.addEventListener("click", () => {
      const payload = {
        version: APP_VERSION,
        uid: uid || null,
        profile: loadJSON(LS_KEYS.profile, { name:"Anonymous", trust:100 }),
        answers: loadJSON(LS_KEYS.answers, {}),
        resources: loadJSON(LS_KEYS.resources, [])
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "timeout-data.json";
      document.body.appendChild(a);
      a.click();
      setTimeout(()=> { URL.revokeObjectURL(url); a.remove(); }, 0);
    });

    // ---- Initial Local Defaults ----
    // Ensure default PIN exists (2580) unless user changed it
    if (!localStorage.getItem(LS_KEYS.pin)) setStoredPin(DEFAULT_PIN);
    // Load saved resources into UI
    renderResources();
    // Prepare questions UI (even before unlock, so it's ready)
    buildQuestions();
    updateScores();

    // ---- Tab Buttons Save Guards ----
    tabs.forEach(b => b.addEventListener("click", () => {
      // nothing special; kept for future guards
    }));

    // ---- PIN modal escape ----
    pinModal.addEventListener("click", (e) => {
      if (e.target === pinModal) closePin();
    });

    // ---- Keyboard shortcuts (optional helpful) ----
    document.addEventListener("keydown", (e) => {
      // Quick lock with Escape when in real app
      if (e.key === "Escape" && unlocked) lockToDecoy();
    });
  </script>
</body>
</html>
