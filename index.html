<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TimeOut</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96'%3E%3Ccircle cx='48' cy='48' r='46' fill='%23fefce8' stroke='%23365b2c' stroke-width='4'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-size='46' font-family='Arial' fill='%23365b2c'%3ET%3C/text%3E%3C/svg%3E" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* ==== THEME (Olive + Rose) ==== */
  :root{
    --brand:#6b8e23;      /* Olive primary */
    --brand-ink:#ffffff;
    --accent:#e11d48;     /* Rose for EXIT/Danger */
    --ink:#1f2937;
    --muted:#6b7280;
    --paper:#fcfbf7;
    --card:#ffffff;
    --edge:#e5e7eb;
    --chip:#eef6e6;
  }
  html,body{background:var(--paper); color:var(--ink);}
  .btn{ padding:.55rem .8rem; border:1px solid var(--edge); border-radius:.8rem; background:var(--card); font-size:.95rem; transition:transform .05s ease; }
  .btn:active{ transform:scale(.97); }
  .btn-primary{ background:var(--brand); color:var(--brand-ink); border-color:var(--brand); }
  .btn-ghost{ background:transparent; border-color:transparent; color:var(--muted); }
  .btn-danger{ background:var(--accent); color:#fff; border-color:var(--accent); }
  #btnQuickExit{ background:var(--accent); color:#fff; border-color:var(--accent); }
  .btn-badge{ font-size:.8rem; padding:.25rem .5rem; border-radius:.5rem; border-color:#d1d5db; }
  .card{ background:var(--card); border:1px solid var(--edge); border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .hidden-soft{ display:none !important; }
  .panel-scroll{ max-height:calc(100vh - 160px); overflow:auto; -webkit-overflow-scrolling:touch; }
  header .btn { min-width:44px; min-height:44px; }
  #hdrClock,#hdrWeather{ display:inline-flex; align-items:center; max-width:44vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .demo-qs button{ display:block; width:100%; text-align:left; margin:.3rem 0; padding:.45rem .6rem; border-radius:.5rem; background:#f3f4f6; }
  .kbd{ font:600 .78rem/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas; background:#f3f4f6; border:1px solid #e5e7eb; padding:.1rem .35rem; border-radius:.4rem; }
  footer.small{ font-size:.72rem; color:#9ca3af; }

  /* ==== Questionnaire emphasis ==== */
  .yn-btn{ border:1px solid var(--edge); background:var(--chip); }
  .yn-btn.selected{ background:var(--brand)!important; color:var(--brand-ink)!important; border-color:var(--brand)!important; }
  .q-card{ border-color:#dfe8cf; background:#fafdf5; }
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-gray-200">
    <div class="max-w-md mx-auto flex items-center justify-between px-3 py-2">
      <div class="flex items-center gap-2">
        <button id="langToggle" class="btn btn-ghost">EN/ES</button>
        <div id="hdrClock" class="text-sm font-medium">--:--</div>
      </div>
      <h1 id="appTitle" class="text-lg font-semibold select-none">TimeOut</h1>
      <div class="flex items-center gap-2">
        <div id="hdrWeather" class="text-sm">‚õÖ</div>
        <button id="btnBack" class="btn btn-ghost hidden-soft">Back</button>
        <button id="btnQuickExit" class="btn btn-ghost hidden-soft">Exit</button>
        <button id="btnPanic" class="btn btn-ghost hidden-soft">Clear&Lock</button>
      </div>
    </div>
  </header>

  <!-- DECOY VIEW -->
  <main id="decoyView" class="max-w-md mx-auto px-3 pt-4 pb-24">
    <section class="card p-4 mb-3">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Timer</h2>
        <span class="text-xs text-gray-500">Long-press title or timer to unlock</span>
      </div>
      <div id="decoyTimerDisplay" class="text-5xl font-mono text-center my-3 select-none">25:00</div>
      <div class="flex gap-2 justify-center">
        <button id="decoyStart" class="btn">Start</button>
        <button id="decoyPause" class="btn">Pause</button>
        <button id="decoyReset" class="btn">Reset</button>
      </div>
    </section>
    <section class="card p-4 mb-3">
      <h2 class="text-base font-semibold mb-2">Calculator</h2>
      <input id="calcInput" class="w-full border rounded-lg px-3 py-2 mb-2" placeholder="e.g., 12+3*4" inputmode="numeric">
      <button id="calcEval" class="btn">=</button>
      <span id="calcOut" class="ml-3 font-mono"></span>
    </section>
    <section class="card p-4 mb-3">
      <h2 class="text-base font-semibold mb-2">Notes</h2>
      <textarea id="decoyNotes" class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="Quick notes‚Ä¶"></textarea>
    </section>
    <footer class="max-w-md mx-auto text-center mt-4">
      <div class="small">v1.3.5</div>
    </footer>
  </main>

  <!-- REAL APP -->
  <main id="appView" class="max-w-md mx-auto px-3 pt-4 pb-28 hidden-soft">
    <!-- Home -->
    <section id="tab-home" class="panel-scroll">
      <div class="card p-4 mb-3">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold" id="homeTitle">Welcome</h2>
          <span class="btn-badge" id="verBadge">v1.3.5</span>
        </div>
        <p class="text-sm text-gray-600 mb-3" id="homeHello">Hi, Anonymous.</p>
        <div class="grid grid-cols-2 gap-2">
          <div class="card p-3">
            <div class="text-sm text-gray-500">Risk</div>
            <div id="riskPct" class="text-2xl font-mono">0%</div>
          </div>
          <div class="card p-3">
            <div class="text-sm text-gray-500">Trust</div>
            <div id="trustPct" class="text-2xl font-mono">100%</div>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-primary" onclick="setTab('checkin')">Go to Check-In</button>
          <button class="btn" onclick="setTab('plan')">Open Plan</button>
        </div>
      </div>
      <div id="safetyCard" class="card p-4">
        <h3 class="font-semibold mb-1" id="safetyTitle">Important Safety Notice</h3>
        <p class="text-sm text-gray-600" id="safetyText">
          This tool helps with planning and private check-ins. It is not emergency help or a guarantee of safety.
          If in danger, call local emergency services.
        </p>
        <button id="btnAckSafety" class="btn btn-primary mt-3">I Understand</button>
      </div>
    </section>

    <!-- Check-In -->
    <section id="tab-checkin" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <div class="flex items-center">
          <h2 id="checkTitle" class="text-lg font-semibold">Check-In</h2>
          <button class="btn btn-ghost" id="askChipCheck" title="Ask support">üéôÔ∏è Ask</button>
        </div>
        <p class="text-sm text-gray-600 mb-2" id="checkIntro">
          Answer 13 quick questions. Buttons highlight. Risk% updates live.
        </p>
        <div id="questions" class="space-y-2"></div>
        <div id="checkFeedback" class="mt-3 space-y-2"></div>
        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnLoadDemo" class="btn">Load Demo Answers</button>
          <button id="btnSaveCheckin" class="btn btn-primary">Save Check-In</button>
        </div>
      </div>
    </section>

    <!-- Plan -->
    <section id="tab-plan" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <div class="flex items-center">
          <h2 id="planTitle" class="text-lg font-semibold">Safety Plan</h2>
          <button class="btn btn-ghost" id="askChipPlan" title="Ask support">üéôÔ∏è Ask</button>
        </div>
        <div class="mt-2 flex gap-2 flex-wrap">
          <button id="btnNewPlan" class="btn">New Plan</button>
          <button id="btnTemplates" class="btn">Templates</button>
          <button id="btnQuickGenerate" class="btn btn-primary">Quick Generate</button>
        </div>
        <div id="plansList" class="mt-3 space-y-2"></div>
      </div>

      <div id="demoQs" class="card p-4">
        <div class="font-semibold mb-2">Example Questions</div>
        <div class="demo-qs">
          <button>Am I safe if I leave now?</button>
          <button>Where can I get help tonight?</button>
          <button>What should I put in my go-bag?</button>
        </div>
      </div>
    </section>

    <!-- Resources -->
    <section id="tab-resources" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <h2 id="resTitle" class="text-lg font-semibold">Resources</h2>
        <p class="text-sm text-gray-600 mb-2">Tap a resource to copy. Use ‚ÄúCall Hotline‚Äù.</p>
        <div class="flex gap-2 mb-2 flex-wrap">
          <button id="callHotlineBtn" class="btn">Call Hotline</button>
          <button id="btnAddResource" class="btn">Add</button>
          <button id="btnSeedLocal" class="btn">Add Local 211</button>
        </div>
        <div id="resList" class="space-y-2"></div>
      </div>
    </section>

    <!-- Profile -->
    <section id="tab-profile" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <h2 class="text-lg font-semibold">Profile</h2>
        <label class="block text-sm mb-1">Display name</label>
        <input id="profName" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="Anonymous">
        <label class="block text-sm mb-1">Change PIN</label>
        <div class="grid grid-cols-3 gap-2">
          <input id="oldPin" class="border rounded-lg px-3 py-2" placeholder="Old" inputmode="numeric" maxlength="8">
          <input id="newPin" class="border rounded-lg px-3 py-2" placeholder="New" inputmode="numeric" maxlength="8">
          <input id="newPin2" class="border rounded-lg px-3 py-2" placeholder="Confirm" inputmode="numeric" maxlength="8">
        </div>
        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnSaveProfile" class="btn btn-primary">Save Profile</button>
          <button id="btnExport" class="btn">Export JSON</button>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">Theme:</span>
            <select id="themePick" class="border rounded-lg px-2 py-2 text-sm">
              <option value="blue">Blue</option>
              <option value="teal">Teal</option>
              <option value="rose">Rose</option>
              <option value="amber">Amber</option>
              <option value="violet">Violet</option>
            </select>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Tabs -->
  <nav id="bottomNav" class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 hidden-soft">
    <div class="max-w-md mx-auto grid grid-cols-5 text-sm">
      <button onclick="setTab('home')" class="py-2 flex flex-col items-center"><span>üè†</span><span id="navHome">Home</span></button>
      <button onclick="setTab('checkin')" class="py-2 flex flex-col items-center"><span>‚úÖ</span><span id="navCheck">Check-In</span></button>
      <button onclick="setTab('plan')" class="py-2 flex flex-col items-center"><span>üß≠</span><span id="navPlan">Plan</span></button>
      <button onclick="setTab('resources')" class="py-2 flex flex-col items-center"><span>üìö</span><span id="navRes">Resources</span></button>
      <button onclick="setTab('profile')" class="py-2 flex flex-col items-center"><span>üë§</span><span id="navProf">Profile</span></button>
    </div>
  </nav>

  <!-- PIN Modal -->
  <div id="pinModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden-soft items-center justify-center">
    <div class="card p-4 w-[92vw] max-w-sm">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Enter PIN</h3>
        <button id="pinClose" class="btn btn-ghost">‚úï</button>
      </div>
      <input id="pinInput" class="w-full border rounded-lg px-3 py-2" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <div class="mt-3 flex gap-2">
        <button id="pinOk" class="btn btn-primary">Unlock</button>
        <button id="pinCancel" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Ask Modal host -->
  <div id="askModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden-soft items-center justify-center"></div>
  <!-- Floating Ask -->
  <button id="askFab" class="btn btn-primary hidden-soft" style="position:fixed;right:16px;bottom:84px;z-index:55">üéôÔ∏è Ask</button>

<script>
/* ===================== CORE STATE ===================== */
const core = {
  lang: localStorage.getItem('timeout_lang') || 'en',
  pin: localStorage.getItem('timeout_pin') || '2580',
  name: localStorage.getItem('timeout_profile_name') || 'Anonymous',
  answers: JSON.parse(localStorage.getItem('timeout_answers')||'{}'),
  resources: JSON.parse(localStorage.getItem('timeout_resources')||'[]'),
  plans: JSON.parse(localStorage.getItem('timeout_plans')||'[]'),
  theme: localStorage.getItem('timeout_theme') || 'blue',
  risk: 0, trust: 100
};
const $ = id => document.getElementById(id);
function saveLocal(){
  localStorage.setItem('timeout_lang', core.lang);
  localStorage.setItem('timeout_pin', core.pin);
  localStorage.setItem('timeout_profile_name', core.name);
  localStorage.setItem('timeout_answers', JSON.stringify(core.answers));
  localStorage.setItem('timeout_resources', JSON.stringify(core.resources));
  localStorage.setItem('timeout_plans', JSON.stringify(core.plans));
  localStorage.setItem('timeout_theme', core.theme);
}
function toast(msg){ alert(msg); }

/* ===================== THEME ===================== */
function applyTheme(){
  const map={
    blue:{brand:'#2563eb',ink:'#ffffff'},
    teal:{brand:'#0ea5a4',ink:'#002b2a'},
    rose:{brand:'#e11d48',ink:'#ffffff'},
    amber:{brand:'#f59e0b',ink:'#1f2937'},
    violet:{brand:'#7c3aed',ink:'#ffffff'}
  }[core.theme] || {brand:'#6b8e23',ink:'#ffffff'}; // default olive
  document.documentElement.style.setProperty('--brand', map.brand);
  document.documentElement.style.setProperty('--brand-ink', map.ink);
  $('themePick').value = core.theme;
}
$('themePick').addEventListener('change', e=>{ core.theme=e.target.value; saveLocal(); applyTheme(); });

/* ===================== LANGUAGE ===================== */
$('langToggle').onclick = ()=>{
  core.lang = core.lang === 'en' ? 'es' : 'en';
  saveLocal();
  applyAll();
  const askOpen = !$('askModal').classList.contains('hidden-soft');
  if (askOpen) { $('askModal').dataset.ready=''; ensureAskModal(); }
};
function T(en, es){ return core.lang==='es'? es: en; }
function applyLang(){
  $('langToggle').textContent = core.lang==='es'?'ES/EN':'EN/ES';
  $('btnQuickExit').textContent = T('Exit','Salir');
  $('btnPanic').textContent = T('Clear&Lock','Borrar y Bloquear');
  $('btnBack').textContent = T('Back','Atr√°s');
  $('homeTitle').textContent = T('Welcome','Bienvenido/a');
  $('homeHello').textContent = T(`Hi, ${core.name}.`, `Hola, ${core.name}.`);
  $('resTitle').textContent = T('Resources','Recursos');
  $('checkTitle').textContent = T('Check-In','Autoevaluaci√≥n');
  $('checkIntro').textContent = T('Answer 13 quick questions. Buttons highlight. Risk% updates live.','Responde 13 preguntas r√°pidas. Los botones se resaltan. El % de riesgo se actualiza en vivo.');
  $('planTitle').textContent = T('Safety Plan','Plan de Seguridad');
  $('navHome').textContent = T('Home','Inicio');
  $('navCheck').textContent = T('Check-In','Autoeval.');
  $('navPlan').textContent = T('Plan','Plan');
  $('navRes').textContent = T('Resources','Recursos');
  $('navProf').textContent = T('Profile','Perfil');

  const dqs = document.querySelectorAll('#demoQs .demo-qs button');
  if(dqs[0]) dqs[0].textContent = T('Am I safe if I leave now?','¬øEstoy seguro/a si me voy ahora?');
  if(dqs[1]) dqs[1].textContent = T('Where can I get help tonight?','¬øD√≥nde puedo obtener ayuda esta noche?');
  if(dqs[2]) dqs[2].textContent = T('What should I put in my go-bag?','¬øQu√© debo poner en mi bolsa de emergencia?');

  const sTitle = document.getElementById('safetyTitle');
  const sText  = document.getElementById('safetyText');
  const sBtn   = document.getElementById('btnAckSafety');
  if (sTitle) sTitle.textContent = T('Important Safety Notice','Aviso importante de seguridad');
  if (sText)  sText.textContent  = T(
    'This tool helps with planning and private check-ins. It is not emergency help or a guarantee of safety. If in danger, call local emergency services.',
    'Esta herramienta ayuda con la planificaci√≥n y chequeos privados. No es ayuda de emergencia ni garant√≠a de seguridad. En peligro, llama a emergencias locales.'
  );
  if (sBtn)   sBtn.textContent   = T('I Understand','Entiendo');
}

/* ===================== CLOCK & WEATHER ===================== */
function tickClock(){
  const d = new Date();
  const h = d.getHours().toString().padStart(2,'0');
  const m = d.getMinutes().toString().padStart(2,'0');
  $('hdrClock').textContent = `${h}:${m}`;
}
setInterval(tickClock, 1000); tickClock();
(function setWeather(){ $('hdrWeather').textContent = '‚õÖ'; })();

/* ===================== DECOY: STOPWATCH/CALC/NOTES ===================== */
let swInterval=null, swSeconds=25*60;
function renderStopwatch(){ const mm=Math.floor(swSeconds/60).toString().padStart(2,'0'); const ss=(swSeconds%60).toString().padStart(2,'0'); $('decoyTimerDisplay').textContent=`${mm}:${ss}`;}
$('decoyStart').onclick=()=>{ if(swInterval) return; swInterval=setInterval(()=>{ if(swSeconds>0){ swSeconds--; renderStopwatch(); }},1000); };
$('decoyPause').onclick=()=>{ clearInterval(swInterval); swInterval=null; };
$('decoyReset').onclick=()=>{ swSeconds=25*60; renderStopwatch(); };
renderStopwatch();
$('calcEval').onclick=()=>{ try{ const v=eval(($('calcInput').value||'').replace(/[^0-9+\-*/(). ]/g,'')); $('calcOut').textContent = isFinite(v)? v: '‚Äî'; }catch{ $('calcOut').textContent='‚Äî'; } };
$('decoyNotes').value = localStorage.getItem('timeout_decoy_notes') || '';
$('decoyNotes').addEventListener('input', e=> localStorage.setItem('timeout_decoy_notes', e.target.value));

/* ===================== UNLOCK (LONG PRESS + PIN) ===================== */
let lpTimer=null;
function bindLongPress(el){
  const start=()=>{ lpTimer=setTimeout(()=> openPinModal(), 800); };
  const clear=()=>{ clearTimeout(lpTimer); };
  el.addEventListener('mousedown',start); el.addEventListener('touchstart',start,{passive:true});
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> el.addEventListener(ev, clear));
}
bindLongPress($('appTitle'));
bindLongPress($('decoyTimerDisplay'));
function openPinModal(){ $('pinModal').classList.remove('hidden-soft'); $('pinInput').value=''; $('pinInput').focus(); }
function closePinModal(){ $('pinModal').classList.add('hidden-soft'); }
$('pinClose').onclick=closePinModal; $('pinCancel').onclick=closePinModal;
$('pinOk').onclick=tryUnlock;
$('pinInput').addEventListener('keydown', e=>{ if(e.key==='Enter') tryUnlock(); });
function tryUnlock(){
  const v = $('pinInput').value.trim();
  if(v===core.pin){ showRealApp(); closePinModal(); }
  else { toast(T('Wrong PIN','PIN incorrecto')); }
}

/* ===================== LOCK/UNLOCK + SAFETY ===================== */
function showRealApp(){
  $('decoyView').classList.add('hidden-soft');
  $('appView').classList.remove('hidden-soft');
  $('bottomNav').classList.remove('hidden-soft');
  $('btnQuickExit').classList.remove('hidden-soft');
  $('btnPanic').classList.remove('hidden-soft');
  $('btnBack').classList.remove('hidden-soft');
  $('askFab').classList.remove('hidden-soft');
  applyLang();
}
function lockToDecoy(){
  $('appView').classList.add('hidden-soft');
  $('bottomNav').classList.add('hidden-soft');
  $('btnQuickExit').classList.add('hidden-soft');
  $('btnPanic').classList.add('hidden-soft');
  $('btnBack').classList.add('hidden-soft');
  $('askFab').classList.add('hidden-soft');
  $('decoyView').classList.remove('hidden-soft');
  closeAsk();
}
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) lockToDecoy(); });
$('btnQuickExit').onclick=()=>{ location.href='https://www.google.com/'; };
$('btnPanic').onclick=()=>{ 
  localStorage.removeItem('timeout_profile_name'); 
  localStorage.removeItem('timeout_answers'); 
  localStorage.removeItem('timeout_resources'); 
  localStorage.removeItem('timeout_plans'); 
  localStorage.removeItem('timeout_theme');
  core.name='Anonymous'; core.answers={}; core.resources=[]; core.plans=[]; core.theme='blue';
  saveLocal(); applyTheme(); lockToDecoy(); 
};

/* ===================== TABS ===================== */
function setTab(name){
  ['home','checkin','plan','resources','profile'].forEach(t=>{
    $('tab-'+t).classList.toggle('hidden-soft', t!==name);
  });
  if(name==='checkin'){ buildQuestions(); updateScoresAndFeedback(); }
  if(name==='plan'){ renderPlans(); }
  if(name==='resources'){ renderResources(); }
}
window.setTab = setTab;

/* ===================== SAFETY ACK (ONCE) ===================== */
function applySafetyAckVisibility(){
  const seen = localStorage.getItem('timeout_safety_ack') === '1';
  const card = document.getElementById('safetyCard');
  if (card) card.style.display = seen ? 'none' : '';
}
document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'btnAckSafety') {
    localStorage.setItem('timeout_safety_ack','1');
    applySafetyAckVisibility();
  }
});

/* ===================== CHECK-IN (13 refined questions + synopsis) ===================== */
const QUESTIONS_EN = [
  "Do you feel safe in your current living space?",
  "Has your partner or someone close to you threatened you recently?",
  "Have you experienced physical harm or injury in the last month?",
  "Does your partner monitor your phone, accounts, or location?",
  "Are you prevented from leaving freely if you wish?",
  "Do you have children or dependents currently at risk?",
  "Do you feel isolated from family, friends, or support?",
  "Do you have access to money or financial resources of your own?",
  "Are you being pressured or forced into sexual activity?",
  "Have you noticed increased jealousy or controlling behavior?",
  "Do you have important documents (ID, bank cards) secured?",
  "Do you have a trusted contact aware of your situation?",
  "Have threats or abuse become more frequent or severe?"
];
const QUESTIONS_ES = [
  "¬øTe sientes seguro/a en tu lugar de residencia actual?",
  "¬øTu pareja u otra persona cercana te ha amenazado recientemente?",
  "¬øHas sufrido da√±o f√≠sico o lesiones en el √∫ltimo mes?",
  "¬øTu pareja controla tu tel√©fono, cuentas o ubicaci√≥n?",
  "¬øTe impiden salir libremente si lo deseas?",
  "¬øTienes hijos o dependientes actualmente en riesgo?",
  "¬øTe sientes aislado/a de familia, amistades o apoyo?",
  "¬øTienes acceso a dinero o recursos financieros propios?",
  "¬øEst√°s siendo presionado/a o forzado/a a actividad sexual?",
  "¬øHas notado celos o conductas de control m√°s intensas?",
  "¬øTienes documentos importantes (ID, tarjetas) asegurados?",
  "¬øAlguien de confianza conoce tu situaci√≥n?",
  "¬øLas amenazas o abusos se han vuelto m√°s frecuentes o graves?"
];
function getQuestions(){ return core.lang==='es' ? QUESTIONS_ES : QUESTIONS_EN; }

function qRow(i, text){
  const qid = 'q'+(i+1);
  const yesSel = core.answers[qid]==='yes' ? 'selected' : '';
  const noSel  = core.answers[qid]==='no'  ? 'selected' : '';
  const yesLab = T('Yes','S√≠');
  const noLab  = T('No','No');
  return `
    <div class="card q-card p-3">
      <div class="mb-2 text-sm">${i+1}. ${text}</div>
      <div class="flex gap-2">
        <button class="btn yn-btn ${yesSel}" data-q="${qid}" data-v="yes">${yesLab}</button>
        <button class="btn yn-btn ${noSel}"  data-q="${qid}" data-v="no">${noLab}</button>
      </div>
    </div>`;
}
function buildQuestions(){
  const box = $('questions'); if(!box) return;
  box.innerHTML = '';
  getQuestions().forEach((q,i)=>{ box.insertAdjacentHTML('beforeend', qRow(i,q)); });
}

/* Risk logic */
const RISK_RULES = {
  q1:'no', q2:'yes', q3:'yes', q4:'yes', q5:'yes',
  q6:'yes', q7:'yes', q8:'no', q9:'yes', q10:'yes',
  q11:'no', q12:'no', q13:'yes'
};
function computeRisk(){
  let risk = 0; 
  for (let i=1;i<=13;i++){
    const k='q'+i, v=core.answers[k];
    if(!v) continue;
    if(RISK_RULES[k]===v) risk++;
  }
  const pct = Math.round((risk/13)*100);
  core.risk = pct; core.trust = 100 - pct;
}
function updateScoresAndFeedback(){
  computeRisk();
  $('riskPct').textContent = core.risk + '%';
  $('trustPct').textContent = core.trust + '%';
  const fb = $('checkFeedback'); if(!fb) return;
  fb.innerHTML = '';

  if(core.risk>=60){
    fb.insertAdjacentHTML('beforeend', `<div class="card p-3 text-sm">‚ö†Ô∏è ${T('High risk ‚Äî consider opening the Plan tab and contacting a hotline in Resources.','Riesgo alto ‚Äî considera abrir la pesta√±a Plan y contactar una l√≠nea de ayuda en Recursos.')}</div>`);
  } else if(core.risk>=30){
    fb.insertAdjacentHTML('beforeend', `<div class="card p-3 text-sm">${T('Moderate risk ‚Äî keep a go-bag and a trusted contact ready.','Riesgo moderado ‚Äî prepara una bolsa de emergencia y un contacto de confianza.')}</div>`);
  } else {
    fb.insertAdjacentHTML('beforeend', `<div class="card p-3 text-sm">${T('Low risk reported ‚Äî stay prepared and review your plan weekly.','Riesgo bajo ‚Äî mantente preparado/a y revisa tu plan semanalmente.')}</div>`);
  }

  const syn = (()=>{
    if(core.risk>=60){
      return T(
        "Your responses indicate urgent safety concerns. Prioritize immediate safety steps (leave to a public place if needed, keep essentials ready, and contact a hotline or a trusted person). Consider documenting incidents safely and updating your plan.",
        "Tus respuestas indican preocupaciones de seguridad urgentes. Prioriza pasos inmediatos (sal a un lugar p√∫blico si es necesario, ten lo esencial listo y contacta una l√≠nea de apoyo o a alguien de confianza). Considera documentar incidentes de forma segura y actualiza tu plan."
      );
    } else if(core.risk>=30){
      return T(
        "There are several warning signs. Strengthen your plan, identify exits and safe contacts, and prepare a small go-bag. Monitor changes and consider speaking with an advocate when possible.",
        "Hay varias se√±ales de alerta. Refuerza tu plan, identifica salidas y contactos seguros, y prepara una bolsa de emergencia. Monitorea cambios y considera hablar con un/a asesor/a cuando sea posible."
      );
    }
    return T(
      "You reported fewer safety concerns. Maintain awareness, review your plan weekly, and keep documents and essentials ready. Re-check if anything changes.",
      "Reportaste menos preocupaciones de seguridad. Mant√©n la atenci√≥n, revisa tu plan semanalmente y conserva documentos y esenciales listos. Vuelve a evaluar si algo cambia."
    );
  })();

  const disc = T(
    "Disclaimer: This guidance is informational and not a diagnosis, treatment, or emergency service. If you feel unsafe at any time, call emergency services.",
    "Aviso: Esta orientaci√≥n es informativa y no constituye diagn√≥stico, tratamiento ni servicio de emergencia. Si te sientes en peligro, llama a emergencias."
  );
  const care = T(
    "Use this TimeOut to think about resources. TimeOut cares. You are not alone.",
    "Usa este TimeOut para pensar en recursos. TimeOut se preocupa por ti. No est√°s solo/a."
  );

  fb.insertAdjacentHTML('beforeend', `
    <div class="card p-3 text-sm">
      <p>${syn}</p>
      <p class="mt-2 italic">${disc}</p>
      <p class="mt-2 font-semibold">${care}</p>
    </div>
  `);
}
document.addEventListener('click', (e)=>{
  const b = e.target.closest('.yn-btn'); if(!b) return;
  const qid = b.dataset.q; const val=b.dataset.v; if(!qid||!val) return;
  core.answers[qid] = val; saveLocal();
  document.querySelectorAll(`.yn-btn[data-q="${qid}"]`).forEach(x=>x.classList.remove('selected'));
  b.classList.add('selected'); updateScoresAndFeedback();
});
$('btnLoadDemo').onclick=()=>{
  core.answers = { 
    q1:'no', q2:'yes', q3:'no', q4:'yes', q5:'no', q6:'no', q7:'yes',
    q8:'no', q9:'no', q10:'yes', q11:'no', q12:'no', q13:'yes'
  };
  saveLocal(); buildQuestions(); updateScoresAndFeedback();
};
$('btnSaveCheckin').onclick=()=>{ saveLocal(); toast(T('Check-In saved.','Autoevaluaci√≥n guardada.')); };

/* ===================== SAFETY PLAN ===================== */
function renderPlans(){
  const list = $('plansList'); if(!list) return;
  list.innerHTML='';
  if(core.plans.length===0){
    list.insertAdjacentHTML('beforeend', `<div class="text-sm text-gray-600">${T('No plans yet. Use New, Templates, or Quick Generate.','A√∫n no hay planes. Usa Nuevo, Plantillas o Generar R√°pido.')}</div>`);
    return;
  }
  core.plans.forEach((p,idx)=>{
    const steps = (p.steps||[]).map(s=>`<li class="list-disc ml-5">${s}</li>`).join('');
    const card = `
      <div class="card p-3">
        <div class="flex items-center justify-between">
          <div class="font-semibold">${p.title||T('Untitled','Sin t√≠tulo')}</div>
          <button data-i="${idx}" class="btn btn-ghost text-rose-600 delPlan">${T('Delete','Eliminar')}</button>
        </div>
        ${steps? `<ul class="mt-2 text-sm">${steps}</ul>`:''}
      </div>`;
    list.insertAdjacentHTML('beforeend', card);
  });
  list.querySelectorAll('.delPlan').forEach(btn=>{
    btn.onclick=()=>{ const i=+btn.dataset.i; core.plans.splice(i,1); saveLocal(); renderPlans(); };
  });
}
$('btnNewPlan').onclick=()=>{
  const t = prompt(T('Plan title?','¬øT√≠tulo del plan?')) || T('Personal Plan','Plan personal');
  const s = prompt(T('Steps (comma-separated):','Pasos (separados por comas):')) || '';
  const steps = s.split(',').map(x=>x.trim()).filter(Boolean);
  core.plans.push({title:t, steps}); saveLocal(); renderPlans();
};
$('btnTemplates').onclick=()=>{
  const template = { title:T('Grab & Go Bag','Bolsa de emergencia'), steps:[T('ID & documents','Identificaci√≥n y documentos'),T('Keys & cash','Llaves y efectivo'),T('Medications','Medicamentos'),T('Change of clothes','Cambio de ropa'),T('Backup phone numbers','N√∫meros de tel√©fono de respaldo')] };
  core.plans.push(template); saveLocal(); renderPlans();
};
let qpGuard=false;
$('btnQuickGenerate').onclick=()=>{
  if(qpGuard) return; qpGuard=true; setTimeout(()=>qpGuard=false,600);
  const a=core.answers; const steps=[];
  if(a.q4==='yes') steps.push(T('Minimize sensitive content on phone; enable screen lock.','Minimiza contenido sensible en el tel√©fono; activa el bloqueo de pantalla.'));
  if(a.q2==='yes' || a.q3==='yes') steps.push(T('Document dates/times privately; tell a trusted person.','Documenta fechas/horas en privado; avisa a alguien de confianza.'));
  if(a.q1==='no') steps.push(T('Move to public place; call a hotline or trusted person.','Mu√©vete a un lugar p√∫blico; llama a una l√≠nea de ayuda o a alguien de confianza.'));
  if(a.q6==='yes') steps.push(T('Set meeting point and alternate caregiver for children.','Define punto de encuentro y cuidador alterno para los ni√±os.'));
  if(a.q12==='no') steps.push(T('Identify one trusted contact and share a simple code word.','Identifica un contacto de confianza y comparte una palabra clave.'));
  if(steps.length===0) steps.push(T('Share location with a trusted person; review exits and transport.','Comparte ubicaci√≥n con alguien de confianza; revisa salidas y transporte.'));
  core.plans.push({title:T('Quick Plan','Plan r√°pido'), steps}); saveLocal(); renderPlans(); toast(T('Quick plan created.','Plan r√°pido creado.'));
};
document.getElementById('demoQs').addEventListener('click', e=>{
  const b=e.target.closest('button'); if(!b) return;
  openAsk(); setTimeout(()=>{ const i=$('askInput'); if(i){ i.value=b.textContent; i.focus(); }},250);
});

/* ===================== RESOURCES ===================== */
function seedResourcesIfEmpty(){
  if(!Array.isArray(core.resources) || core.resources.length===0){
    core.resources = [
      {title:"National Domestic Violence Hotline (US)", desc:"24/7 confidential help ‚Äî call or chat", url:"tel:+18007997233"},
      {title:"RAINN Sexual Assault Hotline (US)", desc:"24/7 ‚Äî phone + online chat", url:"tel:+18006564673"},
      {title:"Childhelp National Child Abuse Hotline (US)", desc:"24/7 ‚Äî children & adults", url:"tel:+18004224453"},
      {title:"StrongHearts Native Helpline (US)", desc:"Support for Native communities", url:"tel:+18447628483"},
      {title:"love is respect (US)", desc:"Dating abuse support ‚Äî call/text/chat", url:"https://www.loveisrespect.org/"},
      {title:"National Deaf DV Hotline (US)", desc:"Deaf/Hard of Hearing support (ASL)", url:"https://thedeafhotline.org/"},
      {title:"211 ‚Äî Local Services (US/Canada)", desc:"Housing, legal, financial, counseling", url:"https://www.211.org/"},
      {title:"SAMHSA Helpline (US)", desc:"Mental health & substance use", url:"tel:+18006624357"},
      {title:"Emergency", desc:"Call your local emergency number", url:"tel:911"}
    ];
    saveLocal();
  }
}
function renderResources(){
  const box=$('resList'); box.innerHTML='';
  core.resources.forEach((r,i)=>{
    const isTel = /^tel:/i.test(r.url||'');
    const item = `
      <div class="card p-3 flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="font-semibold truncate">${r.title}</div>
          <div class="text-sm text-gray-600">${r.desc||''}</div>
          <div class="text-xs mt-1 break-all">${r.url}</div>
        </div>
        <div class="flex flex-col gap-2 shrink-0">
          ${isTel? `<a class="btn" href="${r.url}">${T('Call','Llamar')}</a>` : `<button class="btn openRes" data-i="${i}">${T('Open','Abrir')}</button>`}
          <button class="btn copyRes" data-i="${i}">${T('Copy','Copiar')}</button>
          <button class="btn delRes text-rose-600" data-i="${i}">${T('Delete','Eliminar')}</button>
        </div>
      </div>`;
    box.insertAdjacentHTML('beforeend', item);
  });
  box.querySelectorAll('.copyRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; navigator.clipboard.writeText(core.resources[i].url||''); toast(T('Copied.','Copiado.')); });
  box.querySelectorAll('.delRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; core.resources.splice(i,1); saveLocal(); renderResources(); });
  box.querySelectorAll('.openRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; const u=core.resources[i].url; if(u) location.href=u; });
}
$('callHotlineBtn').onclick=()=>{ location.href='tel:+18007997233'; };
$('btnAddResource').onclick=()=>{
  const title = prompt(T('Title','T√≠tulo'))||''; if(!title) return;
  const desc  = prompt(T('Description (optional)','Descripci√≥n (opcional)'))||'';
  const url   = prompt(T('Link or phone (prefix phone with tel:)','Enlace o tel√©fono (prefijo tel:)'))||'';
  core.resources.push({title,desc,url}); saveLocal(); renderResources();
};
$('btnSeedLocal').onclick=()=>{
  core.resources.push({title:T("Local 211 ‚Äî Services","211 Local ‚Äî Servicios"), desc:T("Tap to open 211","Pulsa para abrir 211"), url:"https://www.211.org/"}); saveLocal(); renderResources();
};

/* ===================== PROFILE ===================== */
$('profName').value = core.name;
$('themePick').value = core.theme;
$('btnSaveProfile').onclick=()=>{
  core.name = $('profName').value.trim() || 'Anonymous';
  const old = $('oldPin').value.trim();
  const np  = $('newPin').value.trim();
  const np2 = $('newPin2').value.trim();
  if(np || np2 || old){
    if(old!==core.pin) return toast(T('Old PIN is wrong.','PIN anterior incorrecto.'));
    if(np.length<4 || np!==np2) return toast(T('New PIN mismatch or too short.','Nuevo PIN no coincide o es muy corto.'));
    core.pin = np;
  }
  saveLocal();
  applyLang();
  toast(T('Profile saved.','Perfil guardado.'));
};
$('btnExport').onclick=()=>{
  const data = {
    profile:{name:core.name},
    answers:core.answers,
    risk:core.risk, trust:core.trust,
    resources:core.resources,
    plans:core.plans,
    theme:core.theme,
    app:"TimeOut", version:"v1.3.5"
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='timeout_export.json'; a.click(); URL.revokeObjectURL(a.href);
};

/* ===================== ASK SUPPORT (VOICE/TEXT DEMO) ===================== */
function ensureAskModal(){
  const host = $('askModal');
  if(host.dataset.ready==='1') return true;
  host.dataset.ready='1';
  host.innerHTML = `
    <div class="card p-4 w-[92vw] max-w-md mx-auto">
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold">${T('Ask Support','Chat de apoyo')}</div>
        <button id="askClose" class="btn btn-ghost">‚úï</button>
      </div>
      <div class="text-xs text-gray-600 mb-2">${T('General guidance only; not therapy or emergency. If in danger, call emergency services.','Orientaci√≥n general; no es terapia ni emergencia. Si hay peligro, llama a emergencias.')}</div>
      <div id="askOut" class="space-y-2 max-h-[42vh] overflow-auto"></div>
      <div class="mt-3 flex gap-2">
        <input id="askInput" class="flex-1 border rounded-lg px-3 py-2" placeholder="${T('Say or type a question‚Ä¶','Di o escribe una pregunta‚Ä¶')}">
        <button id="askMic" class="btn btn-ghost" title="${T('Speak','Hablar')}">üé§</button>
        <button id="askSend" class="btn btn-primary">${T('Send','Enviar')}</button>
      </div>
      <div class="mt-3 text-xs text-gray-600">${T('Try saying:','Prueba decir:')}
        <span class="kbd">${T('Where can I get help tonight?','¬øD√≥nde puedo obtener ayuda esta noche?')}</span>
        <span class="kbd">${T('What should I put in my go-bag?','¬øQu√© pongo en mi bolsa?')}</span>
      </div>
    </div>`;
  function bubble(who,text){
    const el=document.createElement('div'); el.className='card p-2'; el.style.background=who==='user'?'#e8f7ee':'#fff';
    el.innerHTML=`<div class="text-xs text-gray-500">${who==='user'?T('You','T√∫'):T('Support','Apoyo')}</div><div class="mt-1">${text}</div>`;
    $('askOut').appendChild(el); $('askOut').scrollTop = $('askOut').scrollHeight;
  }
  function reply(q){
    const a = core.answers, s=(q||'').toLowerCase();
    if(/go-?bag|bolsa/.test(s)) return T('Pack ID, keys, cash, meds, a charger, and spare clothes. Hide it or leave it with someone you trust.','Empaca identificaci√≥n, llaves, dinero, medicinas, cargador y ropa extra. Esc√≥ndela o d√©jala con alguien de confianza.');
    if(/help|ayuda|hotline|l√≠nea/.test(s)) return T('If at risk, call emergency. See Resources for hotlines; 211 can connect you locally.','Si hay riesgo, llama a emergencias. En Recursos hay l√≠neas de ayuda; 211 conecta con servicios locales.');
    if(/safe|segur|leave|salir/.test(s)) return T('Leaving can be risky ‚Äî plan exits, keep essentials ready, and tell someone you trust when you go.','Salir puede ser riesgoso ‚Äî planea salidas, ten lo esencial listo y avisa a alguien de confianza cuando salgas.');
    if(/phone|privac|privacy|tel[e√©]fono/.test(s)) return a.q4==='yes'? T('Limit sensitive content, use a strong passcode, and consider quick-wipe options.','Limita contenido sensible, usa un c√≥digo fuerte y considera opciones de borrado r√°pido.'): T('Use screen lock and review accounts/sign-ins.','Usa bloqueo de pantalla y revisa cuentas/accesos.');
    if(/threat|amenaz/.test(s)) return a.q2==='yes'? T('Record dates/times privately and tell a trusted person. Consider documenting safely off-device.','Registra fechas/horas en privado y cu√©ntaselo a alguien de confianza. Considera documentar fuera del tel√©fono.'): T('Monitor and update your plan if things change.','Monitorea y actualiza tu plan si algo cambia.');
    return T('Thanks for sharing. Small step: review your plan or add a trusted contact.','Gracias por compartir. Paso peque√±o: revisa tu plan o agrega un contacto de confianza.');
  }
  let _micBusy = false;
  document.addEventListener('click', (e)=>{
    if (e.target && e.target.id === 'askMic') _micBusy = false;
  });
  function send(){ const i=$('askInput'); const q=i.value.trim(); if(!q) return; bubble('user',q); i.value=''; setTimeout(()=> bubble('bot', reply(q)), 300); }
  $('askSend').onclick=send; $('askInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); } });
  $('askClose').onclick=closeAsk;
  $('askMic').onclick=()=>{ 
    if (_micBusy) return; _micBusy = true;
    try{ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR) throw 0;
      const rec=new SR(); rec.lang=(core.lang==='es'?'es-ES':'en-US'); rec.onresult=e=>{ const t=e.results[0][0].transcript; $('askInput').value=t; send(); }; rec.start();
    }catch{ alert(T('Voice not supported on this device.','Voz no soportada en este dispositivo.')); }
  };
  return true;
}
function openAsk(){ ensureAskModal(); $('askModal').classList.remove('hidden-soft'); $('askInput')?.focus(); document.body.style.overflow='hidden'; }
function closeAsk(){ $('askModal').classList.add('hidden-soft'); document.body.style.overflow='auto'; }
$('askFab').onclick=openAsk; $('askChipCheck').onclick=openAsk; $('askChipPlan').onclick=openAsk;

/* ===================== BACK BUTTON ===================== */
$('btnBack').onclick=()=>{
  closeAsk();
  setTab('home');
  window.scrollTo(0,0);
};

/* ===================== INIT & APPLY ===================== */
function applyAll(){
  applyTheme();
  applyLang();
  buildQuestions();
  updateScoresAndFeedback();
  renderPlans();
  renderResources();
  applySafetyAckVisibility();
}
function init(){
  tickClock(); (function(){ $('hdrWeather').textContent = '‚õÖ'; })();
  seedResourcesIfEmpty();
  if(!Array.isArray(core.plans) || core.plans.length===0){
    core.plans=[{title:T('Grab & Go Bag','Bolsa de emergencia'), steps:[T('ID & documents','Identificaci√≥n y documentos'),T('Keys & cash','Llaves y efectivo'),T('Medications','Medicamentos'),T('Change of clothes','Cambio de ropa'),T('Backup phone numbers','N√∫meros de tel√©fono de respaldo')]}];
    saveLocal();
  }
  applyAll();
}
init();

/* ===================== VISIBILITY AUTO-LOCK (dup safe) ===================== */
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) lockToDecoy(); });

/* ===================== QUICK EXIT / PANIC (duplicate guards) ===================== */
let qeGuard=false, pcGuard=false;
document.getElementById('btnQuickExit').onclick=()=>{ if(qeGuard) return; qeGuard=true; setTimeout(()=>qeGuard=false,500); location.href='https://www.google.com/'; };
document.getElementById('btnPanic').onclick=()=>{ if(pcGuard) return; pcGuard=true; setTimeout(()=>pcGuard=false,700);
  localStorage.removeItem('timeout_profile_name'); 
  localStorage.removeItem('timeout_answers'); 
  localStorage.removeItem('timeout_resources'); 
  localStorage.removeItem('timeout_plans'); 
  localStorage.removeItem('timeout_theme');
  core.name='Anonymous'; core.answers={}; core.resources=[]; core.plans=[]; core.theme='blue';
  saveLocal(); applyTheme(); lockToDecoy(); 
};
</script>
</body>
</html>
