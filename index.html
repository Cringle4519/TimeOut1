<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TimeOut</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96'%3E%3Ccircle cx='48' cy='48' r='46' fill='%23fefce8' stroke='%23365b2c' stroke-width='4'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-size='46' font-family='Arial' fill='%23365b2c'%3ET%3C/text%3E%3C/svg%3E" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --brand:#2563eb;
    --brand-ink:#ffffff;
    --ink:#1f2937;
    --muted:#6b7280;
    --paper:#fafaf9;
    --card:#ffffff;
    --edge:#e5e7eb;
  }
  html,body{background:var(--paper); color:var(--ink);}
  .btn{ padding:.55rem .8rem; border:1px solid var(--edge); border-radius:.8rem; background:var(--card); font-size:.95rem; transition:transform .05s ease; }
  .btn:active{ transform:scale(.97); }
  .btn-primary{ background:var(--brand); color:var(--brand-ink); border-color:var(--brand); }
  .btn-ghost{ background:transparent; border-color:transparent; color:var(--muted); }
  .btn-badge{ font-size:.8rem; padding:.25rem .5rem; border-radius:.5rem; border-color:#d1d5db; }
  .card{ background:var(--card); border:1px solid var(--edge); border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .hidden-soft{ display:none !important; }
  .panel-scroll{ max-height:calc(100vh - 160px); overflow:auto; -webkit-overflow-scrolling:touch; }
  .yn-btn.selected{ background:var(--brand)!important; color:var(--brand-ink)!important; border-color:var(--brand)!important; }
  header .btn { min-width:44px; min-height:44px; }
  #hdrClock,#hdrWeather{ display:inline-flex; align-items:center; max-width:44vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .demo-qs button{ display:block; width:100%; text-align:left; margin:.3rem 0; padding:.45rem .6rem; border-radius:.5rem; background:#f3f4f6; }
  .kbd{ font:600 .78rem/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas; background:#f3f4f6; border:1px solid #e5e7eb; padding:.1rem .35rem; border-radius:.4rem; }
  footer.small{ font-size:.72rem; color:#9ca3af; }
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-gray-200">
    <div class="max-w-md mx-auto flex items-center justify-between px-3 py-2">
      <div class="flex items-center gap-2">
        <button id="langToggle" class="btn btn-ghost">EN/ES</button>
        <div id="hdrClock" class="text-sm font-medium">--:--</div>
      </div>
      <h1 id="appTitle" class="text-lg font-semibold select-none">TimeOut</h1>
      <div class="flex items-center gap-2">
        <div id="hdrWeather" class="text-sm">‚õÖ</div>
        <button id="btnBack" class="btn btn-ghost hidden-soft">Back</button>
        <button id="btnQuickExit" class="btn btn-ghost hidden-soft">Exit</button>
        <button id="btnPanic" class="btn btn-ghost hidden-soft">Clear&Lock</button>
      </div>
    </div>
  </header>

  <!-- DECOY VIEW -->
  <main id="decoyView" class="max-w-md mx-auto px-3 pt-4 pb-24">
    <section class="card p-4 mb-3">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Timer</h2>
        <span class="text-xs text-gray-500">Long-press title or timer to unlock</span>
      </div>
      <div id="decoyTimerDisplay" class="text-5xl font-mono text-center my-3 select-none">25:00</div>
      <div class="flex gap-2 justify-center">
        <button id="decoyStart" class="btn">Start</button>
        <button id="decoyPause" class="btn">Pause</button>
        <button id="decoyReset" class="btn">Reset</button>
      </div>
    </section>
    <section class="card p-4 mb-3">
      <h2 class="text-base font-semibold mb-2">Calculator</h2>
      <input id="calcInput" class="w-full border rounded-lg px-3 py-2 mb-2" placeholder="e.g., 12+3*4" inputmode="numeric">
      <button id="calcEval" class="btn">=</button>
      <span id="calcOut" class="ml-3 font-mono"></span>
    </section>
    <section class="card p-4 mb-3">
      <h2 class="text-base font-semibold mb-2">Notes</h2>
      <textarea id="decoyNotes" class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="Quick notes‚Ä¶"></textarea>
    </section>
    <footer class="max-w-md mx-auto text-center mt-4">
      <div class="small">v1.3.5</div>
    </footer>
  </main>

  <!-- REAL APP -->
  <main id="appView" class="max-w-md mx-auto px-3 pt-4 pb-28 hidden-soft">
    <!-- Home -->
    <section id="tab-home" class="panel-scroll">
      <div class="card p-4 mb-3">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold" id="homeTitle">Welcome</h2>
          <span class="btn-badge" id="verBadge">v1.3.5</span>
        </div>
        <p class="text-sm text-gray-600 mb-3" id="homeHello">Hi, Anonymous.</p>
        <div class="grid grid-cols-2 gap-2">
          <div class="card p-3">
            <div class="text-sm text-gray-500">Risk</div>
            <div id="riskPct" class="text-2xl font-mono">0%</div>
          </div>
          <div class="card p-3">
            <div class="text-sm text-gray-500">Trust</div>
            <div id="trustPct" class="text-2xl font-mono">100%</div>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-primary" onclick="setTab('checkin')">Go to Check-In</button>
          <button class="btn" onclick="setTab('plan')">Open Plan</button>
        </div>
      </div>
      <div id="safetyCard" class="card p-4">
        <h3 class="font-semibold mb-1" id="safetyTitle">Important Safety Notice</h3>
        <p class="text-sm text-gray-600" id="safetyText">
          This tool helps with planning and private check-ins. It is not emergency help or a guarantee of safety.
          If in danger, call local emergency services.
        </p>
        <button id="btnAckSafety" class="btn btn-primary mt-3">I Understand</button>
      </div>
    </section>

    <!-- Check-In -->
    <section id="tab-checkin" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <div class="flex items-center">
          <h2 id="checkTitle" class="text-lg font-semibold">Check-In</h2>
          <button class="btn btn-ghost" id="askChipCheck" title="Ask support">üéôÔ∏è Ask</button>
        </div>
        <p class="text-sm text-gray-600 mb-2">
          Answer 13 quick questions. Buttons highlight. Risk% updates live.
        </p>
        <div id="questions" class="space-y-2"></div>
        <div id="checkFeedback" class="mt-3 space-y-2"></div>
        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnLoadDemo" class="btn">Load Demo Answers</button>
          <button id="btnSaveCheckin" class="btn btn-primary">Save Check-In</button>
        </div>
      </div>
    </section>

    <!-- Plan -->
    <section id="tab-plan" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <div class="flex items-center">
          <h2 id="planTitle" class="text-lg font-semibold">Safety Plan</h2>
          <button class="btn btn-ghost" id="askChipPlan" title="Ask support">üéôÔ∏è Ask</button>
        </div>
        <div class="mt-2 flex gap-2 flex-wrap">
          <button id="btnNewPlan" class="btn">New Plan</button>
          <button id="btnTemplates" class="btn">Templates</button>
          <button id="btnQuickGenerate" class="btn btn-primary">Quick Generate</button>
        </div>
        <div id="plansList" class="mt-3 space-y-2"></div>
      </div>

      <div id="demoQs" class="card p-4">
        <div class="font-semibold mb-2">Example Questions</div>
        <div class="demo-qs">
          <button>Am I safe if I leave now?</button>
          <button>Where can I get help tonight?</button>
          <button>What should I put in my go-bag?</button>
        </div>
      </div>
    </section>

    <!-- Resources -->
    <section id="tab-resources" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <h2 id="resTitle" class="text-lg font-semibold">Resources</h2>
        <p class="text-sm text-gray-600 mb-2">Tap a resource to copy. Use ‚ÄúCall Hotline‚Äù.</p>
        <div class="flex gap-2 mb-2 flex-wrap">
          <button id="callHotlineBtn" class="btn">Call Hotline</button>
          <button id="btnAddResource" class="btn">Add</button>
          <button id="btnSeedLocal" class="btn">Add Local 211</button>
        </div>
        <div id="resList" class="space-y-2"></div>
      </div>
    </section>

    <!-- Profile -->
    <section id="tab-profile" class="panel-scroll hidden-soft">
      <div class="card p-4 mb-3">
        <h2 class="text-lg font-semibold">Profile</h2>
        <label class="block text-sm mb-1">Display name</label>
        <input id="profName" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="Anonymous">
        <label class="block text-sm mb-1">Change PIN</label>
        <div class="grid grid-cols-3 gap-2">
          <input id="oldPin" class="border rounded-lg px-3 py-2" placeholder="Old" inputmode="numeric" maxlength="8">
          <input id="newPin" class="border rounded-lg px-3 py-2" placeholder="New" inputmode="numeric" maxlength="8">
          <input id="newPin2" class="border rounded-lg px-3 py-2" placeholder="Confirm" inputmode="numeric" maxlength="8">
        </div>
        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnSaveProfile" class="btn btn-primary">Save Profile</button>
          <button id="btnExport" class="btn">Export JSON</button>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">Theme:</span>
            <select id="themePick" class="border rounded-lg px-2 py-2 text-sm">
              <option value="blue">Blue</option>
              <option value="teal">Teal</option>
              <option value="rose">Rose</option>
              <option value="amber">Amber</option>
              <option value="violet">Violet</option>
              <option value="olive">Olive</option>
              <option value="sand">Sand</option>
            </select>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Tabs -->
  <nav id="bottomNav" class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 hidden-soft">
    <div class="max-w-md mx-auto grid grid-cols-5 text-sm">
      <button onclick="setTab('home')" class="py-2 flex flex-col items-center"><span>üè†</span><span id="navHome">Home</span></button>
      <button onclick="setTab('checkin')" class="py-2 flex flex-col items-center"><span>‚úÖ</span><span id="navCheck">Check-In</span></button>
      <button onclick="setTab('plan')" class="py-2 flex flex-col items-center"><span>üß≠</span><span id="navPlan">Plan</span></button>
      <button onclick="setTab('resources')" class="py-2 flex flex-col items-center"><span>üìö</span><span id="navRes">Resources</span></button>
      <button onclick="setTab('profile')" class="py-2 flex flex-col items-center"><span>üë§</span><span id="navProf">Profile</span></button>
    </div>
  </nav>

  <!-- PIN Modal -->
  <div id="pinModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden-soft items-center justify-center">
    <div class="card p-4 w-[92vw] max-w-sm">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Enter PIN</h3>
        <button id="pinClose" class="btn btn-ghost">‚úï</button>
      </div>
      <input id="pinInput" class="w-full border rounded-lg px-3 py-2" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <div class="mt-3 flex gap-2">
        <button id="pinOk" class="btn btn-primary">Unlock</button>
        <button id="pinCancel" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Ask Modal host -->
  <div id="askModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden-soft items-center justify-center"></div>
  <!-- Floating Ask -->
  <button id="askFab" class="btn btn-primary hidden-soft" style="position:fixed;right:16px;bottom:84px;z-index:55">üéôÔ∏è Ask</button>

<script>
/* ===================== CORE STATE ===================== */
const core = {
  lang: localStorage.getItem('timeout_lang') || 'en',
  pin: localStorage.getItem('timeout_pin') || '2580',
  name: localStorage.getItem('timeout_profile_name') || 'Anonymous',
  answers: JSON.parse(localStorage.getItem('timeout_answers')||'{}'),
  resources: JSON.parse(localStorage.getItem('timeout_resources')||'[]'),
  plans: JSON.parse(localStorage.getItem('timeout_plans')||'[]'),
  theme: localStorage.getItem('timeout_theme') || 'blue',
  risk: 0, trust: 100
};
const $ = id => document.getElementById(id);
function saveLocal(){
  localStorage.setItem('timeout_lang', core.lang);
  localStorage.setItem('timeout_pin', core.pin);
  localStorage.setItem('timeout_profile_name', core.name);
  localStorage.setItem('timeout_answers', JSON.stringify(core.answers));
  localStorage.setItem('timeout_resources', JSON.stringify(core.resources));
  localStorage.setItem('timeout_plans', JSON.stringify(core.plans));
  localStorage.setItem('timeout_theme', core.theme);
}
function toast(msg){ alert(msg); }

/* ===================== THEME ===================== */
function applyTheme(){
  const map={
    blue:{brand:'#2563eb',ink:'#ffffff'},
    teal:{brand:'#0ea5a4',ink:'#002b2a'},
    rose:{brand:'#e11d48',ink:'#ffffff'},
    amber:{brand:'#f59e0b',ink:'#1f2937'},
    violet:{brand:'#7c3aed',ink:'#ffffff'},
    olive:{brand:'#6b8e23',ink:'#ffffff'},
    sand:{brand:'#d4a373',ink:'#1f2937'}
  }[core.theme] || {brand:'#2563eb',ink:'#ffffff'};
  document.documentElement.style.setProperty('--brand', map.brand);
  document.documentElement.style.setProperty('--brand-ink', map.ink);
  $('themePick').value = core.theme;
}
$('themePick').addEventListener('change', e=>{ core.theme=e.target.value; saveLocal(); applyTheme(); });

/* ===================== LANGUAGE ===================== */
$('langToggle').onclick = ()=>{
  core.lang = core.lang === 'en' ? 'es' : 'en';
  saveLocal();
  applyAll(); // rebuild labels/questions/resources/ask modal
  const askOpen = !$('askModal').classList.contains('hidden-soft');
  if (askOpen) { $('askModal').dataset.ready=''; ensureAskModal(); }
};
function T(en, es){ return core.lang==='es'? es: en; }
function applyLang(){
  $('langToggle').textContent = core.lang==='es'?'ES/EN':'EN/ES';
  $('btnQuickExit').textContent = T('Exit','Salir');
  $('btnPanic').textContent = T('Clear&Lock','Borrar y Bloquear');
  $('btnBack').textContent = T('Back','Atr√°s');
  $('homeTitle').textContent = T('Welcome','Bienvenido/a');
  $('homeHello').textContent = T(`Hi, ${core.name}.`, `Hola, ${core.name}.`);
  $('resTitle').textContent = T('Resources','Recursos');
  $('checkTitle').textContent = T('Check-In','Autoevaluaci√≥n');
  $('planTitle').textContent = T('Safety Plan','Plan de Seguridad');
  $('navHome').textContent = T('Home','Inicio');
  $('navCheck').textContent = T('Check-In','Autoeval.');
  $('navPlan').textContent = T('Plan','Plan');
  $('navRes').textContent = T('Resources','Recursos');
  $('navProf').textContent = T('Profile','Perfil');
  const dqs = document.querySelectorAll('#demoQs .demo-qs button');
  if(dqs[0]) dqs[0].textContent = T('Am I safe if I leave now?','¬øEstoy seguro/a si me voy ahora?');
  if(dqs[1]) dqs[1].textContent = T('Where can I get help tonight?','¬øD√≥nde puedo obtener ayuda esta noche?');
  if(dqs[2]) dqs[2].textContent = T('What should I put in my go-bag?','¬øQu√© debo poner en mi bolsa de emergencia?');
  const sTitle = document.getElementById('safetyTitle');
  const sText  = document.getElementById('safetyText');
  const sBtn   = document.getElementById('btnAckSafety');
  if (sTitle) sTitle.textContent = T('Important Safety Notice','Aviso importante de seguridad');
  if (sText)  sText.textContent  = T(
    'This tool helps with planning and private check-ins. It is not emergency help or a guarantee of safety. If in danger, call local emergency services.',
    'Esta herramienta ayuda con la planificaci√≥n y chequeos privados. No es ayuda de emergencia ni garant√≠a de seguridad. En peligro, llama a emergencias locales.'
  );
  if (sBtn)   sBtn.textContent   = T('I Understand','Entiendo');
}

/* ===================== CLOCK & WEATHER ===================== */
function tickClock(){
  const d = new Date();
  const h = d.getHours().toString().padStart(2,'0');
  const m = d.getMinutes().toString().padStart(2,'0');
  $('hdrClock').textContent = `${h}:${m}`;
}
setInterval(tickClock, 1000); tickClock();
(function setWeather(){ $('hdrWeather').textContent = '‚õÖ'; })();

/* ===================== DECOY: STOPWATCH/CALC/NOTES ===================== */
let swInterval=null, swSeconds=25*60;
function renderStopwatch(){ const mm=Math.floor(swSeconds/60).toString().padStart(2,'0'); const ss=(swSeconds%60).toString().padStart(2,'0'); $('decoyTimerDisplay').textContent=`${mm}:${ss}`;}
$('decoyStart').onclick=()=>{ if(swInterval) return; swInterval=setInterval(()=>{ if(swSeconds>0){ swSeconds--; renderStopwatch(); }},1000); };
$('decoyPause').onclick=()=>{ clearInterval(swInterval); swInterval=null; };
$('decoyReset').onclick=()=>{ swSeconds=25*60; renderStopwatch(); };
renderStopwatch();
$('calcEval').onclick=()=>{ try{ const v=eval(($('calcInput').value||'').replace(/[^0-9+\-*/(). ]/g,'')); $('calcOut').textContent = isFinite(v)? v: '‚Äî'; }catch{ $('calcOut').textContent='‚Äî'; } };
$('decoyNotes').value = localStorage.getItem('timeout_decoy_notes') || '';
$('decoyNotes').addEventListener('input', e=> localStorage.setItem('timeout_decoy_notes', e.target.value));

/* ===================== UNLOCK (LONG PRESS + PIN) ===================== */
let lpTimer=null;
function bindLongPress(el){
  const start=()=>{ lpTimer=setTimeout(()=> openPinModal(), 800); };
  const clear=()=>{ clearTimeout(lpTimer); };
  el.addEventListener('mousedown',start); el.addEventListener('touchstart',start,{passive:true});
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> el.addEventListener(ev, clear));
}
bindLongPress($('appTitle'));
bindLongPress($('decoyTimerDisplay'));
function openPinModal(){ $('pinModal').classList.remove('hidden-soft'); $('pinInput').value=''; $('pinInput').focus(); }
function closePinModal(){ $('pinModal').classList.add('hidden-soft'); }
$('pinClose').onclick=closePinModal; $('pinCancel').onclick=closePinModal;
$('pinOk').onclick=tryUnlock;
$('pinInput').addEventListener('keydown', e=>{ if(e.key==='Enter') tryUnlock(); });
function tryUnlock(){
  const v = $('pinInput').value.trim();
  if(v===core.pin){ showRealApp(); closePinModal(); }
  else { toast(T('Wrong PIN','PIN incorrecto')); }
}

/* ===================== LOCK/UNLOCK + SAFETY ===================== */
function showRealApp(){
  $('decoyView').classList.add('hidden-soft');
  $('appView').classList.remove('hidden-soft');
  $('bottomNav').classList.remove('hidden-soft');
  $('btnQuickExit').classList.remove('hidden-soft');
  $('btnPanic').classList.remove('hidden-soft');
  $('btnBack').classList.remove('hidden-soft');
  $('askFab').classList.remove('hidden-soft');
  applyLang();
}
function lockToDecoy(){
  $('appView').classList.add('hidden-soft');
  $('bottomNav').classList.add('hidden-soft');
  $('btnQuickExit').classList.add('hidden-soft');
  $('btnPanic').classList.add('hidden-soft');
  $('btnBack').classList.add('hidden-soft');
  $('askFab').classList.add('hidden-soft');
  $('decoyView').classList.remove('hidden-soft');
  closeAsk();
}
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) lockToDecoy(); });
$('btnQuickExit').onclick=()=>{ location.href='https://www.google.com/'; };
$('btnPanic').onclick=()=>{ 
  localStorage.removeItem('timeout_profile_name'); 
  localStorage.removeItem('timeout_answers'); 
  localStorage.removeItem('timeout_resources'); 
  localStorage.removeItem('timeout_plans'); 
  localStorage.removeItem('timeout_theme');
  core.name='Anonymous'; core.answers={}; core.resources=[]; core.plans=[]; core.theme='blue';
  saveLocal(); applyTheme(); lockToDecoy(); 
};

/* ===================== TABS ===================== */
function setTab(name){
  ['home','checkin','plan','resources','profile'].forEach(t=>{
    $('tab-'+t).classList.toggle('hidden-soft', t!==name);
  });
  if(name==='checkin'){ buildQuestions(); updateScoresAndFeedback(); }
  if(name==='plan'){ renderPlans(); }
  if(name==='resources'){ renderResources(); }
}
window.setTab = setTab;

/* ===================== SAFETY ACK (ONCE) ===================== */
function applySafetyAckVisibility(){
  const seen = localStorage.getItem('timeout_safety_ack') === '1';
  const card = document.getElementById('safetyCard');
  if (card) card.style.display = seen ? 'none' : '';
}
document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'btnAckSafety') {
    localStorage.setItem('timeout_safety_ack','1');
    applySafetyAckVisibility();
  }
});

/* ===================== CHECK-IN (13 PROFESSIONAL-LEANING Qs) ===================== */
const QUESTIONS_EN = [
  "In the past 24 hours, do you feel physically safe where you are right now?",
  "In the past 30 days, has a partner threatened, intimidated, or stalked you (including digital/online)?",
  "In the past 30 days, have you experienced any physical injury or assault from a partner?",
  "Do you believe your partner can access your phone, messages, location, or online accounts without your consent?",
  "Has anyone restricted your ability to leave home, contact others, or seek help when you wanted to?",
  "Are children or other dependents in the home who could be affected by the violence or control?",
  "Have you been isolated from supportive people or services (e.g., friends, family, faith/community, advocates)?",
  "Has financial control been used against you (e.g., taking your money, blocking access to funds, monitoring spending)?",
  "Have you been pressured or forced into sexual activity at any time by this partner?",
  "Are there weapons or dangerous objects in the home or used to threaten you (e.g., firearms, knives, tools)?",
  "Based on recent events, do you believe the situation could escalate to more severe harm soon?",
  "If you needed to leave quickly, do you have a safe place you could go within the next 24‚Äì48 hours?",
  "Would you like immediate information about shelters, hotlines, legal options, or advocacy near you?"
];
const QUESTIONS_ES = [
  "En las √∫ltimas 24 horas, ¬øte sientes f√≠sicamente seguro/a donde est√°s ahora?",
  "En los √∫ltimos 30 d√≠as, ¬øuna pareja te ha amenazado, intimidado o acosado (incluido digital/en l√≠nea)?",
  "En los √∫ltimos 30 d√≠as, ¬øhas sufrido alguna lesi√≥n o agresi√≥n f√≠sica por parte de una pareja?",
  "¬øCrees que tu pareja puede acceder a tu tel√©fono, mensajes, ubicaci√≥n o cuentas en l√≠nea sin tu consentimiento?",
  "¬øAlguien ha restringido tu capacidad de salir, contactar a otros o buscar ayuda cuando quisiste?",
  "¬øHay ni√±os u otras personas dependientes en casa que podr√≠an verse afectados por la violencia o el control?",
  "¬øHas estado aislado/a de personas o servicios de apoyo (p. ej., amigos, familia, comunidad/fe, defensores)?",
  "¬øSe ha utilizado el control financiero en tu contra (p. ej., quitarte dinero, bloquear acceso a fondos, monitorear gastos)?",
  "¬øTu pareja te ha presionado u obligado a tener actividad sexual en alg√∫n momento?",
  "¬øHay armas u objetos peligrosos en el hogar o se usan para amenazarte (p. ej., armas de fuego, cuchillos, herramientas)?",
  "Seg√∫n eventos recientes, ¬øcrees que la situaci√≥n podr√≠a escalar a un da√±o m√°s grave pronto?",
  "Si necesitaras salir r√°pidamente, ¬øtienes un lugar seguro adonde ir en las pr√≥ximas 24‚Äì48 horas?",
  "¬øTe gustar√≠a informaci√≥n inmediata sobre refugios, l√≠neas de ayuda, opciones legales o apoyo cercano?"
];

const ADVICE_EN = {
  q1:{ yes:"You report feeling physically safe in the last day. Continue to monitor your environment and trust your instincts. Maintain simple routines that keep exits clear and your phone charged.",
       no:"You do not feel physically safe right now. If possible, move to a populated or publicly visible area and keep your phone with you. Identify the closest exit and a person you can contact immediately." },
  q2:{ yes:"Threats, intimidation, or stalking raise risk. Document dates and descriptions privately and consider preserving screenshots or logs off-device. Increase privacy settings and review who has access to your accounts.",
       no:"No recent threats reported. Keep boundaries clear and continue to document concerning behavior if it arises. Revisit your plan if patterns change." },
  q3:{ yes:"Recent physical injury signals elevated and acute risk. Seek medical care if needed and consider confidential documentation. A safety plan with exits, code words, and trusted contacts is recommended.",
       no:"No recent physical injury reported. Continue regular check-ins and review steps to stay safe if conditions change." },
  q4:{ yes:"Phone or account access undermines safety. Update passcodes, enable two-factor authentication, and consider creating a separate, private email account. Avoid storing sensitive notes on the device.",
       no:"No current concern about device access. Keep screen lock and account security up to date, and review app permissions periodically." },
  q5:{ yes:"Restriction from leaving or seeking help is coercive control. Identify times or locations where you can safely connect with support. Consider code words with trusted people to request help discreetly.",
       no:"No recent restriction reported. Maintain regular contact with supportive people and know where local services are located." },
  q6:{ yes:"Children or dependents increase complexity and urgency. Plan safe handoffs, alternate caregivers, and how to keep essential items accessible for them. Consider consulting advocates about custody-related safety.",
       no:"No dependents at risk reported. If circumstances change, add steps for children/dependents to your safety plan." },
  q7:{ yes:"Isolation heightens danger. List two people you can contact this week and one community resource (e.g., 211, hotline). Schedule a brief check-in to stay connected.",
       no:"You report some support. Keep those connections active and share a simple safety word or phrase that signals you need help." },
  q8:{ yes:"Financial control is a common barrier. Track essential expenses privately if you can, and explore safe ways to access emergency funds (e.g., low-balance card, cash with a trusted person).",
       no:"No current financial control reported. Consider preparing a small emergency fund and copies of key documents in a safe place." },
  q9:{ yes:"Sexual coercion is abuse and increases risk. Seek confidential support if available. Consider medical care if needed and document incidents privately in a safe location.",
       no:"No sexual coercion reported. If this changes, prioritize medical and advocacy support, and add steps for privacy and evidence preservation." },
  q10:{ yes:"Weapons in the environment elevate lethality risk. Increase distance from storage areas when tensions rise and plan exits that avoid those locations. Consider secure storage options if legally available.",
        no:"No weapons reported. If that changes, review exits and avoid rooms where potential weapons are stored during arguments." },
  q11:{ yes:"Concern about escalation is an important indicator. Prepare a go-bag, keep keys and IDs accessible, and share a time-bound check-in plan with a trusted contact.",
        no:"No immediate escalation concern reported. Continue routine safety reviews and refresh your plan weekly." },
  q12:{ yes:"You report a safe place within 24‚Äì48 hours. Confirm routes and transportation, and identify a backup option if your first choice becomes unavailable.",
        no:"No safe place identified. Call 211 or a hotline to explore shelters or short-term options. Identify one public place you could use temporarily if needed." },
  q13:{ yes:"Resources can help you plan next steps. Hotlines can safety-plan with you and connect you locally. Consider calling when you can speak privately.",
        no:"If you don‚Äôt want resources now, that‚Äôs okay. Save a single number you trust for later (e.g., 211 or the national hotline) so it‚Äôs ready if you need it." }
};
const ADVICE_ES = {
  q1:{ yes:"Indicas sentirte f√≠sicamente seguro/a en el √∫ltimo d√≠a. Sigue observando tu entorno y conf√≠a en tus instintos. Mant√©n salidas despejadas y el tel√©fono cargado.",
       no:"Ahora no te sientes f√≠sicamente seguro/a. Si es posible, mu√©vete a un √°rea p√∫blica y mant√©n el tel√©fono contigo. Identifica la salida m√°s cercana y una persona a quien contactar de inmediato." },
  q2:{ yes:"Las amenazas, la intimidaci√≥n o el acoso aumentan el riesgo. Documenta fechas y descripciones en privado y guarda capturas o registros fuera del dispositivo. Refuerza la privacidad de tus cuentas.",
       no:"No se reportan amenazas recientes. Mant√©n l√≠mites claros y documenta cualquier conducta preocupante. Revisa tu plan si cambian los patrones." },
  q3:{ yes:"Lesiones f√≠sicas recientes indican riesgo agudo. Busca atenci√≥n m√©dica si es necesario y considera documentaci√≥n confidencial. Un plan con salidas, palabras clave y contactos de confianza es recomendable.",
       no:"No se reportan lesiones f√≠sicas recientes. Contin√∫a con autoevaluaciones y repasa pasos de seguridad si cambian las condiciones." },
  q4:{ yes:"El acceso a tu tel√©fono o cuentas reduce la seguridad. Cambia c√≥digos, activa verificaci√≥n en dos pasos y considera un correo privado. Evita guardar notas sensibles en el dispositivo.",
       no:"Sin preocupaci√≥n actual por acceso al dispositivo. Mant√©n el bloqueo de pantalla y seguridad de cuentas al d√≠a; revisa permisos de apps peri√≥dicamente." },
  q5:{ yes:"Restringirte salir o buscar ayuda es control coercitivo. Identifica momentos o lugares para conectarte con apoyo. Considera palabras clave con personas de confianza para pedir ayuda discretamente.",
       no:"Sin restricci√≥n reciente. Mant√©n contacto con apoyos y conoce la ubicaci√≥n de servicios locales." },
  q6:{ yes:"Ni√±os o dependientes aumentan la urgencia. Planifica entregas seguras, cuidadores alternos y acceso a art√≠culos esenciales. Considera consultar con defensores sobre seguridad y custodia.",
       no:"No se reportan dependientes en riesgo. Si la situaci√≥n cambia, agrega pasos para ni√±os/dependientes en tu plan." },
  q7:{ yes:"La aislaci√≥n incrementa el peligro. Elige dos personas para contactar esta semana y un recurso comunitario (p. ej., 211, l√≠nea de ayuda). Programa un breve check-in.",
       no:"Refieres contar con apoyo. Mant√©n esos v√≠nculos y comparte una palabra clave simple para pedir ayuda." },
  q8:{ yes:"El control financiero es una barrera com√∫n. Registra gastos esenciales en privado y explora formas seguras de acceder a fondos de emergencia (p. ej., tarjeta de bajo saldo, efectivo con un tercero).",
       no:"No hay control financiero actual. Considera un peque√±o fondo de emergencia y copias de documentos clave en un lugar seguro." },
  q9:{ yes:"La coerci√≥n sexual es abuso y aumenta el riesgo. Busca apoyo confidencial. Considera atenci√≥n m√©dica si es necesario y documenta en un lugar seguro.",
       no:"No se reporta coerci√≥n sexual. Si cambia, prioriza apoyo m√©dico y de defensa, y agrega pasos de privacidad y preservaci√≥n de evidencia." },
  q10:{ yes:"Armas u objetos peligrosos elevan el riesgo. Aumenta la distancia de zonas de guardado cuando hay tensi√≥n y planea salidas que eviten esos lugares. Considera almacenamiento seguro si es legal.",
        no:"No se reportan armas. Si cambia, revisa salidas y evita habitaciones donde se guardan objetos peligrosos durante discusiones." },
  q11:{ yes:"La preocupaci√≥n por escalada es un indicador clave. Prepara una bolsa de emergencia, mant√©n llaves y documentos accesibles y comparte un plan de check-in con un contacto de confianza.",
        no:"No hay preocupaci√≥n inmediata de escalada. Contin√∫a revisiones rutinarias y actualiza tu plan semanalmente." },
  q12:{ yes:"Refieres un lugar seguro en 24‚Äì48 horas. Confirma rutas y transporte e identifica una opci√≥n de respaldo.",
        no:"Sin lugar seguro identificado. Llama al 211 o a una l√≠nea de ayuda para explorar refugios u opciones temporales. Elige un lugar p√∫blico como alternativa inmediata." },
  q13:{ yes:"Los recursos pueden ayudarte a planear pr√≥ximos pasos. Las l√≠neas de ayuda pueden planificar contigo y conectarte localmente. Considera llamar cuando puedas hablar en privado.",
        no:"Si no deseas recursos ahora, est√° bien. Guarda un n√∫mero de confianza (p. ej., 211 o la l√≠nea nacional) para tenerlo listo si lo necesitas." }
};

function getQuestions(){ return core.lang==='es' ? QUESTIONS_ES : QUESTIONS_EN; }
function getAdvice(){ return core.lang==='es' ? ADVICE_ES : ADVICE_EN; }

function qRow(i, text){
  const qid = 'q'+(i+1);
  const yesSel = core.answers[qid]==='yes' ? 'selected' : '';
  const noSel  = core.answers[qid]==='no'  ? 'selected' : '';
  const yesLab = T('Yes','S√≠');
  const noLab  = T('No','No');
  const advText = renderAdviceText(qid);
  return `
    <div class="card p-3">
      <div class="mb-2 text-sm">${i+1}. ${text}</div>
      <div class="flex gap-2">
        <button class="btn yn-btn ${yesSel}" data-q="${qid}" data-v="yes">${yesLab}</button>
        <button class="btn yn-btn ${noSel}"  data-q="${qid}" data-v="no">${noLab}</button>
      </div>
      <div id="adv-${qid}" class="text-xs text-gray-600 mt-2">${advText}</div>
    </div>`;
}
function buildQuestions(){
  const box = $('questions'); if(!box) return;
  box.innerHTML = '';
  getQuestions().forEach((q,i)=>{ box.insertAdjacentHTML('beforeend', qRow(i,q)); });
}
function renderAdviceText(qid){
  const a = core.answers[qid];
  if(!a) return '';
  const map = getAdvice();
  const item = map[qid];
  if(!item) return '';
  return a==='yes' ? item.yes : item.no;
}
function updateAdviceFor(qid){
  const el = $('adv-'+qid);
  if(el) el.textContent = renderAdviceText(qid);
}

/* RISK: 12 risk-bearing items (q1 no, q2‚Äìq11 yes, q12 no). q13 informational. */
function computeRisk(){
  let risk = 0; const a = core.answers;
  if(a.q1==='no') risk += 1;
  ['q2','q3','q4','q5','q6','q7','q8','q9','q10','q11'].forEach(k=>{ if(a[k]==='yes') risk += 1; });
  if(a.q12==='no') risk += 1;
  const pct = Math.round((risk/12)*100);
  core.risk = pct; core.trust = 100 - pct;
}
function keyFlags(){
  const a=core.answers||{};
  return {
    injury: a.q3==='yes',
    weapons: a.q10==='yes',
    sexual: a.q9==='yes',
    kids: a.q6==='yes',
    restrict: a.q5==='yes',
    escalate: a.q11==='yes',
    noSafePlace: a.q12==='no'
  };
}
function updateScoresAndFeedback(){
  computeRisk();
  $('riskPct').textContent = core.risk + '%';
  $('trustPct').textContent = core.trust + '%';

  const fb = $('checkFeedback'); if(!fb) return;
  fb.innerHTML = '';

  const k = keyFlags();
  let p1='', p2='', p3='';
  if(core.risk>=60){
    p1 = T(
      "Your responses indicate a HIGH level of risk. Prioritize immediate safety: consider moving to a public place, keeping keys and ID on you, and contacting a hotline or trusted person as soon as you can.",
      "Tus respuestas indican un nivel ALTO de riesgo. Prioriza la seguridad inmediata: considera moverte a un lugar p√∫blico, llevar llaves e identificaci√≥n y contactar una l√≠nea de ayuda o a alguien de confianza en cuanto puedas."
    );
    p2 = T(
      "Use this time-out to plan one concrete step for the next 24 hours (e.g., identify the nearest exit, confirm a safe address, arrange a code word). If children or dependents are involved, outline who can help with safe handoffs.",
      "Usa este time-out para planear un paso concreto en las pr√≥ximas 24 horas (p. ej., identificar la salida m√°s cercana, confirmar una direcci√≥n segura, acordar una palabra clave). Si hay ni√±os o dependientes, define qui√©n puede ayudar con traslados seguros."
    );
    p3 = T(
      "TimeOut cares. You are not alone. Disclaimer: This tool offers general guidance only and is not a substitute for professional care or emergency services. If you are in danger, call 911 or your local emergency number.",
      "TimeOut se preocupa por ti. No est√°s solo/a. Aviso: Esta herramienta ofrece orientaci√≥n general y no reemplaza atenci√≥n profesional ni servicios de emergencia. Si est√°s en peligro, llama al 911 o al n√∫mero local de emergencias."
    );
  } else if(core.risk>=30){
    p1 = T(
      "Your responses suggest a MODERATE level of risk. Strengthen your safety plan: prepare a small go-bag, keep your phone charged, and share a time-bound check-in plan with a trusted contact.",
      "Tus respuestas sugieren un nivel MODERADO de riesgo. Refuerza tu plan de seguridad: prepara una bolsa de emergencia, mant√©n el tel√©fono cargado y comparte un plan de seguimiento con l√≠mite de tiempo con un contacto de confianza."
    );
    p2 = T(
      "Focus on practical steps that fit your situation (privacy settings, safe routes, transportation, and access to essential documents). If you anticipate escalation, identify a safe place you could reach quickly.",
      "Conc√©ntrate en pasos pr√°cticos que se ajusten a tu situaci√≥n (privacidad de cuentas, rutas seguras, transporte y acceso a documentos esenciales). Si anticipas escalada, identifica un lugar seguro al que puedas llegar r√°pidamente."
    );
    p3 = T(
      "TimeOut cares. You are not alone. Disclaimer: This tool offers general guidance only and is not a substitute for professional care or emergency services.",
      "TimeOut se preocupa por ti. No est√°s solo/a. Aviso: Esta herramienta ofrece orientaci√≥n general y no reemplaza atenci√≥n profesional ni servicios de emergencia."
    );
  } else {
    p1 = T(
      "Your responses suggest a LOWER level of risk right now. Keep up regular check-ins and review your plan weekly so it stays ready if circumstances change.",
      "Tus respuestas sugieren un nivel BAJO de riesgo en este momento. Mant√©n autoevaluaciones regulares y repasa tu plan cada semana para que est√© listo si cambian las circunstancias."
    );
    p2 = T(
      "Use this time-out to note key resources (one hotline, one local service, one trusted person) and confirm basic device security. Small, steady steps help you stay prepared.",
      "Usa este time-out para anotar recursos clave (una l√≠nea de ayuda, un servicio local, una persona de confianza) y confirmar la seguridad b√°sica del dispositivo. Pasos peque√±os y constantes te mantienen preparado/a."
    );
    p3 = T(
      "TimeOut cares. You are not alone. Disclaimer: This tool offers general guidance only and is not a substitute for professional care or emergency services.",
      "TimeOut se preocupa por ti. No est√°s solo/a. Aviso: Esta herramienta ofrece orientaci√≥n general y no reemplaza atenci√≥n profesional ni servicios de emergencia."
    );
  }

  // Add an extra targeted sentence if certain flags are present
  const extra = [];
  if(k.weapons) extra.push(T("Because weapons are present, plan exits that avoid storage areas and consider secure storage options if available.","Como hay armas, planifica salidas que eviten las zonas de guardado y considera opciones de almacenamiento seguro si est√°n disponibles."));
  if(k.sexual) extra.push(T("Sexual coercion is abuse. Confidential medical or advocacy support can help you review options safely.","La coerci√≥n sexual es abuso. El apoyo m√©dico o de defensa confidencial puede ayudarte a revisar opciones de forma segura."));
  if(k.kids) extra.push(T("Include children/dependents in your plan: safe handoffs, alternate caregivers, and copies of essential items for them.","Incluye a ni√±os/dependientes en tu plan: traslados seguros, cuidadores alternos y copias de art√≠culos esenciales."));
  if(k.restrict) extra.push(T("Coercive control limits help-seeking; identify windows of time and places where you can safely connect with support.","El control coercitivo limita pedir ayuda; identifica momentos y lugares donde puedas conectar con apoyo de forma segura."));
  if(k.noSafePlace) extra.push(T("If no safe place is identified, contact 211 or a hotline to explore emergency shelter or short-term options.","Si no tienes un lugar seguro, contacta 211 o una l√≠nea de ayuda para explorar refugio de emergencia u opciones a corto plazo."));

  fb.insertAdjacentHTML('beforeend',
    `<div class="card p-3 text-sm space-y-2">
       <p>${p1}</p>
       <p>${p2}</p>
       <p>${p3}</p>
       ${extra.length? `<div class="mt-1 text-xs text-gray-600">${extra.join(" ")}</div>`:""}
     </div>`
  );
}

document.addEventListener('click', (e)=>{
  const b = e.target.closest('.yn-btn'); if(!b) return;
  const qid = b.dataset.q; const val=b.dataset.v; if(!qid||!val) return;
  core.answers[qid] = val; saveLocal();
  document.querySelectorAll(`.yn-btn[data-q="${qid}"]`).forEach(x=>x.classList.remove('selected'));
  b.classList.add('selected');
  updateAdviceFor(qid);
  updateScoresAndFeedback();
});

$('btnLoadDemo').onclick=()=>{
  core.answers = {
    q1:'no', q2:'yes', q3:'yes', q4:'yes', q5:'yes',
    q6:'yes', q7:'yes', q8:'yes', q9:'no', q10:'yes',
    q11:'yes', q12:'no', q13:'yes'
  };
  saveLocal(); buildQuestions(); updateScoresAndFeedback();
};
$('btnSaveCheckin').onclick=()=>{ saveLocal(); toast(T('Check-In saved.','Autoevaluaci√≥n guardada.')); };

/* ===================== SAFETY PLAN (unchanged mechanics) ===================== */
function renderPlans(){
  const list = $('plansList'); if(!list) return;
  list.innerHTML='';
  if(core.plans.length===0){
    list.insertAdjacentHTML('beforeend', `<div class="text-sm text-gray-600">${T('No plans yet. Use New, Templates, or Quick Generate.','A√∫n no hay planes. Usa Nuevo, Plantillas o Generar R√°pido.')}</div>`);
    return;
  }
  core.plans.forEach((p,idx)=>{
    const steps = (p.steps||[]).map(s=>`<li class="list-disc ml-5">${s}</li>`).join('');
    const card = `
      <div class="card p-3">
        <div class="flex items-center justify-between">
          <div class="font-semibold">${p.title||T('Untitled','Sin t√≠tulo')}</div>
          <button data-i="${idx}" class="btn btn-ghost text-rose-600 delPlan">${T('Delete','Eliminar')}</button>
        </div>
        ${steps? `<ul class="mt-2 text-sm">${steps}</ul>`:''}
      </div>`;
    list.insertAdjacentHTML('beforeend', card);
  });
  list.querySelectorAll('.delPlan').forEach(btn=>{
    btn.onclick=()=>{ const i=+btn.dataset.i; core.plans.splice(i,1); saveLocal(); renderPlans(); };
  });
}
$('btnNewPlan').onclick=()=>{
  const t = prompt(T('Plan title?','¬øT√≠tulo del plan?')) || T('Personal Plan','Plan personal');
  const s = prompt(T('Steps (comma-separated):','Pasos (separados por comas):')) || '';
  const steps = s.split(',').map(x=>x.trim()).filter(Boolean);
  core.plans.push({title:t, steps}); saveLocal(); renderPlans();
};
$('btnTemplates').onclick=()=>{
  const template = { title:T('Grab & Go Bag','Bolsa de emergencia'), steps:[T('ID & documents','Identificaci√≥n y documentos'),T('Keys & cash','Llaves y efectivo'),T('Medications','Medicamentos'),T('Change of clothes','Cambio de ropa'),T('Backup phone numbers','N√∫meros de tel√©fono de respaldo')] };
  core.plans.push(template); saveLocal(); renderPlans();
};
let qpGuard=false;
$('btnQuickGenerate').onclick=()=>{
  if(qpGuard) return; qpGuard=true; setTimeout(()=>qpGuard=false,600);
  const a=core.answers; const steps=[];
  if(a.q4==='yes') steps.push(T('Minimize sensitive content on phone; enable screen lock.','Minimiza contenido sensible en el tel√©fono; activa el bloqueo de pantalla.'));
  if(a.q2==='yes' || a.q3==='yes') steps.push(T('Document dates/times privately; tell a trusted person.','Documenta fechas/horas en privado; avisa a alguien de confianza.'));
  if(a.q1==='no') steps.push(T('Move to public place; call a hotline or trusted person.','Mu√©vete a un lugar p√∫blico; llama a una l√≠nea de ayuda o a alguien de confianza.'));
  if(a.q6==='yes') steps.push(T('Set meeting point and alternate caregiver for children.','Define punto de encuentro y cuidador alterno para los ni√±os.'));
  if(a.q11==='yes') steps.push(T('Prepare exits and transport; share your plan with a trusted person.','Prepara salidas y transporte; comparte tu plan con alguien de confianza.'));
  if(steps.length===0) steps.push(T('Share location with a trusted person; review exits and transport.','Comparte ubicaci√≥n con alguien de confianza; revisa salidas y transporte.'));
  core.plans.push({title:T('Quick Plan','Plan r√°pido'), steps}); saveLocal(); renderPlans(); toast(T('Quick plan created.','Plan r√°pido creado.'));
};
document.getElementById('demoQs').addEventListener('click', e=>{
  const b=e.target.closest('button'); if(!b) return;
  openAsk(); setTimeout(()=>{ const i=$('askInput'); if(i){ i.value=b.textContent; i.focus(); }},250);
});

/* ===================== RESOURCES ===================== */
function seedResourcesIfEmpty(){
  if(!Array.isArray(core.resources) || core.resources.length===0){
    core.resources = [
      {title:"National Domestic Violence Hotline (US)", desc:"24/7 confidential help ‚Äî call or chat", url:"tel:+18007997233"},
      {title:"RAINN Sexual Assault Hotline (US)", desc:"24/7 ‚Äî phone + online chat", url:"tel:+18006564673"},
      {title:"Childhelp National Child Abuse Hotline (US)", desc:"24/7 ‚Äî children & adults", url:"tel:+18004224453"},
      {title:"StrongHearts Native Helpline (US)", desc:"Support for Native communities", url:"tel:+18447628483"},
      {title:"love is respect (US)", desc:"Dating abuse support ‚Äî call/text/chat", url:"https://www.loveisrespect.org/"},
      {title:"National Deaf DV Hotline (US)", desc:"Deaf/Hard of Hearing support (ASL)", url:"https://thedeafhotline.org/"},
      {title:"211 ‚Äî Local Services (US/Canada)", desc:"Housing, legal, financial, counseling", url:"https://www.211.org/"},
      {title:"SAMHSA Helpline (US)", desc:"Mental health & substance use", url:"tel:+18006624357"},
      {title:"Emergency", desc:"Call your local emergency number", url:"tel:911"}
    ];
    saveLocal();
  }
}
function renderResources(){
  const box=$('resList'); box.innerHTML='';
  core.resources.forEach((r,i)=>{
    const isTel = /^tel:/i.test(r.url||'');
    const item = `
      <div class="card p-3 flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="font-semibold truncate">${r.title}</div>
          <div class="text-sm text-gray-600">${r.desc||''}</div>
          <div class="text-xs mt-1 break-all">${r.url}</div>
        </div>
        <div class="flex flex-col gap-2 shrink-0">
          ${isTel? `<a class="btn" href="${r.url}">${T('Call','Llamar')}</a>` : `<button class="btn openRes" data-i="${i}">${T('Open','Abrir')}</button>`}
          <button class="btn copyRes" data-i="${i}">${T('Copy','Copiar')}</button>
          <button class="btn delRes text-rose-600" data-i="${i}">${T('Delete','Eliminar')}</button>
        </div>
      </div>`;
    box.insertAdjacentHTML('beforeend', item);
  });
  box.querySelectorAll('.copyRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; navigator.clipboard.writeText(core.resources[i].url||''); toast(T('Copied.','Copiado.')); });
  box.querySelectorAll('.delRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; core.resources.splice(i,1); saveLocal(); renderResources(); });
  box.querySelectorAll('.openRes').forEach(b=> b.onclick=()=>{ const i=+b.dataset.i; const u=core.resources[i].url; if(u) location.href=u; });
}
$('callHotlineBtn').onclick=()=>{ location.href='tel:+18007997233'; };
$('btnAddResource').onclick=()=>{
  const title = prompt(T('Title','T√≠tulo'))||''; if(!title) return;
  const desc  = prompt(T('Description (optional)','Descripci√≥n (opcional)'))||'';
  const url   = prompt(T('Link or phone (prefix phone with tel:)','Enlace o tel√©fono (prefijo tel:)'))||'';
  core.resources.push({title,desc,url}); saveLocal(); renderResources();
};
$('btnSeedLocal').onclick=()=>{
  core.resources.push({title:T("Local 211 ‚Äî Services","211 Local ‚Äî Servicios"), desc:T("Tap to open 211","Pulsa para abrir 211"), url:"https://www.211.org/"}); saveLocal(); renderResources();
};

/* ===================== PROFILE ===================== */
$('profName').value = core.name;
$('themePick').value = core.theme;
$('btnSaveProfile').onclick=()=>{
  core.name = $('profName').value.trim() || 'Anonymous';
  const old = $('oldPin').value.trim();
  const np  = $('newPin').value.trim();
  const np2 = $('newPin2').value.trim();
  if(np || np2 || old){
    if(old!==core.pin) return toast(T('Old PIN is wrong.','PIN anterior incorrecto.'));
    if(np.length<4 || np!==np2) return toast(T('New PIN mismatch or too short.','Nuevo PIN no coincide o es muy corto.'));
    core.pin = np;
  }
  saveLocal();
  applyLang();
  toast(T('Profile saved.','Perfil guardado.'));
};
$('btnExport').onclick=()=>{
  const data = {
    profile:{name:core.name},
    answers:core.answers,
    risk:core.risk, trust:core.trust,
    resources:core.resources,
    plans:core.plans,
    theme:core.theme,
    app:"TimeOut", version:"v1.3.5"
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='timeout_export.json'; a.click(); URL.revokeObjectURL(a.href);
};

/* ===================== ASK SUPPORT (VOICE/TEXT DEMO) ===================== */
function ensureAskModal(){
  const host = $('askModal');
  if(host.dataset.ready==='1') return true;
  host.dataset.ready='1';
  host.innerHTML = `
    <div class="card p-4 w-[92vw] max-w-md mx-auto">
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold">${T('Ask Support','Chat de apoyo')}</div>
        <button id="askClose" class="btn btn-ghost">‚úï</button>
      </div>
      <div class="text-xs text-gray-600 mb-2">${T('General guidance only; not therapy or emergency. If in danger, call emergency services.','Orientaci√≥n general; no es terapia ni emergencia. Si hay peligro, llama a emergencias.')}</div>
      <div id="askOut" class="space-y-2 max-h-[42vh] overflow-auto"></div>
      <div class="mt-3 flex gap-2">
        <input id="askInput" class="flex-1 border rounded-lg px-3 py-2" placeholder="${T('Say or type a question‚Ä¶','Di o escribe una pregunta‚Ä¶')}">
        <button id="askMic" class="btn btn-ghost" title="${T('Speak','Hablar')}">üé§</button>
        <button id="askSend" class="btn btn-primary">${T('Send','Enviar')}</button>
      </div>
      <div class="mt-3 text-xs text-gray-600">${T('Try saying:','Prueba decir:')}
        <span class="kbd">${T('Where can I get help tonight?','¬øD√≥nde puedo obtener ayuda esta noche?')}</span>
        <span class="kbd">${T('What should I put in my go-bag?','¬øQu√© pongo en mi bolsa?')}</span>
      </div>
    </div>`;
  function bubble(who,text){
    const el=document.createElement('div'); el.className='card p-2'; el.style.background=who==='user'?'#e8f7ee':'#fff';
    el.innerHTML=`<div class="text-xs text-gray-500">${who==='user'?T('You','T√∫'):T('Support','Apoyo')}</div><div class="mt-1">${text}</div>`;
    $('askOut').appendChild(el); $('askOut').scrollTop = $('askOut').scrollHeight;
  }
  function reply(q){
    const a = core.answers, s=(q||'').toLowerCase();
    if(/go-?bag|bolsa/.test(s)) return T('Pack ID, keys, cash, meds, a charger, and spare clothes. Hide it or leave it with someone you trust.','Empaca identificaci√≥n, llaves, dinero, medicinas, cargador y ropa extra. Esc√≥ndela o d√©jala con alguien de confianza.');
    if(/help|ayuda|hotline|l√≠nea/.test(s)) return T('If at risk, call emergency. See Resources for hotlines; 211 can connect you locally.','Si hay riesgo, llama a emergencias. En Recursos hay l√≠neas de ayuda; 211 conecta con servicios locales.');
    if(/safe|segur|leave|salir/.test(s)) return T('Leaving can be risky ‚Äî plan exits, keep essentials ready, and tell someone you trust when you go.','Salir puede ser riesgoso ‚Äî planea salidas, ten lo esencial listo y avisa a alguien de confianza cuando salgas.');
    if(/phone|privac|privacy|tel[e√©]fono/.test(s)) return a.q4==='yes'? T('Limit sensitive content, use a strong passcode, and consider quick-wipe options.','Limita contenido sensible, usa un c√≥digo fuerte y considera opciones de borrado r√°pido.'): T('Use screen lock and review accounts/sign-ins.','Usa bloqueo de pantalla y revisa cuentas/accesos.');
    if(/threat|amenaz/.test(s)) return a.q2==='yes'? T('Record dates/times privately and tell a trusted person. Consider documenting safely off-device.','Registra fechas/horas en privado y cu√©ntaselo a alguien de confianza. Considera documentar fuera del tel√©fono.'): T('Monitor and update your plan if things change.','Monitorea y actualiza tu plan si algo cambia.');
    return T('Thanks for sharing. Small step: review your plan or add a trusted contact.','Gracias por compartir. Paso peque√±o: revisa tu plan o agrega un contacto de confianza.');
  }
  let _micBusy = false;
  document.addEventListener('click', (e)=>{
    if (e.target && e.target.id === 'askMic') _micBusy = false;
  });
  function send(){ const i=$('askInput'); const q=i.value.trim(); if(!q) return; bubble('user',q); i.value=''; setTimeout(()=> bubble('bot', reply(q)), 300); }
  $('askSend').onclick=send; $('askInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); } });
  $('askClose').onclick=closeAsk;
  $('askMic').onclick=()=>{ 
    if (_micBusy) return; _micBusy = true;
    try{ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR) throw 0;
      const rec=new SR(); rec.lang=(core.lang==='es'?'es-ES':'en-US'); rec.onresult=e=>{ const t=e.results[0][0].transcript; $('askInput').value=t; send(); }; rec.start();
    }catch{ alert(T('Voice not supported on this device.','Voz no soportada en este dispositivo.')); }
  };
  return true;
}
function openAsk(){ ensureAskModal(); $('askModal').classList.remove('hidden-soft'); $('askInput')?.focus(); document.body.style.overflow='hidden'; }
function closeAsk(){ $('askModal').classList.add('hidden-soft'); document.body.style.overflow='auto'; }
$('askFab').onclick=openAsk; $('askChipCheck').onclick=openAsk; $('askChipPlan').onclick=openAsk;

/* ===================== BACK BUTTON ===================== */
$('btnBack').onclick=()=>{
  closeAsk();
  setTab('home');
  window.scrollTo(0,0);
};

/* ===================== INIT & APPLY ===================== */
function applyAll(){
  applyTheme();
  applyLang();
  buildQuestions();
  updateScoresAndFeedback();
  renderPlans();
  renderResources();
  applySafetyAckVisibility();
}
function init(){
  tickClock(); (function(){ $('hdrWeather').textContent = '‚õÖ'; })();
  seedResourcesIfEmpty();
  if(!Array.isArray(core.plans) || core.plans.length===0){
    core.plans=[{title:T('Grab & Go Bag','Bolsa de emergencia'), steps:[T('ID & documents','Identificaci√≥n y documentos'),T('Keys & cash','Llaves y efectivo'),T('Medications','Medicamentos'),T('Change of clothes','Cambio de ropa'),T('Backup phone numbers','N√∫meros de tel√©fono de respaldo')]}];
    saveLocal();
  }
  applyAll();
}
init();

/* ===================== VISIBILITY AUTO-LOCK (dup safe) ===================== */
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) lockToDecoy(); });

/* ===================== QUICK EXIT / PANIC (duplicate guards) ===================== */
let qeGuard=false, pcGuard=false;
document.getElementById('btnQuickExit').onclick=()=>{ if(qeGuard) return; qeGuard=true; setTimeout(()=>qeGuard=false,500); location.href='https://www.google.com/'; };
document.getElementById('btnPanic').onclick=()=>{ if(pcGuard) return; pcGuard=true; setTimeout(()=>pcGuard=false,700);
  localStorage.removeItem('timeout_profile_name'); 
  localStorage.removeItem('timeout_answers'); 
  localStorage.removeItem('timeout_resources'); 
  localStorage.removeItem('timeout_plans'); 
  localStorage.removeItem('timeout_theme');
  core.name='Anonymous'; core.answers={}; core.resources=[]; core.plans=[]; core.theme='blue';
  saveLocal(); applyTheme(); lockToDecoy(); 
};
</script>
</body>
</html>
