<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TimeOut — Mobile Safety App</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<style>
  /* compact custom styles for mobile-first layout */
  body { background:#0f1724; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .app-card { background: linear-gradient(180deg, rgba(17,24,39,0.9), rgba(9,11,16,0.85)); border:1px solid rgba(255,255,255,0.03); border-radius:14px; box-shadow:0 10px 30px rgba(2,6,23,0.6); }
  .tab { padding:.5rem 1rem; border-radius:9999px; cursor:pointer; }
  .tab.active { background:linear-gradient(90deg,#6366f1,#4f46e5); color:white; box-shadow:0 6px 18px rgba(79,70,229,0.16); }
  .q-btn { min-width:64px; border-radius:9999px; padding:.4rem .8rem; }
  .quick-exit { background:#ef4444; color:white; padding:.5rem 1rem; border-radius:10px;}
  .decoy { display:none; }
  .progress-ring { width:72px; height:72px; }
  @media(min-width:768px){ .container-max { max-width:720px; } }
</style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

  <div class="w-full container-max max-w-md space-y-4">
    <!-- Header -->
    <header class="flex items-center justify-between mb-2">
      <div>
        <h1 class="text-2xl font-bold">TimeOut</h1>
        <p class="text-xs text-gray-400">Safety check-in & quick-exit mobile app</p>
      </div>
      <div class="text-xs text-gray-400 text-right">
        <div id="userIdDisplay">local</div>
        <div id="statusBadge" class="text-xs mt-1 text-green-300">Offline (local)</div>
      </div>
    </header>

    <!-- Quick exit / decoy -->
    <div class="flex justify-between items-center gap-2">
      <button id="quickExitBtn" class="quick-exit">Quick Exit</button>
      <button id="decoyBtn" class="bg-gray-700 px-3 py-2 rounded-md text-sm">Decoy Page</button>
    </div>

    <!-- Tabs -->
    <nav class="flex justify-between space-x-2">
      <div id="tabLanding" class="tab active">Home</div>
      <div id="tabCheckin" class="tab">Check-In</div>
      <div id="tabJournal" class="tab">Journal</div>
      <div id="tabResources" class="tab">Resources</div>
      <div id="tabSettings" class="tab">Settings</div>
    </nav>

    <!-- App body / card -->
    <main id="appCard" class="app-card p-4">
      <!-- Landing view -->
      <section id="view-landing">
        <h2 class="text-lg font-semibold">Welcome back</h2>
        <p class="text-sm text-gray-300 mt-1">Tap Check-In to answer the safety questions. Your trust score updates live.</p>

        <div class="mt-4 flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-400">Trust Score</p>
            <div class="text-2xl font-bold" id="trustScoreText">--</div>
          </div>
          <div class="text-center">
            <svg id="trustRing" class="progress-ring" viewBox="0 0 36 36">
              <path id="ringBg" d="M18 2.1a15.9 15.9 0 1 1 0 31.8 15.9 15.9 0 1 1 0-31.8" fill="none" stroke="#111827" stroke-width="4"></path>
              <path id="ring" d="M18 2.1a15.9 15.9 0 1 1 0 31.8 15.9 15.9 0 1 1 0-31.8" fill="none" stroke="#6366f1" stroke-width="4" stroke-linecap="round" stroke-dasharray="0 100"></path>
            </svg>
          </div>
        </div>

        <div class="mt-4">
          <button id="startCheckinBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-2 rounded-md">Start Check-In</button>
        </div>
      </section>

      <!-- Check-in view -->
      <section id="view-checkin" class="hidden">
        <h2 class="text-lg font-semibold">Check-In — 8 Questions</h2>
        <p class="text-xs text-gray-400 mt-1">Answer honestly. Tap Save to persist locally (and to cloud if configured).</p>

        <form id="questionsForm" class="space-y-3 mt-3">
          <!-- Questions (will be populated by JS) -->
        </form>

        <div class="flex gap-2 mt-3">
          <button id="saveAnswersBtn" class="flex-1 bg-green-600 py-2 rounded-md">Save</button>
          <button id="calcScoreBtn" class="flex-1 bg-indigo-600 py-2 rounded-md">Calc Score</button>
        </div>
      </section>

      <!-- Journal view -->
      <section id="view-journal" class="hidden">
        <h2 class="text-lg font-semibold">Journal</h2>
        <p class="text-xs text-gray-400 mt-1">Quick note to yourself. Save locally; export if needed.</p>
        <textarea id="journalText" class="w-full mt-2 p-3 rounded-md bg-gray-800 text-white h-36" placeholder="Write anything..."></textarea>
        <div class="flex gap-2 mt-2">
          <button id="saveJournalBtn" class="flex-1 bg-indigo-600 py-2 rounded-md">Save</button>
          <button id="exportJournalBtn" class="flex-1 bg-gray-700 py-2 rounded-md">Export</button>
        </div>
      </section>

      <!-- Resources view -->
      <section id="view-resources" class="hidden">
        <h2 class="text-lg font-semibold">Resources</h2>
        <ul class="mt-2 text-sm space-y-2">
          <li><a class="text-indigo-300" href="tel:18007997233">National Domestic Violence Hotline: 1-800-799-7233</a></li>
          <li><a class="text-indigo-300" href="https://www.thehotline.org/">thehotline.org</a></li>
          <li><a class="text-indigo-300" href="https://www.rainn.org/">RAINN (sexual assault)</a></li>
        </ul>
      </section>

      <!-- Settings view -->
      <section id="view-settings" class="hidden">
        <h2 class="text-lg font-semibold">Settings</h2>
        <p class="text-xs text-gray-400 mt-1">App mode and persistence</p>

        <div class="mt-3">
          <label class="flex items-center justify-between text-sm">
            <span>Auto-save to localStorage</span>
            <input id="toggleAutosave" type="checkbox" checked />
          </label>
          <label class="flex items-center justify-between text-sm mt-2">
            <span>Enable cloud sync (Firebase)</span>
            <input id="toggleCloud" type="checkbox" />
          </label>
        </div>

        <div class="mt-3 space-y-2">
          <button id="exportDataBtn" class="w-full bg-gray-700 py-2 rounded-md">Export Data</button>
          <input id="importFile" type="file" accept="application/json" class="w-full text-xs text-gray-400" />
          <button id="resetDataBtn" class="w-full bg-red-600 py-2 rounded-md">Reset All Local Data</button>
        </div>

        <div class="mt-3 text-xs text-gray-500">
          <p>Firebase: paste credentials in the top of the file (see comments) to enable cloud save.</p>
        </div>
      </section>

      <!-- Decoy page (quick-exit redirect target inside the app) -->
      <section id="view-decoy" class="hidden decoy">
        <h2 class="text-lg font-semibold">News & Weather</h2>
        <p class="text-xs text-gray-300">Latest headlines</p>
        <ul id="decoyList" class="mt-2 text-sm space-y-1 text-gray-200">
          <li>Local news headline #1</li>
          <li>Local news headline #2</li>
          <li>Weather: Sunny, 72°F</li>
        </ul>
        <div class="mt-3">
          <button id="returnFromDecoy" class="w-full bg-indigo-600 py-2 rounded-md">Return</button>
        </div>
      </section>

    </main>

  </div>

<script>
/* ==========================
   TIMEOUT APP - single file
   - Local persistence via localStorage
   - Optional Firebase placeholders
   - Tab UI, 8 questions, trust score
   ========================== */

/* ----- Configurable Questions ----- */
const QUESTIONS = [
  { id: 'q1', text: "Is your partner currently with you?" },
  { id: 'q2', text: "Have you felt frightened within the last 24 hours?" },
  { id: 'q3', text: "Has any physical harm occurred recently?" },
  { id: 'q4', text: "Do you feel safe going home right now?" },
  { id: 'q5', text: "Have they threatened you or your kids?" },
  { id: 'q6', text: "Do you have a safe place to go?" },
  { id: 'q7', text: "Do you have important documents accessible?" },
  { id: 'q8', text: "Would you like help/resources now?" }
];

/* ----- Storage keys ----- */
const STORAGE_KEY = 'timeout_app_v1';
const JOURNAL_KEY = 'timeout_journal_v1';

/* ----- Simple state ----- */
let STATE = {
  answers: {},   // qid -> boolean
  trustScore: 0,
  journal: '',
  autosave: true,
  cloudEnabled: false
};

/* ----- DOM refs ----- */
const refs = {};
function $(id){ return document.getElementById(id); }

/* ----- Initialize UI ----- */
function init() {
  // Build questions UI
  const form = $('questionsForm');
  QUESTIONS.forEach(q => {
    const wrapper = document.createElement('div');
    wrapper.className = 'flex items-center justify-between bg-gray-800 p-3 rounded-md';
    wrapper.innerHTML = `
      <div>
        <div class="text-sm font-medium">${escapeHtml(q.text)}</div>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" data-q="${q.id}" data-val="yes" class="q-btn bg-green-600 hover:bg-green-700">Yes</button>
        <button type="button" data-q="${q.id}" data-val="no" class="q-btn bg-gray-700 hover:bg-gray-600">No</button>
      </div>
    `;
    form.appendChild(wrapper);
  });

  // wire tab buttons
  ['Landing','Checkin','Journal','Resources','Settings'].forEach(name => {
    $( 'tab' + name ).addEventListener('click', () => switchView(name.toLowerCase()));
  });
  $('startCheckinBtn').addEventListener('click', ()=> switchView('checkin'));
  $('decoyBtn').addEventListener('click', openDecoy);
  $('quickExitBtn').addEventListener('click', quickExit);
  $('returnFromDecoy').addEventListener('click', ()=> switchView('landing'));

  // question buttons
  document.querySelectorAll('[data-q]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const qid = e.currentTarget.dataset.q;
      const val = e.currentTarget.dataset.val === 'yes';
      STATE.answers[qid] = val;
      // visual mark
      const group = document.querySelectorAll(`[data-q="${qid}"]`);
      group.forEach(b => {
        if (b.dataset.val === (val ? 'yes' : 'no')) {
          b.classList.remove('bg-gray-700'); b.classList.add('bg-indigo-600');
        } else {
          b.classList.remove('bg-indigo-600'); b.classList.add('bg-gray-700');
        }
      });
      if (STATE.autosave) saveLocal();
    });
  });

  // Save, calc, journal, settings
  $('saveAnswersBtn').addEventListener('click', async ()=> {
    saveLocal();
    showMessage('Answers saved.');
  });
  $('calcScoreBtn').addEventListener('click', ()=> {
    computeTrust();
    showMessage('Trust score updated.');
  });

  $('saveJournalBtn').addEventListener('click', ()=> {
    STATE.journal = $('journalText').value || '';
    localStorage.setItem(JOURNAL_KEY, STATE.journal);
    showMessage('Journal saved.');
  });
  $('exportJournalBtn').addEventListener('click', ()=> {
    const data = localStorage.getItem(JOURNAL_KEY) || '';
    downloadFile('journal.txt', data);
  });

  $('toggleAutosave').addEventListener('change', (e)=> STATE.autosave = e.target.checked );
  $('toggleCloud').addEventListener('change', (e)=> {
    STATE.cloudEnabled = e.target.checked;
    updateStatusBadge();
  });

  $('exportDataBtn').addEventListener('click', ()=> {
    const exportObj = { state: STATE, stored: localStorage.getItem(STORAGE_KEY), journal: localStorage.getItem(JOURNAL_KEY) };
    downloadFile('timeout-data.json', JSON.stringify(exportObj, null, 2));
  });
  $('importFile').addEventListener('change', (e)=> {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try {
        const obj = JSON.parse(r.result);
        if (obj.state) {
          STATE = obj.state;
          restoreUIFromState();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));
          if (obj.journal) localStorage.setItem(JOURNAL_KEY, obj.journal);
          showMessage('Imported data.');
        } else showMessage('Invalid file.', true);
      } catch (err) { showMessage('Import failed.', true); }
    };
    r.readAsText(f);
  });

  $('resetDataBtn').addEventListener('click', async ()=> {
    const ok = confirm('Reset local data? This cannot be undone.');
    if (!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(JOURNAL_KEY);
    STATE = { answers:{}, trustScore:0, journal:'', autosave:true, cloudEnabled:false };
    restoreUIFromState();
    showMessage('Local data reset.');
  });

  // load saved data
  loadLocal();
  restoreUIFromState();
  computeTrust();
  updateStatusBadge();
}

/* ----- Helper: switch views ----- */
function switchView(view) {
  const mapping = {
    landing: 'view-landing',
    checkin: 'view-checkin',
    journal: 'view-journal',
    resources: 'view-resources',
    settings: 'view-settings'
  };
  // hide all
  Object.values(mapping).forEach(id => { $(id).classList.add('hidden'); });
  const activeId = mapping[view] || 'view-landing';
  $(activeId).classList.remove('hidden');

  // highlight tab
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const tabId = 'tab' + (view.charAt(0).toUpperCase() + view.slice(1));
  if ($(tabId)) $(tabId).classList.add('active');
  // set active state
  STATE.active = view;
}

/* ----- Quick Exit / Decoy ----- */
function quickExit() {
  // Option 1: redirect to external safe site
  const safeUrl = 'https://www.google.com'; // change if you want
  window.location.href = safeUrl;
}
function openDecoy() {
  // show decoy inside app (so back button returns)
  document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
  $('view-decoy').classList.remove('hidden');
  // mark decoy tab style on decoy button
}

/* ----- Persistence: localStorage ----- */
function saveLocal() {
  const toSave = {
    answers: STATE.answers,
    trustScore: STATE.trustScore,
    journal: STATE.journal,
    autosave: STATE.autosave
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
  // also journal
  if (STATE.journal) localStorage.setItem(JOURNAL_KEY, STATE.journal);
}

function loadLocal() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const obj = JSON.parse(raw);
    STATE.answers = obj.answers || {};
    STATE.trustScore = obj.trustScore || 0;
    STATE.journal = obj.journal || '';
    STATE.autosave = typeof obj.autosave === 'boolean' ? obj.autosave : true;
  } catch (e) {
    console.warn('Failed to parse saved state', e);
  }
}

/* ----- Compute trust score ----- */
function computeTrust() {
  // Example: each "no" to risky questions increases score negatively. We'll score 0..100.
  // Simple heuristic: each "yes" to risk increases risk -> lower score.
  let riskCount = 0;
  QUESTIONS.forEach((q, idx) => {
    const ans = STATE.answers[q.id];
    // treat true (yes) as risky for first 5 Qs; invert for safe questions (like having docs)
    if (q.id === 'q6' || q.id === 'q7') {
      // q6: have safe place -> yes reduces risk
      if (ans === true) riskCount -= 1;
    } else {
      if (ans === true) riskCount += 1;
    }
  });
  // normalize: riskCount may be -2..8. Map to trust score 0..100 (higher trust = safer)
  // trust = 100 - (riskCount * 12) with bounding
  let score = 100 - (riskCount * 12);
  score = Math.max(0, Math.min(100, score));
  STATE.trustScore = score;
  updateTrustUI();
  saveLocal();
}

/* ----- UI updates ----- */
function updateTrustUI() {
  $('trustScoreText').textContent = Math.round(STATE.trustScore) + '%';
  const ring = $('ring');
  const pct = STATE.trustScore;
  // stroke-dasharray technique for simple ring
  const dash = (pct / 100) * 100;
  ring.setAttribute('stroke-dasharray', `${dash} 100`);
}

/* restore UI from state */
function restoreUIFromState() {
  // questions
  QUESTIONS.forEach(q => {
    const val = STATE.answers[q.id];
    const group = document.querySelectorAll(`[data-q="${q.id}"]`);
    group.forEach(b => {
      b.classList.remove('bg-indigo-600');
      b.classList.remove('bg-gray-700');
      if (b.dataset.val === 'yes') {
        b.classList.add((val===true)?'bg-indigo-600':'bg-gray-700');
      } else {
        b.classList.add((val===false)?'bg-indigo-600':'bg-gray-700');
      }
    });
  });
  // journal
  $('journalText').value = STATE.journal || localStorage.getItem(JOURNAL_KEY) || '';
  // trust
  updateTrustUI();
  // settings toggles
  $('toggleAutosave').checked = STATE.autosave;
  $('toggleCloud').checked = STATE.cloudEnabled;
}

/* ----- Small utilities ----- */
function showMessage(msg, isError) {
  const box = $('message-box');
  box.textContent = msg;
  box.classList.add('show');
  box.style.background = isError ? '#dc2626' : '#4f46e5';
  setTimeout(()=> box.classList.remove('show'), 2000);
}
function escapeHtml(s){ return s.replace?.(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) || s; }
function downloadFile(name, content) {
  const a = document.createElement('a');
  const blob = new Blob([content], { type:'application/octet-stream' });
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ----- Optional: Firebase wiring placeholder ----- */
/*
  If you want cloud sync:
  1) Add Firebase SDK and config (replace below placeholder with your real config).
  2) On login (anonymous or custom), set STATE.userId = auth.uid and update UI.
  3) On saveLocal(), also write to Firestore under artifacts/{appId}/users/{uid}/... and for meetings etc.

  Example placeholder (do NOT leave keys in public code unless intended):
  const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "..." };

  NOTE: I left Firebase out by default because you need your own keys. If you want, say "add firebase" and
  I'll paste a ready-to-drop-in block that will sign in anonymously and sync STATE to Firestore.
*/

/* ----- Update the status badge (local/cloud) ----- */
function updateStatusBadge() {
  const s = $('statusBadge');
  if (STATE.cloudEnabled) {
    s.textContent = 'Cloud sync: enabled (not configured)';
    s.classList.remove('text-green-300'); s.classList.add('text-yellow-300');
  } else {
    s.textContent = 'Offline (local)';
    s.classList.remove('text-yellow-300'); s.classList.add('text-green-300');
  }
}

/* ----- Init on load ----- */
window.addEventListener('DOMContentLoaded', () => {
  try {
    init();
  } catch (err) {
    console.error('Init error', err);
    showMessage('Init error: see console', true);
  }
});
</script>

</body>
</html>
