<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TimeOut — Safety & Support</title>
  <meta name="theme-color" content="#0b1020" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    body{background:#0b1020}
    .card{background:#121a2a;border:1px solid rgba(255,255,255,.06)}
    .pill{border-radius:9999px}
    .ghost::-webkit-scrollbar{height:6px;width:6px}
    .ghost::-webkit-scrollbar-thumb{background:#334155;border-radius:9999px}
    .tap:active{transform:translateY(1px)}
    .kbd{border:1px solid #475569;border-bottom-width:2px;padding:.15rem .4rem;border-radius:.375rem;font-size:.7rem}
  </style>
</head>
<body class="text-slate-100">
  <main class="max-w-md mx-auto min-h-screen flex flex-col">

    <!-- Header -->
    <header class="sticky top-0 z-20 backdrop-blur bg-black/40 border-b border-white/10">
      <div class="px-4 py-3 flex items-center justify-between">
        <h1 class="text-lg font-semibold">TimeOut</h1>
        <div class="flex items-center gap-2">
          <span id="trustBadge" class="text-xs px-2 py-1 pill bg-indigo-600/20 border border-indigo-400/30 text-indigo-200">Trust: 0%</span>
          <button id="quickExit" class="tap text-xs px-3 py-1 pill bg-rose-600 hover:bg-rose-700">Quick Exit</button>
        </div>
      </div>
      <!-- Tabs row 1 -->
      <nav class="px-2 pb-2 grid grid-cols-4 gap-2 text-xs">
        <button data-tab="home" class="tab pill px-3 py-2 bg-indigo-600">Home</button>
        <button data-tab="checkin" class="tab pill px-3 py-2 bg-slate-700/60">Check-In</button>
        <button data-tab="assessment" class="tab pill px-3 py-2 bg-slate-700/60">Assessment</button>
        <button data-tab="resources" class="tab pill px-3 py-2 bg-slate-700/60">Resources</button>
      </nav>
      <!-- Tabs row 2 -->
      <nav class="px-2 pb-3 grid grid-cols-3 gap-2 text-xs">
        <button data-tab="safety" class="tab pill px-3 py-2 bg-slate-700/60">Safety Plan</button>
        <button data-tab="profile" class="tab pill px-3 py-2 bg-slate-700/60">Profile</button>
        <button data-tab="settings" class="tab pill px-3 py-2 bg-slate-700/60">Settings</button>
      </nav>
    </header>

    <!-- Content -->
    <section id="view" class="flex-1 p-4 space-y-3"></section>

    <!-- Footer actions -->
    <footer class="sticky bottom-0 bg-black/40 border-t border-white/10">
      <div class="px-4 py-3 flex items-center gap-2">
        <button id="primaryAction" class="tap flex-1 pill px-4 py-3 bg-indigo-600 hover:bg-indigo-700 font-semibold">New Check-In</button>
        <button id="resetAll" class="tap pill px-4 py-3 bg-slate-700 hover:bg-slate-600">Reset</button>
      </div>
    </footer>
  </main>

  <script>
  // =============== STATE & STORAGE ===============
  const STORAGE_KEY = 'timeout_app_v1';
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  const state = {
    tab: 'home',
    profile: { displayName:'', zip:'', safeContact:'', notes:'' },
    checkins: [], // [{ts, mood, safety, note}]
    assessment: { answers:{}, score:0 }, // 8 Qs
    safetyPlan: { codeWord:'', escapeRoute:'', essentials:'', transport:'', pets:'' },
    trust: 0
  };

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) Object.assign(state, JSON.parse(raw));
    }catch{}
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    renderTrust();
  }

  // =============== TRUST SCORE ===============
  function computeTrust(){
    // Base from assessment (lower score => safer => higher trust)
    const base = Math.max(0, 100 - state.assessment.score*8); // 0..100
    // Consistency from last 7 check-ins: higher safety => higher trust
    const recent = state.checkins.slice(-7);
    const avgSafety = recent.length ? recent.reduce((a,c)=>a+c.safety,0)/recent.length : 5;
    const consistency = Math.round((avgSafety/10)*100); // 0..100
    // Engagement from total number of check-ins
    const engagement = Math.min(100, state.checkins.length*7); // caps at ~15+ check-ins
    const t = Math.round(base*0.5 + consistency*0.25 + engagement*0.25);
    state.trust = Math.min(100, Math.max(0, t));
  }
  function renderTrust(){
    computeTrust();
    const b = $('#trustBadge');
    b.textContent = 'Trust: ' + state.trust + '%';
    b.className = 'text-xs px-2 py-1 pill border ' +
      (state.trust>=75 ? 'bg-emerald-600/20 border-emerald-400/30 text-emerald-200' :
       state.trust>=40 ? 'bg-amber-600/20 border-amber-400/30 text-amber-200' :
                         'bg-rose-600/20 border-rose-400/30 text-rose-200');
  }

  // =============== VIEW HELPERS ===============
  const view = $('#view');

  function setTab(t){
    state.tab = t;
    $$('.tab').forEach(btn=>{
      const active = btn.dataset.tab===t;
      btn.classList.toggle('bg-indigo-600', active);
      btn.classList.toggle('bg-slate-700/60', !active);
    });
    render();
    save();
  }

  function card(title, inner=''){
    const el = document.createElement('div');
    el.className = 'card rounded-2xl p-4';
    el.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">${title}</h3>
      </div>
      <div class="text-sm space-y-2">${inner}</div>`;
    return el;
  }

  function render(){
    switch(state.tab){
      case 'home': return renderHome();
      case 'checkin': return renderCheckIn();
      case 'assessment': return renderAssessment();
      case 'resources': return renderResources();
      case 'safety': return renderSafety();
      case 'profile': return renderProfile();
      case 'settings': return renderSettings();
    }
  }

  // =============== HOME ===============
  function renderHome(){
    view.innerHTML = '';
    const hero = card('Welcome', `
      <p>Your private space to check-in, assess risk, and keep a safety plan handy.</p>
      <ul class="text-slate-300 list-disc pl-5 space-y-1">
        <li>Use <b>Quick Exit</b> if you need to leave now.</li>
        <li>Run the <b>Assessment</b> (8 questions) to update your risk level.</li>
        <li>Track feelings with <b>Check-Ins</b>. That improves your Trust score.</li>
      </ul>
    `);
    const latest = card('Recent Check-Ins');
    if (!state.checkins.length){
      latest.querySelector('.text-sm').innerHTML = '<p class="text-slate-400">No check-ins yet.</p>';
    } else {
      const list = document.createElement('div');
      list.className = 'space-y-2 max-h-56 overflow-auto ghost pr-1';
      state.checkins.slice(-10).reverse().forEach(c=>{
        const d = new Date(c.ts).toLocaleString();
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-slate-800/50 rounded-xl p-2';
        row.innerHTML = `
          <div>
            <div class="text-xs text-slate-400">${d}</div>
            <div class="text-sm">${c.note || '(no note)'}</div>
          </div>
          <div class="text-right">
            <div class="text-xs">Mood: <b>${c.mood}/10</b></div>
            <div class="text-xs">Safety: <b>${c.safety}/10</b></div>
          </div>`;
        list.appendChild(row);
      });
      latest.querySelector('.text-sm').replaceWith(list);
    }
    view.appendChild(hero);
    view.appendChild(latest);
    const pa = $('#primaryAction');
    pa.textContent = 'New Check-In';
    pa.onclick = ()=>setTab('checkin');
  }

  // =============== CHECK-IN ===============
  function renderCheckIn(){
    view.innerHTML = '';
    const form = card('Quick Check-In', `
      <label class="block">Mood (0–10)
        <input id="mood" type="range" min="0" max="10" value="5" class="w-full">
      </label>
      <label class="block">How safe do you feel right now? (0–10)
        <input id="safety" type="range" min="0" max="10" value="5" class="w-full">
      </label>
      <label class="block">Note (optional)
        <textarea id="note" rows="3" class="w-full bg-slate-900 rounded-lg p-2 border border-white/10" placeholder="Anything you want to remember…"></textarea>
      </label>
      <button id="saveCheckin" class="tap w-full pill bg-indigo-600 hover:bg-indigo-700 py-3 font-semibold">Save Check-In</button>
    `);
    view.appendChild(form);
    $('#saveCheckin').onclick = ()=>{
      const mood = +$('#mood').value;
      const safety = +$('#safety').value;
      const note = $('#note').value.trim();
      state.checkins.push({ ts: Date.now(), mood, safety, note });
      save();
      setTab('home');
    };
    const pa = $('#primaryAction');
    pa.textContent = 'Save Check-In';
    pa.onclick = ()=>$('#saveCheckin').click();
  }

  // =============== ASSESSMENT (8 Qs) ===============
  const QUESTIONS = [
    'Has your partner threatened you or someone you love?',
    'Has physical violence happened in the last 30 days?',
    'Does your partner control where you go, who you see, or your money?',
    'Has your partner ever strangled/choked you?',
    'Does your partner have access to weapons?',
    'Has your partner ever destroyed property or hurt pets?',
    'Are there children who have witnessed violence?',
    'Are you currently afraid to go home?'
  ];
  function renderAssessment(){
    view.innerHTML = '';
    const wrap = card('Safety Assessment (8 questions)');
    const box = document.createElement('div');
    box.className = 'space-y-3';
    QUESTIONS.forEach((q, i)=>{
      const id = 'q'+(i+1);
      const val = state.assessment.answers[id] ?? '';
      const row = document.createElement('div');
      row.className = 'bg-slate-800/50 rounded-xl p-3';
      row.innerHTML = `
        <div class="text-sm mb-2">${i+1}. ${q}</div>
        <div class="flex gap-2">
          ${['No','Unsure','Yes'].map(opt=>{
            const v = opt.toLowerCase();
            const active = val===v ? 'bg-indigo-600' : 'bg-slate-700';
            return `<button class="ans tap px-3 py-2 pill ${active}" data-id="${id}" data-val="${v}">${opt}</button>`;
          }).join('')}
        </div>`;
      box.appendChild(row);
    });
    wrap.querySelector('.text-sm').replaceWith(box);
    view.appendChild(wrap);

    const summary = card('Summary', `
      <div id="riskLine">Risk: <b>Unknown</b></div>
      <button id="saveAssessment" class="tap w-full pill bg-amber-600 hover:bg-amber-700 py-3 font-semibold">Save Assessment</button>
    `);
    view.appendChild(summary);

    $$('.ans', view).forEach(b=>{
      b.onclick = ()=>{
        const id = b.dataset.id, v = b.dataset.val;
        state.assessment.answers[id] = v;
        // toggle peers
        $$(`.ans[data-id="${id}"]`, view).forEach(p=>p.classList.remove('bg-indigo-600'));
        b.classList.add('bg-indigo-600');
        updateAssessmentRisk();
      };
    });
    $('#saveAssessment').onclick = ()=>{
      updateAssessmentRisk();
      save();
      setTab('home');
    };
    updateAssessmentRisk();

    const pa = $('#primaryAction');
    pa.textContent = 'Save Assessment';
    pa.onclick = ()=>$('#saveAssessment').click();
  }
  function updateAssessmentRisk(){
    const a = state.assessment.answers;
    let score = 0;
    Object.keys(a).forEach(k=>{
      score += (a[k]==='yes'?2 : a[k]==='unsure'?1 : 0);
    });
    state.assessment.score = score;
    const risk = score>=10 ? 'High' : score>=5 ? 'Moderate' : 'Lower';
    const c = score>=10 ? 'text-rose-300' : score>=5 ? 'text-amber-300' : 'text-emerald-300';
    const line = $('#riskLine');
    if (line) line.innerHTML = `Risk: <b class="${c}">${risk}</b> (score ${score})`;
    renderTrust();
  }

  // =============== RESOURCES ===============
  function renderResources(){
    view.innerHTML = '';
    view.appendChild(card('Resources', `
      <div class="space-y-2">
        <a class="block p-3 rounded-xl bg-slate-800/50" href="tel:18007997233">National DV Hotline (US): 1-800-799-7233</a>
        <a class="block p-3 rounded-xl bg-slate-800/50" href="sms:88788">Text: 88788 (US)</a>
        <a class="block p-3 rounded-xl bg-slate-800/50" href="https://www.thehotline.org" target="_blank" rel="noopener">thehotline.org</a>
        <p class="text-slate-400 text-xs">Outside the US? Search your country’s hotline.</p>
      </div>
    `));
    const pa = $('#primaryAction');
    pa.textContent = 'New Check-In';
    pa.onclick = ()=>setTab('checkin');
  }

  // =============== SAFETY PLAN ===============
  function renderSafety(){
    view.innerHTML = '';
    const f = card('Safety Plan', `
      <label class="block text-sm">Code word with trusted person
        <input id="sp_code" class="mt-1 w-full bg-slate-900 rounded-lg p-2 border border-white/10">
      </label>
      <label class="block text-sm">Escape route / safe places
        <textarea id="sp_route" rows="2" class="mt-1 w-full bg-slate-900 rounded-lg p-2 border border-white/10"></textarea>
      </label>
      <label class="block text-sm">Essentials bag (IDs, meds, cash)
        <textarea id="sp_ess" rows="2" class="mt-1 w-full bg-slate-900 rounded-lg p-2 border border-white/10"></textarea>
      </label>
      <label class="block text-sm">Transport plan
        <input id="sp_trans" class="mt-1 w-full bg-slate-900 rounded-lg p-2 border border-white/10">
      </label>
      <label class="block text-sm">Pets plan
        <input id="sp_pets" class="mt-1 w-full bg-slate-900 rounded-lg p-2 border border-white/10">
      </label>
      <button id="savePlan" class="tap w-full pill bg-indigo-600 hover:bg-indigo-700 py-3 font-semibold">Save Plan</button>
    `);
    view.appendChild(f);
    // preload
    $('#sp_code').value = state.safetyPlan.codeWord || '';
    $('#sp_route').value = state.safetyPlan.escapeRoute || '';
    $('#sp_ess').value = state.safetyPlan.essentials || '';
    $('#sp_trans').value = state.safetyPlan.transport || '';
    $('#sp_pets').value = state.safetyPlan.pets || '';
    $('#savePlan').onclick = ()=>{
      state.safetyPlan = {
        codeWord: $('#sp_code').value.trim(),
        escapeRoute: $('#sp_route').value.trim(),
        essentials: $('#sp_ess').value.trim(),
        transport: $('#sp_trans').value.trim(),
        pets: $('#sp_pets').value.trim()
      };
      save(); setTab('home');
    };
    const pa = $('#primaryAction');
    pa.textContent = 'Save Plan';
    pa.onclick = ()=>$('#savePlan').click();
  }

  // =============== PROFILE ===============
  function renderProfile(){
    view.innerHTML = '';
    const f = card('Profile', `
      <label class="block text-sm">Display name
        <input id="pf_name" class="mt-1 w-full bg-slate-900 rounded-lg p-2 border border-white/10" placeholder="Optional alias">
      </label>
      <label class="block text-sm">ZIP / Area
        <input id="pf_zip" class="mt-1 w-full bg-slate-900 rounded-lg p-2 border border-white/10" placeholder="e.g., 30303">
      </label>
      <label class="block text-sm">Trusted contact (phone or email)
        <input id="pf_contact" class="mt-1 w-full bg-slate-900 rounded-lg p-2 border border-white/10">
      </label>
      <label class="block text-sm">Notes (private)
        <textarea id="pf_notes" rows="3" class="mt-1 w-full bg-slate-900 rounded-lg p-2 border border-white/10"></textarea>
      </label>
      <button id="saveProfile" class="tap w-full pill bg-indigo-600 hover:bg-indigo-700 py-3 font-semibold">Save Profile</button>
    `);
    view.appendChild(f);
    $('#pf_name').value = state.profile.displayName || '';
    $('#pf_zip').value = state.profile.zip || '';
    $('#pf_contact').value = state.profile.safeContact || '';
    $('#pf_notes').value = state.profile.notes || '';
    $('#saveProfile').onclick = ()=>{
      state.profile = {
        displayName: $('#pf_name').value.trim(),
        zip: $('#pf_zip').value.trim(),
        safeContact: $('#pf_contact').value.trim(),
        notes: $('#pf_notes').value.trim()
      };
      save(); setTab('home');
    };
    const pa = $('#primaryAction');
    pa.textContent = 'Save Profile';
    pa.onclick = ()=>$('#saveProfile').click();
  }

  // =============== SETTINGS ===============
  function renderSettings(){
    view.innerHTML = '';
    const privacy = card('Privacy & Storage', `
      <p class="text-slate-300">Data is stored only on this device (localStorage).</p>
      <div class="grid grid-cols-2 gap-2">
        <button id="exportData" class="tap pill bg-slate-700 hover:bg-slate-600 py-2">Export JSON</button>
        <button id="importData" class="tap pill bg-slate-700 hover:bg-slate-600 py-2">Import JSON</button>
      </div>
      <input id="importFile" type="file" accept="application/json" class="hidden">
    `);
    const tips = card('Tips', `
      <p class="text-slate-300">Add to Home Screen for an app-like icon. Use <span class="kbd">Reset</span> to clear local data on this device.</p>
    `);
    view.appendChild(privacy);
    view.appendChild(tips);

    $('#exportData').onclick = ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'timeout-export.json';
      a.click();
    };
    $('#importData').onclick = ()=>$('#importFile').click();
    $('#importFile').onchange = async e=>{
      const f = e.target.files[0];
      if (!f) return;
      try{
        const data = JSON.parse(await f.text());
        Object.assign(state, data);
        save(); render();
      }catch{
        alert('Invalid file.');
      }
    };

    const pa = $('#primaryAction');
    pa.textContent = 'New Check-In';
    pa.onclick = ()=>setTab('checkin');
  }

  // =============== GLOBAL ACTIONS ===============
  $('#quickExit').onclick = ()=>{
    document.body.innerHTML = '<div class="p-6 text-center text-slate-200">Loading…</div>';
    location.href = 'https://www.weather.com/';
  };
  $('#resetAll').onclick = ()=>{
    if (!confirm('Erase all local data on this device?')) return;
    localStorage.removeItem(STORAGE_KEY);
    state.tab='home';
    state.profile={displayName:'',zip:'',safeContact:'',notes:''};
    state.checkins=[];
    state.assessment={answers:{},score:0};
    state.safetyPlan={codeWord:'',escapeRoute:'',essentials:'',transport:'',pets:''};
    state.trust=0;
    renderTrust(); render(); save();
  };
  $$('.tab').forEach(b=>b.addEventListener('click',()=>setTab(b.dataset.tab)));

  // =============== BOOT ===============
  load();
  renderTrust();
  setTab(state.tab || 'home');
  </script>
</body>
</html>
